[{"CVE_ID":"CVE-2019-11487","CWE_ID":"416","category":"security","commit_id":"88b1a17dfc3ed7728316478fae0f5ad508f50397","commit_message":"From 88b1a17dfc3ed7728316478fae0f5ad508f50397 Mon Sep 17 00:00:00 2001\nFrom: Linus Torvalds <torvalds@linux-foundation.org>\nDate: Thu, 11 Apr 2019 10:14:59 -0700\nSubject: mm: add 'try_get_page()' helper function\n\nThis is the same as the traditional 'get_page()' function, but instead\nof unconditionally incrementing the reference count of the page, it only\ndoes so if the count was \"safe\".  It returns whether the reference count\nwas incremented (and is marked __must_check, since the caller obviously\nhas to be aware of it).\n\nAlso like 'get_page()', you can't use this function unless you already\nhad a reference to the page.  The intent is that you can use this\nexactly like get_page(), but in situations where you want to limit the\nmaximum reference count.\n\nThe code currently does an unconditional WARN_ON_ONCE() if we ever hit\nthe reference count issues (either zero or negative), as a notification\nthat the conditional non-increment actually happened.\n\nNOTE! The count access for the \"safety\" check is inherently racy, but\nthat doesn't matter since the buffer we use is basically half the range\nof the reference count (ie we look at the sign of the count).\n\nAcked-by: Matthew Wilcox <willy@infradead.org>\nCc: Jann Horn <jannh@google.com>\nCc: stable@kernel.org\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n include\/linux\/mm.h | 9 +++++++++\n 1 file changed, 9 insertions(+)\n\n","diff_code":"diff --git a\/include\/linux\/mm.h b\/include\/linux\/mm.h\nindex 541d99b86aea..7000ddd807e0 100644\n--- a\/include\/linux\/mm.h\n+++ b\/include\/linux\/mm.h\n@@ -980,6 +980,15 @@ static inline void get_page(struct page *page)\n \tpage_ref_inc(page);\n }\n \n+static inline __must_check bool try_get_page(struct page *page)\n+{\n+\tpage = compound_head(page);\n+\tif (WARN_ON_ONCE(page_ref_count(page) <= 0))\n+\t\treturn false;\n+\tpage_ref_inc(page);\n+\treturn true;\n+}\n+\n static inline void put_page(struct page *page)\n {\n \tpage = compound_head(page);\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2018-19824","CWE_ID":"416","category":"security","commit_id":"5f8cf712582617d523120df67d392059eaf2fc4b","commit_message":"From 5f8cf712582617d523120df67d392059eaf2fc4b Mon Sep 17 00:00:00 2001\nFrom: Hui Peng <benquike@gmail.com>\nDate: Mon, 3 Dec 2018 16:09:34 +0100\nSubject: ALSA: usb-audio: Fix UAF decrement if card has no live interfaces in\n card.c\n\nIf a USB sound card reports 0 interfaces, an error condition is triggered\nand the function usb_audio_probe errors out. In the error path, there was a\nuse-after-free vulnerability where the memory object of the card was first\nfreed, followed by a decrement of the number of active chips. Moving the\ndecrement above the atomic_dec fixes the UAF.\n\n[ The original problem was introduced in 3.1 kernel, while it was\n  developed in a different form.  The Fixes tag below indicates the\n  original commit but it doesn't mean that the patch is applicable\n  cleanly. -- tiwai ]\n\nFixes: 362e4e49abe5 (\"ALSA: usb-audio - clear chip->probing on error exit\")\nReported-by: Hui Peng <benquike@gmail.com>\nReported-by: Mathias Payer <mathias.payer@nebelwelt.net>\nSigned-off-by: Hui Peng <benquike@gmail.com>\nSigned-off-by: Mathias Payer <mathias.payer@nebelwelt.net>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Takashi Iwai <tiwai@suse.de>\n---\n sound\/usb\/card.c | 5 ++++-\n 1 file changed, 4 insertions(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/sound\/usb\/card.c b\/sound\/usb\/card.c\nindex 2bfe4e80a6b9..a105947eaf55 100644\n--- a\/sound\/usb\/card.c\n+++ b\/sound\/usb\/card.c\n@@ -682,9 +682,12 @@ static int usb_audio_probe(struct usb_interface *intf,\n \n  __error:\n \tif (chip) {\n+\t\t\/* chip->active is inside the chip->card object,\n+\t\t * decrement before memory is possibly returned.\n+\t\t *\/\n+\t\tatomic_dec(&chip->active);\n \t\tif (!chip->num_interfaces)\n \t\t\tsnd_card_free(chip->card);\n-\t\tatomic_dec(&chip->active);\n \t}\n \tmutex_unlock(&register_mutex);\n \treturn err;\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-15115","CWE_ID":"416","category":"security","commit_id":"df80cd9b28b9ebaa284a41df611dbf3a2d05ca74","commit_message":"From df80cd9b28b9ebaa284a41df611dbf3a2d05ca74 Mon Sep 17 00:00:00 2001\nFrom: Xin Long <lucien.xin@gmail.com>\nDate: Tue, 17 Oct 2017 23:26:10 +0800\nSubject: sctp: do not peel off an assoc from one netns to another one\n\nNow when peeling off an association to the sock in another netns, all\ntransports in this assoc are not to be rehashed and keep use the old\nkey in hashtable.\n\nAs a transport uses sk->net as the hash key to insert into hashtable,\nit would miss removing these transports from hashtable due to the new\nnetns when closing the sock and all transports are being freeed, then\nlater an use-after-free issue could be caused when looking up an asoc\nand dereferencing those transports.\n\nThis is a very old issue since very beginning, ChunYu found it with\nsyzkaller fuzz testing with this series:\n\n  socket$inet6_sctp()\n  bind$inet6()\n  sendto$inet6()\n  unshare(0x40000000)\n  getsockopt$inet_sctp6_SCTP_GET_ASSOC_ID_LIST()\n  getsockopt$inet_sctp6_SCTP_SOCKOPT_PEELOFF()\n\nThis patch is to block this call when peeling one assoc off from one\nnetns to another one, so that the netns of all transport would not\ngo out-sync with the key in hashtable.\n\nNote that this patch didn't fix it by rehashing transports, as it's\ndifficult to handle the situation when the tuple is already in use\nin the new netns. Besides, no one would like to peel off one assoc\nto another netns, considering ipaddrs, ifaces, etc. are usually\ndifferent.\n\nReported-by: ChunYu Wang <chunwang@redhat.com>\nSigned-off-by: Xin Long <lucien.xin@gmail.com>\nAcked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>\nAcked-by: Neil Horman <nhorman@tuxdriver.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n---\n net\/sctp\/socket.c | 4 ++++\n 1 file changed, 4 insertions(+)\n\n","diff_code":"diff --git a\/net\/sctp\/socket.c b\/net\/sctp\/socket.c\nindex d4730ada7f32..17841ab30798 100644\n--- a\/net\/sctp\/socket.c\n+++ b\/net\/sctp\/socket.c\n@@ -4906,6 +4906,10 @@ int sctp_do_peeloff(struct sock *sk, sctp_assoc_t id, struct socket **sockp)\n \tstruct socket *sock;\n \tint err = 0;\n \n+\t\/* Do not peel off from one netns to another one. *\/\n+\tif (!net_eq(current->nsproxy->net_ns, sock_net(sk)))\n+\t\treturn -EINVAL;\n+\n \tif (!asoc)\n \t\treturn -EINVAL;\n \n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2019-9003","CWE_ID":"416","category":"security","commit_id":"77f8269606bf95fcb232ee86f6da80886f1dfae8","commit_message":"From 77f8269606bf95fcb232ee86f6da80886f1dfae8 Mon Sep 17 00:00:00 2001\nFrom: Yang Yingliang <yangyingliang@huawei.com>\nDate: Wed, 16 Jan 2019 13:33:22 +0800\nSubject: ipmi: fix use-after-free of user->release_barrier.rda\n\nWhen we do the following test, we got oops in ipmi_msghandler driver\nwhile((1))\ndo\n\tservice ipmievd restart & service ipmievd restart\ndone\n\n---------------------------------------------------------------\n[  294.230186] Unable to handle kernel paging request at virtual address 0000803fea6ea008\n[  294.230188] Mem abort info:\n[  294.230190]   ESR = 0x96000004\n[  294.230191]   Exception class = DABT (current EL), IL = 32 bits\n[  294.230193]   SET = 0, FnV = 0\n[  294.230194]   EA = 0, S1PTW = 0\n[  294.230195] Data abort info:\n[  294.230196]   ISV = 0, ISS = 0x00000004\n[  294.230197]   CM = 0, WnR = 0\n[  294.230199] user pgtable: 4k pages, 48-bit VAs, pgdp = 00000000a1c1b75a\n[  294.230201] [0000803fea6ea008] pgd=0000000000000000\n[  294.230204] Internal error: Oops: 96000004 [#1] SMP\n[  294.235211] Modules linked in: nls_utf8 isofs rpcrdma ib_iser ib_srpt target_core_mod ib_srp scsi_transport_srp ib_ipoib rdma_ucm ib_umad rdma_cm ib_cm iw_cm dm_mirror dm_region_hash dm_log dm_mod aes_ce_blk crypto_simd cryptd aes_ce_cipher ghash_ce sha2_ce ses sha256_arm64 sha1_ce hibmc_drm hisi_sas_v2_hw enclosure sg hisi_sas_main sbsa_gwdt ip_tables mlx5_ib ib_uverbs marvell ib_core mlx5_core ixgbe ipmi_si mdio hns_dsaf ipmi_devintf ipmi_msghandler hns_enet_drv hns_mdio\n[  294.277745] CPU: 3 PID: 0 Comm: swapper\/3 Kdump: loaded Not tainted 5.0.0-rc2+ #113\n[  294.285511] Hardware name: Huawei TaiShan 2280 \/BC11SPCD, BIOS 1.37 11\/21\/2017\n[  294.292835] pstate: 80000005 (Nzcv daif -PAN -UAO)\n[  294.297695] pc : __srcu_read_lock+0x38\/0x58\n[  294.301940] lr : acquire_ipmi_user+0x2c\/0x70 [ipmi_msghandler]\n[  294.307853] sp : ffff00001001bc80\n[  294.311208] x29: ffff00001001bc80 x28: ffff0000117e5000\n[  294.316594] x27: 0000000000000000 x26: dead000000000100\n[  294.321980] x25: dead000000000200 x24: ffff803f6bd06800\n[  294.327366] x23: 0000000000000000 x22: 0000000000000000\n[  294.332752] x21: ffff00001001bd04 x20: ffff80df33d19018\n[  294.338137] x19: ffff80df33d19018 x18: 0000000000000000\n[  294.343523] x17: 0000000000000000 x16: 0000000000000000\n[  294.348908] x15: 0000000000000000 x14: 0000000000000002\n[  294.354293] x13: 0000000000000000 x12: 0000000000000000\n[  294.359679] x11: 0000000000000000 x10: 0000000000100000\n[  294.365065] x9 : 0000000000000000 x8 : 0000000000000004\n[  294.370451] x7 : 0000000000000000 x6 : ffff80df34558678\n[  294.375836] x5 : 000000000000000c x4 : 0000000000000000\n[  294.381221] x3 : 0000000000000001 x2 : 0000803fea6ea000\n[  294.386607] x1 : 0000803fea6ea008 x0 : 0000000000000001\n[  294.391994] Process swapper\/3 (pid: 0, stack limit = 0x0000000083087293)\n[  294.398791] Call trace:\n[  294.401266]  __srcu_read_lock+0x38\/0x58\n[  294.405154]  acquire_ipmi_user+0x2c\/0x70 [ipmi_msghandler]\n[  294.410716]  deliver_response+0x80\/0xf8 [ipmi_msghandler]\n[  294.416189]  deliver_local_response+0x28\/0x68 [ipmi_msghandler]\n[  294.422193]  handle_one_recv_msg+0x158\/0xcf8 [ipmi_msghandler]\n[  294.432050]  handle_new_recv_msgs+0xc0\/0x210 [ipmi_msghandler]\n[  294.441984]  smi_recv_tasklet+0x8c\/0x158 [ipmi_msghandler]\n[  294.451618]  tasklet_action_common.isra.5+0x88\/0x138\n[  294.460661]  tasklet_action+0x2c\/0x38\n[  294.468191]  __do_softirq+0x120\/0x2f8\n[  294.475561]  irq_exit+0x134\/0x140\n[  294.482445]  __handle_domain_irq+0x6c\/0xc0\n[  294.489954]  gic_handle_irq+0xb8\/0x178\n[  294.497037]  el1_irq+0xb0\/0x140\n[  294.503381]  arch_cpu_idle+0x34\/0x1a8\n[  294.510096]  do_idle+0x1d4\/0x290\n[  294.516322]  cpu_startup_entry+0x28\/0x30\n[  294.523230]  secondary_start_kernel+0x184\/0x1d0\n[  294.530657] Code: d538d082 d2800023 8b010c81 8b020021 (c85f7c25)\n[  294.539746] ---[ end trace 8a7a880dee570b29 ]---\n[  294.547341] Kernel panic - not syncing: Fatal exception in interrupt\n[  294.556837] SMP: stopping secondary CPUs\n[  294.563996] Kernel Offset: disabled\n[  294.570515] CPU features: 0x002,21006008\n[  294.577638] Memory Limit: none\n[  294.587178] Starting crashdump kernel...\n[  294.594314] Bye!\n\nBecause the user->release_barrier.rda is freed in ipmi_destroy_user(), but\nthe refcount is not zero, when acquire_ipmi_user() uses user->release_barrier.rda\nin __srcu_read_lock(), it causes oops.\nFix this by calling cleanup_srcu_struct() when the refcount is zero.\n\nFixes: e86ee2d44b44 (\"ipmi: Rework locking and shutdown for hot remove\")\nCc: stable@vger.kernel.org # 4.18\nSigned-off-by: Yang Yingliang <yangyingliang@huawei.com>\n\nSigned-off-by: Corey Minyard <cminyard@mvista.com>\n---\n drivers\/char\/ipmi\/ipmi_msghandler.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/drivers\/char\/ipmi\/ipmi_msghandler.c b\/drivers\/char\/ipmi\/ipmi_msghandler.c\nindex cc5665c47a0e..e43c27ff59b4 100644\n--- a\/drivers\/char\/ipmi\/ipmi_msghandler.c\n+++ b\/drivers\/char\/ipmi\/ipmi_msghandler.c\n@@ -1184,6 +1184,7 @@ EXPORT_SYMBOL(ipmi_get_smi_info);\n static void free_user(struct kref *ref)\n {\n \tstruct ipmi_user *user = container_of(ref, struct ipmi_user, refcount);\n+\tcleanup_srcu_struct(&user->release_barrier);\n \tkfree(user);\n }\n \n@@ -1260,7 +1261,6 @@ int ipmi_destroy_user(struct ipmi_user *user)\n {\n \t_ipmi_destroy_user(user);\n \n-\tcleanup_srcu_struct(&user->release_barrier);\n \tkref_put(&user->refcount, free_user);\n \n \treturn 0;\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-11176","CWE_ID":"416","category":"security","commit_id":"f991af3daabaecff34684fd51fac80319d1baad1","commit_message":"From f991af3daabaecff34684fd51fac80319d1baad1 Mon Sep 17 00:00:00 2001\nFrom: Cong Wang <xiyou.wangcong@gmail.com>\nDate: Sun, 9 Jul 2017 13:19:55 -0700\nSubject: [PATCH] mqueue: fix a use-after-free in sys_mq_notify()\n\nThe retry logic for netlink_attachskb() inside sys_mq_notify()\nis nasty and vulnerable:\n\n1) The sock refcnt is already released when retry is needed\n2) The fd is controllable by user-space because we already\n   release the file refcnt\n\nso we when retry but the fd has been just closed by user-space\nduring this small window, we end up calling netlink_detachskb()\non the error path which releases the sock again, later when\nthe user-space closes this socket a use-after-free could be\ntriggered.\n\nSetting 'sock' to NULL here should be sufficient to fix it.\n\nReported-by: GeneBlue <geneblue.mail@gmail.com>\nSigned-off-by: Cong Wang <xiyou.wangcong@gmail.com>\nCc: Andrew Morton <akpm@linux-foundation.org>\nCc: Manfred Spraul <manfred@colorfullife.com>\nCc: stable@kernel.org\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n ipc\/mqueue.c | 4 +++-\n 1 file changed, 3 insertions(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/ipc\/mqueue.c b\/ipc\/mqueue.c\nindex c9ff943f19abc..eb1391b52c6f8 100644\n--- a\/ipc\/mqueue.c\n+++ b\/ipc\/mqueue.c\n@@ -1270,8 +1270,10 @@ static int do_mq_notify(mqd_t mqdes, const struct sigevent *notification)\n \n \t\t\ttimeo = MAX_SCHEDULE_TIMEOUT;\n \t\t\tret = netlink_attachskb(sock, nc, &timeo, NULL);\n-\t\t\tif (ret == 1)\n+\t\t\tif (ret == 1) {\n+\t\t\t\tsock = NULL;\n \t\t\t\tgoto retry;\n+\t\t\t}\n \t\t\tif (ret) {\n \t\t\t\tsock = NULL;\n \t\t\t\tnc = NULL;\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2016-1251","CWE_ID":"416","category":"security","commit_id":"3619c170461a3107a258d1fd2d00ed4832adb1b1","commit_message":"From 3619c170461a3107a258d1fd2d00ed4832adb1b1 Mon Sep 17 00:00:00 2001\nFrom: Pali <pali@cpan.org>\nDate: Fri, 18 Nov 2016 19:01:48 +0100\nSubject: [PATCH] Fix use-after-free for repeated fetchrow_arrayref calls when\n mysql_server_prepare=1\n\nFunction dbd_st_fetch() via Renew() can reallocate output buffer for\nmysql_stmt_fetch() call. But it does not update pointer to that buffer in\nimp_sth->stmt structure initialized by mysql_stmt_bind_result() function.\nThat leads to use-after-free in any mysql function which access\nimp_sth->stmt structure (e.g. mysql_stmt_fetch()).\n\nThis patch fix this problem and properly updates pointer in imp_sth->stmt\nstructure after Renew() call.\n\nTest 40server_prepare_crash.t is extended to check for that use-after-free\ncrash.\n---\n dbdimp.c                   |  2 ++\n t\/40server_prepare_crash.t | 45 +++++++++++++++++++++++++++++++++++---\n 2 files changed, 44 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/dbdimp.c b\/dbdimp.c\nindex f8055bc..9b8b313 100644\n--- a\/dbdimp.c\n+++ b\/dbdimp.c\n@@ -4050,6 +4050,8 @@ dbd_st_fetch(SV *sth, imp_sth_t* imp_sth)\n           Renew(fbh->data, fbh->length, char);\n           buffer->buffer_length= fbh->length;\n           buffer->buffer= (char *) fbh->data;\n+          imp_sth->stmt->bind[i].buffer_length = fbh->length;\n+          imp_sth->stmt->bind[i].buffer = (char *)fbh->data;\n \n           if (DBIc_TRACE_LEVEL(imp_xxh) >= 2) {\n             int j;\ndiff --git a\/t\/40server_prepare_crash.t b\/t\/40server_prepare_crash.t\nindex 6db3207..df6e2b3 100644\n--- a\/t\/40server_prepare_crash.t\n+++ b\/t\/40server_prepare_crash.t\n@@ -10,11 +10,22 @@ require \"t\/lib.pl\";\n my $dbh = eval { DBI->connect($test_dsn, $test_user, $test_password, { PrintError => 1, RaiseError => 1, AutoCommit => 0, mysql_server_prepare => 1, mysql_server_prepare_disable_fallback => 1 }) };\n plan skip_all => \"no database connection\" if $@ or not $dbh;\n \n-plan tests => 17;\n+plan tests => 39;\n \n-ok $dbh->do(\"CREATE TEMPORARY TABLE t (i INTEGER NOT NULL, n TEXT)\");\n+my $sth;\n \n-ok my $sth = $dbh->prepare(\"SELECT * FROM t WHERE i=? AND n=?\");\n+ok $dbh->do(\"CREATE TEMPORARY TABLE t (i INTEGER NOT NULL, n LONGBLOB)\");\n+\n+ok $sth = $dbh->prepare(\"INSERT INTO t(i, n) VALUES(?, ?)\");\n+ok $sth->execute(1, \"x\" x 10);\n+ok $sth->execute(2, \"x\" x 100);\n+ok $sth->execute(3, \"x\" x 1000);\n+ok $sth->execute(4, \"x\" x 10000);\n+ok $sth->execute(5, \"x\" x 100000);\n+ok $sth->execute(6, \"x\" x 1000000);\n+ok $sth->finish();\n+\n+ok $sth = $dbh->prepare(\"SELECT * FROM t WHERE i=? AND n=?\");\n \n ok $sth->bind_param(2, \"x\" x 1000000);\n ok $sth->bind_param(1, \"abcx\", 12);\n@@ -34,6 +45,34 @@ ok $sth = $dbh->prepare(\"SELECT 1 FROM t WHERE i = ?\" . (\" OR i = ?\" x 10000));\n ok $sth->execute((1) x (10001));\n ok $sth->finish();\n \n+my $test;\n+ok $sth = $dbh->prepare(\"SELECT i,n FROM t WHERE i = ?\");\n+\n+ok $sth->execute(1);\n+ok $sth->fetchrow_arrayref();\n+\n+ok $sth->execute(2);\n+$test = map { $_ } 'a';\n+ok $sth->fetchrow_arrayref();\n+\n+ok $sth->execute(3);\n+$test = map { $_ } 'b' x 10000000; # try to reuse released memory\n+ok $sth->fetchrow_arrayref();\n+\n+ok $sth->execute(4);\n+$test = map { $_ } 'cd' x 10000000; # try to reuse of released memory\n+ok $sth->fetchrow_arrayref();\n+\n+ok $sth->execute(5);\n+$test = map { $_ } 'efg' x 10000000; # try to reuse of released memory\n+ok $sth->fetchrow_arrayref();\n+\n+ok $sth->execute(6);\n+$test = map { $_ } 'hijk' x 10000000; # try to reuse of released memory\n+ok $sth->fetchrow_arrayref();\n+\n+ok $sth->finish();\n+\n ok $dbh->do(\"SELECT 1 FROM t WHERE i = ?\" . (\" OR i = ?\" x 10000), {}, (1) x (10001));\n \n ok $dbh->disconnect();\n","owner":"perl5-dbi","repo":"DBD-mysql","source":"cve"},{"CVE_ID":"CVE-2017-16525","CWE_ID":"416","category":"security","commit_id":"299d7572e46f98534033a9e65973f13ad1ce9047","commit_message":"From 299d7572e46f98534033a9e65973f13ad1ce9047 Mon Sep 17 00:00:00 2001\nFrom: Johan Hovold <johan@kernel.org>\nDate: Wed, 4 Oct 2017 11:01:13 +0200\nSubject: [PATCH] USB: serial: console: fix use-after-free after failed setup\n\nMake sure to reset the USB-console port pointer when console setup fails\nin order to avoid having the struct usb_serial be prematurely freed by\nthe console code when the device is later disconnected.\n\nFixes: 73e487fdb75f (\"[PATCH] USB console: fix disconnection issues\")\nCc: stable <stable@vger.kernel.org>\t# 2.6.18\nAcked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\nSigned-off-by: Johan Hovold <johan@kernel.org>\n---\n drivers\/usb\/serial\/console.c | 1 +\n 1 file changed, 1 insertion(+)\n\n","diff_code":"diff --git a\/drivers\/usb\/serial\/console.c b\/drivers\/usb\/serial\/console.c\nindex ed8ba3ef5c794..43a862a90a775 100644\n--- a\/drivers\/usb\/serial\/console.c\n+++ b\/drivers\/usb\/serial\/console.c\n@@ -186,6 +186,7 @@ static int usb_console_setup(struct console *co, char *options)\n \ttty_kref_put(tty);\n  reset_open_count:\n \tport->port.count = 0;\n+\tinfo->port = NULL;\n \tusb_autopm_put_interface(serial->interface);\n  error_get_interface:\n \tusb_serial_put(serial);\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2016-4805","CWE_ID":"416","category":"security","commit_id":"1f461dcdd296eecedaffffc6bae2bfa90bd7eb89","commit_message":"From 1f461dcdd296eecedaffffc6bae2bfa90bd7eb89 Mon Sep 17 00:00:00 2001\nFrom: Guillaume Nault <g.nault@alphalink.fr>\nDate: Wed, 23 Mar 2016 16:38:55 +0100\nSubject: ppp: take reference on channels netns\n\nLet channels hold a reference on their network namespace.\nSome channel types, like ppp_async and ppp_synctty, can have their\nuserspace controller running in a different namespace. Therefore they\ncan't rely on them to preclude their netns from being removed from\nunder them.\n\n==================================================================\nBUG: KASAN: use-after-free in ppp_unregister_channel+0x372\/0x3a0 at\naddr ffff880064e217e0\nRead of size 8 by task syz-executor\/11581\n=============================================================================\nBUG net_namespace (Not tainted): kasan: bad access detected\n-----------------------------------------------------------------------------\n\nDisabling lock debugging due to kernel taint\nINFO: Allocated in copy_net_ns+0x6b\/0x1a0 age=92569 cpu=3 pid=6906\n[<      none      >] ___slab_alloc+0x4c7\/0x500 kernel\/mm\/slub.c:2440\n[<      none      >] __slab_alloc+0x4c\/0x90 kernel\/mm\/slub.c:2469\n[<     inline     >] slab_alloc_node kernel\/mm\/slub.c:2532\n[<     inline     >] slab_alloc kernel\/mm\/slub.c:2574\n[<      none      >] kmem_cache_alloc+0x23a\/0x2b0 kernel\/mm\/slub.c:2579\n[<     inline     >] kmem_cache_zalloc kernel\/include\/linux\/slab.h:597\n[<     inline     >] net_alloc kernel\/net\/core\/net_namespace.c:325\n[<      none      >] copy_net_ns+0x6b\/0x1a0 kernel\/net\/core\/net_namespace.c:360\n[<      none      >] create_new_namespaces+0x2f6\/0x610 kernel\/kernel\/nsproxy.c:95\n[<      none      >] copy_namespaces+0x297\/0x320 kernel\/kernel\/nsproxy.c:150\n[<      none      >] copy_process.part.35+0x1bf4\/0x5760 kernel\/kernel\/fork.c:1451\n[<     inline     >] copy_process kernel\/kernel\/fork.c:1274\n[<      none      >] _do_fork+0x1bc\/0xcb0 kernel\/kernel\/fork.c:1723\n[<     inline     >] SYSC_clone kernel\/kernel\/fork.c:1832\n[<      none      >] SyS_clone+0x37\/0x50 kernel\/kernel\/fork.c:1826\n[<      none      >] entry_SYSCALL_64_fastpath+0x16\/0x7a kernel\/arch\/x86\/entry\/entry_64.S:185\n\nINFO: Freed in net_drop_ns+0x67\/0x80 age=575 cpu=2 pid=2631\n[<      none      >] __slab_free+0x1fc\/0x320 kernel\/mm\/slub.c:2650\n[<     inline     >] slab_free kernel\/mm\/slub.c:2805\n[<      none      >] kmem_cache_free+0x2a0\/0x330 kernel\/mm\/slub.c:2814\n[<     inline     >] net_free kernel\/net\/core\/net_namespace.c:341\n[<      none      >] net_drop_ns+0x67\/0x80 kernel\/net\/core\/net_namespace.c:348\n[<      none      >] cleanup_net+0x4e5\/0x600 kernel\/net\/core\/net_namespace.c:448\n[<      none      >] process_one_work+0x794\/0x1440 kernel\/kernel\/workqueue.c:2036\n[<      none      >] worker_thread+0xdb\/0xfc0 kernel\/kernel\/workqueue.c:2170\n[<      none      >] kthread+0x23f\/0x2d0 kernel\/drivers\/block\/aoe\/aoecmd.c:1303\n[<      none      >] ret_from_fork+0x3f\/0x70 kernel\/arch\/x86\/entry\/entry_64.S:468\nINFO: Slab 0xffffea0001938800 objects=3 used=0 fp=0xffff880064e20000\nflags=0x5fffc0000004080\nINFO: Object 0xffff880064e20000 @offset=0 fp=0xffff880064e24200\n\nCPU: 1 PID: 11581 Comm: syz-executor Tainted: G    B           4.4.0+\nHardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS\nrel-1.8.2-0-g33fbe13 by qemu-project.org 04\/01\/2014\n 00000000ffffffff ffff8800662c7790 ffffffff8292049d ffff88003e36a300\n ffff880064e20000 ffff880064e20000 ffff8800662c77c0 ffffffff816f2054\n ffff88003e36a300 ffffea0001938800 ffff880064e20000 0000000000000000\nCall Trace:\n [<     inline     >] __dump_stack kernel\/lib\/dump_stack.c:15\n [<ffffffff8292049d>] dump_stack+0x6f\/0xa2 kernel\/lib\/dump_stack.c:50\n [<ffffffff816f2054>] print_trailer+0xf4\/0x150 kernel\/mm\/slub.c:654\n [<ffffffff816f875f>] object_err+0x2f\/0x40 kernel\/mm\/slub.c:661\n [<     inline     >] print_address_description kernel\/mm\/kasan\/report.c:138\n [<ffffffff816fb0c5>] kasan_report_error+0x215\/0x530 kernel\/mm\/kasan\/report.c:236\n [<     inline     >] kasan_report kernel\/mm\/kasan\/report.c:259\n [<ffffffff816fb4de>] __asan_report_load8_noabort+0x3e\/0x40 kernel\/mm\/kasan\/report.c:280\n [<     inline     >] ? ppp_pernet kernel\/include\/linux\/compiler.h:218\n [<ffffffff83ad71b2>] ? ppp_unregister_channel+0x372\/0x3a0 kernel\/drivers\/net\/ppp\/ppp_generic.c:2392\n [<     inline     >] ppp_pernet kernel\/include\/linux\/compiler.h:218\n [<ffffffff83ad71b2>] ppp_unregister_channel+0x372\/0x3a0 kernel\/drivers\/net\/ppp\/ppp_generic.c:2392\n [<     inline     >] ? ppp_pernet kernel\/drivers\/net\/ppp\/ppp_generic.c:293\n [<ffffffff83ad6f26>] ? ppp_unregister_channel+0xe6\/0x3a0 kernel\/drivers\/net\/ppp\/ppp_generic.c:2392\n [<ffffffff83ae18f3>] ppp_asynctty_close+0xa3\/0x130 kernel\/drivers\/net\/ppp\/ppp_async.c:241\n [<ffffffff83ae1850>] ? async_lcp_peek+0x5b0\/0x5b0 kernel\/drivers\/net\/ppp\/ppp_async.c:1000\n [<ffffffff82c33239>] tty_ldisc_close.isra.1+0x99\/0xe0 kernel\/drivers\/tty\/tty_ldisc.c:478\n [<ffffffff82c332c0>] tty_ldisc_kill+0x40\/0x170 kernel\/drivers\/tty\/tty_ldisc.c:744\n [<ffffffff82c34943>] tty_ldisc_release+0x1b3\/0x260 kernel\/drivers\/tty\/tty_ldisc.c:772\n [<ffffffff82c1ef21>] tty_release+0xac1\/0x13e0 kernel\/drivers\/tty\/tty_io.c:1901\n [<ffffffff82c1e460>] ? release_tty+0x320\/0x320 kernel\/drivers\/tty\/tty_io.c:1688\n [<ffffffff8174de36>] __fput+0x236\/0x780 kernel\/fs\/file_table.c:208\n [<ffffffff8174e405>] ____fput+0x15\/0x20 kernel\/fs\/file_table.c:244\n [<ffffffff813595ab>] task_work_run+0x16b\/0x200 kernel\/kernel\/task_work.c:115\n [<     inline     >] exit_task_work kernel\/include\/linux\/task_work.h:21\n [<ffffffff81307105>] do_exit+0x8b5\/0x2c60 kernel\/kernel\/exit.c:750\n [<ffffffff813fdd20>] ? debug_check_no_locks_freed+0x290\/0x290 kernel\/kernel\/locking\/lockdep.c:4123\n [<ffffffff81306850>] ? mm_update_next_owner+0x6f0\/0x6f0 kernel\/kernel\/exit.c:357\n [<ffffffff813215e6>] ? __dequeue_signal+0x136\/0x470 kernel\/kernel\/signal.c:550\n [<ffffffff8132067b>] ? recalc_sigpending_tsk+0x13b\/0x180 kernel\/kernel\/signal.c:145\n [<ffffffff81309628>] do_group_exit+0x108\/0x330 kernel\/kernel\/exit.c:880\n [<ffffffff8132b9d4>] get_signal+0x5e4\/0x14f0 kernel\/kernel\/signal.c:2307\n [<     inline     >] ? kretprobe_table_lock kernel\/kernel\/kprobes.c:1113\n [<ffffffff8151d355>] ? kprobe_flush_task+0xb5\/0x450 kernel\/kernel\/kprobes.c:1158\n [<ffffffff8115f7d3>] do_signal+0x83\/0x1c90 kernel\/arch\/x86\/kernel\/signal.c:712\n [<ffffffff8151d2a0>] ? recycle_rp_inst+0x310\/0x310 kernel\/include\/linux\/list.h:655\n [<ffffffff8115f750>] ? setup_sigcontext+0x780\/0x780 kernel\/arch\/x86\/kernel\/signal.c:165\n [<ffffffff81380864>] ? finish_task_switch+0x424\/0x5f0 kernel\/kernel\/sched\/core.c:2692\n [<     inline     >] ? finish_lock_switch kernel\/kernel\/sched\/sched.h:1099\n [<ffffffff81380560>] ? finish_task_switch+0x120\/0x5f0 kernel\/kernel\/sched\/core.c:2678\n [<     inline     >] ? context_switch kernel\/kernel\/sched\/core.c:2807\n [<ffffffff85d794e9>] ? __schedule+0x919\/0x1bd0 kernel\/kernel\/sched\/core.c:3283\n [<ffffffff81003901>] exit_to_usermode_loop+0xf1\/0x1a0 kernel\/arch\/x86\/entry\/common.c:247\n [<     inline     >] prepare_exit_to_usermode kernel\/arch\/x86\/entry\/common.c:282\n [<ffffffff810062ef>] syscall_return_slowpath+0x19f\/0x210 kernel\/arch\/x86\/entry\/common.c:344\n [<ffffffff85d88022>] int_ret_from_sys_call+0x25\/0x9f kernel\/arch\/x86\/entry\/entry_64.S:281\nMemory state around the buggy address:\n ffff880064e21680: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n ffff880064e21700: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n>ffff880064e21780: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n                                                       ^\n ffff880064e21800: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n ffff880064e21880: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n==================================================================\n\nFixes: 273ec51dd7ce (\"net: ppp_generic - introduce net-namespace functionality v2\")\nReported-by: Baozeng Ding <sploving1@gmail.com>\nSigned-off-by: Guillaume Nault <g.nault@alphalink.fr>\nReviewed-by: Cyrill Gorcunov <gorcunov@openvz.org>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n---\n drivers\/net\/ppp\/ppp_generic.c | 4 +++-\n 1 file changed, 3 insertions(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/drivers\/net\/ppp\/ppp_generic.c b\/drivers\/net\/ppp\/ppp_generic.c\nindex 4fd861063ed4..f572b31a2b20 100644\n--- a\/drivers\/net\/ppp\/ppp_generic.c\n+++ b\/drivers\/net\/ppp\/ppp_generic.c\n@@ -2307,7 +2307,7 @@ int ppp_register_net_channel(struct net *net, struct ppp_channel *chan)\n \n \tpch->ppp = NULL;\n \tpch->chan = chan;\n-\tpch->chan_net = net;\n+\tpch->chan_net = get_net(net);\n \tchan->ppp = pch;\n \tinit_ppp_file(&pch->file, CHANNEL);\n \tpch->file.hdrlen = chan->hdrlen;\n@@ -2404,6 +2404,8 @@ ppp_unregister_channel(struct ppp_channel *chan)\n \tspin_lock_bh(&pn->all_channels_lock);\n \tlist_del(&pch->list);\n \tspin_unlock_bh(&pn->all_channels_lock);\n+\tput_net(pch->chan_net);\n+\tpch->chan_net = NULL;\n \n \tpch->file.dead = 1;\n \twake_up_interruptible(&pch->file.rwait);\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-18202","CWE_ID":"416","category":"security","commit_id":"687cb0884a714ff484d038e9190edc874edcf146","commit_message":"From 687cb0884a714ff484d038e9190edc874edcf146 Mon Sep 17 00:00:00 2001\nFrom: Wang Nan <wangnan0@huawei.com>\nDate: Wed, 29 Nov 2017 16:09:58 -0800\nSubject: [PATCH] mm, oom_reaper: gather each vma to prevent leaking TLB entry\n\ntlb_gather_mmu(&tlb, mm, 0, -1) means gathering the whole virtual memory\nspace.  In this case, tlb->fullmm is true.  Some archs like arm64\ndoesn't flush TLB when tlb->fullmm is true:\n\n  commit 5a7862e83000 (\"arm64: tlbflush: avoid flushing when fullmm == 1\").\n\nWhich causes leaking of tlb entries.\n\nWill clarifies his patch:\n \"Basically, we tag each address space with an ASID (PCID on x86) which\n  is resident in the TLB. This means we can elide TLB invalidation when\n  pulling down a full mm because we won't ever assign that ASID to\n  another mm without doing TLB invalidation elsewhere (which actually\n  just nukes the whole TLB).\n\n  I think that means that we could potentially not fault on a kernel\n  uaccess, because we could hit in the TLB\"\n\nThere could be a window between complete_signal() sending IPI to other\ncores and all threads sharing this mm are really kicked off from cores.\nIn this window, the oom reaper may calls tlb_flush_mmu_tlbonly() to\nflush TLB then frees pages.  However, due to the above problem, the TLB\nentries are not really flushed on arm64.  Other threads are possible to\naccess these pages through TLB entries.  Moreover, a copy_to_user() can\nalso write to these pages without generating page fault, causes\nuse-after-free bugs.\n\nThis patch gathers each vma instead of gathering full vm space.  In this\ncase tlb->fullmm is not true.  The behavior of oom reaper become similar\nto munmapping before do_exit, which should be safe for all archs.\n\nLink: http:\/\/lkml.kernel.org\/r\/20171107095453.179940-1-wangnan0@huawei.com\nFixes: aac453635549 (\"mm, oom: introduce oom reaper\")\nSigned-off-by: Wang Nan <wangnan0@huawei.com>\nAcked-by: Michal Hocko <mhocko@suse.com>\nAcked-by: David Rientjes <rientjes@google.com>\nCc: Minchan Kim <minchan@kernel.org>\nCc: Will Deacon <will.deacon@arm.com>\nCc: Bob Liu <liubo95@huawei.com>\nCc: Ingo Molnar <mingo@kernel.org>\nCc: Roman Gushchin <guro@fb.com>\nCc: Konstantin Khlebnikov <khlebnikov@yandex-team.ru>\nCc: Andrea Arcangeli <aarcange@redhat.com>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n mm\/oom_kill.c | 7 ++++---\n 1 file changed, 4 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/mm\/oom_kill.c b\/mm\/oom_kill.c\nindex c86fbd1b590ec..c957be32b27a9 100644\n--- a\/mm\/oom_kill.c\n+++ b\/mm\/oom_kill.c\n@@ -550,7 +550,6 @@ static bool __oom_reap_task_mm(struct task_struct *tsk, struct mm_struct *mm)\n \t *\/\n \tset_bit(MMF_UNSTABLE, &mm->flags);\n \n-\ttlb_gather_mmu(&tlb, mm, 0, -1);\n \tfor (vma = mm->mmap ; vma; vma = vma->vm_next) {\n \t\tif (!can_madv_dontneed_vma(vma))\n \t\t\tcontinue;\n@@ -565,11 +564,13 @@ static bool __oom_reap_task_mm(struct task_struct *tsk, struct mm_struct *mm)\n \t\t * we do not want to block exit_mmap by keeping mm ref\n \t\t * count elevated without a good reason.\n \t\t *\/\n-\t\tif (vma_is_anonymous(vma) || !(vma->vm_flags & VM_SHARED))\n+\t\tif (vma_is_anonymous(vma) || !(vma->vm_flags & VM_SHARED)) {\n+\t\t\ttlb_gather_mmu(&tlb, mm, vma->vm_start, vma->vm_end);\n \t\t\tunmap_page_range(&tlb, vma, vma->vm_start, vma->vm_end,\n \t\t\t\t\t NULL);\n+\t\t\ttlb_finish_mmu(&tlb, vma->vm_start, vma->vm_end);\n+\t\t}\n \t}\n-\ttlb_finish_mmu(&tlb, 0, -1);\n \tpr_info(\"oom_reaper: reaped process %d (%s), now anon-rss:%lukB, file-rss:%lukB, shmem-rss:%lukB\\n\",\n \t\t\ttask_pid_nr(tsk), tsk->comm,\n \t\t\tK(get_mm_counter(mm, MM_ANONPAGES)),\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2015-1351","CWE_ID":"416","category":"security","commit_id":"777c39f4042327eac4b63c7ee87dc1c7a09a3115","commit_message":"From 777c39f4042327eac4b63c7ee87dc1c7a09a3115 Mon Sep 17 00:00:00 2001\nFrom: Xinchen Hui <laruence@php.net>\nDate: Thu, 8 Jan 2015 16:32:20 +0800\nSubject: [PATCH] Fixed #68677\n\n---\n ext\/opcache\/zend_shared_alloc.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/ext\/opcache\/zend_shared_alloc.c b\/ext\/opcache\/zend_shared_alloc.c\nindex 4036abe..48c16ab 100644\n--- a\/ext\/opcache\/zend_shared_alloc.c\n+++ b\/ext\/opcache\/zend_shared_alloc.c\n@@ -344,10 +344,10 @@ void *_zend_shared_memdup(void *source, size_t size, zend_bool free_source)\n \tretval = ZCG(mem);\n \tZCG(mem) = (void*)(((char*)ZCG(mem)) + ZEND_ALIGNED_SIZE(size));\n \tmemcpy(retval, source, size);\n+\tzend_shared_alloc_register_xlat_entry(source, retval);\n \tif (free_source) {\n \t\tefree(source);\n \t}\n-\tzend_shared_alloc_register_xlat_entry(source, retval);\n \treturn retval;\n }\n \n-- \n2.1.4\n\n","owner":"php","repo":"php-src","source":"cve"},{"CVE_ID":"CVE-2016-7913","CWE_ID":"416","category":"security","commit_id":"8dfbcc4351a0b6d2f2d77f367552f48ffefafe18","commit_message":"From 8dfbcc4351a0b6d2f2d77f367552f48ffefafe18 Mon Sep 17 00:00:00 2001\nFrom: Mauro Carvalho Chehab <mchehab@osg.samsung.com>\nDate: Thu, 28 Jan 2016 09:22:44 -0200\nSubject: [PATCH] [media] xc2028: avoid use after free\n\nIf struct xc2028_config is passed without a firmware name,\nthe following trouble may happen:\n\n[11009.907205] xc2028 5-0061: type set to XCeive xc2028\/xc3028 tuner\n[11009.907491] ==================================================================\n[11009.907750] BUG: KASAN: use-after-free in strcmp+0x96\/0xb0 at addr ffff8803bd78ab40\n[11009.907992] Read of size 1 by task modprobe\/28992\n[11009.907994] =============================================================================\n[11009.907997] BUG kmalloc-16 (Tainted: G        W      ): kasan: bad access detected\n[11009.907999] -----------------------------------------------------------------------------\n\n[11009.908008] INFO: Allocated in xhci_urb_enqueue+0x214\/0x14c0 [xhci_hcd] age=0 cpu=3 pid=28992\n[11009.908012] \t___slab_alloc+0x581\/0x5b0\n[11009.908014] \t__slab_alloc+0x51\/0x90\n[11009.908017] \t__kmalloc+0x27b\/0x350\n[11009.908022] \txhci_urb_enqueue+0x214\/0x14c0 [xhci_hcd]\n[11009.908026] \tusb_hcd_submit_urb+0x1e8\/0x1c60\n[11009.908029] \tusb_submit_urb+0xb0e\/0x1200\n[11009.908032] \tusb_serial_generic_write_start+0xb6\/0x4c0\n[11009.908035] \tusb_serial_generic_write+0x92\/0xc0\n[11009.908039] \tusb_console_write+0x38a\/0x560\n[11009.908045] \tcall_console_drivers.constprop.14+0x1ee\/0x2c0\n[11009.908051] \tconsole_unlock+0x40d\/0x900\n[11009.908056] \tvprintk_emit+0x4b4\/0x830\n[11009.908061] \tvprintk_default+0x1f\/0x30\n[11009.908064] \tprintk+0x99\/0xb5\n[11009.908067] \tkasan_report_error+0x10a\/0x550\n[11009.908070] \t__asan_report_load1_noabort+0x43\/0x50\n[11009.908074] INFO: Freed in xc2028_set_config+0x90\/0x630 [tuner_xc2028] age=1 cpu=3 pid=28992\n[11009.908077] \t__slab_free+0x2ec\/0x460\n[11009.908080] \tkfree+0x266\/0x280\n[11009.908083] \txc2028_set_config+0x90\/0x630 [tuner_xc2028]\n[11009.908086] \txc2028_attach+0x310\/0x8a0 [tuner_xc2028]\n[11009.908090] \tem28xx_attach_xc3028.constprop.7+0x1f9\/0x30d [em28xx_dvb]\n[11009.908094] \tem28xx_dvb_init.part.3+0x8e4\/0x5cf4 [em28xx_dvb]\n[11009.908098] \tem28xx_dvb_init+0x81\/0x8a [em28xx_dvb]\n[11009.908101] \tem28xx_register_extension+0xd9\/0x190 [em28xx]\n[11009.908105] \tem28xx_dvb_register+0x10\/0x1000 [em28xx_dvb]\n[11009.908108] \tdo_one_initcall+0x141\/0x300\n[11009.908111] \tdo_init_module+0x1d0\/0x5ad\n[11009.908114] \tload_module+0x6666\/0x9ba0\n[11009.908117] \tSyS_finit_module+0x108\/0x130\n[11009.908120] \tentry_SYSCALL_64_fastpath+0x16\/0x76\n[11009.908123] INFO: Slab 0xffffea000ef5e280 objects=25 used=25 fp=0x          (null) flags=0x2ffff8000004080\n[11009.908126] INFO: Object 0xffff8803bd78ab40 @offset=2880 fp=0x0000000000000001\n\n[11009.908130] Bytes b4 ffff8803bd78ab30: 01 00 00 00 2a 07 00 00 9d 28 00 00 01 00 00 00  ....*....(......\n[11009.908133] Object ffff8803bd78ab40: 01 00 00 00 00 00 00 00 b0 1d c3 6a 00 88 ff ff  ...........j....\n[11009.908137] CPU: 3 PID: 28992 Comm: modprobe Tainted: G    B   W       4.5.0-rc1+ #43\n[11009.908140] Hardware name:                  \/NUC5i7RYB, BIOS RYBDWi35.86A.0350.2015.0812.1722 08\/12\/2015\n[11009.908142]  ffff8803bd78a000 ffff8802c273f1b8 ffffffff81932007 ffff8803c6407a80\n[11009.908148]  ffff8802c273f1e8 ffffffff81556759 ffff8803c6407a80 ffffea000ef5e280\n[11009.908153]  ffff8803bd78ab40 dffffc0000000000 ffff8802c273f210 ffffffff8155ccb4\n[11009.908158] Call Trace:\n[11009.908162]  [<ffffffff81932007>] dump_stack+0x4b\/0x64\n[11009.908165]  [<ffffffff81556759>] print_trailer+0xf9\/0x150\n[11009.908168]  [<ffffffff8155ccb4>] object_err+0x34\/0x40\n[11009.908171]  [<ffffffff8155f260>] kasan_report_error+0x230\/0x550\n[11009.908175]  [<ffffffff81237d71>] ? trace_hardirqs_off_caller+0x21\/0x290\n[11009.908179]  [<ffffffff8155e926>] ? kasan_unpoison_shadow+0x36\/0x50\n[11009.908182]  [<ffffffff8155f5c3>] __asan_report_load1_noabort+0x43\/0x50\n[11009.908185]  [<ffffffff8155ea00>] ? __asan_register_globals+0x50\/0xa0\n[11009.908189]  [<ffffffff8194cea6>] ? strcmp+0x96\/0xb0\n[11009.908192]  [<ffffffff8194cea6>] strcmp+0x96\/0xb0\n[11009.908196]  [<ffffffffa13ba4ac>] xc2028_set_config+0x15c\/0x630 [tuner_xc2028]\n[11009.908200]  [<ffffffffa13bac90>] xc2028_attach+0x310\/0x8a0 [tuner_xc2028]\n[11009.908203]  [<ffffffff8155ea78>] ? memset+0x28\/0x30\n[11009.908206]  [<ffffffffa13ba980>] ? xc2028_set_config+0x630\/0x630 [tuner_xc2028]\n[11009.908211]  [<ffffffffa157a59a>] em28xx_attach_xc3028.constprop.7+0x1f9\/0x30d [em28xx_dvb]\n[11009.908215]  [<ffffffffa157aa2a>] ? em28xx_dvb_init.part.3+0x37c\/0x5cf4 [em28xx_dvb]\n[11009.908219]  [<ffffffffa157a3a1>] ? hauppauge_hvr930c_init+0x487\/0x487 [em28xx_dvb]\n[11009.908222]  [<ffffffffa01795ac>] ? lgdt330x_attach+0x1cc\/0x370 [lgdt330x]\n[11009.908226]  [<ffffffffa01793e0>] ? i2c_read_demod_bytes.isra.2+0x210\/0x210 [lgdt330x]\n[11009.908230]  [<ffffffff812e87d0>] ? ref_module.part.15+0x10\/0x10\n[11009.908233]  [<ffffffff812e56e0>] ? module_assert_mutex_or_preempt+0x80\/0x80\n[11009.908238]  [<ffffffffa157af92>] em28xx_dvb_init.part.3+0x8e4\/0x5cf4 [em28xx_dvb]\n[11009.908242]  [<ffffffffa157a6ae>] ? em28xx_attach_xc3028.constprop.7+0x30d\/0x30d [em28xx_dvb]\n[11009.908245]  [<ffffffff8195222d>] ? string+0x14d\/0x1f0\n[11009.908249]  [<ffffffff8195381f>] ? symbol_string+0xff\/0x1a0\n[11009.908253]  [<ffffffff81953720>] ? uuid_string+0x6f0\/0x6f0\n[11009.908257]  [<ffffffff811a775e>] ? __kernel_text_address+0x7e\/0xa0\n[11009.908260]  [<ffffffff8104b02f>] ? print_context_stack+0x7f\/0xf0\n[11009.908264]  [<ffffffff812e9846>] ? __module_address+0xb6\/0x360\n[11009.908268]  [<ffffffff8137fdc9>] ? is_ftrace_trampoline+0x99\/0xe0\n[11009.908271]  [<ffffffff811a775e>] ? __kernel_text_address+0x7e\/0xa0\n[11009.908275]  [<ffffffff81240a70>] ? debug_check_no_locks_freed+0x290\/0x290\n[11009.908278]  [<ffffffff8104a24b>] ? dump_trace+0x11b\/0x300\n[11009.908282]  [<ffffffffa13e8143>] ? em28xx_register_extension+0x23\/0x190 [em28xx]\n[11009.908285]  [<ffffffff81237d71>] ? trace_hardirqs_off_caller+0x21\/0x290\n[11009.908289]  [<ffffffff8123ff56>] ? trace_hardirqs_on_caller+0x16\/0x590\n[11009.908292]  [<ffffffff812404dd>] ? trace_hardirqs_on+0xd\/0x10\n[11009.908296]  [<ffffffffa13e8143>] ? em28xx_register_extension+0x23\/0x190 [em28xx]\n[11009.908299]  [<ffffffff822dcbb0>] ? mutex_trylock+0x400\/0x400\n[11009.908302]  [<ffffffff810021a1>] ? do_one_initcall+0x131\/0x300\n[11009.908306]  [<ffffffff81296dc7>] ? call_rcu_sched+0x17\/0x20\n[11009.908309]  [<ffffffff8159e708>] ? put_object+0x48\/0x70\n[11009.908314]  [<ffffffffa1579f11>] em28xx_dvb_init+0x81\/0x8a [em28xx_dvb]\n[11009.908317]  [<ffffffffa13e81f9>] em28xx_register_extension+0xd9\/0x190 [em28xx]\n[11009.908320]  [<ffffffffa0150000>] ? 0xffffffffa0150000\n[11009.908324]  [<ffffffffa0150010>] em28xx_dvb_register+0x10\/0x1000 [em28xx_dvb]\n[11009.908327]  [<ffffffff810021b1>] do_one_initcall+0x141\/0x300\n[11009.908330]  [<ffffffff81002070>] ? try_to_run_init_process+0x40\/0x40\n[11009.908333]  [<ffffffff8123ff56>] ? trace_hardirqs_on_caller+0x16\/0x590\n[11009.908337]  [<ffffffff8155e926>] ? kasan_unpoison_shadow+0x36\/0x50\n[11009.908340]  [<ffffffff8155e926>] ? kasan_unpoison_shadow+0x36\/0x50\n[11009.908343]  [<ffffffff8155e926>] ? kasan_unpoison_shadow+0x36\/0x50\n[11009.908346]  [<ffffffff8155ea37>] ? __asan_register_globals+0x87\/0xa0\n[11009.908350]  [<ffffffff8144da7b>] do_init_module+0x1d0\/0x5ad\n[11009.908353]  [<ffffffff812f2626>] load_module+0x6666\/0x9ba0\n[11009.908356]  [<ffffffff812e9c90>] ? symbol_put_addr+0x50\/0x50\n[11009.908361]  [<ffffffffa1580037>] ? em28xx_dvb_init.part.3+0x5989\/0x5cf4 [em28xx_dvb]\n[11009.908366]  [<ffffffff812ebfc0>] ? module_frob_arch_sections+0x20\/0x20\n[11009.908369]  [<ffffffff815bc940>] ? open_exec+0x50\/0x50\n[11009.908374]  [<ffffffff811671bb>] ? ns_capable+0x5b\/0xd0\n[11009.908377]  [<ffffffff812f5e58>] SyS_finit_module+0x108\/0x130\n[11009.908379]  [<ffffffff812f5d50>] ? SyS_init_module+0x1f0\/0x1f0\n[11009.908383]  [<ffffffff81004044>] ? lockdep_sys_exit_thunk+0x12\/0x14\n[11009.908394]  [<ffffffff822e6936>] entry_SYSCALL_64_fastpath+0x16\/0x76\n[11009.908396] Memory state around the buggy address:\n[11009.908398]  ffff8803bd78aa00: 00 00 fc fc fc fc fc fc fc fc fc fc fc fc fc fc\n[11009.908401]  ffff8803bd78aa80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc\n[11009.908403] >ffff8803bd78ab00: fc fc fc fc fc fc fc fc 00 00 fc fc fc fc fc fc\n[11009.908405]                                            ^\n[11009.908407]  ffff8803bd78ab80: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc\n[11009.908409]  ffff8803bd78ac00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc\n[11009.908411] ==================================================================\n\nIn order to avoid it, let's set the cached value of the firmware\nname to NULL after freeing it. While here, return an error if\nthe memory allocation fails.\n\nSigned-off-by: Mauro Carvalho Chehab <mchehab@osg.samsung.com>\n---\n drivers\/media\/tuners\/tuner-xc2028.c | 3 ++-\n 1 file changed, 2 insertions(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/drivers\/media\/tuners\/tuner-xc2028.c b\/drivers\/media\/tuners\/tuner-xc2028.c\nindex 4e941f00b6008..082ff5608455c 100644\n--- a\/drivers\/media\/tuners\/tuner-xc2028.c\n+++ b\/drivers\/media\/tuners\/tuner-xc2028.c\n@@ -1403,11 +1403,12 @@ static int xc2028_set_config(struct dvb_frontend *fe, void *priv_cfg)\n \t * in order to avoid troubles during device release.\n \t *\/\n \tkfree(priv->ctrl.fname);\n+\tpriv->ctrl.fname = NULL;\n \tmemcpy(&priv->ctrl, p, sizeof(priv->ctrl));\n \tif (p->fname) {\n \t\tpriv->ctrl.fname = kstrdup(p->fname, GFP_KERNEL);\n \t\tif (priv->ctrl.fname == NULL)\n-\t\t\trc = -ENOMEM;\n+\t\t\treturn -ENOMEM;\n \t}\n \n \t\/*\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-15126","CWE_ID":"416","category":"security","commit_id":"384632e67e0829deb8015ee6ad916b180049d252","commit_message":"From 384632e67e0829deb8015ee6ad916b180049d252 Mon Sep 17 00:00:00 2001\nFrom: Andrea Arcangeli <aarcange@redhat.com>\nDate: Tue, 3 Oct 2017 16:15:38 -0700\nSubject: userfaultfd: non-cooperative: fix fork use after free\n\nWhen reading the event from the uffd, we put it on a temporary\nfork_event list to detect if we can still access it after releasing and\nretaking the event_wqh.lock.\n\nIf fork aborts and removes the event from the fork_event all is fine as\nlong as we're still in the userfault read context and fork_event head is\nstill alive.\n\nWe've to put the event allocated in the fork kernel stack, back from\nfork_event list-head to the event_wqh head, before returning from\nuserfaultfd_ctx_read, because the fork_event head lifetime is limited to\nthe userfaultfd_ctx_read stack lifetime.\n\nForgetting to move the event back to its event_wqh place then results in\n__remove_wait_queue(&ctx->event_wqh, &ewq->wq); in\nuserfaultfd_event_wait_completion to remove it from a head that has been\nalready freed from the reader stack.\n\nThis could only happen if resolve_userfault_fork failed (for example if\nthere are no file descriptors available to allocate the fork uffd).  If\nit succeeded it was put back correctly.\n\nFurthermore, after find_userfault_evt receives a fork event, the forked\nuserfault context in fork_nctx and uwq->msg.arg.reserved.reserved1 can\nbe released by the fork thread as soon as the event_wqh.lock is\nreleased.  Taking a reference on the fork_nctx before dropping the lock\nprevents an use after free in resolve_userfault_fork().\n\nIf the fork side aborted and it already released everything, we still\ntry to succeed resolve_userfault_fork(), if possible.\n\nFixes: 893e26e61d04eac9 (\"userfaultfd: non-cooperative: Add fork() event\")\nLink: http:\/\/lkml.kernel.org\/r\/20170920180413.26713-1-aarcange@redhat.com\nSigned-off-by: Andrea Arcangeli <aarcange@redhat.com>\nReported-by: Mark Rutland <mark.rutland@arm.com>\nTested-by: Mark Rutland <mark.rutland@arm.com>\nCc: Pavel Emelyanov <xemul@virtuozzo.com>\nCc: Mike Rapoport <rppt@linux.vnet.ibm.com>\nCc: \"Dr. David Alan Gilbert\" <dgilbert@redhat.com>\nCc: Mike Kravetz <mike.kravetz@oracle.com>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n fs\/userfaultfd.c | 66 +++++++++++++++++++++++++++++++++++++++++++++++---------\n 1 file changed, 56 insertions(+), 10 deletions(-)\n\n","diff_code":"diff --git a\/fs\/userfaultfd.c b\/fs\/userfaultfd.c\nindex ef4b48d1ea42..1c713fd5b3e6 100644\n--- a\/fs\/userfaultfd.c\n+++ b\/fs\/userfaultfd.c\n@@ -588,6 +588,12 @@ static void userfaultfd_event_wait_completion(struct userfaultfd_ctx *ctx,\n \t\t\tbreak;\n \t\tif (ACCESS_ONCE(ctx->released) ||\n \t\t    fatal_signal_pending(current)) {\n+\t\t\t\/*\n+\t\t\t * &ewq->wq may be queued in fork_event, but\n+\t\t\t * __remove_wait_queue ignores the head\n+\t\t\t * parameter. It would be a problem if it\n+\t\t\t * didn't.\n+\t\t\t *\/\n \t\t\t__remove_wait_queue(&ctx->event_wqh, &ewq->wq);\n \t\t\tif (ewq->msg.event == UFFD_EVENT_FORK) {\n \t\t\t\tstruct userfaultfd_ctx *new;\n@@ -1061,6 +1067,12 @@ static ssize_t userfaultfd_ctx_read(struct userfaultfd_ctx *ctx, int no_wait,\n \t\t\t\t\t(unsigned long)\n \t\t\t\t\tuwq->msg.arg.reserved.reserved1;\n \t\t\t\tlist_move(&uwq->wq.entry, &fork_event);\n+\t\t\t\t\/*\n+\t\t\t\t * fork_nctx can be freed as soon as\n+\t\t\t\t * we drop the lock, unless we take a\n+\t\t\t\t * reference on it.\n+\t\t\t\t *\/\n+\t\t\t\tuserfaultfd_ctx_get(fork_nctx);\n \t\t\t\tspin_unlock(&ctx->event_wqh.lock);\n \t\t\t\tret = 0;\n \t\t\t\tbreak;\n@@ -1091,19 +1103,53 @@ static ssize_t userfaultfd_ctx_read(struct userfaultfd_ctx *ctx, int no_wait,\n \n \tif (!ret && msg->event == UFFD_EVENT_FORK) {\n \t\tret = resolve_userfault_fork(ctx, fork_nctx, msg);\n+\t\tspin_lock(&ctx->event_wqh.lock);\n+\t\tif (!list_empty(&fork_event)) {\n+\t\t\t\/*\n+\t\t\t * The fork thread didn't abort, so we can\n+\t\t\t * drop the temporary refcount.\n+\t\t\t *\/\n+\t\t\tuserfaultfd_ctx_put(fork_nctx);\n+\n+\t\t\tuwq = list_first_entry(&fork_event,\n+\t\t\t\t\t       typeof(*uwq),\n+\t\t\t\t\t       wq.entry);\n+\t\t\t\/*\n+\t\t\t * If fork_event list wasn't empty and in turn\n+\t\t\t * the event wasn't already released by fork\n+\t\t\t * (the event is allocated on fork kernel\n+\t\t\t * stack), put the event back to its place in\n+\t\t\t * the event_wq. fork_event head will be freed\n+\t\t\t * as soon as we return so the event cannot\n+\t\t\t * stay queued there no matter the current\n+\t\t\t * \"ret\" value.\n+\t\t\t *\/\n+\t\t\tlist_del(&uwq->wq.entry);\n+\t\t\t__add_wait_queue(&ctx->event_wqh, &uwq->wq);\n \n-\t\tif (!ret) {\n-\t\t\tspin_lock(&ctx->event_wqh.lock);\n-\t\t\tif (!list_empty(&fork_event)) {\n-\t\t\t\tuwq = list_first_entry(&fork_event,\n-\t\t\t\t\t\t       typeof(*uwq),\n-\t\t\t\t\t\t       wq.entry);\n-\t\t\t\tlist_del(&uwq->wq.entry);\n-\t\t\t\t__add_wait_queue(&ctx->event_wqh, &uwq->wq);\n+\t\t\t\/*\n+\t\t\t * Leave the event in the waitqueue and report\n+\t\t\t * error to userland if we failed to resolve\n+\t\t\t * the userfault fork.\n+\t\t\t *\/\n+\t\t\tif (likely(!ret))\n \t\t\t\tuserfaultfd_event_complete(ctx, uwq);\n-\t\t\t}\n-\t\t\tspin_unlock(&ctx->event_wqh.lock);\n+\t\t} else {\n+\t\t\t\/*\n+\t\t\t * Here the fork thread aborted and the\n+\t\t\t * refcount from the fork thread on fork_nctx\n+\t\t\t * has already been released. We still hold\n+\t\t\t * the reference we took before releasing the\n+\t\t\t * lock above. If resolve_userfault_fork\n+\t\t\t * failed we've to drop it because the\n+\t\t\t * fork_nctx has to be freed in such case. If\n+\t\t\t * it succeeded we'll hold it because the new\n+\t\t\t * uffd references it.\n+\t\t\t *\/\n+\t\t\tif (ret)\n+\t\t\t\tuserfaultfd_ctx_put(fork_nctx);\n \t\t}\n+\t\tspin_unlock(&ctx->event_wqh.lock);\n \t}\n \n \treturn ret;\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2018-1000039","CWE_ID":"416","category":"security","commit_id":"71ceebcf56e682504da22c4035b39a2d451e8ffd","commit_message":"From 71ceebcf56e682504da22c4035b39a2d451e8ffd Mon Sep 17 00:00:00 2001\nFrom: Sebastian Rasmussen <sebras@gmail.com>\nDate: Tue, 23 Jan 2018 03:04:33 +0100\nSubject: [PATCH 1\/1] Bug 698888: Keep one-to-many state when splitting nodes\n in cmap splay trees.\n\nThanks to oss-fuzz for reporting this.\n---\n source\/pdf\/pdf-cmap.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/source\/pdf\/pdf-cmap.c b\/source\/pdf\/pdf-cmap.c\nindex ade72c4..bedc130 100644\n--- a\/source\/pdf\/pdf-cmap.c\n+++ b\/source\/pdf\/pdf-cmap.c\n@@ -520,7 +520,7 @@ add_range(fz_context *ctx, pdf_cmap *cmap, unsigned int low, unsigned int high,\n \t\t\t\t\t\/* case 3, reduces to case 5 *\/\n \t\t\t\t\tint new_high = tree[current].high;\n \t\t\t\t\ttree[current].high = low-1;\n-\t\t\t\t\tadd_range(ctx, cmap, high+1, new_high, tree[current].out + high + 1 - tree[current].low, 0, many);\n+\t\t\t\t\tadd_range(ctx, cmap, high+1, new_high, tree[current].out + high + 1 - tree[current].low, 0, tree[current].many);\n \t\t\t\t}\n \t\t\t\t\/* Now look for where to move to next (left for case 0, right for case 5) *\/\n \t\t\t\tif (tree[current].low > high) {\n-- \n2.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2018-17182","CWE_ID":"416","category":"security","commit_id":"7a9cdebdcc17e426fb5287e4a82db1dfe86339b2","commit_message":"From 7a9cdebdcc17e426fb5287e4a82db1dfe86339b2 Mon Sep 17 00:00:00 2001\nFrom: Linus Torvalds <torvalds@linux-foundation.org>\nDate: Wed, 12 Sep 2018 23:57:48 -1000\nSubject: mm: get rid of vmacache_flush_all() entirely\n\nJann Horn points out that the vmacache_flush_all() function is not only\npotentially expensive, it's buggy too.  It also happens to be entirely\nunnecessary, because the sequence number overflow case can be avoided by\nsimply making the sequence number be 64-bit.  That doesn't even grow the\ndata structures in question, because the other adjacent fields are\nalready 64-bit.\n\nSo simplify the whole thing by just making the sequence number overflow\ncase go away entirely, which gets rid of all the complications and makes\nthe code faster too.  Win-win.\n\n[ Oleg Nesterov points out that the VMACACHE_FULL_FLUSHES statistics\n  also just goes away entirely with this ]\n\nReported-by: Jann Horn <jannh@google.com>\nSuggested-by: Will Deacon <will.deacon@arm.com>\nAcked-by: Davidlohr Bueso <dave@stgolabs.net>\nCc: Oleg Nesterov <oleg@redhat.com>\nCc: stable@kernel.org\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n include\/linux\/mm_types.h      |  2 +-\n include\/linux\/mm_types_task.h |  2 +-\n include\/linux\/vm_event_item.h |  1 -\n include\/linux\/vmacache.h      |  5 -----\n mm\/debug.c                    |  4 ++--\n mm\/vmacache.c                 | 38 --------------------------------------\n 6 files changed, 4 insertions(+), 48 deletions(-)\n\n","diff_code":"diff --git a\/include\/linux\/mm_types.h b\/include\/linux\/mm_types.h\nindex cd2bc939efd0..5ed8f6292a53 100644\n--- a\/include\/linux\/mm_types.h\n+++ b\/include\/linux\/mm_types.h\n@@ -341,7 +341,7 @@ struct mm_struct {\n \tstruct {\n \t\tstruct vm_area_struct *mmap;\t\t\/* list of VMAs *\/\n \t\tstruct rb_root mm_rb;\n-\t\tu32 vmacache_seqnum;                   \/* per-thread vmacache *\/\n+\t\tu64 vmacache_seqnum;                   \/* per-thread vmacache *\/\n #ifdef CONFIG_MMU\n \t\tunsigned long (*get_unmapped_area) (struct file *filp,\n \t\t\t\tunsigned long addr, unsigned long len,\ndiff --git a\/include\/linux\/mm_types_task.h b\/include\/linux\/mm_types_task.h\nindex 5fe87687664c..d7016dcb245e 100644\n--- a\/include\/linux\/mm_types_task.h\n+++ b\/include\/linux\/mm_types_task.h\n@@ -32,7 +32,7 @@\n #define VMACACHE_MASK (VMACACHE_SIZE - 1)\n \n struct vmacache {\n-\tu32 seqnum;\n+\tu64 seqnum;\n \tstruct vm_area_struct *vmas[VMACACHE_SIZE];\n };\n \ndiff --git a\/include\/linux\/vm_event_item.h b\/include\/linux\/vm_event_item.h\nindex 5c7f010676a7..47a3441cf4c4 100644\n--- a\/include\/linux\/vm_event_item.h\n+++ b\/include\/linux\/vm_event_item.h\n@@ -105,7 +105,6 @@ enum vm_event_item { PGPGIN, PGPGOUT, PSWPIN, PSWPOUT,\n #ifdef CONFIG_DEBUG_VM_VMACACHE\n \t\tVMACACHE_FIND_CALLS,\n \t\tVMACACHE_FIND_HITS,\n-\t\tVMACACHE_FULL_FLUSHES,\n #endif\n #ifdef CONFIG_SWAP\n \t\tSWAP_RA,\ndiff --git a\/include\/linux\/vmacache.h b\/include\/linux\/vmacache.h\nindex 3e9a963edd6a..6fce268a4588 100644\n--- a\/include\/linux\/vmacache.h\n+++ b\/include\/linux\/vmacache.h\n@@ -10,7 +10,6 @@ static inline void vmacache_flush(struct task_struct *tsk)\n \tmemset(tsk->vmacache.vmas, 0, sizeof(tsk->vmacache.vmas));\n }\n \n-extern void vmacache_flush_all(struct mm_struct *mm);\n extern void vmacache_update(unsigned long addr, struct vm_area_struct *newvma);\n extern struct vm_area_struct *vmacache_find(struct mm_struct *mm,\n \t\t\t\t\t\t    unsigned long addr);\n@@ -24,10 +23,6 @@ extern struct vm_area_struct *vmacache_find_exact(struct mm_struct *mm,\n static inline void vmacache_invalidate(struct mm_struct *mm)\n {\n \tmm->vmacache_seqnum++;\n-\n-\t\/* deal with overflows *\/\n-\tif (unlikely(mm->vmacache_seqnum == 0))\n-\t\tvmacache_flush_all(mm);\n }\n \n #endif \/* __LINUX_VMACACHE_H *\/\ndiff --git a\/mm\/debug.c b\/mm\/debug.c\nindex 38c926520c97..bd10aad8539a 100644\n--- a\/mm\/debug.c\n+++ b\/mm\/debug.c\n@@ -114,7 +114,7 @@ EXPORT_SYMBOL(dump_vma);\n \n void dump_mm(const struct mm_struct *mm)\n {\n-\tpr_emerg(\"mm %px mmap %px seqnum %d task_size %lu\\n\"\n+\tpr_emerg(\"mm %px mmap %px seqnum %llu task_size %lu\\n\"\n #ifdef CONFIG_MMU\n \t\t\"get_unmapped_area %px\\n\"\n #endif\n@@ -142,7 +142,7 @@ void dump_mm(const struct mm_struct *mm)\n \t\t\"tlb_flush_pending %d\\n\"\n \t\t\"def_flags: %#lx(%pGv)\\n\",\n \n-\t\tmm, mm->mmap, mm->vmacache_seqnum, mm->task_size,\n+\t\tmm, mm->mmap, (long long) mm->vmacache_seqnum, mm->task_size,\n #ifdef CONFIG_MMU\n \t\tmm->get_unmapped_area,\n #endif\ndiff --git a\/mm\/vmacache.c b\/mm\/vmacache.c\nindex ea517bef7dc5..cdc32a3b02fa 100644\n--- a\/mm\/vmacache.c\n+++ b\/mm\/vmacache.c\n@@ -19,44 +19,6 @@\n #endif\n #define VMACACHE_HASH(addr) ((addr >> VMACACHE_SHIFT) & VMACACHE_MASK)\n \n-\/*\n- * Flush vma caches for threads that share a given mm.\n- *\n- * The operation is safe because the caller holds the mmap_sem\n- * exclusively and other threads accessing the vma cache will\n- * have mmap_sem held at least for read, so no extra locking\n- * is required to maintain the vma cache.\n- *\/\n-void vmacache_flush_all(struct mm_struct *mm)\n-{\n-\tstruct task_struct *g, *p;\n-\n-\tcount_vm_vmacache_event(VMACACHE_FULL_FLUSHES);\n-\n-\t\/*\n-\t * Single threaded tasks need not iterate the entire\n-\t * list of process. We can avoid the flushing as well\n-\t * since the mm's seqnum was increased and don't have\n-\t * to worry about other threads' seqnum. Current's\n-\t * flush will occur upon the next lookup.\n-\t *\/\n-\tif (atomic_read(&mm->mm_users) == 1)\n-\t\treturn;\n-\n-\trcu_read_lock();\n-\tfor_each_process_thread(g, p) {\n-\t\t\/*\n-\t\t * Only flush the vmacache pointers as the\n-\t\t * mm seqnum is already set and curr's will\n-\t\t * be set upon invalidation when the next\n-\t\t * lookup is done.\n-\t\t *\/\n-\t\tif (mm == p->mm)\n-\t\t\tvmacache_flush(p);\n-\t}\n-\trcu_read_unlock();\n-}\n-\n \/*\n  * This task may be accessing a foreign mm via (for example)\n  * get_user_pages()->find_vma().  The vmacache is task-local and this\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2016-5771","CWE_ID":"416","category":"security","commit_id":"3f627e580acfdaf0595ae3b115b8bec677f203ee","commit_message":"From 3f627e580acfdaf0595ae3b115b8bec677f203ee Mon Sep 17 00:00:00 2001\nFrom: Stanislav Malyshev <stas@php.net>\nDate: Mon, 20 Jun 2016 21:26:33 -0700\nSubject: [PATCH] Fixed ##72433: Use After Free Vulnerability in PHP's GC\n algorithm and unserialize\n\n---\n Zend\/tests\/gc_024.phpt                   |  2 +-\n ext\/spl\/spl_array.c                      | 11 ++++++++\n ext\/standard\/tests\/strings\/bug72433.phpt | 32 ++++++++++++++++++++++++\n 3 files changed, 44 insertions(+), 1 deletion(-)\n create mode 100644 ext\/standard\/tests\/strings\/bug72433.phpt\n\n","diff_code":"diff --git a\/Zend\/tests\/gc_024.phpt b\/Zend\/tests\/gc_024.phpt\nindex 9a2ceb88f504..ca78da63d3b7 100644\n--- a\/Zend\/tests\/gc_024.phpt\n+++ b\/Zend\/tests\/gc_024.phpt\n@@ -13,5 +13,5 @@ var_dump(gc_collect_cycles());\n echo \"ok\\n\";\n ?>\n --EXPECT--\n-int(1)\n+int(2)\n ok\ndiff --git a\/ext\/spl\/spl_array.c b\/ext\/spl\/spl_array.c\nindex c89cf4994b1c..4e03c408c663 100644\n--- a\/ext\/spl\/spl_array.c\n+++ b\/ext\/spl\/spl_array.c\n@@ -831,6 +831,16 @@ static HashTable* spl_array_get_debug_info(zval *obj, int *is_temp TSRMLS_DC) \/*\n }\n \/* }}} *\/\n \n+static HashTable *spl_array_get_gc(zval *object, zval ***gc_data, int *gc_data_count TSRMLS_DC) \/* {{{ *\/\n+{\n+\tspl_array_object *intern = (spl_array_object*)zend_object_store_get_object(object TSRMLS_CC);\n+\n+\t*gc_data = &intern->array;\n+\t*gc_data_count = 1;\n+\treturn zend_std_get_properties(object);\n+}\n+\/* }}} *\/\n+\n static zval *spl_array_read_property(zval *object, zval *member, int type, const zend_literal *key TSRMLS_DC) \/* {{{ *\/\n {\n \tspl_array_object *intern = (spl_array_object*)zend_object_store_get_object(object TSRMLS_CC);\n@@ -1961,6 +1971,7 @@ PHP_MINIT_FUNCTION(spl_array)\n \n \tspl_handler_ArrayObject.get_properties = spl_array_get_properties;\n \tspl_handler_ArrayObject.get_debug_info = spl_array_get_debug_info;\n+\tspl_handler_ArrayObject.get_gc = spl_array_get_gc;\n \tspl_handler_ArrayObject.read_property = spl_array_read_property;\n \tspl_handler_ArrayObject.write_property = spl_array_write_property;\n \tspl_handler_ArrayObject.get_property_ptr_ptr = spl_array_get_property_ptr_ptr;\ndiff --git a\/ext\/standard\/tests\/strings\/bug72433.phpt b\/ext\/standard\/tests\/strings\/bug72433.phpt\nnew file mode 100644\nindex 000000000000..3a2c89701b12\n--- \/dev\/null\n+++ b\/ext\/standard\/tests\/strings\/bug72433.phpt\n@@ -0,0 +1,32 @@\n+--TEST--\n+Bug #72433: Use After Free Vulnerability in PHP's GC algorithm and unserialize\n+--FILE--\n+<?php\n+\/\/ Fill any potential freed spaces until now.\n+$filler = array();\n+for($i = 0; $i < 100; $i++)\n+\t$filler[] = \"\";\n+\/\/ Create our payload and unserialize it.\n+$serialized_payload = 'a:3:{i:0;r:1;i:1;r:1;i:2;C:11:\"ArrayObject\":19:{x:i:0;r:1;;m:a:0:{}}}';\n+$free_me = unserialize($serialized_payload);\n+\/\/ We need to increment the reference counter of our ArrayObject s.t. all reference counters of our unserialized array become 0.\n+$inc_ref_by_one = $free_me[2];\n+\/\/ The call to gc_collect_cycles will free '$free_me'.\n+gc_collect_cycles();\n+\/\/ We now have multiple freed spaces. Fill all of them.\n+$fill_freed_space_1 = \"filler_zval_1\";\n+$fill_freed_space_2 = \"filler_zval_2\";\n+var_dump($free_me);\n+?>\n+--EXPECTF--\n+array(3) {\n+  [0]=>\n+  *RECURSION*\n+  [1]=>\n+  *RECURSION*\n+  [2]=>\n+  object(ArrayObject)#%d (1) {\n+    [\"storage\":\"ArrayObject\":private]=>\n+    *RECURSION*\n+  }\n+}\n","owner":"php","repo":"php-src","source":"cve"},{"CVE_ID":"CVE-2019-11487","CWE_ID":"416","category":"security","commit_id":"f958d7b528b1b40c44cfda5eabe2d82760d868c3","commit_message":"From f958d7b528b1b40c44cfda5eabe2d82760d868c3 Mon Sep 17 00:00:00 2001\nFrom: Linus Torvalds <torvalds@linux-foundation.org>\nDate: Thu, 11 Apr 2019 10:06:20 -0700\nSubject: mm: make page ref count overflow check tighter and more explicit\n\nWe have a VM_BUG_ON() to check that the page reference count doesn't\nunderflow (or get close to overflow) by checking the sign of the count.\n\nThat's all fine, but we actually want to allow people to use a \"get page\nref unless it's already very high\" helper function, and we want that one\nto use the sign of the page ref (without triggering this VM_BUG_ON).\n\nChange the VM_BUG_ON to only check for small underflows (or _very_ close\nto overflowing), and ignore overflows which have strayed into negative\nterritory.\n\nAcked-by: Matthew Wilcox <willy@infradead.org>\nCc: Jann Horn <jannh@google.com>\nCc: stable@kernel.org\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n include\/linux\/mm.h | 6 +++++-\n 1 file changed, 5 insertions(+), 1 deletion(-)\n\nFrom 88b1a17dfc3ed7728316478fae0f5ad508f50397 Mon Sep 17 00:00:00 2001\nFrom: Linus Torvalds <torvalds@linux-foundation.org>\nDate: Thu, 11 Apr 2019 10:14:59 -0700\nSubject: mm: add 'try_get_page()' helper function\n\nThis is the same as the traditional 'get_page()' function, but instead\nof unconditionally incrementing the reference count of the page, it only\ndoes so if the count was \"safe\".  It returns whether the reference count\nwas incremented (and is marked __must_check, since the caller obviously\nhas to be aware of it).\n\nAlso like 'get_page()', you can't use this function unless you already\nhad a reference to the page.  The intent is that you can use this\nexactly like get_page(), but in situations where you want to limit the\nmaximum reference count.\n\nThe code currently does an unconditional WARN_ON_ONCE() if we ever hit\nthe reference count issues (either zero or negative), as a notification\nthat the conditional non-increment actually happened.\n\nNOTE! The count access for the \"safety\" check is inherently racy, but\nthat doesn't matter since the buffer we use is basically half the range\nof the reference count (ie we look at the sign of the count).\n\nAcked-by: Matthew Wilcox <willy@infradead.org>\nCc: Jann Horn <jannh@google.com>\nCc: stable@kernel.org\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n include\/linux\/mm.h | 9 +++++++++\n 1 file changed, 9 insertions(+)\n\nFrom 8fde12ca79aff9b5ba951fce1a2641901b8d8e64 Mon Sep 17 00:00:00 2001\nFrom: Linus Torvalds <torvalds@linux-foundation.org>\nDate: Thu, 11 Apr 2019 10:49:19 -0700\nSubject: mm: prevent get_user_pages() from overflowing page refcount\n\nIf the page refcount wraps around past zero, it will be freed while\nthere are still four billion references to it.  One of the possible\navenues for an attacker to try to make this happen is by doing direct IO\non a page multiple times.  This patch makes get_user_pages() refuse to\ntake a new page reference if there are already more than two billion\nreferences to the page.\n\nReported-by: Jann Horn <jannh@google.com>\nAcked-by: Matthew Wilcox <willy@infradead.org>\nCc: stable@kernel.org\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n mm\/gup.c     | 48 ++++++++++++++++++++++++++++++++++++------------\n mm\/hugetlb.c | 13 +++++++++++++\n 2 files changed, 49 insertions(+), 12 deletions(-)\n\nFrom 15fab63e1e57be9fdb5eec1bbc5916e9825e9acb Mon Sep 17 00:00:00 2001\nFrom: Matthew Wilcox <willy@infradead.org>\nDate: Fri, 5 Apr 2019 14:02:10 -0700\nSubject: fs: prevent page refcount overflow in pipe_buf_get\n\nChange pipe_buf_get() to return a bool indicating whether it succeeded\nin raising the refcount of the page (if the thing in the pipe is a page).\nThis removes another mechanism for overflowing the page refcount.  All\ncallers converted to handle a failure.\n\nReported-by: Jann Horn <jannh@google.com>\nSigned-off-by: Matthew Wilcox <willy@infradead.org>\nCc: stable@kernel.org\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n fs\/fuse\/dev.c             | 12 ++++++------\n fs\/pipe.c                 |  4 ++--\n fs\/splice.c               | 12 ++++++++++--\n include\/linux\/pipe_fs_i.h | 10 ++++++----\n kernel\/trace\/trace.c      |  6 +++++-\n 5 files changed, 29 insertions(+), 15 deletions(-)\n\n","diff_code":"diff --git a\/include\/linux\/mm.h b\/include\/linux\/mm.h\nindex 80bb6408fe73..541d99b86aea 100644\n--- a\/include\/linux\/mm.h\n+++ b\/include\/linux\/mm.h\n@@ -965,6 +965,10 @@ static inline bool is_pci_p2pdma_page(const struct page *page)\n }\n #endif \/* CONFIG_DEV_PAGEMAP_OPS *\/\n \n+\/* 127: arbitrary random number, small enough to assemble well *\/\n+#define page_ref_zero_or_close_to_overflow(page) \\\n+\t((unsigned int) page_ref_count(page) + 127u <= 127u)\n+\n static inline void get_page(struct page *page)\n {\n \tpage = compound_head(page);\n@@ -972,7 +976,7 @@ static inline void get_page(struct page *page)\n \t * Getting a normal page or the head of a compound page\n \t * requires to already have an elevated page->_refcount.\n \t *\/\n-\tVM_BUG_ON_PAGE(page_ref_count(page) <= 0, page);\n+\tVM_BUG_ON_PAGE(page_ref_zero_or_close_to_overflow(page), page);\n \tpage_ref_inc(page);\n }\n \n-- \ncgit 1.2-0.3.lf.el7\n\n\ndiff --git a\/include\/linux\/mm.h b\/include\/linux\/mm.h\nindex 541d99b86aea..7000ddd807e0 100644\n--- a\/include\/linux\/mm.h\n+++ b\/include\/linux\/mm.h\n@@ -980,6 +980,15 @@ static inline void get_page(struct page *page)\n \tpage_ref_inc(page);\n }\n \n+static inline __must_check bool try_get_page(struct page *page)\n+{\n+\tpage = compound_head(page);\n+\tif (WARN_ON_ONCE(page_ref_count(page) <= 0))\n+\t\treturn false;\n+\tpage_ref_inc(page);\n+\treturn true;\n+}\n+\n static inline void put_page(struct page *page)\n {\n \tpage = compound_head(page);\n-- \ncgit 1.2-0.3.lf.el7\n\n\ndiff --git a\/mm\/gup.c b\/mm\/gup.c\nindex 75029649baca..81e0bdefa2cc 100644\n--- a\/mm\/gup.c\n+++ b\/mm\/gup.c\n@@ -157,8 +157,12 @@ retry:\n \t\tgoto retry;\n \t}\n \n-\tif (flags & FOLL_GET)\n-\t\tget_page(page);\n+\tif (flags & FOLL_GET) {\n+\t\tif (unlikely(!try_get_page(page))) {\n+\t\t\tpage = ERR_PTR(-ENOMEM);\n+\t\t\tgoto out;\n+\t\t}\n+\t}\n \tif (flags & FOLL_TOUCH) {\n \t\tif ((flags & FOLL_WRITE) &&\n \t\t    !pte_dirty(pte) && !PageDirty(page))\n@@ -295,7 +299,10 @@ retry_locked:\n \t\t\tif (pmd_trans_unstable(pmd))\n \t\t\t\tret = -EBUSY;\n \t\t} else {\n-\t\t\tget_page(page);\n+\t\t\tif (unlikely(!try_get_page(page))) {\n+\t\t\t\tspin_unlock(ptl);\n+\t\t\t\treturn ERR_PTR(-ENOMEM);\n+\t\t\t}\n \t\t\tspin_unlock(ptl);\n \t\t\tlock_page(page);\n \t\t\tret = split_huge_page(page);\n@@ -497,7 +504,10 @@ static int get_gate_page(struct mm_struct *mm, unsigned long address,\n \t\tif (is_device_public_page(*page))\n \t\t\tgoto unmap;\n \t}\n-\tget_page(*page);\n+\tif (unlikely(!try_get_page(*page))) {\n+\t\tret = -ENOMEM;\n+\t\tgoto unmap;\n+\t}\n out:\n \tret = 0;\n unmap:\n@@ -1393,6 +1403,20 @@ static void undo_dev_pagemap(int *nr, int nr_start, struct page **pages)\n \t}\n }\n \n+\/*\n+ * Return the compund head page with ref appropriately incremented,\n+ * or NULL if that failed.\n+ *\/\n+static inline struct page *try_get_compound_head(struct page *page, int refs)\n+{\n+\tstruct page *head = compound_head(page);\n+\tif (WARN_ON_ONCE(page_ref_count(head) < 0))\n+\t\treturn NULL;\n+\tif (unlikely(!page_cache_add_speculative(head, refs)))\n+\t\treturn NULL;\n+\treturn head;\n+}\n+\n #ifdef CONFIG_ARCH_HAS_PTE_SPECIAL\n static int gup_pte_range(pmd_t pmd, unsigned long addr, unsigned long end,\n \t\t\t int write, struct page **pages, int *nr)\n@@ -1427,9 +1451,9 @@ static int gup_pte_range(pmd_t pmd, unsigned long addr, unsigned long end,\n \n \t\tVM_BUG_ON(!pfn_valid(pte_pfn(pte)));\n \t\tpage = pte_page(pte);\n-\t\thead = compound_head(page);\n \n-\t\tif (!page_cache_get_speculative(head))\n+\t\thead = try_get_compound_head(page, 1);\n+\t\tif (!head)\n \t\t\tgoto pte_unmap;\n \n \t\tif (unlikely(pte_val(pte) != pte_val(*ptep))) {\n@@ -1568,8 +1592,8 @@ static int gup_huge_pmd(pmd_t orig, pmd_t *pmdp, unsigned long addr,\n \t\trefs++;\n \t} while (addr += PAGE_SIZE, addr != end);\n \n-\thead = compound_head(pmd_page(orig));\n-\tif (!page_cache_add_speculative(head, refs)) {\n+\thead = try_get_compound_head(pmd_page(orig), refs);\n+\tif (!head) {\n \t\t*nr -= refs;\n \t\treturn 0;\n \t}\n@@ -1606,8 +1630,8 @@ static int gup_huge_pud(pud_t orig, pud_t *pudp, unsigned long addr,\n \t\trefs++;\n \t} while (addr += PAGE_SIZE, addr != end);\n \n-\thead = compound_head(pud_page(orig));\n-\tif (!page_cache_add_speculative(head, refs)) {\n+\thead = try_get_compound_head(pud_page(orig), refs);\n+\tif (!head) {\n \t\t*nr -= refs;\n \t\treturn 0;\n \t}\n@@ -1643,8 +1667,8 @@ static int gup_huge_pgd(pgd_t orig, pgd_t *pgdp, unsigned long addr,\n \t\trefs++;\n \t} while (addr += PAGE_SIZE, addr != end);\n \n-\thead = compound_head(pgd_page(orig));\n-\tif (!page_cache_add_speculative(head, refs)) {\n+\thead = try_get_compound_head(pgd_page(orig), refs);\n+\tif (!head) {\n \t\t*nr -= refs;\n \t\treturn 0;\n \t}\ndiff --git a\/mm\/hugetlb.c b\/mm\/hugetlb.c\nindex 8dfdffc34a99..c220315dc533 100644\n--- a\/mm\/hugetlb.c\n+++ b\/mm\/hugetlb.c\n@@ -4298,6 +4298,19 @@ long follow_hugetlb_page(struct mm_struct *mm, struct vm_area_struct *vma,\n \n \t\tpfn_offset = (vaddr & ~huge_page_mask(h)) >> PAGE_SHIFT;\n \t\tpage = pte_page(huge_ptep_get(pte));\n+\n+\t\t\/*\n+\t\t * Instead of doing 'try_get_page()' below in the same_page\n+\t\t * loop, just check the count once here.\n+\t\t *\/\n+\t\tif (unlikely(page_count(page) <= 0)) {\n+\t\t\tif (pages) {\n+\t\t\t\tspin_unlock(ptl);\n+\t\t\t\tremainder = 0;\n+\t\t\t\terr = -ENOMEM;\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n same_page:\n \t\tif (pages) {\n \t\t\tpages[i] = mem_map_offset(page, pfn_offset);\n-- \ncgit 1.2-0.3.lf.el7\n\n\ndiff --git a\/fs\/fuse\/dev.c b\/fs\/fuse\/dev.c\nindex 809c0f2f9942..64f4de983468 100644\n--- a\/fs\/fuse\/dev.c\n+++ b\/fs\/fuse\/dev.c\n@@ -2034,10 +2034,8 @@ static ssize_t fuse_dev_splice_write(struct pipe_inode_info *pipe,\n \t\trem += pipe->bufs[(pipe->curbuf + idx) & (pipe->buffers - 1)].len;\n \n \tret = -EINVAL;\n-\tif (rem < len) {\n-\t\tpipe_unlock(pipe);\n-\t\tgoto out;\n-\t}\n+\tif (rem < len)\n+\t\tgoto out_free;\n \n \trem = len;\n \twhile (rem) {\n@@ -2055,7 +2053,9 @@ static ssize_t fuse_dev_splice_write(struct pipe_inode_info *pipe,\n \t\t\tpipe->curbuf = (pipe->curbuf + 1) & (pipe->buffers - 1);\n \t\t\tpipe->nrbufs--;\n \t\t} else {\n-\t\t\tpipe_buf_get(pipe, ibuf);\n+\t\t\tif (!pipe_buf_get(pipe, ibuf))\n+\t\t\t\tgoto out_free;\n+\n \t\t\t*obuf = *ibuf;\n \t\t\tobuf->flags &= ~PIPE_BUF_FLAG_GIFT;\n \t\t\tobuf->len = rem;\n@@ -2078,11 +2078,11 @@ static ssize_t fuse_dev_splice_write(struct pipe_inode_info *pipe,\n \tret = fuse_dev_do_write(fud, &cs, len);\n \n \tpipe_lock(pipe);\n+out_free:\n \tfor (idx = 0; idx < nbuf; idx++)\n \t\tpipe_buf_release(pipe, &bufs[idx]);\n \tpipe_unlock(pipe);\n \n-out:\n \tkvfree(bufs);\n \treturn ret;\n }\ndiff --git a\/fs\/pipe.c b\/fs\/pipe.c\nindex bdc5d3c0977d..b1543b85c14a 100644\n--- a\/fs\/pipe.c\n+++ b\/fs\/pipe.c\n@@ -189,9 +189,9 @@ EXPORT_SYMBOL(generic_pipe_buf_steal);\n  *\tin the tee() system call, when we duplicate the buffers in one\n  *\tpipe into another.\n  *\/\n-void generic_pipe_buf_get(struct pipe_inode_info *pipe, struct pipe_buffer *buf)\n+bool generic_pipe_buf_get(struct pipe_inode_info *pipe, struct pipe_buffer *buf)\n {\n-\tget_page(buf->page);\n+\treturn try_get_page(buf->page);\n }\n EXPORT_SYMBOL(generic_pipe_buf_get);\n \ndiff --git a\/fs\/splice.c b\/fs\/splice.c\nindex de2ede048473..f30af82b850d 100644\n--- a\/fs\/splice.c\n+++ b\/fs\/splice.c\n@@ -1588,7 +1588,11 @@ retry:\n \t\t\t * Get a reference to this pipe buffer,\n \t\t\t * so we can copy the contents over.\n \t\t\t *\/\n-\t\t\tpipe_buf_get(ipipe, ibuf);\n+\t\t\tif (!pipe_buf_get(ipipe, ibuf)) {\n+\t\t\t\tif (ret == 0)\n+\t\t\t\t\tret = -EFAULT;\n+\t\t\t\tbreak;\n+\t\t\t}\n \t\t\t*obuf = *ibuf;\n \n \t\t\t\/*\n@@ -1660,7 +1664,11 @@ static int link_pipe(struct pipe_inode_info *ipipe,\n \t\t * Get a reference to this pipe buffer,\n \t\t * so we can copy the contents over.\n \t\t *\/\n-\t\tpipe_buf_get(ipipe, ibuf);\n+\t\tif (!pipe_buf_get(ipipe, ibuf)) {\n+\t\t\tif (ret == 0)\n+\t\t\t\tret = -EFAULT;\n+\t\t\tbreak;\n+\t\t}\n \n \t\tobuf = opipe->bufs + nbuf;\n \t\t*obuf = *ibuf;\ndiff --git a\/include\/linux\/pipe_fs_i.h b\/include\/linux\/pipe_fs_i.h\nindex 5a3bb3b7c9ad..3f2a42c11e20 100644\n--- a\/include\/linux\/pipe_fs_i.h\n+++ b\/include\/linux\/pipe_fs_i.h\n@@ -108,18 +108,20 @@ struct pipe_buf_operations {\n \t\/*\n \t * Get a reference to the pipe buffer.\n \t *\/\n-\tvoid (*get)(struct pipe_inode_info *, struct pipe_buffer *);\n+\tbool (*get)(struct pipe_inode_info *, struct pipe_buffer *);\n };\n \n \/**\n  * pipe_buf_get - get a reference to a pipe_buffer\n  * @pipe:\tthe pipe that the buffer belongs to\n  * @buf:\tthe buffer to get a reference to\n+ *\n+ * Return: %true if the reference was successfully obtained.\n  *\/\n-static inline void pipe_buf_get(struct pipe_inode_info *pipe,\n+static inline __must_check bool pipe_buf_get(struct pipe_inode_info *pipe,\n \t\t\t\tstruct pipe_buffer *buf)\n {\n-\tbuf->ops->get(pipe, buf);\n+\treturn buf->ops->get(pipe, buf);\n }\n \n \/**\n@@ -178,7 +180,7 @@ struct pipe_inode_info *alloc_pipe_info(void);\n void free_pipe_info(struct pipe_inode_info *);\n \n \/* Generic pipe buffer ops functions *\/\n-void generic_pipe_buf_get(struct pipe_inode_info *, struct pipe_buffer *);\n+bool generic_pipe_buf_get(struct pipe_inode_info *, struct pipe_buffer *);\n int generic_pipe_buf_confirm(struct pipe_inode_info *, struct pipe_buffer *);\n int generic_pipe_buf_steal(struct pipe_inode_info *, struct pipe_buffer *);\n void generic_pipe_buf_release(struct pipe_inode_info *, struct pipe_buffer *);\ndiff --git a\/kernel\/trace\/trace.c b\/kernel\/trace\/trace.c\nindex c4238b441624..0f300d488c9f 100644\n--- a\/kernel\/trace\/trace.c\n+++ b\/kernel\/trace\/trace.c\n@@ -6835,12 +6835,16 @@ static void buffer_pipe_buf_release(struct pipe_inode_info *pipe,\n \tbuf->private = 0;\n }\n \n-static void buffer_pipe_buf_get(struct pipe_inode_info *pipe,\n+static bool buffer_pipe_buf_get(struct pipe_inode_info *pipe,\n \t\t\t\tstruct pipe_buffer *buf)\n {\n \tstruct buffer_ref *ref = (struct buffer_ref *)buf->private;\n \n+\tif (ref->ref > INT_MAX\/2)\n+\t\treturn false;\n+\n \tref->ref++;\n+\treturn true;\n }\n \n \/* Pipe buffer operations for a buffer. *\/\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-7185","CWE_ID":"416","category":"security","commit_id":"042eb437973a202d00589b13d628181c6de5cf5b","commit_message":"From 042eb437973a202d00589b13d628181c6de5cf5b Mon Sep 17 00:00:00 2001\nFrom: Alexander Alashkin <alexander.alashkin@cesanta.com>\nDate: Mon, 3 Apr 2017 10:14:16 +0100\nSubject: [PATCH] Fix crash in multipart handling\n\nClose cesanta\/dev#6974\n\nPUBLISHED_FROM=4d4e4a46eceba10aec8dacb7f8f58bd078c92307\n---\n mongoose\/mongoose.c | 6 ++++++\n 1 file changed, 6 insertions(+)\n\n","diff_code":"diff --git a\/mongoose\/mongoose.c b\/mongoose\/mongoose.c\nindex 8bc2546ba..bd9535719 100644\n--- a\/mongoose\/mongoose.c\n+++ b\/mongoose\/mongoose.c\n@@ -5961,6 +5961,12 @@ static int mg_http_multipart_wait_for_boundary(struct mg_connection *c) {\n   struct mbuf *io = &c->recv_mbuf;\n   struct mg_http_proto_data *pd = mg_http_get_proto_data(c);\n \n+  if (pd->mp_stream.boundary == NULL) {\n+    pd->mp_stream.state = MPS_FINALIZE;\n+    DBG((\"Invalid request: boundary not initilaized\"));\n+    return 0;\n+  }\n+\n   if ((int) io->len < pd->mp_stream.boundary_len + 2) {\n     return 0;\n   }\n","owner":"cesanta","repo":"mongoose-os","source":"cve"},{"CVE_ID":"CVE-2015-8871","CWE_ID":"416","category":"security","commit_id":"940100c28ae28931722290794889cf84a92c5f6f","commit_message":"From 940100c28ae28931722290794889cf84a92c5f6f Mon Sep 17 00:00:00 2001\nFrom: mayeut <mayeut@users.noreply.github.com>\nDate: Sun, 6 Sep 2015 17:24:03 +0200\nSubject: [PATCH] Fix potential use-after-free in opj_j2k_write_mco function\n\nFixes #563\n---\n src\/lib\/openjp2\/j2k.c | 8 ++++----\n 1 file changed, 4 insertions(+), 4 deletions(-)\n\n","diff_code":"diff --git a\/src\/lib\/openjp2\/j2k.c b\/src\/lib\/openjp2\/j2k.c\nindex 19a48f564..d487d89d7 100644\n--- a\/src\/lib\/openjp2\/j2k.c\n+++ b\/src\/lib\/openjp2\/j2k.c\n@@ -5559,8 +5559,7 @@ static OPJ_BOOL opj_j2k_write_mco(     opj_j2k_t *p_j2k,\n         assert(p_stream != 00);\n \n         l_tcp =&(p_j2k->m_cp.tcps[p_j2k->m_current_tile_number]);\n-        l_current_data = p_j2k->m_specific_param.m_encoder.m_header_tile_data;\n-\n+\t\n         l_mco_size = 5 + l_tcp->m_nb_mcc_records;\n         if (l_mco_size > p_j2k->m_specific_param.m_encoder.m_header_tile_data_size) {\n \n@@ -5575,6 +5574,8 @@ static OPJ_BOOL opj_j2k_write_mco(     opj_j2k_t *p_j2k,\n                 p_j2k->m_specific_param.m_encoder.m_header_tile_data = new_header_tile_data;\n                 p_j2k->m_specific_param.m_encoder.m_header_tile_data_size = l_mco_size;\n         }\n+        l_current_data = p_j2k->m_specific_param.m_encoder.m_header_tile_data;\n+\n \n         opj_write_bytes(l_current_data,J2K_MS_MCO,2);                   \/* MCO *\/\n         l_current_data += 2;\n@@ -5586,10 +5587,9 @@ static OPJ_BOOL opj_j2k_write_mco(     opj_j2k_t *p_j2k,\n         ++l_current_data;\n \n         l_mcc_record = l_tcp->m_mcc_records;\n-        for     (i=0;i<l_tcp->m_nb_mcc_records;++i) {\n+        for (i=0;i<l_tcp->m_nb_mcc_records;++i) {\n                 opj_write_bytes(l_current_data,l_mcc_record->m_index,1);\/* Imco -> use the mcc indicated by 1*\/\n                 ++l_current_data;\n-\n                 ++l_mcc_record;\n         }\n \n","owner":"uclouvain","repo":"openjpeg","source":"cve"},{"CVE_ID":"CVE-2017-16525","CWE_ID":"416","category":"security","commit_id":"bd998c2e0df0469707503023d50d46cf0b10c787","commit_message":"From bd998c2e0df0469707503023d50d46cf0b10c787 Mon Sep 17 00:00:00 2001\nFrom: Johan Hovold <johan@kernel.org>\nDate: Wed, 4 Oct 2017 11:01:12 +0200\nSubject: [PATCH] USB: serial: console: fix use-after-free on disconnect\n\nA clean-up patch removing two redundant NULL-checks from the console\ndisconnect handler inadvertently also removed a third check. This could\nlead to the struct usb_serial being prematurely freed by the console\ncode when a driver accepts but does not register any ports for an\ninterface which also lacks endpoint descriptors.\n\nFixes: 0e517c93dc02 (\"USB: serial: console: clean up sanity checks\")\nCc: stable <stable@vger.kernel.org>     # 4.11\nReported-by: Andrey Konovalov <andreyknvl@google.com>\nAcked-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\nSigned-off-by: Johan Hovold <johan@kernel.org>\n---\n drivers\/usb\/serial\/console.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/drivers\/usb\/serial\/console.c b\/drivers\/usb\/serial\/console.c\nindex fdf89800ebc3f..ed8ba3ef5c794 100644\n--- a\/drivers\/usb\/serial\/console.c\n+++ b\/drivers\/usb\/serial\/console.c\n@@ -265,7 +265,7 @@ static struct console usbcons = {\n \n void usb_serial_console_disconnect(struct usb_serial *serial)\n {\n-\tif (serial->port[0] == usbcons_info.port) {\n+\tif (serial->port[0] && serial->port[0] == usbcons_info.port) {\n \t\tusb_serial_console_exit();\n \t\tusb_serial_put(serial);\n \t}\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2018-1999013","CWE_ID":"416","category":"security","commit_id":"a7e032a277452366771951e29fd0bf2bd5c029f0","commit_message":"From a7e032a277452366771951e29fd0bf2bd5c029f0 Mon Sep 17 00:00:00 2001\nFrom: Michael Niedermayer <michael@niedermayer.cc>\nDate: Tue, 3 Jul 2018 21:37:46 +0200\nSubject: [PATCH] avformat\/rmdec: Do not pass mime type in rm_read_multi() to\n ff_rm_read_mdpr_codecdata()\n\nFixes: use after free()\nFixes: rmdec-crash-ffe85b4cab1597d1cfea6955705e53f1f5c8a362\n\nFound-by: Paul Ch <paulcher@icloud.com>\nSigned-off-by: Michael Niedermayer <michael@niedermayer.cc>\n---\n libavformat\/rmdec.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/libavformat\/rmdec.c b\/libavformat\/rmdec.c\nindex ac61723c66a..0216003e88e 100644\n--- a\/libavformat\/rmdec.c\n+++ b\/libavformat\/rmdec.c\n@@ -522,7 +522,7 @@ static int rm_read_multi(AVFormatContext *s, AVIOContext *pb,\n \n         size2 = avio_rb32(pb);\n         ret = ff_rm_read_mdpr_codecdata(s, s->pb, st2, st2->priv_data,\n-                                        size2, mime);\n+                                        size2, NULL);\n         if (ret < 0)\n             return ret;\n     }\n","owner":"FFmpeg","repo":"FFmpeg","source":"cve"},{"CVE_ID":"CVE-2014-0131","CWE_ID":"416","category":"security","commit_id":"1fd819ecb90cc9b822cd84d3056ddba315d3340f","commit_message":"From 1fd819ecb90cc9b822cd84d3056ddba315d3340f Mon Sep 17 00:00:00 2001\nFrom: \"Michael S. Tsirkin\" <mst@redhat.com>\nDate: Mon, 10 Mar 2014 19:28:08 +0200\nSubject: skbuff: skb_segment: orphan frags before copying\n\nskb_segment copies frags around, so we need\nto copy them carefully to avoid accessing\nuser memory after reporting completion to userspace\nthrough a callback.\n\nskb_segment doesn't normally happen on datapath:\nTSO needs to be disabled - so disabling zero copy\nin this case does not look like a big deal.\n\nSigned-off-by: Michael S. Tsirkin <mst@redhat.com>\nAcked-by: Herbert Xu <herbert@gondor.apana.org.au>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n---\n net\/core\/skbuff.c | 6 ++++++\n 1 file changed, 6 insertions(+)\n\n","diff_code":"diff --git a\/net\/core\/skbuff.c b\/net\/core\/skbuff.c\nindex dc4f7683ff52..869c7afe3b07 100644\n--- a\/net\/core\/skbuff.c\n+++ b\/net\/core\/skbuff.c\n@@ -2854,6 +2854,7 @@ struct sk_buff *skb_segment(struct sk_buff *head_skb,\n \tskb_frag_t *frag = skb_shinfo(head_skb)->frags;\n \tunsigned int mss = skb_shinfo(head_skb)->gso_size;\n \tunsigned int doffset = head_skb->data - skb_mac_header(head_skb);\n+\tstruct sk_buff *frag_skb = head_skb;\n \tunsigned int offset = doffset;\n \tunsigned int tnl_hlen = skb_tnl_header_len(head_skb);\n \tunsigned int headroom;\n@@ -2898,6 +2899,7 @@ struct sk_buff *skb_segment(struct sk_buff *head_skb,\n \t\t\ti = 0;\n \t\t\tnfrags = skb_shinfo(list_skb)->nr_frags;\n \t\t\tfrag = skb_shinfo(list_skb)->frags;\n+\t\t\tfrag_skb = list_skb;\n \t\t\tpos += skb_headlen(list_skb);\n \n \t\t\twhile (pos < offset + len) {\n@@ -2985,6 +2987,7 @@ struct sk_buff *skb_segment(struct sk_buff *head_skb,\n \t\t\t\ti = 0;\n \t\t\t\tnfrags = skb_shinfo(list_skb)->nr_frags;\n \t\t\t\tfrag = skb_shinfo(list_skb)->frags;\n+\t\t\t\tfrag_skb = list_skb;\n \n \t\t\t\tBUG_ON(!nfrags);\n \n@@ -2999,6 +3002,9 @@ struct sk_buff *skb_segment(struct sk_buff *head_skb,\n \t\t\t\tgoto err;\n \t\t\t}\n \n+\t\t\tif (unlikely(skb_orphan_frags(frag_skb, GFP_ATOMIC)))\n+\t\t\t\tgoto err;\n+\n \t\t\t*nskb_frag = *frag;\n \t\t\t__skb_frag_ref(nskb_frag);\n \t\t\tsize = skb_frag_size(nskb_frag);\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2019-13045","CWE_ID":"416","category":"security","commit_id":"5a67b983dc97caeb5df1139aabd0bc4f260a47d8","commit_message":"From 5a67b983dc97caeb5df1139aabd0bc4f260a47d8 Mon Sep 17 00:00:00 2001\nFrom: ailin-nemui <ailin-nemui@users.noreply.github.com>\nDate: Mon, 17 Jun 2019 15:22:27 +0200\nSubject: [PATCH] copy sasl username and password values\n\n---\n src\/irc\/core\/irc-core.c              | 2 ++\n src\/irc\/core\/irc-servers-reconnect.c | 4 ++--\n src\/irc\/core\/irc-servers-setup.c     | 4 ++--\n 3 files changed, 6 insertions(+), 4 deletions(-)\n\n","diff_code":"diff --git a\/src\/irc\/core\/irc-core.c b\/src\/irc\/core\/irc-core.c\nindex e65abe255..b5e80f2a0 100644\n--- a\/src\/irc\/core\/irc-core.c\n+++ b\/src\/irc\/core\/irc-core.c\n@@ -75,6 +75,8 @@ static void destroy_server_connect(SERVER_CONNECT_REC *conn)\n \n \tg_free_not_null(ircconn->usermode);\n \tg_free_not_null(ircconn->alternate_nick);\n+\tg_free_not_null(ircconn->sasl_username);\n+\tg_free_not_null(ircconn->sasl_password);\n }\n \n void irc_core_init(void)\ndiff --git a\/src\/irc\/core\/irc-servers-reconnect.c b\/src\/irc\/core\/irc-servers-reconnect.c\nindex 3d2933f4e..cfe28a1a0 100644\n--- a\/src\/irc\/core\/irc-servers-reconnect.c\n+++ b\/src\/irc\/core\/irc-servers-reconnect.c\n@@ -49,8 +49,8 @@ static void sig_server_connect_copy(SERVER_CONNECT_REC **dest,\n \trec->usermode = g_strdup(src->usermode);\n \trec->alternate_nick = g_strdup(src->alternate_nick);\n \trec->sasl_mechanism = src->sasl_mechanism;\n-\trec->sasl_username = src->sasl_username;\n-\trec->sasl_password = src->sasl_password;\n+\trec->sasl_username = g_strdup(src->sasl_username);\n+\trec->sasl_password = g_strdup(src->sasl_password);\n \t*dest = (SERVER_CONNECT_REC *) rec;\n }\n \ndiff --git a\/src\/irc\/core\/irc-servers-setup.c b\/src\/irc\/core\/irc-servers-setup.c\nindex 56e52edd0..5f1290a2f 100644\n--- a\/src\/irc\/core\/irc-servers-setup.c\n+++ b\/src\/irc\/core\/irc-servers-setup.c\n@@ -101,8 +101,8 @@ static void sig_server_setup_fill_chatnet(IRC_SERVER_CONNECT_REC *conn,\n \t\t\tconn->sasl_mechanism = SASL_MECHANISM_PLAIN;\n \t\t\tif (ircnet->sasl_username != NULL && *ircnet->sasl_username &&\n \t\t\t    ircnet->sasl_password != NULL && *ircnet->sasl_password) {\n-\t\t\t\tconn->sasl_username = ircnet->sasl_username;\n-\t\t\t\tconn->sasl_password = ircnet->sasl_password;\n+\t\t\t\tconn->sasl_username = g_strdup(ircnet->sasl_username);\n+\t\t\t\tconn->sasl_password = g_strdup(ircnet->sasl_password);\n \t\t\t} else\n \t\t\t\tg_warning(\"The fields sasl_username and sasl_password are either missing or empty\");\n \t\t}\n","owner":"irssi","repo":"irssi","source":"cve"},{"CVE_ID":"CVE-2017-7946","CWE_ID":"416","category":"security","commit_id":"d1e8ac62c6d978d4662f69116e30230d43033c92","commit_message":"From d1e8ac62c6d978d4662f69116e30230d43033c92 Mon Sep 17 00:00:00 2001\nFrom: pancake <pancake@nopcode.org>\nDate: Tue, 18 Apr 2017 13:37:33 +0200\nSubject: [PATCH] Fix null deref and uaf in mach0 parser\n\n---\n libr\/bin\/format\/mach0\/mach0.c | 92 +++++++++++++++++++----------------\n 1 file changed, 51 insertions(+), 41 deletions(-)\n\n","diff_code":"diff --git a\/libr\/bin\/format\/mach0\/mach0.c b\/libr\/bin\/format\/mach0\/mach0.c\nindex 206ab11570..398a44b152 100644\n--- a\/libr\/bin\/format\/mach0\/mach0.c\n+++ b\/libr\/bin\/format\/mach0\/mach0.c\n@@ -1119,7 +1119,7 @@ static int init_items(struct MACH0_(obj_t)* bin) {\n \t\tcase LC_LOAD_WEAK_DYLIB:\n \t\t\tsdb_set (bin->kv, sdb_fmt (0, \"mach0_cmd_%d.cmd\", i), \"load_dylib\", 0);\n \t\t\tbin->nlibs++;\n-\t\t\tif (!parse_dylib(bin, off)){\n+\t\t\tif (!parse_dylib (bin, off)){\n \t\t\t\tbprintf (\"Cannot parse dylib\\n\");\n \t\t\t\tbin->nlibs--;\n \t\t\t\treturn false;\n@@ -1130,30 +1130,31 @@ static int init_items(struct MACH0_(obj_t)* bin) {\n \t\t\t{\n \t\t\tut8 dyldi[sizeof (struct dyld_info_command)] = {0};\n \t\t\tsdb_set (bin->kv, sdb_fmt (0, \"mach0_cmd_%d.cmd\", i), \"dyld_info\", 0);\n-\t\t\tbin->dyld_info = malloc (sizeof(struct dyld_info_command));\n-\n-\t\t\tif (off + sizeof (struct dyld_info_command) > bin->size){\n-\t\t\t\tbprintf (\"Cannot parse dyldinfo\\n\");\n-\t\t\t\tfree (bin->dyld_info);\n-\t\t\t\treturn false;\n-\t\t\t}\n-\t\t\tif (r_buf_read_at (bin->b, off, dyldi, sizeof (struct dyld_info_command)) == -1) {\n-\t\t\t\tfree (bin->dyld_info);\n-\t\t\t\tbin->dyld_info = NULL;\n-\t\t\t\tbprintf (\"Error: read (LC_DYLD_INFO) at 0x%08\"PFMT64x\"\\n\", off);\n-\t\t\t} else {\n-\t\t\t\tbin->dyld_info->cmd = r_read_ble32 (&dyldi[0], bin->big_endian);\n-\t\t\t\tbin->dyld_info->cmdsize = r_read_ble32 (&dyldi[4], bin->big_endian);\n-\t\t\t\tbin->dyld_info->rebase_off = r_read_ble32 (&dyldi[8], bin->big_endian);\n-\t\t\t\tbin->dyld_info->rebase_size = r_read_ble32 (&dyldi[12], bin->big_endian);\n-\t\t\t\tbin->dyld_info->bind_off = r_read_ble32 (&dyldi[16], bin->big_endian);\n-\t\t\t\tbin->dyld_info->bind_size = r_read_ble32 (&dyldi[20], bin->big_endian);\n-\t\t\t\tbin->dyld_info->weak_bind_off = r_read_ble32 (&dyldi[24], bin->big_endian);\n-\t\t\t\tbin->dyld_info->weak_bind_size = r_read_ble32 (&dyldi[28], bin->big_endian);\n-\t\t\t\tbin->dyld_info->lazy_bind_off = r_read_ble32 (&dyldi[32], bin->big_endian);\n-\t\t\t\tbin->dyld_info->lazy_bind_size = r_read_ble32 (&dyldi[36], bin->big_endian);\n-\t\t\t\tbin->dyld_info->export_off = r_read_ble32 (&dyldi[40], bin->big_endian);\n-\t\t\t\tbin->dyld_info->export_size = r_read_ble32 (&dyldi[44], bin->big_endian);\n+\t\t\tbin->dyld_info = calloc (1, sizeof (struct dyld_info_command));\n+\t\t\tif (bin->dyld_info) {\n+\t\t\t\tif (off + sizeof (struct dyld_info_command) > bin->size){\n+\t\t\t\t\tbprintf (\"Cannot parse dyldinfo\\n\");\n+\t\t\t\t\tR_FREE (bin->dyld_info);\n+\t\t\t\t\treturn false;\n+\t\t\t\t}\n+\t\t\t\tif (r_buf_read_at (bin->b, off, dyldi, sizeof (struct dyld_info_command)) == -1) {\n+\t\t\t\t\tfree (bin->dyld_info);\n+\t\t\t\t\tbin->dyld_info = NULL;\n+\t\t\t\t\tbprintf (\"Error: read (LC_DYLD_INFO) at 0x%08\"PFMT64x\"\\n\", off);\n+\t\t\t\t} else {\n+\t\t\t\t\tbin->dyld_info->cmd = r_read_ble32 (&dyldi[0], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->cmdsize = r_read_ble32 (&dyldi[4], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->rebase_off = r_read_ble32 (&dyldi[8], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->rebase_size = r_read_ble32 (&dyldi[12], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->bind_off = r_read_ble32 (&dyldi[16], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->bind_size = r_read_ble32 (&dyldi[20], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->weak_bind_off = r_read_ble32 (&dyldi[24], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->weak_bind_size = r_read_ble32 (&dyldi[28], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->lazy_bind_off = r_read_ble32 (&dyldi[32], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->lazy_bind_size = r_read_ble32 (&dyldi[36], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->export_off = r_read_ble32 (&dyldi[40], bin->big_endian);\n+\t\t\t\t\tbin->dyld_info->export_size = r_read_ble32 (&dyldi[44], bin->big_endian);\n+\t\t\t\t}\n \t\t\t}\n \t\t\t}\n \t\t\tbreak;\n@@ -1747,17 +1748,20 @@ struct reloc_t* MACH0_(get_relocs)(struct MACH0_(obj_t)* bin) {\n \t\tif ((bind_size + lazy_size)<1) {\n \t\t\treturn NULL;\n \t\t}\n-\t\tif (bin->dyld_info->bind_off > bin->size || bin->dyld_info->bind_off + bind_size > bin->size)\n+\t\tif (bin->dyld_info->bind_off > bin->size || bin->dyld_info->bind_off + bind_size > bin->size) {\n \t\t\treturn NULL;\n+\t\t}\n \t\tif (bin->dyld_info->lazy_bind_off > bin->size || \\\n-\t\t\tbin->dyld_info->lazy_bind_off + lazy_size > bin->size)\n+\t\t\tbin->dyld_info->lazy_bind_off + lazy_size > bin->size) {\n \t\t\treturn NULL;\n-\t\tif (bin->dyld_info->bind_off+bind_size+lazy_size > bin->size)\n+\t\t}\n+\t\tif (bin->dyld_info->bind_off+bind_size+lazy_size > bin->size) {\n \t\t\treturn NULL;\n+\t\t}\n \t\t\/\/ NOTE(eddyb) it's a waste of memory, but we don't know the actual number of relocs.\n-\t\tif (!(relocs = calloc (1, (1 + bind_size + lazy_size) * sizeof (struct reloc_t))))\n+\t\tif (!(relocs = calloc (1, (1 + bind_size + lazy_size) * sizeof (struct reloc_t)))) {\n \t\t\treturn NULL;\n-\n+\t\t}\n \t\topcodes = calloc (1, bind_size + lazy_size + 1);\n \t\tif (!opcodes) {\n \t\t\tfree (relocs);\n@@ -1905,12 +1909,14 @@ relocs[i++].last = 0;\\\n \t\tfree (opcodes);\n \t} else {\n \t\tint j;\n-\t\tif (!bin->symtab || !bin->symstr || !bin->sects || !bin->indirectsyms)\n+\t\tif (!bin->symtab || !bin->symstr || !bin->sects || !bin->indirectsyms) {\n \t\t\treturn NULL;\n-\t\tif (!(relocs = malloc ((bin->dysymtab.nundefsym + 1) * sizeof(struct reloc_t))))\n+\t\t}\n+\t\tif (!(relocs = malloc ((bin->dysymtab.nundefsym + 1) * sizeof(struct reloc_t)))) {\n \t\t\treturn NULL;\n+\t\t}\n \t\tfor (j = 0; j < bin->dysymtab.nundefsym; j++) {\n-\t\t\tif (parse_import_ptr(bin, &relocs[i], bin->dysymtab.iundefsym + j)) {\n+\t\t\tif (parse_import_ptr (bin, &relocs[i], bin->dysymtab.iundefsym + j)) {\n \t\t\t\trelocs[i].ord = j;\n \t\t\t\trelocs[i++].last = 0;\n \t\t\t}\n@@ -1954,7 +1960,6 @@ struct addr_t* MACH0_(get_entrypoint)(struct MACH0_(obj_t)* bin) {\n \t\t}\n \t\tbin->entry = entry->addr;\n \t}\n-\n \treturn entry;\n }\n \n@@ -1962,10 +1967,12 @@ struct lib_t* MACH0_(get_libs)(struct MACH0_(obj_t)* bin) {\n \tstruct lib_t *libs;\n \tint i;\n \n-\tif (!bin->nlibs)\n+\tif (!bin->nlibs) {\n \t\treturn NULL;\n-\tif (!(libs = calloc ((bin->nlibs + 1), sizeof(struct lib_t))))\n+\t}\n+\tif (!(libs = calloc ((bin->nlibs + 1), sizeof(struct lib_t)))) {\n \t\treturn NULL;\n+\t}\n \tfor (i = 0; i < bin->nlibs; i++) {\n \t\tstrncpy (libs[i].name, bin->libs[i], R_BIN_MACH0_STRING_LENGTH);\n \t\tlibs[i].name[R_BIN_MACH0_STRING_LENGTH-1] = '\\0';\n@@ -1978,12 +1985,14 @@ struct lib_t* MACH0_(get_libs)(struct MACH0_(obj_t)* bin) {\n ut64 MACH0_(get_baddr)(struct MACH0_(obj_t)* bin) {\n \tint i;\n \n-\tif (bin->hdr.filetype != MH_EXECUTE && bin->hdr.filetype != MH_DYLINKER)\n+\tif (bin->hdr.filetype != MH_EXECUTE && bin->hdr.filetype != MH_DYLINKER) {\n \t\treturn 0;\n-\n-\tfor (i = 0; i < bin->nsegs; ++i)\n-\t\tif (bin->segs[i].fileoff == 0 && bin->segs[i].filesize != 0)\n+\t}\n+\tfor (i = 0; i < bin->nsegs; ++i) {\n+\t\tif (bin->segs[i].fileoff == 0 && bin->segs[i].filesize != 0) {\n \t\t\treturn bin->segs[i].vmaddr;\n+\t\t}\n+\t}\n \treturn 0;\n }\n \n@@ -2309,8 +2318,9 @@ ut64 MACH0_(get_main)(struct MACH0_(obj_t)* bin) {\n \t\tut8 b[128];\n \t\tut64 entry = addr_to_offset(bin, bin->entry);\n \t\t\/\/ XXX: X86 only and hacky!\n-\t\tif (entry > bin->size || entry + sizeof (b) > bin->size)\n+\t\tif (entry > bin->size || entry + sizeof (b) > bin->size) {\n \t\t\treturn 0;\n+\t\t}\n \t\ti = r_buf_read_at (bin->b, entry, b, sizeof (b));\n \t\tif (i < 1) {\n \t\t\treturn 0;\n","owner":"radare","repo":"radare2","source":"cve"},{"CVE_ID":"CVE-2016-9576","CWE_ID":"416","category":"security","commit_id":"a0ac402cfcdc904f9772e1762b3fda112dcc56a0","commit_message":"From a0ac402cfcdc904f9772e1762b3fda112dcc56a0 Mon Sep 17 00:00:00 2001\nFrom: Linus Torvalds <torvalds@linux-foundation.org>\nDate: Tue, 6 Dec 2016 16:18:14 -0800\nSubject: [PATCH] Don't feed anything but regular iovec's to\n blk_rq_map_user_iov\n\nIn theory we could map other things, but there's a reason that function\nis called \"user_iov\".  Using anything else (like splice can do) just\nconfuses it.\n\nReported-and-tested-by: Johannes Thumshirn <jthumshirn@suse.de>\nCc: Al Viro <viro@ZenIV.linux.org.uk>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n block\/blk-map.c | 4 ++++\n 1 file changed, 4 insertions(+)\n\n","diff_code":"diff --git a\/block\/blk-map.c b\/block\/blk-map.c\nindex b8657fa8dc9af..27fd8d92892d4 100644\n--- a\/block\/blk-map.c\n+++ b\/block\/blk-map.c\n@@ -118,6 +118,9 @@ int blk_rq_map_user_iov(struct request_queue *q, struct request *rq,\n \tstruct iov_iter i;\n \tint ret;\n \n+\tif (!iter_is_iovec(iter))\n+\t\tgoto fail;\n+\n \tif (map_data)\n \t\tcopy = true;\n \telse if (iov_iter_alignment(iter) & align)\n@@ -140,6 +143,7 @@ int blk_rq_map_user_iov(struct request_queue *q, struct request *rq,\n \n unmap_rq:\n \t__blk_rq_unmap_user(bio);\n+fail:\n \trq->bio = NULL;\n \treturn -EINVAL;\n }\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2018-16840","CWE_ID":"416","category":"security","commit_id":"81d135d67155c5295b1033679c606165d4e28f3f","commit_message":"From 81d135d67155c5295b1033679c606165d4e28f3f Mon Sep 17 00:00:00 2001\nFrom: Daniel Stenberg <daniel@haxx.se>\nDate: Thu, 18 Oct 2018 15:07:15 +0200\nSubject: [PATCH] Curl_close: clear data->multi_easy on free to avoid\n use-after-free\n\nRegression from b46cfbc068 (7.59.0)\nCVE-2018-16840\nReported-by: Brian Carpenter (Geeknik Labs)\n\nBug: https:\/\/curl.haxx.se\/docs\/CVE-2018-16840.html\n---\n lib\/url.c | 4 +++-\n 1 file changed, 3 insertions(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/lib\/url.c b\/lib\/url.c\nindex 723b898065..0d5a13f996 100644\n--- a\/lib\/url.c\n+++ b\/lib\/url.c\n@@ -331,10 +331,12 @@ CURLcode Curl_close(struct Curl_easy *data)\n        and detach this handle from there. *\/\n     curl_multi_remove_handle(data->multi, data);\n \n-  if(data->multi_easy)\n+  if(data->multi_easy) {\n     \/* when curl_easy_perform() is used, it creates its own multi handle to\n        use and this is the one *\/\n     curl_multi_cleanup(data->multi_easy);\n+    data->multi_easy = NULL;\n+  }\n \n   \/* Destroy the timeout list that is held in the easy handle. It is\n      \/normally\/ done by curl_multi_remove_handle() but this is \"just in\n","owner":"curl","repo":"curl","source":"cve"},{"CVE_ID":"CVE-2018-16540","CWE_ID":"416","category":"security","commit_id":"c432131c3fdb2143e148e8ba88555f7f7a63b25e","commit_message":"From c432131c3fdb2143e148e8ba88555f7f7a63b25e Mon Sep 17 00:00:00 2001\nFrom: Chris Liddell <chris.liddell@artifex.com>\nDate: Thu, 23 Aug 2018 14:13:25 +0100\nSubject: [PATCH] Bug 699661: Avoid sharing pointers between pdf14 compositors\n\nIf a copdevice is triggered when the pdf14 compositor is the device, we make\na copy of the device, then throw an error because, by default we're only allowed\nto copy the device prototype - then freeing it calls the finalize, which frees\nseveral pointers shared with the parent.\n\nMake a pdf14 specific finish_copydevice() which NULLs the relevant pointers,\nbefore, possibly, throwing the same error as the default method.\n\nThis also highlighted a problem with reopening the X11 devices, where a custom\nerror handler could be replaced with itself, meaning it also called itself,\nand infifite recursion resulted.\n\nKeep a note of if the handler replacement has been done, and don't do it a\nsecond time.\n---\n base\/gdevp14.c     | 17 ++++++++++++++++-\n devices\/gdevxini.c | 12 ++++++++----\n 2 files changed, 24 insertions(+), 5 deletions(-)\n\n","diff_code":"diff --git a\/base\/gdevp14.c b\/base\/gdevp14.c\nindex d9f8e79..eb9cc23 100644\n--- a\/base\/gdevp14.c\n+++ b\/base\/gdevp14.c\n@@ -178,6 +178,7 @@ static\tdev_proc_fill_mask(pdf14_fill_mask);\n static\tdev_proc_stroke_path(pdf14_stroke_path);\n static\tdev_proc_begin_typed_image(pdf14_begin_typed_image);\n static\tdev_proc_text_begin(pdf14_text_begin);\n+static  dev_proc_finish_copydevice(pdf14_finish_copydevice);\n static\tdev_proc_create_compositor(pdf14_create_compositor);\n static\tdev_proc_create_compositor(pdf14_forward_create_compositor);\n static\tdev_proc_begin_transparency_group(pdf14_begin_transparency_group);\n@@ -245,7 +246,7 @@ static\tconst gx_color_map_procs *\n         pdf14_create_compositor,\t\/* create_compositor *\/\\\n         NULL,\t\t\t\t\/* get_hardware_params *\/\\\n         pdf14_text_begin,\t\t\/* text_begin *\/\\\n-        NULL,\t\t\t\t\/* finish_copydevice *\/\\\n+        pdf14_finish_copydevice,        \/* finish_copydevice *\/\\\n         pdf14_begin_transparency_group,\\\n         pdf14_end_transparency_group,\\\n         pdf14_begin_transparency_mask,\\\n@@ -3935,6 +3936,19 @@ pdf14_text_begin(gx_device * dev, gs_gstate * pgs,\n     return code;\n }\n \n+static\tint\n+pdf14_finish_copydevice(gx_device *new_dev, const gx_device *from_dev)\n+{\n+    pdf14_device *pdev = (pdf14_device*)new_dev;\n+\n+    pdev->ctx = NULL;\n+    pdev->trans_group_parent_cmap_procs = NULL;\n+    pdev->smaskcolor = NULL;\n+\n+    \/* Only allow copying the prototype. *\/\n+    return (from_dev->memory ? gs_note_error(gs_error_rangecheck) : 0);\n+}\n+\n \/*\n  * Implement copy_mono by filling lots of small rectangles.\n  *\/\n@@ -8093,6 +8107,7 @@ c_pdf14trans_clist_read_update(gs_composite_t *\tpcte, gx_device\t* cdev,\n                        before reopening the device *\/\n                     if (p14dev->ctx != NULL) {\n                         pdf14_ctx_free(p14dev->ctx);\n+                        p14dev->ctx = NULL;\n                     }\n                     dev_proc(tdev, open_device) (tdev);\n                 }\ndiff --git a\/devices\/gdevxini.c b\/devices\/gdevxini.c\nindex 8511eac..23b8c35 100644\n--- a\/devices\/gdevxini.c\n+++ b\/devices\/gdevxini.c\n@@ -59,7 +59,8 @@ static struct xv_ {\n     Boolean alloc_error;\n     XErrorHandler orighandler;\n     XErrorHandler oldhandler;\n-} x_error_handler;\n+    Boolean set;\n+} x_error_handler = {0};\n \n static int\n x_catch_alloc(Display * dpy, XErrorEvent * err)\n@@ -74,7 +75,8 @@ x_catch_alloc(Display * dpy, XErrorEvent * err)\n int\n x_catch_free_colors(Display * dpy, XErrorEvent * err)\n {\n-    if (err->request_code == X_FreeColors)\n+    if (err->request_code == X_FreeColors ||\n+        x_error_handler.orighandler == x_catch_free_colors)\n         return 0;\n     return x_error_handler.orighandler(dpy, err);\n }\n@@ -274,8 +276,10 @@ gdev_x_open(gx_device_X * xdev)\n         return_error(gs_error_ioerror);\n     }\n     \/* Buggy X servers may cause a Bad Access on XFreeColors. *\/\n-    x_error_handler.orighandler = XSetErrorHandler(x_catch_free_colors);\n-\n+    if (!x_error_handler.set) {\n+        x_error_handler.orighandler = XSetErrorHandler(x_catch_free_colors);\n+        x_error_handler.set = True;\n+    }\n     \/* Get X Resources.  Use the toolkit for this. *\/\n     XtToolkitInitialize();\n     app_con = XtCreateApplicationContext();\n-- \n2.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2018-5344","CWE_ID":"416","category":"security","commit_id":"ae6650163c66a7eff1acd6eb8b0f752dcfa8eba5","commit_message":"From ae6650163c66a7eff1acd6eb8b0f752dcfa8eba5 Mon Sep 17 00:00:00 2001\nFrom: Linus Torvalds <torvalds@linux-foundation.org>\nDate: Fri, 5 Jan 2018 16:26:00 -0800\nSubject: [PATCH] loop: fix concurrent lo_open\/lo_release\nMIME-Version: 1.0\nContent-Type: text\/plain; charset=UTF-8\nContent-Transfer-Encoding: 8bit\n\n\u8303\u9f99\u98de reports that KASAN can report a use-after-free in __lock_acquire.\nThe reason is due to insufficient serialization in lo_release(), which\nwill continue to use the loop device even after it has decremented the\nlo_refcnt to zero.\n\nIn the meantime, another process can come in, open the loop device\nagain as it is being shut down. Confusion ensues.\n\nReported-by: \u8303\u9f99\u98de <long7573@126.com>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\nSigned-off-by: Jens Axboe <axboe@kernel.dk>\n---\n drivers\/block\/loop.c | 10 ++++++++--\n 1 file changed, 8 insertions(+), 2 deletions(-)\n\n","diff_code":"diff --git a\/drivers\/block\/loop.c b\/drivers\/block\/loop.c\nindex bc8e61506968a..d5fe720cf1494 100644\n--- a\/drivers\/block\/loop.c\n+++ b\/drivers\/block\/loop.c\n@@ -1581,9 +1581,8 @@ static int lo_open(struct block_device *bdev, fmode_t mode)\n \treturn err;\n }\n \n-static void lo_release(struct gendisk *disk, fmode_t mode)\n+static void __lo_release(struct loop_device *lo)\n {\n-\tstruct loop_device *lo = disk->private_data;\n \tint err;\n \n \tif (atomic_dec_return(&lo->lo_refcnt))\n@@ -1610,6 +1609,13 @@ static void lo_release(struct gendisk *disk, fmode_t mode)\n \tmutex_unlock(&lo->lo_ctl_mutex);\n }\n \n+static void lo_release(struct gendisk *disk, fmode_t mode)\n+{\n+\tmutex_lock(&loop_index_mutex);\n+\t__lo_release(disk->private_data);\n+\tmutex_unlock(&loop_index_mutex);\n+}\n+\n static const struct block_device_operations lo_fops = {\n \t.owner =\tTHIS_MODULE,\n \t.open =\t\tlo_open,\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-1000211","CWE_ID":"416","category":"security","commit_id":"280a61b300a1614f6037efc0902ff7ecf17146e9","commit_message":"From 280a61b300a1614f6037efc0902ff7ecf17146e9 Mon Sep 17 00:00:00 2001\nFrom: \"Thomas E. Dickey\" <dickey@invisible-island.net>\nDate: Wed, 5 Jul 2017 23:04:01 +0000\nSubject: [PATCH] snapshot of project \"lynx\", label v2-8-9dev_15b\n\n---\n CHANGES                                   |  4 +++-\n PACKAGE\/debian\/lynx-dev.lintian-overrides |  2 +-\n src\/HTML.c                                | 27 ++++++++++++++++-------\n 3 files changed, 23 insertions(+), 10 deletions(-)\n\n","diff_code":"diff --git a\/CHANGES b\/CHANGES\nindex 7f06e953..641bd277 100644\n--- a\/CHANGES\n+++ b\/CHANGES\n@@ -1,9 +1,11 @@\n--- $LynxId: CHANGES,v 1.910 2017\/07\/05 20:39:40 tom Exp $\n+-- $LynxId: CHANGES,v 1.911 2017\/07\/05 22:23:00 tom Exp $\n ===============================================================================\n Changes since Lynx 2.8 release\n ===============================================================================\n \n 2017-07-05 (2.8.9dev.16)\n+* add a check to ensure that HTML_put_string() will not append a chunk onto\n+  itself (report by Ned Williamson) -TD\n * update et.po, tr.po from\n     http:\/\/translationproject.org\/latest\/lynx\n \ndiff --git a\/PACKAGE\/debian\/lynx-dev.lintian-overrides b\/PACKAGE\/debian\/lynx-dev.lintian-overrides\nindex 280b562d..a2345b7e 100644\n--- a\/PACKAGE\/debian\/lynx-dev.lintian-overrides\n+++ b\/PACKAGE\/debian\/lynx-dev.lintian-overrides\n@@ -1,5 +1,5 @@\n # Lynx's version-numbering is not understood by lintian, though legal.\n-lynx-dev: rc-version-greater-than-expected-version 2.8.9dev.15 > 2.8.9 (consider using 2.8.9~dev.15)\n+lynx-dev: rc-version-greater-than-expected-version\n \n # This is intentional because it is referenced from the documentation.\n lynx-dev: extra-license-file usr\/share\/doc\/lynx-dev\/COPYING\ndiff --git a\/src\/HTML.c b\/src\/HTML.c\nindex c9ab9395..63d67206 100644\n--- a\/src\/HTML.c\n+++ b\/src\/HTML.c\n@@ -1,5 +1,5 @@\n \/*\n- * $LynxId: HTML.c,v 1.173 2017\/07\/04 20:05:01 tom Exp $\n+ * $LynxId: HTML.c,v 1.174 2017\/07\/05 22:48:09 tom Exp $\n  *\n  *\t\tStructured stream to Rich hypertext converter\n  *\t\t============================================\n@@ -505,6 +505,8 @@ void HTML_put_character(HTStructured * me, int c)\n  *\/\n void HTML_put_string(HTStructured * me, const char *s)\n {\n+    HTChunk *target = NULL;\n+\n #ifdef USE_PRETTYSRC\n     char *translated_string = NULL;\n #endif\n@@ -525,15 +527,15 @@ void HTML_put_string(HTStructured * me, const char *s)\n \tbreak;\t\t\t\/* Do Nothing *\/\n \n     case HTML_TITLE:\n-\tHTChunkPuts(&me->title, s);\n+\ttarget = &me->title;\n \tbreak;\n \n     case HTML_STYLE:\n-\tHTChunkPuts(&me->style_block, s);\n+\ttarget = &me->style_block;\n \tbreak;\n \n     case HTML_SCRIPT:\n-\tHTChunkPuts(&me->script, s);\n+\ttarget = &me->script;\n \tbreak;\n \n     case HTML_PRE:\t\t\/* Formatted text *\/\n@@ -547,20 +549,20 @@ void HTML_put_string(HTStructured * me, const char *s)\n \tbreak;\n \n     case HTML_OBJECT:\n-\tHTChunkPuts(&me->object, s);\n+\ttarget = &me->object;\n \tbreak;\n \n     case HTML_TEXTAREA:\n-\tHTChunkPuts(&me->textarea, s);\n+\ttarget = &me->textarea;\n \tbreak;\n \n     case HTML_SELECT:\n     case HTML_OPTION:\n-\tHTChunkPuts(&me->option, s);\n+\ttarget = &me->option;\n \tbreak;\n \n     case HTML_MATH:\n-\tHTChunkPuts(&me->math, s);\n+\ttarget = &me->math;\n \tbreak;\n \n     default:\t\t\t\/* Free format text? *\/\n@@ -651,6 +653,15 @@ void HTML_put_string(HTStructured * me, const char *s)\n \t    }\t\t\t\/* for *\/\n \t}\n     }\t\t\t\t\/* end switch *\/\n+\n+    if (target != NULL) {\n+\tif (target->data == s) {\n+\t    CTRACE((tfp, \"BUG: appending chunk to itself: `%.*s'\\n\",\n+\t\t    target->size, target->data));\n+\t} else {\n+\t    HTChunkPuts(target, s);\n+\t}\n+    }\n #ifdef USE_PRETTYSRC\n     if (psrc_convert_string) {\n \tpsrc_convert_string = FALSE;\n","owner":"ThomasDickey","repo":"lynx-snapshots","source":"cve"},{"CVE_ID":"CVE-2017-10966","CWE_ID":"416","category":"security","commit_id":"29ebac987da1da2c892aed5ed329256b7bc94bca","commit_message":"From 29ebac987da1da2c892aed5ed329256b7bc94bca Mon Sep 17 00:00:00 2001\nFrom: Nei <ailin.nemui@gmail.com>\nDate: Thu, 29 Jun 2017 13:48:44 +0000\nSubject: [PATCH 1\/2] Check return value of localtime\n\nFixes #10\n---\n src\/core\/misc.c | 3 +++\n 1 file changed, 3 insertions(+)\n\nFrom 73b851c39c11d01199e6c040749fb20e468f6c8d Mon Sep 17 00:00:00 2001\nFrom: ailin-nemui <ailin-nemui@users.noreply.github.com>\nDate: Tue, 4 Jul 2017 16:10:55 +0200\nSubject: [PATCH 2\/2] correct GHashTable usage\n\n---\n src\/core\/nicklist.c | 17 ++++++++++-------\n 1 file changed, 10 insertions(+), 7 deletions(-)\n\n","diff_code":"diff --git a\/src\/core\/misc.c b\/src\/core\/misc.c\nindex ce49925b1..0b2d8e776 100644\n--- a\/src\/core\/misc.c\n+++ b\/src\/core\/misc.c\n@@ -560,6 +560,9 @@ char *my_asctime(time_t t)\n         int len;\n \n \ttm = localtime(&t);\n+\tif (tm == NULL)\n+\t    return g_strdup(\"???\");\n+\n \tstr = g_strdup(asctime(tm));\n \n \tlen = strlen(str);\n\ndiff --git a\/src\/core\/nicklist.c b\/src\/core\/nicklist.c\nindex 54dfb5fb2..0bc88ab8d 100644\n--- a\/src\/core\/nicklist.c\n+++ b\/src\/core\/nicklist.c\n@@ -54,23 +54,26 @@ static void nick_hash_add(CHANNEL_REC *channel, NICK_REC *nick)\n \n static void nick_hash_remove(CHANNEL_REC *channel, NICK_REC *nick)\n {\n-\tNICK_REC *list;\n+\tNICK_REC *list, *newlist;\n \n \tlist = g_hash_table_lookup(channel->nicks, nick->nick);\n \tif (list == NULL)\n \t\treturn;\n \n-\tif (list == nick || list->next == NULL) {\n-\t\tg_hash_table_remove(channel->nicks, nick->nick);\n-\t\tif (list->next != NULL) {\n-\t\t\tg_hash_table_insert(channel->nicks, nick->next->nick,\n-\t\t\t\t\t    nick->next);\n-\t\t}\n+\tif (list == nick) {\n+\t\tnewlist = nick->next;\n \t} else {\n+\t\tnewlist = list;\n \t\twhile (list->next != nick)\n \t\t\tlist = list->next;\n \t\tlist->next = nick->next;\n \t}\n+\n+\tg_hash_table_remove(channel->nicks, nick->nick);\n+\tif (newlist != NULL) {\n+\t\tg_hash_table_insert(channel->nicks, newlist->nick,\n+\t\t\t\t    newlist);\n+\t}\n }\n \n \/* Add new nick to list *\/\n","owner":"irssi","repo":"irssi.irssi.irssi","source":"cve"},{"CVE_ID":"CVE-2017-17052","CWE_ID":"416","category":"security","commit_id":"2b7e8665b4ff51c034c55df3cff76518d1a9ee3a","commit_message":"From 2b7e8665b4ff51c034c55df3cff76518d1a9ee3a Mon Sep 17 00:00:00 2001\nFrom: Eric Biggers <ebiggers@google.com>\nDate: Fri, 25 Aug 2017 15:55:43 -0700\nSubject: fork: fix incorrect fput of ->exe_file causing use-after-free\n\nCommit 7c051267931a (\"mm, fork: make dup_mmap wait for mmap_sem for\nwrite killable\") made it possible to kill a forking task while it is\nwaiting to acquire its ->mmap_sem for write, in dup_mmap().\n\nHowever, it was overlooked that this introduced an new error path before\na reference is taken on the mm_struct's ->exe_file.  Since the\n->exe_file of the new mm_struct was already set to the old ->exe_file by\nthe memcpy() in dup_mm(), it was possible for the mmput() in the error\npath of dup_mm() to drop a reference to ->exe_file which was never\ntaken.\n\nThis caused the struct file to later be freed prematurely.\n\nFix it by updating mm_init() to NULL out the ->exe_file, in the same\nplace it clears other things like the list of mmaps.\n\nThis bug was found by syzkaller.  It can be reproduced using the\nfollowing C program:\n\n    #define _GNU_SOURCE\n    #include <pthread.h>\n    #include <stdlib.h>\n    #include <sys\/mman.h>\n    #include <sys\/syscall.h>\n    #include <sys\/wait.h>\n    #include <unistd.h>\n\n    static void *mmap_thread(void *_arg)\n    {\n        for (;;) {\n            mmap(NULL, 0x1000000, PROT_READ,\n                 MAP_POPULATE|MAP_ANONYMOUS|MAP_PRIVATE, -1, 0);\n        }\n    }\n\n    static void *fork_thread(void *_arg)\n    {\n        usleep(rand() % 10000);\n        fork();\n    }\n\n    int main(void)\n    {\n        fork();\n        fork();\n        fork();\n        for (;;) {\n            if (fork() == 0) {\n                pthread_t t;\n\n                pthread_create(&t, NULL, mmap_thread, NULL);\n                pthread_create(&t, NULL, fork_thread, NULL);\n                usleep(rand() % 10000);\n                syscall(__NR_exit_group, 0);\n            }\n            wait(NULL);\n        }\n    }\n\nNo special kernel config options are needed.  It usually causes a NULL\npointer dereference in __remove_shared_vm_struct() during exit, or in\ndup_mmap() (which is usually inlined into copy_process()) during fork.\nBoth are due to a vm_area_struct's ->vm_file being used after it's\nalready been freed.\n\nGoogle Bug Id: 64772007\n\nLink: http:\/\/lkml.kernel.org\/r\/20170823211408.31198-1-ebiggers3@gmail.com\nFixes: 7c051267931a (\"mm, fork: make dup_mmap wait for mmap_sem for write killable\")\nSigned-off-by: Eric Biggers <ebiggers@google.com>\nTested-by: Mark Rutland <mark.rutland@arm.com>\nAcked-by: Michal Hocko <mhocko@suse.com>\nCc: Dmitry Vyukov <dvyukov@google.com>\nCc: Ingo Molnar <mingo@kernel.org>\nCc: Konstantin Khlebnikov <koct9i@gmail.com>\nCc: Oleg Nesterov <oleg@redhat.com>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Vlastimil Babka <vbabka@suse.cz>\nCc: <stable@vger.kernel.org>\t[v4.7+]\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n kernel\/fork.c | 1 +\n 1 file changed, 1 insertion(+)\n\n","diff_code":"diff --git a\/kernel\/fork.c b\/kernel\/fork.c\nindex e075b7780421..cbbea277b3fb 100644\n--- a\/kernel\/fork.c\n+++ b\/kernel\/fork.c\n@@ -806,6 +806,7 @@ static struct mm_struct *mm_init(struct mm_struct *mm, struct task_struct *p,\n \tmm_init_cpumask(mm);\n \tmm_init_aio(mm);\n \tmm_init_owner(mm, p);\n+\tRCU_INIT_POINTER(mm->exe_file, NULL);\n \tmmu_notifier_mm_init(mm);\n \tinit_tlb_flush_pending(mm);\n #if defined(CONFIG_TRANSPARENT_HUGEPAGE) && !USE_SPLIT_PMD_PTLOCKS\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2018-10876","CWE_ID":"416","category":"security","commit_id":"8844618d8aa7a9973e7b527d038a2a589665002c","commit_message":"From 8844618d8aa7a9973e7b527d038a2a589665002c Mon Sep 17 00:00:00 2001\nFrom: Theodore Ts'o <tytso@mit.edu>\nDate: Thu, 14 Jun 2018 00:58:00 -0400\nSubject: ext4: only look at the bg_flags field if it is valid\n\nThe bg_flags field in the block group descripts is only valid if the\nuninit_bg or metadata_csum feature is enabled.  We were not\nconsistently looking at this field; fix this.\n\nAlso block group #0 must never have uninitialized allocation bitmaps,\nor need to be zeroed, since that's where the root inode, and other\nspecial inodes are set up.  Check for these conditions and mark the\nfile system as corrupted if they are detected.\n\nThis addresses CVE-2018-10876.\n\nhttps:\/\/bugzilla.kernel.org\/show_bug.cgi?id=199403\n\nSigned-off-by: Theodore Ts'o <tytso@mit.edu>\nCc: stable@kernel.org\n---\n fs\/ext4\/balloc.c  | 11 ++++++++++-\n fs\/ext4\/ialloc.c  | 14 ++++++++++++--\n fs\/ext4\/mballoc.c |  6 ++++--\n fs\/ext4\/super.c   | 11 ++++++++++-\n 4 files changed, 36 insertions(+), 6 deletions(-)\n\n","diff_code":"diff --git a\/fs\/ext4\/balloc.c b\/fs\/ext4\/balloc.c\nindex 8a2e202ade8a..e68cefe08261 100644\n--- a\/fs\/ext4\/balloc.c\n+++ b\/fs\/ext4\/balloc.c\n@@ -438,7 +438,16 @@ ext4_read_block_bitmap_nowait(struct super_block *sb, ext4_group_t block_group)\n \t\tgoto verify;\n \t}\n \text4_lock_group(sb, block_group);\n-\tif (desc->bg_flags & cpu_to_le16(EXT4_BG_BLOCK_UNINIT)) {\n+\tif (ext4_has_group_desc_csum(sb) &&\n+\t    (desc->bg_flags & cpu_to_le16(EXT4_BG_BLOCK_UNINIT))) {\n+\t\tif (block_group == 0) {\n+\t\t\text4_unlock_group(sb, block_group);\n+\t\t\tunlock_buffer(bh);\n+\t\t\text4_error(sb, \"Block bitmap for bg 0 marked \"\n+\t\t\t\t   \"uninitialized\");\n+\t\t\terr = -EFSCORRUPTED;\n+\t\t\tgoto out;\n+\t\t}\n \t\terr = ext4_init_block_bitmap(sb, bh, block_group, desc);\n \t\tset_bitmap_uptodate(bh);\n \t\tset_buffer_uptodate(bh);\ndiff --git a\/fs\/ext4\/ialloc.c b\/fs\/ext4\/ialloc.c\nindex 4d6e007f3569..da6c10c1e37a 100644\n--- a\/fs\/ext4\/ialloc.c\n+++ b\/fs\/ext4\/ialloc.c\n@@ -150,7 +150,16 @@ ext4_read_inode_bitmap(struct super_block *sb, ext4_group_t block_group)\n \t}\n \n \text4_lock_group(sb, block_group);\n-\tif (desc->bg_flags & cpu_to_le16(EXT4_BG_INODE_UNINIT)) {\n+\tif (ext4_has_group_desc_csum(sb) &&\n+\t    (desc->bg_flags & cpu_to_le16(EXT4_BG_INODE_UNINIT))) {\n+\t\tif (block_group == 0) {\n+\t\t\text4_unlock_group(sb, block_group);\n+\t\t\tunlock_buffer(bh);\n+\t\t\text4_error(sb, \"Inode bitmap for bg 0 marked \"\n+\t\t\t\t   \"uninitialized\");\n+\t\t\terr = -EFSCORRUPTED;\n+\t\t\tgoto out;\n+\t\t}\n \t\tmemset(bh->b_data, 0, (EXT4_INODES_PER_GROUP(sb) + 7) \/ 8);\n \t\text4_mark_bitmap_end(EXT4_INODES_PER_GROUP(sb),\n \t\t\t\t     sb->s_blocksize * 8, bh->b_data);\n@@ -994,7 +1003,8 @@ got:\n \n \t\t\/* recheck and clear flag under lock if we still need to *\/\n \t\text4_lock_group(sb, group);\n-\t\tif (gdp->bg_flags & cpu_to_le16(EXT4_BG_BLOCK_UNINIT)) {\n+\t\tif (ext4_has_group_desc_csum(sb) &&\n+\t\t    (gdp->bg_flags & cpu_to_le16(EXT4_BG_BLOCK_UNINIT))) {\n \t\t\tgdp->bg_flags &= cpu_to_le16(~EXT4_BG_BLOCK_UNINIT);\n \t\t\text4_free_group_clusters_set(sb, gdp,\n \t\t\t\text4_free_clusters_after_init(sb, group, gdp));\ndiff --git a\/fs\/ext4\/mballoc.c b\/fs\/ext4\/mballoc.c\nindex 243c42fdc155..402c769c51ea 100644\n--- a\/fs\/ext4\/mballoc.c\n+++ b\/fs\/ext4\/mballoc.c\n@@ -2444,7 +2444,8 @@ int ext4_mb_add_groupinfo(struct super_block *sb, ext4_group_t group,\n \t * initialize bb_free to be able to skip\n \t * empty groups without initialization\n \t *\/\n-\tif (desc->bg_flags & cpu_to_le16(EXT4_BG_BLOCK_UNINIT)) {\n+\tif (ext4_has_group_desc_csum(sb) &&\n+\t    (desc->bg_flags & cpu_to_le16(EXT4_BG_BLOCK_UNINIT))) {\n \t\tmeta_group_info[i]->bb_free =\n \t\t\text4_free_clusters_after_init(sb, group, desc);\n \t} else {\n@@ -3010,7 +3011,8 @@ ext4_mb_mark_diskspace_used(struct ext4_allocation_context *ac,\n #endif\n \text4_set_bits(bitmap_bh->b_data, ac->ac_b_ex.fe_start,\n \t\t      ac->ac_b_ex.fe_len);\n-\tif (gdp->bg_flags & cpu_to_le16(EXT4_BG_BLOCK_UNINIT)) {\n+\tif (ext4_has_group_desc_csum(sb) &&\n+\t    (gdp->bg_flags & cpu_to_le16(EXT4_BG_BLOCK_UNINIT))) {\n \t\tgdp->bg_flags &= cpu_to_le16(~EXT4_BG_BLOCK_UNINIT);\n \t\text4_free_group_clusters_set(sb, gdp,\n \t\t\t\t\t     ext4_free_clusters_after_init(sb,\ndiff --git a\/fs\/ext4\/super.c b\/fs\/ext4\/super.c\nindex c61675d62195..4d34430d75f6 100644\n--- a\/fs\/ext4\/super.c\n+++ b\/fs\/ext4\/super.c\n@@ -3139,13 +3139,22 @@ static ext4_group_t ext4_has_uninit_itable(struct super_block *sb)\n \text4_group_t group, ngroups = EXT4_SB(sb)->s_groups_count;\n \tstruct ext4_group_desc *gdp = NULL;\n \n+\tif (!ext4_has_group_desc_csum(sb))\n+\t\treturn ngroups;\n+\n \tfor (group = 0; group < ngroups; group++) {\n \t\tgdp = ext4_get_group_desc(sb, group, NULL);\n \t\tif (!gdp)\n \t\t\tcontinue;\n \n-\t\tif (!(gdp->bg_flags & cpu_to_le16(EXT4_BG_INODE_ZEROED)))\n+\t\tif (gdp->bg_flags & cpu_to_le16(EXT4_BG_INODE_ZEROED))\n+\t\t\tcontinue;\n+\t\tif (group != 0)\n \t\t\tbreak;\n+\t\text4_error(sb, \"Inode table for bg 0 marked as \"\n+\t\t\t   \"needing zeroing\");\n+\t\tif (sb_rdonly(sb))\n+\t\t\treturn ngroups;\n \t}\n \n \treturn group;\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2016-6309","CWE_ID":"416","category":"security","commit_id":"acacbfa7565c78d2273c0b2a2e5e803f44afefeb","commit_message":"From acacbfa7565c78d2273c0b2a2e5e803f44afefeb Mon Sep 17 00:00:00 2001\nFrom: Matt Caswell <matt@openssl.org>\nDate: Fri, 23 Sep 2016 16:58:11 +0100\nSubject: [PATCH] Fix Use After Free for large message sizes\nMIME-Version: 1.0\nContent-Type: text\/plain; charset=utf8\nContent-Transfer-Encoding: 8bit\n\nThe buffer to receive messages is initialised to 16k. If a message is\nreceived that is larger than that then the buffer is \"realloc'd\". This can\ncause the location of the underlying buffer to change. Anything that is\nreferring to the old location will be referring to free'd data. In the\nrecent commit c1ef7c97 (master) and 4b390b6c (1.1.0) the point in the code\nwhere the message buffer is grown was changed. However s->init_msg was not\nupdated to point at the new location.\n\nCVE-2016-6309\n\nReviewed-by: Emilia K\u00c3\u00a4sper <emilia@openssl.org>\n(cherry picked from commit 0d698f6696e114a6e47f8b75ff88ec81f9e30175)\n---\n ssl\/statem\/statem.c | 20 +++++++++++++++++---\n 1 file changed, 17 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/ssl\/statem\/statem.c b\/ssl\/statem\/statem.c\nindex 5faf6aece7..caaf0687b5 100644\n--- a\/ssl\/statem\/statem.c\n+++ b\/ssl\/statem\/statem.c\n@@ -445,6 +445,21 @@ static void init_read_state_machine(SSL *s)\n     st->read_state = READ_STATE_HEADER;\n }\n \n+static int grow_init_buf(SSL *s, size_t size) {\n+\n+    size_t msg_offset = (char *)s->init_msg - s->init_buf->data;\n+\n+    if (!BUF_MEM_grow_clean(s->init_buf, (int)size))\n+        return 0;\n+\n+    if (size < msg_offset)\n+        return 0;\n+\n+    s->init_msg = s->init_buf->data + msg_offset;\n+\n+    return 1;\n+}\n+\n \/*\n  * This function implements the sub-state machine when the message flow is in\n  * MSG_FLOW_READING. The valid sub-states and transitions are:\n@@ -545,9 +560,8 @@ static SUB_STATE_RETURN read_state_machine(SSL *s)\n             \/* dtls_get_message already did this *\/\n             if (!SSL_IS_DTLS(s)\n                     && s->s3->tmp.message_size > 0\n-                    && !BUF_MEM_grow_clean(s->init_buf,\n-                                           (int)s->s3->tmp.message_size\n-                                           + SSL3_HM_HEADER_LENGTH)) {\n+                    && !grow_init_buf(s, s->s3->tmp.message_size\n+                                         + SSL3_HM_HEADER_LENGTH)) {\n                 ssl3_send_alert(s, SSL3_AL_FATAL, SSL_AD_INTERNAL_ERROR);\n                 SSLerr(SSL_F_READ_STATE_MACHINE, ERR_R_BUF_LIB);\n                 return SUB_STATE_ERROR;\n-- \n2.17.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2017-9527","CWE_ID":"416","category":"security","commit_id":"5c114c91d4ff31859fcd84cf8bf349b737b90d99","commit_message":"From 5c114c91d4ff31859fcd84cf8bf349b737b90d99 Mon Sep 17 00:00:00 2001\nFrom: \"Yukihiro \\\"Matz\\\" Matsumoto\" <matz@ruby-lang.org>\nDate: Mon, 10 Apr 2017 09:46:09 +0900\nSubject: [PATCH] Clear unused stack region that may refer freed objects; fix\n #3596\n\n---\n src\/gc.c | 13 +++++++------\n 1 file changed, 7 insertions(+), 6 deletions(-)\n\n","diff_code":"diff --git a\/src\/gc.c b\/src\/gc.c\nindex 116fd0bfd..19bc1ad4b 100644\n--- a\/src\/gc.c\n+++ b\/src\/gc.c\n@@ -544,6 +544,7 @@ mark_context_stack(mrb_state *mrb, struct mrb_context *c)\n {\n   size_t i;\n   size_t e;\n+  mrb_value nil;\n \n   if (c->stack == NULL) return;\n   e = c->stack - c->stbase;\n@@ -553,14 +554,14 @@ mark_context_stack(mrb_state *mrb, struct mrb_context *c)\n     mrb_value v = c->stbase[i];\n \n     if (!mrb_immediate_p(v)) {\n-      if (mrb_basic_ptr(v)->tt == MRB_TT_FREE) {\n-        c->stbase[i] = mrb_nil_value();\n-      }\n-      else {\n-        mrb_gc_mark(mrb, mrb_basic_ptr(v));\n-      }\n+      mrb_gc_mark(mrb, mrb_basic_ptr(v));\n     }\n   }\n+  e = c->stend - c->stbase;\n+  nil = mrb_nil_value();\n+  for (; i<e; i++) {\n+    c->stbase[i] = nil;\n+  }\n }\n \n static void\n","owner":"mruby","repo":"mruby","source":"cve"},{"CVE_ID":"CVE-2014-9906","CWE_ID":"416","category":"security","commit_id":"a56ae87a4c1c1fead7d09c3653905841ccccf1cc","commit_message":"From a56ae87a4c1c1fead7d09c3653905841ccccf1cc Mon Sep 17 00:00:00 2001\nFrom: Giovanni Bechis <giovanni@bigio.snb.it>\nDate: Tue, 9 Sep 2014 17:14:17 +0200\nSubject: [PATCH] fix use-after-free crash in RT #97625\n\n---\n dbdimp.c | 14 +++++++++++---\n 1 file changed, 11 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/dbdimp.c b\/dbdimp.c\nindex 0aaa5f1..bcb35f0 100644\n--- a\/dbdimp.c\n+++ b\/dbdimp.c\n@@ -1996,6 +1996,7 @@ static int my_login(pTHX_ SV* dbh, imp_dbh_t *imp_dbh)\n   char* password;\n   char* mysql_socket;\n   int   result;\n+  int\tfresh = 0;\n   D_imp_xxh(dbh);\n \n   \/* TODO- resolve this so that it is set only if DBI is 1.607 *\/\n@@ -2044,12 +2045,18 @@ static int my_login(pTHX_ SV* dbh, imp_dbh_t *imp_dbh)\n \t\t  port ? port : \"NULL\");\n \n   if (!imp_dbh->pmysql) {\n+     fresh = 1;\n      Newz(908, imp_dbh->pmysql, 1, MYSQL);\n   }\n   result = mysql_dr_connect(dbh, imp_dbh->pmysql, mysql_socket, host, port, user,\n \t\t\t  password, dbname, imp_dbh) ? TRUE : FALSE;\n-  if (!result)\n+  if (fresh && !result) {\n+      \/* Prevent leaks, but do not free in case of a reconnect. See #97625 *\/\n+      do_error(dbh, mysql_errno(imp_dbh->pmysql),\n+              mysql_error(imp_dbh->pmysql) ,mysql_sqlstate(imp_dbh->pmysql));\n       Safefree(imp_dbh->pmysql);\n+      imp_dbh->pmysql = NULL;\n+  }\n   return result;\n }\n \n@@ -2102,8 +2109,9 @@ int dbd_db_login(SV* dbh, imp_dbh_t* imp_dbh, char* dbname, char* user,\n \n   if (!my_login(aTHX_ dbh, imp_dbh))\n   {\n-    do_error(dbh, mysql_errno(imp_dbh->pmysql),\n-            mysql_error(imp_dbh->pmysql) ,mysql_sqlstate(imp_dbh->pmysql));\n+    if(imp_dbh->pmysql)\n+        do_error(dbh, mysql_errno(imp_dbh->pmysql),\n+                mysql_error(imp_dbh->pmysql) ,mysql_sqlstate(imp_dbh->pmysql));\n     return FALSE;\n   }\n \n","owner":"perl5-dbi","repo":"DBD-mysql","source":"cve"},{"CVE_ID":"CVE-2018-1000039","CWE_ID":"416","category":"security","commit_id":"4dcc6affe04368461310a21238f7e1871a752a05","commit_message":"From 4dcc6affe04368461310a21238f7e1871a752a05 Mon Sep 17 00:00:00 2001\nFrom: Sebastian Rasmussen <sebras@gmail.com>\nDate: Fri, 2 Feb 2018 00:37:51 +0100\nSubject: [PATCH 1\/1] Bug 698891: Keep colorspace for luminosity transparency\n group.\n\nThis was forgotten when a gray colorspace was used as a fallback\nin case a colorspace was never set. Thanks to oss-fuzz for reporting.\n---\n source\/pdf\/pdf-op-run.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/source\/pdf\/pdf-op-run.c b\/source\/pdf\/pdf-op-run.c\nindex 16c5c2f..c51bb53 100644\n--- a\/source\/pdf\/pdf-op-run.c\n+++ b\/source\/pdf\/pdf-op-run.c\n@@ -135,7 +135,7 @@ begin_softmask(fz_context *ctx, pdf_run_processor *pr, softmask_save *save)\n \tmask_colorspace = pdf_xobject_colorspace(ctx, softmask);\n \n \tif (gstate->luminosity && !mask_colorspace)\n-\t\tmask_colorspace = fz_device_gray(ctx);\n+\t\tmask_colorspace = fz_keep_colorspace(ctx, fz_device_gray(ctx));\n \n \tfz_try(ctx)\n \t{\n-- \n2.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2019-11811","CWE_ID":"416","category":"security","commit_id":"401e7e88d4ef80188ffa07095ac00456f901b8c4","commit_message":"From 401e7e88d4ef80188ffa07095ac00456f901b8c4 Mon Sep 17 00:00:00 2001\nFrom: Yang Yingliang <yangyingliang@huawei.com>\nDate: Mon, 28 Jan 2019 11:08:54 +0800\nSubject: ipmi_si: fix use-after-free of resource->name\n\nWhen we excute the following commands, we got oops\nrmmod ipmi_si\ncat \/proc\/ioports\n\n[ 1623.482380] Unable to handle kernel paging request at virtual address ffff00000901d478\n[ 1623.482382] Mem abort info:\n[ 1623.482383]   ESR = 0x96000007\n[ 1623.482385]   Exception class = DABT (current EL), IL = 32 bits\n[ 1623.482386]   SET = 0, FnV = 0\n[ 1623.482387]   EA = 0, S1PTW = 0\n[ 1623.482388] Data abort info:\n[ 1623.482389]   ISV = 0, ISS = 0x00000007\n[ 1623.482390]   CM = 0, WnR = 0\n[ 1623.482393] swapper pgtable: 4k pages, 48-bit VAs, pgdp = 00000000d7d94a66\n[ 1623.482395] [ffff00000901d478] pgd=000000dffbfff003, pud=000000dffbffe003, pmd=0000003f5d06e003, pte=0000000000000000\n[ 1623.482399] Internal error: Oops: 96000007 [#1] SMP\n[ 1623.487407] Modules linked in: ipmi_si(E) nls_utf8 isofs rpcrdma ib_iser ib_srpt target_core_mod ib_srp scsi_transport_srp ib_ipoib rdma_ucm ib_umad rdma_cm ib_cm dm_mirror dm_region_hash dm_log iw_cm dm_mod aes_ce_blk crypto_simd cryptd aes_ce_cipher ses ghash_ce sha2_ce enclosure sha256_arm64 sg sha1_ce hisi_sas_v2_hw hibmc_drm sbsa_gwdt hisi_sas_main ip_tables mlx5_ib ib_uverbs marvell ib_core mlx5_core ixgbe mdio hns_dsaf ipmi_devintf hns_enet_drv ipmi_msghandler hns_mdio [last unloaded: ipmi_si]\n[ 1623.532410] CPU: 30 PID: 11438 Comm: cat Kdump: loaded Tainted: G            E     5.0.0-rc3+ #168\n[ 1623.541498] Hardware name: Huawei TaiShan 2280 \/BC11SPCD, BIOS 1.37 11\/21\/2017\n[ 1623.548822] pstate: a0000005 (NzCv daif -PAN -UAO)\n[ 1623.553684] pc : string+0x28\/0x98\n[ 1623.557040] lr : vsnprintf+0x368\/0x5e8\n[ 1623.560837] sp : ffff000013213a80\n[ 1623.564191] x29: ffff000013213a80 x28: ffff00001138abb5\n[ 1623.569577] x27: ffff000013213c18 x26: ffff805f67d06049\n[ 1623.574963] x25: 0000000000000000 x24: ffff00001138abb5\n[ 1623.580349] x23: 0000000000000fb7 x22: ffff0000117ed000\n[ 1623.585734] x21: ffff000011188fd8 x20: ffff805f67d07000\n[ 1623.591119] x19: ffff805f67d06061 x18: ffffffffffffffff\n[ 1623.596505] x17: 0000000000000200 x16: 0000000000000000\n[ 1623.601890] x15: ffff0000117ed748 x14: ffff805f67d07000\n[ 1623.607276] x13: ffff805f67d0605e x12: 0000000000000000\n[ 1623.612661] x11: 0000000000000000 x10: 0000000000000000\n[ 1623.618046] x9 : 0000000000000000 x8 : 000000000000000f\n[ 1623.623432] x7 : ffff805f67d06061 x6 : fffffffffffffffe\n[ 1623.628817] x5 : 0000000000000012 x4 : ffff00000901d478\n[ 1623.634203] x3 : ffff0a00ffffff04 x2 : ffff805f67d07000\n[ 1623.639588] x1 : ffff805f67d07000 x0 : ffffffffffffffff\n[ 1623.644974] Process cat (pid: 11438, stack limit = 0x000000008d4cbc10)\n[ 1623.651592] Call trace:\n[ 1623.654068]  string+0x28\/0x98\n[ 1623.657071]  vsnprintf+0x368\/0x5e8\n[ 1623.660517]  seq_vprintf+0x70\/0x98\n[ 1623.668009]  seq_printf+0x7c\/0xa0\n[ 1623.675530]  r_show+0xc8\/0xf8\n[ 1623.682558]  seq_read+0x330\/0x440\n[ 1623.689877]  proc_reg_read+0x78\/0xd0\n[ 1623.697346]  __vfs_read+0x60\/0x1a0\n[ 1623.704564]  vfs_read+0x94\/0x150\n[ 1623.711339]  ksys_read+0x6c\/0xd8\n[ 1623.717939]  __arm64_sys_read+0x24\/0x30\n[ 1623.725077]  el0_svc_common+0x120\/0x148\n[ 1623.732035]  el0_svc_handler+0x30\/0x40\n[ 1623.738757]  el0_svc+0x8\/0xc\n[ 1623.744520] Code: d1000406 aa0103e2 54000149 b4000080 (39400085)\n[ 1623.753441] ---[ end trace f91b6a4937de9835 ]---\n[ 1623.760871] Kernel panic - not syncing: Fatal exception\n[ 1623.768935] SMP: stopping secondary CPUs\n[ 1623.775718] Kernel Offset: disabled\n[ 1623.781998] CPU features: 0x002,21006008\n[ 1623.788777] Memory Limit: none\n[ 1623.798329] Starting crashdump kernel...\n[ 1623.805202] Bye!\n\nIf io_setup is called successful in try_smi_init() but try_smi_init()\ngoes out_err before calling ipmi_register_smi(), so ipmi_unregister_smi()\nwill not be called while removing module. It leads to the resource that\nallocated in io_setup() can not be freed, but the name(DEVICE_NAME) of\nresource is freed while removing the module. It causes use-after-free\nwhen cat \/proc\/ioports.\n\nFix this by calling io_cleanup() while try_smi_init() goes to out_err.\nand don't call io_cleanup() until io_setup() returns successful to avoid\nwarning prints.\n\nFixes: 93c303d2045b (\"ipmi_si: Clean up shutdown a bit\")\nCc: stable@vger.kernel.org\nReported-by: NuoHan Qiao <qiaonuohan@huawei.com>\nSuggested-by: Corey Minyard <cminyard@mvista.com>\nSigned-off-by: Yang Yingliang <yangyingliang@huawei.com>\nSigned-off-by: Corey Minyard <cminyard@mvista.com>\n---\n drivers\/char\/ipmi\/ipmi_si_intf.c    | 5 +++++\n drivers\/char\/ipmi\/ipmi_si_mem_io.c  | 5 +++--\n drivers\/char\/ipmi\/ipmi_si_port_io.c | 5 +++--\n 3 files changed, 11 insertions(+), 4 deletions(-)\n\n","diff_code":"diff --git a\/drivers\/char\/ipmi\/ipmi_si_intf.c b\/drivers\/char\/ipmi\/ipmi_si_intf.c\nindex dc8603d34320..f1b9fda6b9df 100644\n--- a\/drivers\/char\/ipmi\/ipmi_si_intf.c\n+++ b\/drivers\/char\/ipmi\/ipmi_si_intf.c\n@@ -2085,6 +2085,11 @@ static int try_smi_init(struct smi_info *new_smi)\n \tWARN_ON(new_smi->io.dev->init_name != NULL);\n \n  out_err:\n+\tif (rv && new_smi->io.io_cleanup) {\n+\t\tnew_smi->io.io_cleanup(&new_smi->io);\n+\t\tnew_smi->io.io_cleanup = NULL;\n+\t}\n+\n \tkfree(init_name);\n \treturn rv;\n }\ndiff --git a\/drivers\/char\/ipmi\/ipmi_si_mem_io.c b\/drivers\/char\/ipmi\/ipmi_si_mem_io.c\nindex fd0ec8d6bf0e..75583612ab10 100644\n--- a\/drivers\/char\/ipmi\/ipmi_si_mem_io.c\n+++ b\/drivers\/char\/ipmi\/ipmi_si_mem_io.c\n@@ -81,8 +81,6 @@ int ipmi_si_mem_setup(struct si_sm_io *io)\n \tif (!addr)\n \t\treturn -ENODEV;\n \n-\tio->io_cleanup = mem_cleanup;\n-\n \t\/*\n \t * Figure out the actual readb\/readw\/readl\/etc routine to use based\n \t * upon the register size.\n@@ -141,5 +139,8 @@ int ipmi_si_mem_setup(struct si_sm_io *io)\n \t\tmem_region_cleanup(io, io->io_size);\n \t\treturn -EIO;\n \t}\n+\n+\tio->io_cleanup = mem_cleanup;\n+\n \treturn 0;\n }\ndiff --git a\/drivers\/char\/ipmi\/ipmi_si_port_io.c b\/drivers\/char\/ipmi\/ipmi_si_port_io.c\nindex ef6dffcea9fa..03924c32b6e9 100644\n--- a\/drivers\/char\/ipmi\/ipmi_si_port_io.c\n+++ b\/drivers\/char\/ipmi\/ipmi_si_port_io.c\n@@ -68,8 +68,6 @@ int ipmi_si_port_setup(struct si_sm_io *io)\n \tif (!addr)\n \t\treturn -ENODEV;\n \n-\tio->io_cleanup = port_cleanup;\n-\n \t\/*\n \t * Figure out the actual inb\/inw\/inl\/etc routine to use based\n \t * upon the register size.\n@@ -109,5 +107,8 @@ int ipmi_si_port_setup(struct si_sm_io *io)\n \t\t\treturn -EIO;\n \t\t}\n \t}\n+\n+\tio->io_cleanup = port_cleanup;\n+\n \treturn 0;\n }\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2018-10675","CWE_ID":"416","category":"security","commit_id":"73223e4e2e3867ebf033a5a8eb2e5df0158ccc99","commit_message":"From 73223e4e2e3867ebf033a5a8eb2e5df0158ccc99 Mon Sep 17 00:00:00 2001\nFrom: zhong jiang <zhongjiang@huawei.com>\nDate: Fri, 18 Aug 2017 15:16:24 -0700\nSubject: mm\/mempolicy: fix use after free when calling get_mempolicy\n\nI hit a use after free issue when executing trinity and repoduced it\nwith KASAN enabled.  The related call trace is as follows.\n\n  BUG: KASan: use after free in SyS_get_mempolicy+0x3c8\/0x960 at addr ffff8801f582d766\n  Read of size 2 by task syz-executor1\/798\n\n  INFO: Allocated in mpol_new.part.2+0x74\/0x160 age=3 cpu=1 pid=799\n     __slab_alloc+0x768\/0x970\n     kmem_cache_alloc+0x2e7\/0x450\n     mpol_new.part.2+0x74\/0x160\n     mpol_new+0x66\/0x80\n     SyS_mbind+0x267\/0x9f0\n     system_call_fastpath+0x16\/0x1b\n  INFO: Freed in __mpol_put+0x2b\/0x40 age=4 cpu=1 pid=799\n     __slab_free+0x495\/0x8e0\n     kmem_cache_free+0x2f3\/0x4c0\n     __mpol_put+0x2b\/0x40\n     SyS_mbind+0x383\/0x9f0\n     system_call_fastpath+0x16\/0x1b\n  INFO: Slab 0xffffea0009cb8dc0 objects=23 used=8 fp=0xffff8801f582de40 flags=0x200000000004080\n  INFO: Object 0xffff8801f582d760 @offset=5984 fp=0xffff8801f582d600\n\n  Bytes b4 ffff8801f582d750: ae 01 ff ff 00 00 00 00 5a 5a 5a 5a 5a 5a 5a 5a  ........ZZZZZZZZ\n  Object ffff8801f582d760: 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b 6b  kkkkkkkkkkkkkkkk\n  Object ffff8801f582d770: 6b 6b 6b 6b 6b 6b 6b a5                          kkkkkkk.\n  Redzone ffff8801f582d778: bb bb bb bb bb bb bb bb                          ........\n  Padding ffff8801f582d8b8: 5a 5a 5a 5a 5a 5a 5a 5a                          ZZZZZZZZ\n  Memory state around the buggy address:\n  ffff8801f582d600: fb fb fb fc fc fc fc fc fc fc fc fc fc fc fc fc\n  ffff8801f582d680: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc\n  >ffff8801f582d700: fc fc fc fc fc fc fc fc fc fc fc fc fb fb fb fc\n\n!shared memory policy is not protected against parallel removal by other\nthread which is normally protected by the mmap_sem.  do_get_mempolicy,\nhowever, drops the lock midway while we can still access it later.\n\nEarly premature up_read is a historical artifact from times when\nput_user was called in this path see https:\/\/lwn.net\/Articles\/124754\/\nbut that is gone since 8bccd85ffbaf (\"[PATCH] Implement sys_* do_*\nlayering in the memory policy layer.\").  but when we have the the\ncurrent mempolicy ref count model.  The issue was introduced\naccordingly.\n\nFix the issue by removing the premature release.\n\nLink: http:\/\/lkml.kernel.org\/r\/1502950924-27521-1-git-send-email-zhongjiang@huawei.com\nSigned-off-by: zhong jiang <zhongjiang@huawei.com>\nAcked-by: Michal Hocko <mhocko@suse.com>\nCc: Minchan Kim <minchan@kernel.org>\nCc: Vlastimil Babka <vbabka@suse.cz>\nCc: David Rientjes <rientjes@google.com>\nCc: Mel Gorman <mgorman@techsingularity.net>\nCc: <stable@vger.kernel.org>\t[2.6+]\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n mm\/mempolicy.c | 5 -----\n 1 file changed, 5 deletions(-)\n\n","diff_code":"diff --git a\/mm\/mempolicy.c b\/mm\/mempolicy.c\nindex d911fa5cb2a7..618ab125228b 100644\n--- a\/mm\/mempolicy.c\n+++ b\/mm\/mempolicy.c\n@@ -861,11 +861,6 @@ static long do_get_mempolicy(int *policy, nodemask_t *nmask,\n \t\t*policy |= (pol->flags & MPOL_MODE_FLAGS);\n \t}\n \n-\tif (vma) {\n-\t\tup_read(&current->mm->mmap_sem);\n-\t\tvma = NULL;\n-\t}\n-\n \terr = 0;\n \tif (nmask) {\n \t\tif (mpol_store_user_nodemask(pol)) {\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-16943","CWE_ID":"416","category":"security","commit_id":"4e6ae6235c68de243b1c2419027472d7659aa2b4","commit_message":"From 4e6ae6235c68de243b1c2419027472d7659aa2b4 Mon Sep 17 00:00:00 2001\nFrom: Jeremy Harris <jgh146exb@wizmail.org>\nDate: Fri, 24 Nov 2017 20:22:33 +0000\nSubject: [PATCH] Avoid release of store if there have been later allocations. \n Bug 2199\n\n---\n src\/src\/receive.c | 7 ++++---\n 1 file changed, 4 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/src\/src\/receive.c b\/src\/src\/receive.c\nindex e7e518a..d9b5001 100644\n--- a\/src\/src\/receive.c\n+++ b\/src\/src\/receive.c\n@@ -1810,8 +1810,8 @@ for (;;)\n   (and sometimes lunatic messages can have ones that are 100s of K long) we\n   call store_release() for strings that have been copied - if the string is at\n   the start of a block (and therefore the only thing in it, because we aren't\n-  doing any other gets), the block gets freed. We can only do this because we\n-  know there are no other calls to store_get() going on. *\/\n+  doing any other gets), the block gets freed. We can only do this release if\n+  there were no allocations since the once that we want to free. *\/\n \n   if (ptr >= header_size - 4)\n     {\n@@ -1820,9 +1820,10 @@ for (;;)\n     header_size *= 2;\n     if (!store_extend(next->text, oldsize, header_size))\n       {\n+      BOOL release_ok = store_last_get[store_pool] == next->text;\n       uschar *newtext = store_get(header_size);\n       memcpy(newtext, next->text, ptr);\n-      store_release(next->text);\n+      if (release_ok) store_release(next->text);\n       next->text = newtext;\n       }\n     }\n-- \n1.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2017-7374","CWE_ID":"416","category":"security","commit_id":"1b53cf9815bb4744958d41f3795d5d5a1d365e2d","commit_message":"From 1b53cf9815bb4744958d41f3795d5d5a1d365e2d Mon Sep 17 00:00:00 2001\nFrom: Eric Biggers <ebiggers@google.com>\nDate: Tue, 21 Feb 2017 15:07:11 -0800\nSubject: fscrypt: remove broken support for detecting keyring key revocation\n\nFilesystem encryption ostensibly supported revoking a keyring key that\nhad been used to \"unlock\" encrypted files, causing those files to become\n\"locked\" again.  This was, however, buggy for several reasons, the most\nsevere of which was that when key revocation happened to be detected for\nan inode, its fscrypt_info was immediately freed, even while other\nthreads could be using it for encryption or decryption concurrently.\nThis could be exploited to crash the kernel or worse.\n\nThis patch fixes the use-after-free by removing the code which detects\nthe keyring key having been revoked, invalidated, or expired.  Instead,\nan encrypted inode that is \"unlocked\" now simply remains unlocked until\nit is evicted from memory.  Note that this is no worse than the case for\nblock device-level encryption, e.g. dm-crypt, and it still remains\npossible for a privileged user to evict unused pages, inodes, and\ndentries by running 'sync; echo 3 > \/proc\/sys\/vm\/drop_caches', or by\nsimply unmounting the filesystem.  In fact, one of those actions was\nalready needed anyway for key revocation to work even somewhat sanely.\nThis change is not expected to break any applications.\n\nIn the future I'd like to implement a real API for fscrypt key\nrevocation that interacts sanely with ongoing filesystem operations ---\nwaiting for existing operations to complete and blocking new operations,\nand invalidating and sanitizing key material and plaintext from the VFS\ncaches.  But this is a hard problem, and for now this bug must be fixed.\n\nThis bug affected almost all versions of ext4, f2fs, and ubifs\nencryption, and it was potentially reachable in any kernel configured\nwith encryption support (CONFIG_EXT4_ENCRYPTION=y,\nCONFIG_EXT4_FS_ENCRYPTION=y, CONFIG_F2FS_FS_ENCRYPTION=y, or\nCONFIG_UBIFS_FS_ENCRYPTION=y).  Note that older kernels did not use the\nshared fs\/crypto\/ code, but due to the potential security implications\nof this bug, it may still be worthwhile to backport this fix to them.\n\nFixes: b7236e21d55f (\"ext4 crypto: reorganize how we store keys in the inode\")\nCc: stable@vger.kernel.org # v4.2+\nSigned-off-by: Eric Biggers <ebiggers@google.com>\nSigned-off-by: Theodore Ts'o <tytso@mit.edu>\nAcked-by: Michael Halcrow <mhalcrow@google.com>\n---\n fs\/crypto\/crypto.c          | 10 +--------\n fs\/crypto\/fname.c           |  2 +-\n fs\/crypto\/fscrypt_private.h |  4 ----\n fs\/crypto\/keyinfo.c         | 52 ++++++++-------------------------------------\n 4 files changed, 11 insertions(+), 57 deletions(-)\n\n","diff_code":"diff --git a\/fs\/crypto\/crypto.c b\/fs\/crypto\/crypto.c\nindex 02a7a9286449..6d6eca394d4d 100644\n--- a\/fs\/crypto\/crypto.c\n+++ b\/fs\/crypto\/crypto.c\n@@ -327,7 +327,6 @@ EXPORT_SYMBOL(fscrypt_decrypt_page);\n static int fscrypt_d_revalidate(struct dentry *dentry, unsigned int flags)\n {\n \tstruct dentry *dir;\n-\tstruct fscrypt_info *ci;\n \tint dir_has_key, cached_with_key;\n \n \tif (flags & LOOKUP_RCU)\n@@ -339,18 +338,11 @@ static int fscrypt_d_revalidate(struct dentry *dentry, unsigned int flags)\n \t\treturn 0;\n \t}\n \n-\tci = d_inode(dir)->i_crypt_info;\n-\tif (ci && ci->ci_keyring_key &&\n-\t    (ci->ci_keyring_key->flags & ((1 << KEY_FLAG_INVALIDATED) |\n-\t\t\t\t\t  (1 << KEY_FLAG_REVOKED) |\n-\t\t\t\t\t  (1 << KEY_FLAG_DEAD))))\n-\t\tci = NULL;\n-\n \t\/* this should eventually be an flag in d_flags *\/\n \tspin_lock(&dentry->d_lock);\n \tcached_with_key = dentry->d_flags & DCACHE_ENCRYPTED_WITH_KEY;\n \tspin_unlock(&dentry->d_lock);\n-\tdir_has_key = (ci != NULL);\n+\tdir_has_key = (d_inode(dir)->i_crypt_info != NULL);\n \tdput(dir);\n \n \t\/*\ndiff --git a\/fs\/crypto\/fname.c b\/fs\/crypto\/fname.c\nindex 13052b85c393..37b49894c762 100644\n--- a\/fs\/crypto\/fname.c\n+++ b\/fs\/crypto\/fname.c\n@@ -350,7 +350,7 @@ int fscrypt_setup_filename(struct inode *dir, const struct qstr *iname,\n \t\tfname->disk_name.len = iname->len;\n \t\treturn 0;\n \t}\n-\tret = fscrypt_get_crypt_info(dir);\n+\tret = fscrypt_get_encryption_info(dir);\n \tif (ret && ret != -EOPNOTSUPP)\n \t\treturn ret;\n \ndiff --git a\/fs\/crypto\/fscrypt_private.h b\/fs\/crypto\/fscrypt_private.h\nindex fdbb8af32eaf..e39696e64494 100644\n--- a\/fs\/crypto\/fscrypt_private.h\n+++ b\/fs\/crypto\/fscrypt_private.h\n@@ -67,7 +67,6 @@ struct fscrypt_info {\n \tu8 ci_filename_mode;\n \tu8 ci_flags;\n \tstruct crypto_skcipher *ci_ctfm;\n-\tstruct key *ci_keyring_key;\n \tu8 ci_master_key[FS_KEY_DESCRIPTOR_SIZE];\n };\n \n@@ -101,7 +100,4 @@ extern int fscrypt_do_page_crypto(const struct inode *inode,\n extern struct page *fscrypt_alloc_bounce_page(struct fscrypt_ctx *ctx,\n \t\t\t\t\t      gfp_t gfp_flags);\n \n-\/* keyinfo.c *\/\n-extern int fscrypt_get_crypt_info(struct inode *);\n-\n #endif \/* _FSCRYPT_PRIVATE_H *\/\ndiff --git a\/fs\/crypto\/keyinfo.c b\/fs\/crypto\/keyinfo.c\nindex 02eb6b9e4438..cb3e82abf034 100644\n--- a\/fs\/crypto\/keyinfo.c\n+++ b\/fs\/crypto\/keyinfo.c\n@@ -95,6 +95,7 @@ static int validate_user_key(struct fscrypt_info *crypt_info,\n \tkfree(description);\n \tif (IS_ERR(keyring_key))\n \t\treturn PTR_ERR(keyring_key);\n+\tdown_read(&keyring_key->sem);\n \n \tif (keyring_key->type != &key_type_logon) {\n \t\tprintk_once(KERN_WARNING\n@@ -102,11 +103,9 @@ static int validate_user_key(struct fscrypt_info *crypt_info,\n \t\tres = -ENOKEY;\n \t\tgoto out;\n \t}\n-\tdown_read(&keyring_key->sem);\n \tukp = user_key_payload(keyring_key);\n \tif (ukp->datalen != sizeof(struct fscrypt_key)) {\n \t\tres = -EINVAL;\n-\t\tup_read(&keyring_key->sem);\n \t\tgoto out;\n \t}\n \tmaster_key = (struct fscrypt_key *)ukp->data;\n@@ -117,17 +116,11 @@ static int validate_user_key(struct fscrypt_info *crypt_info,\n \t\t\t\t\"%s: key size incorrect: %d\\n\",\n \t\t\t\t__func__, master_key->size);\n \t\tres = -ENOKEY;\n-\t\tup_read(&keyring_key->sem);\n \t\tgoto out;\n \t}\n \tres = derive_key_aes(ctx->nonce, master_key->raw, raw_key);\n-\tup_read(&keyring_key->sem);\n-\tif (res)\n-\t\tgoto out;\n-\n-\tcrypt_info->ci_keyring_key = keyring_key;\n-\treturn 0;\n out:\n+\tup_read(&keyring_key->sem);\n \tkey_put(keyring_key);\n \treturn res;\n }\n@@ -169,12 +162,11 @@ static void put_crypt_info(struct fscrypt_info *ci)\n \tif (!ci)\n \t\treturn;\n \n-\tkey_put(ci->ci_keyring_key);\n \tcrypto_free_skcipher(ci->ci_ctfm);\n \tkmem_cache_free(fscrypt_info_cachep, ci);\n }\n \n-int fscrypt_get_crypt_info(struct inode *inode)\n+int fscrypt_get_encryption_info(struct inode *inode)\n {\n \tstruct fscrypt_info *crypt_info;\n \tstruct fscrypt_context ctx;\n@@ -184,21 +176,15 @@ int fscrypt_get_crypt_info(struct inode *inode)\n \tu8 *raw_key = NULL;\n \tint res;\n \n+\tif (inode->i_crypt_info)\n+\t\treturn 0;\n+\n \tres = fscrypt_initialize(inode->i_sb->s_cop->flags);\n \tif (res)\n \t\treturn res;\n \n \tif (!inode->i_sb->s_cop->get_context)\n \t\treturn -EOPNOTSUPP;\n-retry:\n-\tcrypt_info = ACCESS_ONCE(inode->i_crypt_info);\n-\tif (crypt_info) {\n-\t\tif (!crypt_info->ci_keyring_key ||\n-\t\t\t\tkey_validate(crypt_info->ci_keyring_key) == 0)\n-\t\t\treturn 0;\n-\t\tfscrypt_put_encryption_info(inode, crypt_info);\n-\t\tgoto retry;\n-\t}\n \n \tres = inode->i_sb->s_cop->get_context(inode, &ctx, sizeof(ctx));\n \tif (res < 0) {\n@@ -229,7 +215,6 @@ retry:\n \tcrypt_info->ci_data_mode = ctx.contents_encryption_mode;\n \tcrypt_info->ci_filename_mode = ctx.filenames_encryption_mode;\n \tcrypt_info->ci_ctfm = NULL;\n-\tcrypt_info->ci_keyring_key = NULL;\n \tmemcpy(crypt_info->ci_master_key, ctx.master_key_descriptor,\n \t\t\t\tsizeof(crypt_info->ci_master_key));\n \n@@ -273,14 +258,8 @@ retry:\n \tif (res)\n \t\tgoto out;\n \n-\tkzfree(raw_key);\n-\traw_key = NULL;\n-\tif (cmpxchg(&inode->i_crypt_info, NULL, crypt_info) != NULL) {\n-\t\tput_crypt_info(crypt_info);\n-\t\tgoto retry;\n-\t}\n-\treturn 0;\n-\n+\tif (cmpxchg(&inode->i_crypt_info, NULL, crypt_info) == NULL)\n+\t\tcrypt_info = NULL;\n out:\n \tif (res == -ENOKEY)\n \t\tres = 0;\n@@ -288,6 +267,7 @@ out:\n \tkzfree(raw_key);\n \treturn res;\n }\n+EXPORT_SYMBOL(fscrypt_get_encryption_info);\n \n void fscrypt_put_encryption_info(struct inode *inode, struct fscrypt_info *ci)\n {\n@@ -305,17 +285,3 @@ void fscrypt_put_encryption_info(struct inode *inode, struct fscrypt_info *ci)\n \tput_crypt_info(ci);\n }\n EXPORT_SYMBOL(fscrypt_put_encryption_info);\n-\n-int fscrypt_get_encryption_info(struct inode *inode)\n-{\n-\tstruct fscrypt_info *ci = inode->i_crypt_info;\n-\n-\tif (!ci ||\n-\t\t(ci->ci_keyring_key &&\n-\t\t (ci->ci_keyring_key->flags & ((1 << KEY_FLAG_INVALIDATED) |\n-\t\t\t\t\t       (1 << KEY_FLAG_REVOKED) |\n-\t\t\t\t\t       (1 << KEY_FLAG_DEAD)))))\n-\t\treturn fscrypt_get_crypt_info(inode);\n-\treturn 0;\n-}\n-EXPORT_SYMBOL(fscrypt_get_encryption_info);\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-16528","CWE_ID":"416","category":"security","commit_id":"fc27fe7e8deef2f37cba3f2be2d52b6ca5eb9d57","commit_message":"From fc27fe7e8deef2f37cba3f2be2d52b6ca5eb9d57 Mon Sep 17 00:00:00 2001\nFrom: Takashi Iwai <tiwai@suse.de>\nDate: Tue, 12 Sep 2017 12:41:20 +0200\nSubject: [PATCH] ALSA: seq: Cancel pending autoload work at unbinding device\n\nALSA sequencer core has a mechanism to load the enumerated devices\nautomatically, and it's performed in an off-load work.  This seems\ncausing some race when a sequencer is removed while the pending\nautoload work is running.  As syzkaller spotted, it may lead to some\nuse-after-free:\n  BUG: KASAN: use-after-free in snd_rawmidi_dev_seq_free+0x69\/0x70\n  sound\/core\/rawmidi.c:1617\n  Write of size 8 at addr ffff88006c611d90 by task kworker\/2:1\/567\n\n  CPU: 2 PID: 567 Comm: kworker\/2:1 Not tainted 4.13.0+ #29\n  Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01\/01\/2011\n  Workqueue: events autoload_drivers\n  Call Trace:\n   __dump_stack lib\/dump_stack.c:16 [inline]\n   dump_stack+0x192\/0x22c lib\/dump_stack.c:52\n   print_address_description+0x78\/0x280 mm\/kasan\/report.c:252\n   kasan_report_error mm\/kasan\/report.c:351 [inline]\n   kasan_report+0x230\/0x340 mm\/kasan\/report.c:409\n   __asan_report_store8_noabort+0x1c\/0x20 mm\/kasan\/report.c:435\n   snd_rawmidi_dev_seq_free+0x69\/0x70 sound\/core\/rawmidi.c:1617\n   snd_seq_dev_release+0x4f\/0x70 sound\/core\/seq_device.c:192\n   device_release+0x13f\/0x210 drivers\/base\/core.c:814\n   kobject_cleanup lib\/kobject.c:648 [inline]\n   kobject_release lib\/kobject.c:677 [inline]\n   kref_put include\/linux\/kref.h:70 [inline]\n   kobject_put+0x145\/0x240 lib\/kobject.c:694\n   put_device+0x25\/0x30 drivers\/base\/core.c:1799\n   klist_devices_put+0x36\/0x40 drivers\/base\/bus.c:827\n   klist_next+0x264\/0x4a0 lib\/klist.c:403\n   next_device drivers\/base\/bus.c:270 [inline]\n   bus_for_each_dev+0x17e\/0x210 drivers\/base\/bus.c:312\n   autoload_drivers+0x3b\/0x50 sound\/core\/seq_device.c:117\n   process_one_work+0x9fb\/0x1570 kernel\/workqueue.c:2097\n   worker_thread+0x1e4\/0x1350 kernel\/workqueue.c:2231\n   kthread+0x324\/0x3f0 kernel\/kthread.c:231\n   ret_from_fork+0x25\/0x30 arch\/x86\/entry\/entry_64.S:425\n\nThe fix is simply to assure canceling the autoload work at removing\nthe device.\n\nReported-by: Andrey Konovalov <andreyknvl@google.com>\nTested-by: Andrey Konovalov <andreyknvl@google.com>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Takashi Iwai <tiwai@suse.de>\n---\n sound\/core\/seq_device.c | 3 +++\n 1 file changed, 3 insertions(+)\n\n","diff_code":"diff --git a\/sound\/core\/seq_device.c b\/sound\/core\/seq_device.c\nindex c4acf17e9f5e5..e40a2cba5002a 100644\n--- a\/sound\/core\/seq_device.c\n+++ b\/sound\/core\/seq_device.c\n@@ -148,8 +148,10 @@ void snd_seq_device_load_drivers(void)\n \tflush_work(&autoload_work);\n }\n EXPORT_SYMBOL(snd_seq_device_load_drivers);\n+#define cancel_autoload_drivers()\tcancel_work_sync(&autoload_work)\n #else\n #define queue_autoload_drivers() \/* NOP *\/\n+#define cancel_autoload_drivers() \/* NOP *\/\n #endif\n \n \/*\n@@ -159,6 +161,7 @@ static int snd_seq_device_dev_free(struct snd_device *device)\n {\n \tstruct snd_seq_device *dev = device->device_data;\n \n+\tcancel_autoload_drivers();\n \tput_device(&dev->dev);\n \treturn 0;\n }\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2018-16541","CWE_ID":"416","category":"security","commit_id":"241d91112771a6104de10b3948c3f350d6690c1d","commit_message":"From 241d91112771a6104de10b3948c3f350d6690c1d Mon Sep 17 00:00:00 2001\nFrom: Chris Liddell <chris.liddell@artifex.com>\nDate: Thu, 23 Aug 2018 15:41:18 +0100\nSubject: [PATCH] Bug 699664: Ensure the correct is in place before cleanup\n\nIf the PS job replaces the device and leaves that graphics state in place, we\nwouldn't cleanup the default device in the normal way, but rely on the garbage\ncollector.\n\nThis works (but isn't ideal), *except* when the job replaces the device with\nthe null device (using the nulldevice operator) - this means that\n.uninstallpagedevice doesn't replace the existing device with the nulldevice\n(since it is already installed), the device from the graphics ends up being\nfreed - and as it is the nulldevice, which we rely on, memory corruption\nand a segfault can happen.\n\nWe avoid this by checking if the current device is the nulldevice, and if so,\nrestoring it away, before continuing with the device cleanup.\n---\n psi\/imain.c | 10 ++++++++++\n 1 file changed, 10 insertions(+)\n\n","diff_code":"diff --git a\/psi\/imain.c b\/psi\/imain.c\nindex 2fe1546..138bfc8 100644\n--- a\/psi\/imain.c\n+++ b\/psi\/imain.c\n@@ -936,6 +936,16 @@ gs_main_finit(gs_main_instance * minst, int exit_status, int code)\n             i_ctx_p = minst->i_ctx_p; \/* interp_reclaim could change it. *\/\n         }\n \n+        if (i_ctx_p->pgs != NULL && i_ctx_p->pgs->device != NULL &&\n+            gx_device_is_null(i_ctx_p->pgs->device)) {\n+            \/* if the job replaced the device with the nulldevice, we we need to grestore\n+               away that device, so the block below can properly dispense\n+               with the default device.\n+             *\/\n+            int code = gs_grestoreall(i_ctx_p->pgs);\n+            if (code < 0) return_error(gs_error_Fatal);\n+        }\n+\n         if (i_ctx_p->pgs != NULL && i_ctx_p->pgs->device != NULL) {\n             gx_device *pdev = i_ctx_p->pgs->device;\n             const char * dname = pdev->dname;\n-- \n2.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2017-15129","CWE_ID":"416","category":"security","commit_id":"21b5944350052d2583e82dd59b19a9ba94a007f0","commit_message":"From 21b5944350052d2583e82dd59b19a9ba94a007f0 Mon Sep 17 00:00:00 2001\nFrom: \"Eric W. Biederman\" <ebiederm@xmission.com>\nDate: Tue, 19 Dec 2017 11:27:56 -0600\nSubject: net: Fix double free and memory corruption in get_net_ns_by_id()\n\n(I can trivially verify that that idr_remove in cleanup_net happens\n after the network namespace count has dropped to zero --EWB)\n\nFunction get_net_ns_by_id() does not check for net::count\nafter it has found a peer in netns_ids idr.\n\nIt may dereference a peer, after its count has already been\nfinaly decremented. This leads to double free and memory\ncorruption:\n\nput_net(peer)                                   rtnl_lock()\natomic_dec_and_test(&peer->count) [count=0]     ...\n__put_net(peer)                                 get_net_ns_by_id(net, id)\n  spin_lock(&cleanup_list_lock)\n  list_add(&net->cleanup_list, &cleanup_list)\n  spin_unlock(&cleanup_list_lock)\nqueue_work()                                      peer = idr_find(&net->netns_ids, id)\n  |                                               get_net(peer) [count=1]\n  |                                               ...\n  |                                               (use after final put)\n  v                                               ...\n  cleanup_net()                                   ...\n    spin_lock(&cleanup_list_lock)                 ...\n    list_replace_init(&cleanup_list, ..)          ...\n    spin_unlock(&cleanup_list_lock)               ...\n    ...                                           ...\n    ...                                           put_net(peer)\n    ...                                             atomic_dec_and_test(&peer->count) [count=0]\n    ...                                               spin_lock(&cleanup_list_lock)\n    ...                                               list_add(&net->cleanup_list, &cleanup_list)\n    ...                                               spin_unlock(&cleanup_list_lock)\n    ...                                             queue_work()\n    ...                                           rtnl_unlock()\n    rtnl_lock()                                   ...\n    for_each_net(tmp) {                           ...\n      id = __peernet2id(tmp, peer)                ...\n      spin_lock_irq(&tmp->nsid_lock)              ...\n      idr_remove(&tmp->netns_ids, id)             ...\n      ...                                         ...\n      net_drop_ns()                               ...\n\tnet_free(peer)                            ...\n    }                                             ...\n  |\n  v\n  cleanup_net()\n    ...\n    (Second free of peer)\n\nAlso, put_net() on the right cpu may reorder with left's cpu\nlist_replace_init(&cleanup_list, ..), and then cleanup_list\nwill be corrupted.\n\nSince cleanup_net() is executed in worker thread, while\nput_net(peer) can happen everywhere, there should be\nenough time for concurrent get_net_ns_by_id() to pick\nthe peer up, and the race does not seem to be unlikely.\nThe patch fixes the problem in standard way.\n\n(Also, there is possible problem in peernet2id_alloc(), which requires\ncheck for net::count under nsid_lock and maybe_get_net(peer), but\nin current stable kernel it's used under rtnl_lock() and it has to be\nsafe. Openswitch begun to use peernet2id_alloc(), and possibly it should\nbe fixed too. While this is not in stable kernel yet, so I'll send\na separate message to netdev@ later).\n\nCc: Nicolas Dichtel <nicolas.dichtel@6wind.com>\nSigned-off-by: Kirill Tkhai <ktkhai@virtuozzo.com>\nFixes: 0c7aecd4bde4 \"netns: add rtnl cmd to add and get peer netns ids\"\nReviewed-by: Andrey Ryabinin <aryabinin@virtuozzo.com>\nReviewed-by: \"Eric W. Biederman\" <ebiederm@xmission.com>\nSigned-off-by: Eric W. Biederman <ebiederm@xmission.com>\nReviewed-by: Eric Dumazet <edumazet@google.com>\nAcked-by: Nicolas Dichtel <nicolas.dichtel@6wind.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n---\n net\/core\/net_namespace.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/net\/core\/net_namespace.c b\/net\/core\/net_namespace.c\nindex b797832565d3..60a71be75aea 100644\n--- a\/net\/core\/net_namespace.c\n+++ b\/net\/core\/net_namespace.c\n@@ -267,7 +267,7 @@ struct net *get_net_ns_by_id(struct net *net, int id)\n \tspin_lock_bh(&net->nsid_lock);\n \tpeer = idr_find(&net->netns_ids, id);\n \tif (peer)\n-\t\tget_net(peer);\n+\t\tpeer = maybe_get_net(peer);\n \tspin_unlock_bh(&net->nsid_lock);\n \trcu_read_unlock();\n \n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2019-3817","CWE_ID":"416","category":"security","commit_id":"e3a5d056633677959ad924a51758876d415e7046","commit_message":"From e3a5d056633677959ad924a51758876d415e7046 Mon Sep 17 00:00:00 2001\nFrom: Riccardo Schirone <rschiron@redhat.com>\nDate: Mon, 21 Jan 2019 18:11:42 +0100\nSubject: [PATCH] Fix UAF in comps_objmrtree_unite function\n\nThe added field is not used at all in many places and it is probably the\nleft-over of some copy-paste.\n---\n libcomps\/src\/comps_mradix.c    | 2 --\n libcomps\/src\/comps_objmradix.c | 2 --\n libcomps\/src\/comps_objradix.c  | 2 --\n libcomps\/src\/comps_radix.c     | 1 -\n 4 files changed, 7 deletions(-)\n\n","diff_code":"diff --git a\/libcomps\/src\/comps_mradix.c b\/libcomps\/src\/comps_mradix.c\nindex 8ef9640..dfdee8e 100644\n--- a\/libcomps\/src\/comps_mradix.c\n+++ b\/libcomps\/src\/comps_mradix.c\n@@ -177,7 +177,6 @@ void comps_mrtree_unite(COMPS_MRTree *rt1, COMPS_MRTree *rt2) {\n     struct Pair {\n         COMPS_HSList * subnodes;\n         char * key;\n-        char added;\n     } *pair, *parent_pair;\n \n     pair = malloc(sizeof(struct Pair));\n@@ -195,7 +194,6 @@ void comps_mrtree_unite(COMPS_MRTree *rt1, COMPS_MRTree *rt2) {\n         parent_pair = (struct Pair*) it->data;\n         free(it);\n \n-        pair->added = 0;\n         for (it = tmp_subnodes->first; it != NULL; it=it->next) {\n             pair = malloc(sizeof(struct Pair));\n             pair->subnodes = ((COMPS_MRTreeData*)it->data)->subnodes;\ndiff --git a\/libcomps\/src\/comps_objmradix.c b\/libcomps\/src\/comps_objmradix.c\nindex 9a2038b..22ad262 100644\n--- a\/libcomps\/src\/comps_objmradix.c\n+++ b\/libcomps\/src\/comps_objmradix.c\n@@ -285,7 +285,6 @@ void comps_objmrtree_unite(COMPS_ObjMRTree *rt1, COMPS_ObjMRTree *rt2) {\n     struct Pair {\n         COMPS_HSList * subnodes;\n         char * key;\n-        char added;\n     } *pair, *parent_pair;\n \n     pair = malloc(sizeof(struct Pair));\n@@ -303,7 +302,6 @@ void comps_objmrtree_unite(COMPS_ObjMRTree *rt1, COMPS_ObjMRTree *rt2) {\n         parent_pair = (struct Pair*) it->data;\n         free(it);\n \n-        pair->added = 0;\n         for (it = tmp_subnodes->first; it != NULL; it=it->next) {\n             pair = malloc(sizeof(struct Pair));\n             pair->subnodes = ((COMPS_ObjMRTreeData*)it->data)->subnodes;\ndiff --git a\/libcomps\/src\/comps_objradix.c b\/libcomps\/src\/comps_objradix.c\nindex c657b75..840592a 100644\n--- a\/libcomps\/src\/comps_objradix.c\n+++ b\/libcomps\/src\/comps_objradix.c\n@@ -697,7 +697,6 @@ void comps_objrtree_unite(COMPS_ObjRTree *rt1, COMPS_ObjRTree *rt2) {\n     struct Pair {\n         COMPS_HSList * subnodes;\n         char * key;\n-        char added;\n     } *pair, *parent_pair;\n \n     pair = malloc(sizeof(struct Pair));\n@@ -716,7 +715,6 @@ void comps_objrtree_unite(COMPS_ObjRTree *rt1, COMPS_ObjRTree *rt2) {\n         \/\/printf(\"key-part:%s\\n\", parent_pair->key);\n         free(it);\n \n-        \/\/pair->added = 0;\n         for (it = tmp_subnodes->first; it != NULL; it=it->next) {\n             pair = malloc(sizeof(struct Pair));\n             pair->subnodes = ((COMPS_ObjRTreeData*)it->data)->subnodes;\ndiff --git a\/libcomps\/src\/comps_radix.c b\/libcomps\/src\/comps_radix.c\nindex ada4fda..05dcaf2 100644\n--- a\/libcomps\/src\/comps_radix.c\n+++ b\/libcomps\/src\/comps_radix.c\n@@ -529,7 +529,6 @@ void comps_rtree_unite(COMPS_RTree *rt1, COMPS_RTree *rt2) {\n     struct Pair {\n         COMPS_HSList * subnodes;\n         char * key;\n-        char added;\n     } *pair, *parent_pair;\n \n     pair = malloc(sizeof(struct Pair));\n","owner":"rpm-software-management","repo":"libcomps","source":"cve"},{"CVE_ID":"CVE-2017-17053","CWE_ID":"416","category":"security","commit_id":"ccd5b3235180eef3cfec337df1c8554ab151b5cc","commit_message":"From ccd5b3235180eef3cfec337df1c8554ab151b5cc Mon Sep 17 00:00:00 2001\nFrom: Eric Biggers <ebiggers@google.com>\nDate: Thu, 24 Aug 2017 10:50:29 -0700\nSubject: x86\/mm: Fix use-after-free of ldt_struct\n\nThe following commit:\n\n  39a0526fb3f7 (\"x86\/mm: Factor out LDT init from context init\")\n\nrenamed init_new_context() to init_new_context_ldt() and added a new\ninit_new_context() which calls init_new_context_ldt().  However, the\nerror code of init_new_context_ldt() was ignored.  Consequently, if a\nmemory allocation in alloc_ldt_struct() failed during a fork(), the\n->context.ldt of the new task remained the same as that of the old task\n(due to the memcpy() in dup_mm()).  ldt_struct's are not intended to be\nshared, so a use-after-free occurred after one task exited.\n\nFix the bug by making init_new_context() pass through the error code of\ninit_new_context_ldt().\n\nThis bug was found by syzkaller, which encountered the following splat:\n\n    BUG: KASAN: use-after-free in free_ldt_struct.part.2+0x10a\/0x150 arch\/x86\/kernel\/ldt.c:116\n    Read of size 4 at addr ffff88006d2cb7c8 by task kworker\/u9:0\/3710\n\n    CPU: 1 PID: 3710 Comm: kworker\/u9:0 Not tainted 4.13.0-rc4-next-20170811 #2\n    Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Bochs 01\/01\/2011\n    Call Trace:\n     __dump_stack lib\/dump_stack.c:16 [inline]\n     dump_stack+0x194\/0x257 lib\/dump_stack.c:52\n     print_address_description+0x73\/0x250 mm\/kasan\/report.c:252\n     kasan_report_error mm\/kasan\/report.c:351 [inline]\n     kasan_report+0x24e\/0x340 mm\/kasan\/report.c:409\n     __asan_report_load4_noabort+0x14\/0x20 mm\/kasan\/report.c:429\n     free_ldt_struct.part.2+0x10a\/0x150 arch\/x86\/kernel\/ldt.c:116\n     free_ldt_struct arch\/x86\/kernel\/ldt.c:173 [inline]\n     destroy_context_ldt+0x60\/0x80 arch\/x86\/kernel\/ldt.c:171\n     destroy_context arch\/x86\/include\/asm\/mmu_context.h:157 [inline]\n     __mmdrop+0xe9\/0x530 kernel\/fork.c:889\n     mmdrop include\/linux\/sched\/mm.h:42 [inline]\n     exec_mmap fs\/exec.c:1061 [inline]\n     flush_old_exec+0x173c\/0x1ff0 fs\/exec.c:1291\n     load_elf_binary+0x81f\/0x4ba0 fs\/binfmt_elf.c:855\n     search_binary_handler+0x142\/0x6b0 fs\/exec.c:1652\n     exec_binprm fs\/exec.c:1694 [inline]\n     do_execveat_common.isra.33+0x1746\/0x22e0 fs\/exec.c:1816\n     do_execve+0x31\/0x40 fs\/exec.c:1860\n     call_usermodehelper_exec_async+0x457\/0x8f0 kernel\/umh.c:100\n     ret_from_fork+0x2a\/0x40 arch\/x86\/entry\/entry_64.S:431\n\n    Allocated by task 3700:\n     save_stack_trace+0x16\/0x20 arch\/x86\/kernel\/stacktrace.c:59\n     save_stack+0x43\/0xd0 mm\/kasan\/kasan.c:447\n     set_track mm\/kasan\/kasan.c:459 [inline]\n     kasan_kmalloc+0xad\/0xe0 mm\/kasan\/kasan.c:551\n     kmem_cache_alloc_trace+0x136\/0x750 mm\/slab.c:3627\n     kmalloc include\/linux\/slab.h:493 [inline]\n     alloc_ldt_struct+0x52\/0x140 arch\/x86\/kernel\/ldt.c:67\n     write_ldt+0x7b7\/0xab0 arch\/x86\/kernel\/ldt.c:277\n     sys_modify_ldt+0x1ef\/0x240 arch\/x86\/kernel\/ldt.c:307\n     entry_SYSCALL_64_fastpath+0x1f\/0xbe\n\n    Freed by task 3700:\n     save_stack_trace+0x16\/0x20 arch\/x86\/kernel\/stacktrace.c:59\n     save_stack+0x43\/0xd0 mm\/kasan\/kasan.c:447\n     set_track mm\/kasan\/kasan.c:459 [inline]\n     kasan_slab_free+0x71\/0xc0 mm\/kasan\/kasan.c:524\n     __cache_free mm\/slab.c:3503 [inline]\n     kfree+0xca\/0x250 mm\/slab.c:3820\n     free_ldt_struct.part.2+0xdd\/0x150 arch\/x86\/kernel\/ldt.c:121\n     free_ldt_struct arch\/x86\/kernel\/ldt.c:173 [inline]\n     destroy_context_ldt+0x60\/0x80 arch\/x86\/kernel\/ldt.c:171\n     destroy_context arch\/x86\/include\/asm\/mmu_context.h:157 [inline]\n     __mmdrop+0xe9\/0x530 kernel\/fork.c:889\n     mmdrop include\/linux\/sched\/mm.h:42 [inline]\n     __mmput kernel\/fork.c:916 [inline]\n     mmput+0x541\/0x6e0 kernel\/fork.c:927\n     copy_process.part.36+0x22e1\/0x4af0 kernel\/fork.c:1931\n     copy_process kernel\/fork.c:1546 [inline]\n     _do_fork+0x1ef\/0xfb0 kernel\/fork.c:2025\n     SYSC_clone kernel\/fork.c:2135 [inline]\n     SyS_clone+0x37\/0x50 kernel\/fork.c:2129\n     do_syscall_64+0x26c\/0x8c0 arch\/x86\/entry\/common.c:287\n     return_from_SYSCALL_64+0x0\/0x7a\n\nHere is a C reproducer:\n\n    #include <asm\/ldt.h>\n    #include <pthread.h>\n    #include <signal.h>\n    #include <stdlib.h>\n    #include <sys\/syscall.h>\n    #include <sys\/wait.h>\n    #include <unistd.h>\n\n    static void *fork_thread(void *_arg)\n    {\n        fork();\n    }\n\n    int main(void)\n    {\n        struct user_desc desc = { .entry_number = 8191 };\n\n        syscall(__NR_modify_ldt, 1, &desc, sizeof(desc));\n\n        for (;;) {\n            if (fork() == 0) {\n                pthread_t t;\n\n                srand(getpid());\n                pthread_create(&t, NULL, fork_thread, NULL);\n                usleep(rand() % 10000);\n                syscall(__NR_exit_group, 0);\n            }\n            wait(NULL);\n        }\n    }\n\nNote: the reproducer takes advantage of the fact that alloc_ldt_struct()\nmay use vmalloc() to allocate a large ->entries array, and after\ncommit:\n\n  5d17a73a2ebe (\"vmalloc: back off when the current task is killed\")\n\nit is possible for userspace to fail a task's vmalloc() by\nsending a fatal signal, e.g. via exit_group().  It would be more\ndifficult to reproduce this bug on kernels without that commit.\n\nThis bug only affected kernels with CONFIG_MODIFY_LDT_SYSCALL=y.\n\nSigned-off-by: Eric Biggers <ebiggers@google.com>\nAcked-by: Dave Hansen <dave.hansen@linux.intel.com>\nCc: <stable@vger.kernel.org> [v4.6+]\nCc: Andrew Morton <akpm@linux-foundation.org>\nCc: Andy Lutomirski <luto@amacapital.net>\nCc: Borislav Petkov <bp@alien8.de>\nCc: Brian Gerst <brgerst@gmail.com>\nCc: Christoph Hellwig <hch@lst.de>\nCc: Denys Vlasenko <dvlasenk@redhat.com>\nCc: Dmitry Vyukov <dvyukov@google.com>\nCc: Linus Torvalds <torvalds@linux-foundation.org>\nCc: Michal Hocko <mhocko@suse.com>\nCc: Peter Zijlstra <peterz@infradead.org>\nCc: Rik van Riel <riel@redhat.com>\nCc: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>\nCc: Thomas Gleixner <tglx@linutronix.de>\nCc: linux-mm@kvack.org\nFixes: 39a0526fb3f7 (\"x86\/mm: Factor out LDT init from context init\")\nLink: http:\/\/lkml.kernel.org\/r\/20170824175029.76040-1-ebiggers3@gmail.com\nSigned-off-by: Ingo Molnar <mingo@kernel.org>\n---\n arch\/x86\/include\/asm\/mmu_context.h | 4 +---\n 1 file changed, 1 insertion(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/arch\/x86\/include\/asm\/mmu_context.h b\/arch\/x86\/include\/asm\/mmu_context.h\nindex 265c907d7d4c..7a234be7e298 100644\n--- a\/arch\/x86\/include\/asm\/mmu_context.h\n+++ b\/arch\/x86\/include\/asm\/mmu_context.h\n@@ -140,9 +140,7 @@ static inline int init_new_context(struct task_struct *tsk,\n \t\tmm->context.execute_only_pkey = -1;\n \t}\n \t#endif\n-\tinit_new_context_ldt(tsk, mm);\n-\n-\treturn 0;\n+\treturn init_new_context_ldt(tsk, mm);\n }\n static inline void destroy_context(struct mm_struct *mm)\n {\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2018-11383","CWE_ID":"416","category":"security","commit_id":"9d348bcc2c4bbd3805e7eec97b594be9febbdf9a","commit_message":"From 9d348bcc2c4bbd3805e7eec97b594be9febbdf9a Mon Sep 17 00:00:00 2001\nFrom: pancake <pancake@nopcode.org>\nDate: Tue, 24 Apr 2018 09:55:19 +0200\nSubject: [PATCH] Fix #9943 - Invalid free on RAnal.avr\n\n---\n libr\/anal\/p\/anal_avr.c | 2 +-\n libr\/core\/cmd_anal.c   | 3 ++-\n 2 files changed, 3 insertions(+), 2 deletions(-)\n\n","diff_code":"diff --git a\/libr\/anal\/p\/anal_avr.c b\/libr\/anal\/p\/anal_avr.c\nindex 1da1ab0551..93d72ce52a 100644\n--- a\/libr\/anal\/p\/anal_avr.c\n+++ b\/libr\/anal\/p\/anal_avr.c\n@@ -619,7 +619,7 @@ INST_HANDLER (cpi) { \/\/ CPI Rd, K\n INST_HANDLER (cpse) {\t\/\/ CPSE Rd, Rr\n \tint r = (buf[0] & 0xf) | ((buf[1] & 0x2) << 3);\n \tint d = ((buf[0] >> 4) & 0xf) | ((buf[1] & 0x1) << 4);\n-\tRAnalOp next_op;\n+\tRAnalOp next_op = {0};\n \n \t\/\/ calculate next instruction size (call recursively avr_op_analyze)\n \t\/\/ and free next_op's esil string (we dont need it now)\ndiff --git a\/libr\/core\/cmd_anal.c b\/libr\/core\/cmd_anal.c\nindex ed079135c1..969cf32a33 100644\n--- a\/libr\/core\/cmd_anal.c\n+++ b\/libr\/core\/cmd_anal.c\n@@ -4350,8 +4350,9 @@ static void cmd_anal_esil(RCore *core, const char *input) {\n \t\t{\n \t\t\t\/\/ anal ESIL to REIL.\n \t\t\tRAnalEsil *esil = r_anal_esil_new (stacksize, iotrap, addrsize);\n-\t\t\tif (!esil)\n+\t\t\tif (!esil) {\n \t\t\t\treturn;\n+\t\t\t}\n \t\t\tr_anal_esil_to_reil_setup (esil, core->anal, romem, stats);\n \t\t\tr_anal_esil_set_pc (esil, core->offset);\n \t\t\tr_anal_esil_parse (esil, input + 2);\n","owner":"radare","repo":"radare2","source":"cve"},{"CVE_ID":"CVE-2019-12819","CWE_ID":"416","category":"security","commit_id":"6ff7b060535e87c2ae14dd8548512abfdda528fb","commit_message":"From 6ff7b060535e87c2ae14dd8548512abfdda528fb Mon Sep 17 00:00:00 2001\nFrom: YueHaibing <yuehaibing@huawei.com>\nDate: Thu, 21 Feb 2019 22:42:01 +0800\nSubject: mdio_bus: Fix use-after-free on device_register fails\n\nKASAN has found use-after-free in fixed_mdio_bus_init,\ncommit 0c692d07842a (\"drivers\/net\/phy\/mdio_bus.c: call\nput_device on device_register() failure\") call put_device()\nwhile device_register() fails,give up the last reference\nto the device and allow mdiobus_release to be executed\n,kfreeing the bus. However in most drives, mdiobus_free\nbe called to free the bus while mdiobus_register fails.\nuse-after-free occurs when access bus again, this patch\nrevert it to let mdiobus_free free the bus.\n\nKASAN report details as below:\n\nBUG: KASAN: use-after-free in mdiobus_free+0x85\/0x90 drivers\/net\/phy\/mdio_bus.c:482\nRead of size 4 at addr ffff8881dc824d78 by task syz-executor.0\/3524\n\nCPU: 1 PID: 3524 Comm: syz-executor.0 Not tainted 5.0.0-rc7+ #45\nHardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04\/01\/2014\nCall Trace:\n __dump_stack lib\/dump_stack.c:77 [inline]\n dump_stack+0xfa\/0x1ce lib\/dump_stack.c:113\n print_address_description+0x65\/0x270 mm\/kasan\/report.c:187\n kasan_report+0x149\/0x18d mm\/kasan\/report.c:317\n mdiobus_free+0x85\/0x90 drivers\/net\/phy\/mdio_bus.c:482\n fixed_mdio_bus_init+0x283\/0x1000 [fixed_phy]\n ? 0xffffffffc0e40000\n ? 0xffffffffc0e40000\n ? 0xffffffffc0e40000\n do_one_initcall+0xfa\/0x5ca init\/main.c:887\n do_init_module+0x204\/0x5f6 kernel\/module.c:3460\n load_module+0x66b2\/0x8570 kernel\/module.c:3808\n __do_sys_finit_module+0x238\/0x2a0 kernel\/module.c:3902\n do_syscall_64+0x147\/0x600 arch\/x86\/entry\/common.c:290\n entry_SYSCALL_64_after_hwframe+0x49\/0xbe\nRIP: 0033:0x462e99\nCode: f7 d8 64 89 02 b8 ff ff ff ff c3 66 0f 1f 44 00 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 bc ff ff ff f7 d8 64 89 01 48\nRSP: 002b:00007f6215c19c58 EFLAGS: 00000246 ORIG_RAX: 0000000000000139\nRAX: ffffffffffffffda RBX: 000000000073bf00 RCX: 0000000000462e99\nRDX: 0000000000000000 RSI: 0000000020000080 RDI: 0000000000000003\nRBP: 00007f6215c19c70 R08: 0000000000000000 R09: 0000000000000000\nR10: 0000000000000000 R11: 0000000000000246 R12: 00007f6215c1a6bc\nR13: 00000000004bcefb R14: 00000000006f7030 R15: 0000000000000004\n\nAllocated by task 3524:\n set_track mm\/kasan\/common.c:85 [inline]\n __kasan_kmalloc.constprop.3+0xa0\/0xd0 mm\/kasan\/common.c:496\n kmalloc include\/linux\/slab.h:545 [inline]\n kzalloc include\/linux\/slab.h:740 [inline]\n mdiobus_alloc_size+0x54\/0x1b0 drivers\/net\/phy\/mdio_bus.c:143\n fixed_mdio_bus_init+0x163\/0x1000 [fixed_phy]\n do_one_initcall+0xfa\/0x5ca init\/main.c:887\n do_init_module+0x204\/0x5f6 kernel\/module.c:3460\n load_module+0x66b2\/0x8570 kernel\/module.c:3808\n __do_sys_finit_module+0x238\/0x2a0 kernel\/module.c:3902\n do_syscall_64+0x147\/0x600 arch\/x86\/entry\/common.c:290\n entry_SYSCALL_64_after_hwframe+0x49\/0xbe\n\nFreed by task 3524:\n set_track mm\/kasan\/common.c:85 [inline]\n __kasan_slab_free+0x130\/0x180 mm\/kasan\/common.c:458\n slab_free_hook mm\/slub.c:1409 [inline]\n slab_free_freelist_hook mm\/slub.c:1436 [inline]\n slab_free mm\/slub.c:2986 [inline]\n kfree+0xe1\/0x270 mm\/slub.c:3938\n device_release+0x78\/0x200 drivers\/base\/core.c:919\n kobject_cleanup lib\/kobject.c:662 [inline]\n kobject_release lib\/kobject.c:691 [inline]\n kref_put include\/linux\/kref.h:67 [inline]\n kobject_put+0x146\/0x240 lib\/kobject.c:708\n put_device+0x1c\/0x30 drivers\/base\/core.c:2060\n __mdiobus_register+0x483\/0x560 drivers\/net\/phy\/mdio_bus.c:382\n fixed_mdio_bus_init+0x26b\/0x1000 [fixed_phy]\n do_one_initcall+0xfa\/0x5ca init\/main.c:887\n do_init_module+0x204\/0x5f6 kernel\/module.c:3460\n load_module+0x66b2\/0x8570 kernel\/module.c:3808\n __do_sys_finit_module+0x238\/0x2a0 kernel\/module.c:3902\n do_syscall_64+0x147\/0x600 arch\/x86\/entry\/common.c:290\n entry_SYSCALL_64_after_hwframe+0x49\/0xbe\n\nThe buggy address belongs to the object at ffff8881dc824c80\n which belongs to the cache kmalloc-2k of size 2048\nThe buggy address is located 248 bytes inside of\n 2048-byte region [ffff8881dc824c80, ffff8881dc825480)\nThe buggy address belongs to the page:\npage:ffffea0007720800 count:1 mapcount:0 mapping:ffff8881f6c02800 index:0x0 compound_mapcount: 0\nflags: 0x2fffc0000010200(slab|head)\nraw: 02fffc0000010200 0000000000000000 0000000500000001 ffff8881f6c02800\nraw: 0000000000000000 00000000800f000f 00000001ffffffff 0000000000000000\npage dumped because: kasan: bad access detected\n\nMemory state around the buggy address:\n ffff8881dc824c00: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc\n ffff8881dc824c80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n>ffff8881dc824d00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n                                                                ^\n ffff8881dc824d80: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n ffff8881dc824e00: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb\n\nFixes: 0c692d07842a (\"drivers\/net\/phy\/mdio_bus.c: call put_device on device_register() failure\")\nSigned-off-by: YueHaibing <yuehaibing@huawei.com>\nReviewed-by: Andrew Lunn <andrew@lunn.ch>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n---\n drivers\/net\/phy\/mdio_bus.c | 1 -\n 1 file changed, 1 deletion(-)\n\n","diff_code":"diff --git a\/drivers\/net\/phy\/mdio_bus.c b\/drivers\/net\/phy\/mdio_bus.c\nindex 66b9cfe692fc..7368616286ae 100644\n--- a\/drivers\/net\/phy\/mdio_bus.c\n+++ b\/drivers\/net\/phy\/mdio_bus.c\n@@ -379,7 +379,6 @@ int __mdiobus_register(struct mii_bus *bus, struct module *owner)\n \terr = device_register(&bus->dev);\n \tif (err) {\n \t\tpr_err(\"mii_bus %s failed to register\\n\", bus->id);\n-\t\tput_device(&bus->dev);\n \t\treturn -EINVAL;\n \t}\n \n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2016-6833","CWE_ID":"416","category":"security","commit_id":"6c352ca9b4ee3e1e286ea9e8434bd8e69ac7d0d8","commit_message":"From 6c352ca9b4ee3e1e286ea9e8434bd8e69ac7d0d8 Mon Sep 17 00:00:00 2001\nFrom: Li Qiang <liqiang6-s@360.cn>\nDate: Mon, 8 Aug 2016 18:08:31 +0530\nSubject: [PATCH] net: vmxnet3: check for device_active before write\n\nVmxnet3 device emulator does not check if the device is active,\nbefore using it for write. It leads to a use after free issue,\nif the vmxnet3_io_bar0_write routine is called after the device is\ndeactivated. Add check to avoid it.\n\nReported-by: Li Qiang <liqiang6-s@360.cn>\nSigned-off-by: Prasad J Pandit <pjp@fedoraproject.org>\nAcked-by: Dmitry Fleytman <dmitry@daynix.com>\nSigned-off-by: Jason Wang <jasowang@redhat.com>\n---\n hw\/net\/vmxnet3.c | 4 ++++\n 1 file changed, 4 insertions(+)\n\n","diff_code":"diff --git a\/hw\/net\/vmxnet3.c b\/hw\/net\/vmxnet3.c\nindex bbf44ad..90f6943 100644\n--- a\/hw\/net\/vmxnet3.c\n+++ b\/hw\/net\/vmxnet3.c\n@@ -1167,6 +1167,10 @@ vmxnet3_io_bar0_write(void *opaque, hwaddr addr,\n {\n     VMXNET3State *s = opaque;\n \n+    if (!s->device_active) {\n+        return;\n+    }\n+\n     if (VMW_IS_MULTIREG_ADDR(addr, VMXNET3_REG_TXPROD,\n                         VMXNET3_DEVICE_MAX_TX_QUEUES, VMXNET3_REG_ALIGN)) {\n         int tx_queue_idx =\n-- \n1.8.3.1\n\n","owner":"qemu","repo":"qemu","source":"cve"},{"CVE_ID":"CVE-2016-10051","CWE_ID":"416","category":"security","commit_id":"ecc03a2518c2b7dd375fde3a040fdae0bdf6a521","commit_message":"From ecc03a2518c2b7dd375fde3a040fdae0bdf6a521 Mon Sep 17 00:00:00 2001\nFrom: Cristy <urban-warrior@imagemagick.org>\nDate: Fri, 5 Aug 2016 16:33:16 -0400\nSubject: [PATCH] Prevent memory use after free\n\n---\n ChangeLog    | 2 ++\n coders\/pwp.c | 2 --\n 2 files changed, 2 insertions(+), 2 deletions(-)\n\n","diff_code":"diff --git a\/ChangeLog b\/ChangeLog\nindex e0bdcd1224..8199991cc4 100644\n--- a\/ChangeLog\n+++ b\/ChangeLog\n@@ -1,5 +1,7 @@\n 2016-08-03  6.9.5-5 Cristy  <quetzlzacatenango@image...>\n   * Prevent buffer overflow (bug report from Max Thrane).\n+  * Prevent memory use after free (reference\n+    https:\/\/www.imagemagick.org\/discourse-server\/viewtopic.php?f=3&t=30245).\n \n 2016-07-30  6.9.5-4 Cristy  <quetzlzacatenango@image...>\n   * Release ImageMagick version 6.9.5-4, GIT revision 10973:a00fa93:20160729.\ndiff --git a\/coders\/pwp.c b\/coders\/pwp.c\nindex b55eda0544..9432daad63 100644\n--- a\/coders\/pwp.c\n+++ b\/coders\/pwp.c\n@@ -248,8 +248,6 @@ static Image *ReadPWPImage(const ImageInfo *image_info,ExceptionInfo *exception)\n     (void) close(unique_file);\n   (void) RelinquishUniqueFileResource(read_info->filename);\n   read_info=DestroyImageInfo(read_info);\n-  (void) CloseBlob(pwp_image);\n-  pwp_image=DestroyImage(pwp_image);\n   if (EOFBlob(image) != MagickFalse)\n     {\n       char\n","owner":"ImageMagick","repo":"ImageMagick","source":"cve"},{"CVE_ID":"CVE-2017-7191","CWE_ID":"416","category":"security","commit_id":"7c09b72848f99886964266ff531b41c69fe138f5","commit_message":"From 7c09b72848f99886964266ff531b41c69fe138f5 Mon Sep 17 00:00:00 2001\nFrom: dequis <dx@dxzone.com.ar>\nDate: Mon, 27 Feb 2017 23:42:57 -0300\nSubject: [PATCH] fe-netjoin: remove irc servers on \"server disconnected\"\n signal\n\n---\n src\/fe-common\/irc\/fe-netjoin.c | 16 ++++++++++++++++\n 1 file changed, 16 insertions(+)\n\n","diff_code":"diff --git a\/src\/fe-common\/irc\/fe-netjoin.c b\/src\/fe-common\/irc\/fe-netjoin.c\nindex 4eb388c05..8272093fe 100644\n--- a\/src\/fe-common\/irc\/fe-netjoin.c\n+++ b\/src\/fe-common\/irc\/fe-netjoin.c\n@@ -470,6 +470,20 @@ static void read_settings(void)\n \t}\n }\n \n+static void sig_server_disconnected(IRC_SERVER_REC *server)\n+{\n+\tNETJOIN_SERVER_REC *netjoin_server;\n+\n+\tg_return_if_fail(server != NULL);\n+\n+\tif (!IS_IRC_SERVER(server))\n+\t\treturn;\n+\n+\tif ((netjoin_server = netjoin_find_server(server))) {\n+\t\tnetjoin_server_remove(netjoin_server);\n+\t}\n+}\n+\n void fe_netjoin_init(void)\n {\n \tsettings_add_bool(\"misc\", \"hide_netsplit_quits\", TRUE);\n@@ -480,6 +494,7 @@ void fe_netjoin_init(void)\n \n \tread_settings();\n \tsignal_add(\"setup changed\", (SIGNAL_FUNC) read_settings);\n+\tsignal_add(\"server disconnected\", (SIGNAL_FUNC) sig_server_disconnected);\n }\n \n void fe_netjoin_deinit(void)\n@@ -492,6 +507,7 @@ void fe_netjoin_deinit(void)\n \t}\n \n \tsignal_remove(\"setup changed\", (SIGNAL_FUNC) read_settings);\n+\tsignal_remove(\"server disconnected\", (SIGNAL_FUNC) sig_server_disconnected);\n \n \tsignal_remove(\"message quit\", (SIGNAL_FUNC) msg_quit);\n \tsignal_remove(\"message join\", (SIGNAL_FUNC) msg_join);\n","owner":"irssi","repo":"irssi.irssi.irssi","source":"cve"},{"CVE_ID":"CVE-2017-17499","CWE_ID":"416","category":"security","commit_id":"8c35502217c1879cb8257c617007282eee3fe1cc","commit_message":"From 8c35502217c1879cb8257c617007282eee3fe1cc Mon Sep 17 00:00:00 2001\nFrom: Dirk Lemstra <dirk@git.imagemagick.org>\nDate: Sat, 18 Nov 2017 10:23:27 +0100\nSubject: [PATCH] Added missing return to avoid use after free.\n\n---\n Magick++\/lib\/Image.cpp | 1 +\n 1 file changed, 1 insertion(+)\n\n","diff_code":"diff --git a\/Magick++\/lib\/Image.cpp b\/Magick++\/lib\/Image.cpp\nindex f4fc34a689..15d98f2d95 100644\n--- a\/Magick++\/lib\/Image.cpp\n+++ b\/Magick++\/lib\/Image.cpp\n@@ -5087,6 +5087,7 @@ void Magick::Image::read(MagickCore::Image *image,\n       if (!quiet())\n         throwExceptionExplicit(MagickCore::ImageWarning,\n           \"No image was loaded.\");\n+      return;\n     }\n   ThrowImageException;\n }\n","owner":"ImageMagick","repo":"ImageMagick","source":"cve"},{"CVE_ID":"CVE-2015-8949","CWE_ID":"416","category":"security","commit_id":"2e1cbd0034cf0041f832ba81d07c24db886782d8","commit_message":"From 2e1cbd0034cf0041f832ba81d07c24db886782d8 Mon Sep 17 00:00:00 2001\nFrom: Hanno <hanno@gentoo.org>\nDate: Sat, 14 Nov 2015 23:06:12 +0100\nSubject: [PATCH] Fix use after free error.\n\n---\n dbdimp.c | 9 ++++-----\n 1 file changed, 4 insertions(+), 5 deletions(-)\n\n","diff_code":"diff --git a\/dbdimp.c b\/dbdimp.c\nindex d507588..acdfee8 100644\n--- a\/dbdimp.c\n+++ b\/dbdimp.c\n@@ -2085,10 +2085,6 @@ static int my_login(pTHX_ SV* dbh, imp_dbh_t *imp_dbh)\n   }\n   result = mysql_dr_connect(dbh, imp_dbh->pmysql, mysql_socket, host, port, user,\n \t\t\t  password, dbname, imp_dbh) ? TRUE : FALSE;\n-  if (fresh && !result) {\n-      \/* Prevent leaks, but do not free in case of a reconnect. See #97625 *\/\n-      Safefree(imp_dbh->pmysql);\n-  }\n   return result;\n }\n \n@@ -2142,9 +2138,12 @@ int dbd_db_login(SV* dbh, imp_dbh_t* imp_dbh, char* dbname, char* user,\n \n   if (!my_login(aTHX_ dbh, imp_dbh))\n   {\n-    if(imp_dbh->pmysql)\n+    if(imp_dbh->pmysql) {\n         do_error(dbh, mysql_errno(imp_dbh->pmysql),\n                 mysql_error(imp_dbh->pmysql) ,mysql_sqlstate(imp_dbh->pmysql));\n+        Safefree(imp_dbh->pmysql);\n+\n+    }\n     return FALSE;\n   }\n \n","owner":"perl5-dbi","repo":"DBD-mysql","source":"cve"},{"CVE_ID":"CVE-2016-8674","CWE_ID":"416","category":"security","commit_id":"1e03c06456d997435019fb3526fa2d4be7dbc6ec","commit_message":"From 1e03c06456d997435019fb3526fa2d4be7dbc6ec Mon Sep 17 00:00:00 2001\nFrom: Robin Watts <robin.watts@artifex.com>\nDate: Thu, 22 Sep 2016 13:44:45 +0100\nSubject: [PATCH] Bug 697015: Avoid object references vanishing during repair.\n\nA PDF repair can be triggered 'just in time', when we encounter\na problem in the file. The idea is that this can happen without\nthe enclosing code being aware of it.\n\nThus the enclosing code may be holding 'borrowed' references\n(such as those returned by pdf_dict_get()) at the time when the\nrepair is triggered. We are therefore at pains to ensure that\nthe repair does not replace any objects that exist already, so\nthat the calling code will not have these references unexpectedly\ninvalidated.\n\nThe sole exception to this is when we replace the 'Length' fields\nin stream dictionaries with the actual lengths. Bug 697015 shows\nexactly this situation causing a reference to become invalid.\n\nThe solution implemented here is to add an 'orphan list' to the\ndocument, where we put these (hopefully few, small) objects. These\norphans are kept around until the document is closed.\n---\n include\/mupdf\/pdf\/document.h |  4 ++++\n include\/mupdf\/pdf\/object.h   |  1 +\n source\/pdf\/pdf-object.c      | 31 +++++++++++++++++++++++++++----\n source\/pdf\/pdf-repair.c      | 28 +++++++++++++++++++++++++---\n source\/pdf\/pdf-xref.c        |  6 ++++++\n 5 files changed, 63 insertions(+), 7 deletions(-)\n\n","diff_code":"diff --git a\/include\/mupdf\/pdf\/document.h b\/include\/mupdf\/pdf\/document.h\nindex aabf05f..0078c4a 100644\n--- a\/include\/mupdf\/pdf\/document.h\n+++ b\/include\/mupdf\/pdf\/document.h\n@@ -269,6 +269,10 @@ struct pdf_document_s\n \t\tfz_hash_table *images;\n \t\tfz_hash_table *fonts;\n \t} resources;\n+\n+\tint orphans_max;\n+\tint orphans_count;\n+\tpdf_obj **orphans;\n };\n \n \/*\ndiff --git a\/include\/mupdf\/pdf\/object.h b\/include\/mupdf\/pdf\/object.h\nindex 5bc3dca..bf57455 100644\n--- a\/include\/mupdf\/pdf\/object.h\n+++ b\/include\/mupdf\/pdf\/object.h\n@@ -110,6 +110,7 @@ pdf_obj *pdf_dict_gets(fz_context *ctx, pdf_obj *dict, const char *key);\n pdf_obj *pdf_dict_getsa(fz_context *ctx, pdf_obj *dict, const char *key, const char *abbrev);\n void pdf_dict_put(fz_context *ctx, pdf_obj *dict, pdf_obj *key, pdf_obj *val);\n void pdf_dict_put_drop(fz_context *ctx, pdf_obj *dict, pdf_obj *key, pdf_obj *val);\n+void pdf_dict_get_put_drop(fz_context *ctx, pdf_obj *dict, pdf_obj *key, pdf_obj *val, pdf_obj **old_val);\n void pdf_dict_puts(fz_context *ctx, pdf_obj *dict, const char *key, pdf_obj *val);\n void pdf_dict_puts_drop(fz_context *ctx, pdf_obj *dict, const char *key, pdf_obj *val);\n void pdf_dict_putp(fz_context *ctx, pdf_obj *dict, const char *path, pdf_obj *val);\ndiff --git a\/source\/pdf\/pdf-object.c b\/source\/pdf\/pdf-object.c\nindex b4e33f3..1c19ba4 100644\n--- a\/source\/pdf\/pdf-object.c\n+++ b\/source\/pdf\/pdf-object.c\n@@ -1265,11 +1265,14 @@ pdf_dict_geta(fz_context *ctx, pdf_obj *obj, pdf_obj *key, pdf_obj *abbrev)\n \treturn pdf_dict_get(ctx, obj, abbrev);\n }\n \n-void\n-pdf_dict_put(fz_context *ctx, pdf_obj *obj, pdf_obj *key, pdf_obj *val)\n+static void\n+pdf_dict_get_put(fz_context *ctx, pdf_obj *obj, pdf_obj *key, pdf_obj *val, pdf_obj **old_val)\n {\n \tint i;\n \n+\tif (old_val)\n+\t\t*old_val = NULL;\n+\n \tRESOLVE(obj);\n \tif (!OBJ_IS_DICT(obj))\n \t\tfz_throw(ctx, FZ_ERROR_GENERIC, \"not a dict (%s)\", pdf_objkindstr(obj));\n@@ -1295,7 +1298,10 @@ pdf_dict_put(fz_context *ctx, pdf_obj *obj, pdf_obj *key, pdf_obj *val)\n \t\t{\n \t\t\tpdf_obj *d = DICT(obj)->items[i].v;\n \t\t\tDICT(obj)->items[i].v = pdf_keep_obj(ctx, val);\n-\t\t\tpdf_drop_obj(ctx, d);\n+\t\t\tif (old_val)\n+\t\t\t\t*old_val = d;\n+\t\t\telse\n+\t\t\t\tpdf_drop_obj(ctx, d);\n \t\t}\n \t}\n \telse\n@@ -1316,10 +1322,27 @@ pdf_dict_put(fz_context *ctx, pdf_obj *obj, pdf_obj *key, pdf_obj *val)\n }\n \n void\n+pdf_dict_put(fz_context *ctx, pdf_obj *obj, pdf_obj *key, pdf_obj *val)\n+{\n+\tpdf_dict_get_put(ctx, obj, key, val, NULL);\n+}\n+\n+void\n pdf_dict_put_drop(fz_context *ctx, pdf_obj *obj, pdf_obj *key, pdf_obj *val)\n {\n \tfz_try(ctx)\n-\t\tpdf_dict_put(ctx, obj, key, val);\n+\t\tpdf_dict_get_put(ctx, obj, key, val, NULL);\n+\tfz_always(ctx)\n+\t\tpdf_drop_obj(ctx, val);\n+\tfz_catch(ctx)\n+\t\tfz_rethrow(ctx);\n+}\n+\n+void\n+pdf_dict_get_put_drop(fz_context *ctx, pdf_obj *obj, pdf_obj *key, pdf_obj *val, pdf_obj **old_val)\n+{\n+\tfz_try(ctx)\n+\t\tpdf_dict_get_put(ctx, obj, key, val, old_val);\n \tfz_always(ctx)\n \t\tpdf_drop_obj(ctx, val);\n \tfz_catch(ctx)\ndiff --git a\/source\/pdf\/pdf-repair.c b\/source\/pdf\/pdf-repair.c\nindex 690bf15..167f609 100644\n--- a\/source\/pdf\/pdf-repair.c\n+++ b\/source\/pdf\/pdf-repair.c\n@@ -260,6 +260,27 @@ pdf_repair_obj_stm(fz_context *ctx, pdf_document *doc, int stm_num)\n \t}\n }\n \n+static void\n+orphan_object(fz_context *ctx, pdf_document *doc, pdf_obj *obj)\n+{\n+\tif (doc->orphans_count == doc->orphans_max)\n+\t{\n+\t\tint new_max = (doc->orphans_max ? doc->orphans_max*2 : 32);\n+\n+\t\tfz_try(ctx)\n+\t\t{\n+\t\t\tdoc->orphans = fz_resize_array(ctx, doc->orphans, new_max, sizeof(*doc->orphans));\n+\t\t\tdoc->orphans_max = new_max;\n+\t\t}\n+\t\tfz_catch(ctx)\n+\t\t{\n+\t\t\tpdf_drop_obj(ctx, obj);\n+\t\t\tfz_rethrow(ctx);\n+\t\t}\n+\t}\n+\tdoc->orphans[doc->orphans_count++] = obj;\n+}\n+\n void\n pdf_repair_xref(fz_context *ctx, pdf_document *doc)\n {\n@@ -528,12 +549,13 @@ pdf_repair_xref(fz_context *ctx, pdf_document *doc)\n \t\t\t\/* correct stream length for unencrypted documents *\/\n \t\t\tif (!encrypt && list[i].stm_len >= 0)\n \t\t\t{\n+\t\t\t\tpdf_obj *old_obj = NULL;\n \t\t\t\tdict = pdf_load_object(ctx, doc, list[i].num);\n \n \t\t\t\tlength = pdf_new_int(ctx, doc, list[i].stm_len);\n-\t\t\t\tpdf_dict_put(ctx, dict, PDF_NAME_Length, length);\n-\t\t\t\tpdf_drop_obj(ctx, length);\n-\n+\t\t\t\tpdf_dict_get_put_drop(ctx, dict, PDF_NAME_Length, length, &old_obj);\n+\t\t\t\tif (old_obj)\n+\t\t\t\t\torphan_object(ctx, doc, old_obj);\n \t\t\t\tpdf_drop_obj(ctx, dict);\n \t\t\t}\n \t\t}\ndiff --git a\/source\/pdf\/pdf-xref.c b\/source\/pdf\/pdf-xref.c\nindex 7d21775..0cf20d4 100644\n--- a\/source\/pdf\/pdf-xref.c\n+++ b\/source\/pdf\/pdf-xref.c\n@@ -1620,6 +1620,12 @@ pdf_drop_document_imp(fz_context *ctx, pdf_document *doc)\n \n \t\tpdf_drop_resource_tables(ctx, doc);\n \n+\t\tfor (i = 0; i < doc->orphans_count; i++)\n+\t\t{\n+\t\t\tpdf_drop_obj(ctx, doc->orphans[i]);\n+\t\t}\n+\t\tfz_free(ctx, doc->orphans);\n+\n \t\tfz_free(ctx, doc);\n \t}\n \tfz_always(ctx)\n-- \n2.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2016-6290","CWE_ID":"416","category":"security","commit_id":"3798eb6fd5dddb211b01d41495072fd9858d4e32","commit_message":"From 3798eb6fd5dddb211b01d41495072fd9858d4e32 Mon Sep 17 00:00:00 2001\nFrom: Stanislav Malyshev <stas@php.net>\nDate: Tue, 12 Jul 2016 23:27:45 -0700\nSubject: [PATCH] Fix bug #72562 - destroy var_hash properly\n\n---\n ext\/session\/session.c           |  3 ++-\n ext\/session\/tests\/bug72562.phpt | 44 +++++++++++++++++++++++++++++++++++++++++\n 2 files changed, 46 insertions(+), 1 deletion(-)\n create mode 100644 ext\/session\/tests\/bug72562.phpt\n\n","diff_code":"diff --git a\/ext\/session\/session.c b\/ext\/session\/session.c\nindex f5439ea..cb6cc01 100644\n--- a\/ext\/session\/session.c\n+++ b\/ext\/session\/session.c\n@@ -866,7 +866,7 @@ PS_SERIALIZER_DECODE_FUNC(php_serialize) \/* {{{ *\/\n \tif (php_var_unserialize(&session_vars, &val, endptr, &var_hash TSRMLS_CC)) {\n \t\tvar_push_dtor(&var_hash, &session_vars);\n \t}\n-\t\n+\n \tPHP_VAR_UNSERIALIZE_DESTROY(var_hash);\n \tif (PS(http_session_vars)) {\n \t\tzval_ptr_dtor(&PS(http_session_vars));\n@@ -931,6 +931,7 @@ PS_SERIALIZER_DECODE_FUNC(php_binary) \/* {{{ *\/\n \t\tnamelen = ((unsigned char)(*p)) & (~PS_BIN_UNDEF);\n \n \t\tif (namelen < 0 || namelen > PS_BIN_MAX || (p + namelen) >= endptr) {\n+\t\t\tPHP_VAR_UNSERIALIZE_DESTROY(var_hash);\n \t\t\treturn FAILURE;\n \t\t}\n \ndiff --git a\/ext\/session\/tests\/bug72562.phpt b\/ext\/session\/tests\/bug72562.phpt\nnew file mode 100644\nindex 0000000..d85e48b\n--- \/dev\/null\n+++ b\/ext\/session\/tests\/bug72562.phpt\n@@ -0,0 +1,44 @@\n+--TEST--\n+Bug #72562: Use After Free in unserialize() with Unexpected Session Deserialization\n+--SKIPIF--\n+<?php include('skipif.inc'); ?>\n+--FILE--\n+<?php\n+\n+ini_set('session.serialize_handler', 'php_binary');\n+session_start();\n+$sess = \"\\x1xi:1;\\x2y\";\n+session_decode($sess);\n+$uns_1 = '{';\n+$out_1[] = unserialize($uns_1);\n+unset($out_1);\n+$fakezval = ptr2str(1122334455);\n+$fakezval .= ptr2str(0);\n+$fakezval .= \"\\x00\\x00\\x00\\x00\";\n+$fakezval .= \"\\x01\";\n+$fakezval .= \"\\x00\";\n+$fakezval .= \"\\x00\\x00\";\n+for ($i = 0; $i < 5; $i++) {\n+  $v[$i] = $fakezval.$i;\n+}\n+$uns_2 = 'R:2;';\n+$out_2 = unserialize($uns_2);\n+var_dump($out_2);\n+\n+function ptr2str($ptr)\n+{\n+\t$out = '';\n+\tfor ($i = 0; $i < 8; $i++) {\n+\t\t$out .= chr($ptr & 0xff);\n+\t\t$ptr >>= 8;\n+\t}\n+\treturn $out;\n+}\n+?>\n+--EXPECTF--\n+Warning: session_decode(): Failed to decode session object. Session has been destroyed in %s\/bug72562.php on line %d\n+\n+Notice: unserialize(): Error at offset 0 of 1 bytes in %s\/bug72562.php on line %d\n+\n+Notice: unserialize(): Error at offset 4 of 4 bytes in %s\/bug72562.php on line %d\n+bool(false)\n-- \n2.1.4\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2018-10879","CWE_ID":"416","category":"security","commit_id":"5369a762c882c0b6e9599e4ebbb3a9ba9eee7e2d","commit_message":"From 5369a762c882c0b6e9599e4ebbb3a9ba9eee7e2d Mon Sep 17 00:00:00 2001\nFrom: Theodore Ts'o <tytso@mit.edu>\nDate: Wed, 13 Jun 2018 00:23:11 -0400\nSubject: ext4: add corruption check in ext4_xattr_set_entry()\n\nIn theory this should have been caught earlier when the xattr list was\nverified, but in case it got missed, it's simple enough to add check\nto make sure we don't overrun the xattr buffer.\n\nThis addresses CVE-2018-10879.\n\nhttps:\/\/bugzilla.kernel.org\/show_bug.cgi?id=200001\n\nSigned-off-by: Theodore Ts'o <tytso@mit.edu>\nReviewed-by: Andreas Dilger <adilger@dilger.ca>\nCc: stable@kernel.org\n---\n fs\/ext4\/xattr.c | 10 ++++++++--\n 1 file changed, 8 insertions(+), 2 deletions(-)\n\n","diff_code":"diff --git a\/fs\/ext4\/xattr.c b\/fs\/ext4\/xattr.c\nindex fc4ced59c565..230ba79715f6 100644\n--- a\/fs\/ext4\/xattr.c\n+++ b\/fs\/ext4\/xattr.c\n@@ -1560,7 +1560,7 @@ static int ext4_xattr_set_entry(struct ext4_xattr_info *i,\n \t\t\t\thandle_t *handle, struct inode *inode,\n \t\t\t\tbool is_block)\n {\n-\tstruct ext4_xattr_entry *last;\n+\tstruct ext4_xattr_entry *last, *next;\n \tstruct ext4_xattr_entry *here = s->here;\n \tsize_t min_offs = s->end - s->base, name_len = strlen(i->name);\n \tint in_inode = i->in_inode;\n@@ -1595,7 +1595,13 @@ static int ext4_xattr_set_entry(struct ext4_xattr_info *i,\n \n \t\/* Compute min_offs and last. *\/\n \tlast = s->first;\n-\tfor (; !IS_LAST_ENTRY(last); last = EXT4_XATTR_NEXT(last)) {\n+\tfor (; !IS_LAST_ENTRY(last); last = next) {\n+\t\tnext = EXT4_XATTR_NEXT(last);\n+\t\tif ((void *)next >= s->end) {\n+\t\t\tEXT4_ERROR_INODE(inode, \"corrupted xattr entries\");\n+\t\t\tret = -EFSCORRUPTED;\n+\t\t\tgoto out;\n+\t\t}\n \t\tif (!last->e_value_inum && last->e_value_size) {\n \t\t\tsize_t offs = le16_to_cpu(last->e_value_offs);\n \t\t\tif (offs < min_offs)\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-17499","CWE_ID":"416","category":"security","commit_id":"dd96d671e4d5ae22c6894c302e8996c13f24c45a","commit_message":"From dd96d671e4d5ae22c6894c302e8996c13f24c45a Mon Sep 17 00:00:00 2001\nFrom: Dirk Lemstra <dirk@git.imagemagick.org>\nDate: Sat, 18 Nov 2017 10:23:53 +0100\nSubject: [PATCH] Added missing return to avoid use after free.\n\n---\n Magick++\/lib\/Image.cpp | 9 +++++++--\n 1 file changed, 7 insertions(+), 2 deletions(-)\n\n","diff_code":"diff --git a\/Magick++\/lib\/Image.cpp b\/Magick++\/lib\/Image.cpp\nindex 3e42e0b7a4..5344686489 100644\n--- a\/Magick++\/lib\/Image.cpp\n+++ b\/Magick++\/lib\/Image.cpp\n@@ -5140,9 +5140,14 @@ void Magick::Image::read(MagickCore::Image *image,\n       image == (MagickCore::Image *) NULL)\n     {\n       (void) MagickCore::DestroyExceptionInfo(exceptionInfo);\n-      throwExceptionExplicit(ImageWarning,\"No image was loaded.\");\n+      if (!quiet())\n+        throwExceptionExplicit(MagickCore::ImageWarning,\n+          \"No image was loaded.\");\n+    }\n+  else\n+    {\n+      ThrowImageException;\n     }\n-  ThrowImageException;\n   if (image != (MagickCore::Image *) NULL)\n     throwException(&image->exception,quiet());\n }\n","owner":"ImageMagick","repo":"ImageMagick","source":"cve"},{"CVE_ID":"CVE-2017-12877","CWE_ID":"416","category":"security","commit_id":"04178de2247e353fc095846784b9a10fefdbf890","commit_message":"From 04178de2247e353fc095846784b9a10fefdbf890 Mon Sep 17 00:00:00 2001\nFrom: Cristy <urban-warrior@imagemagick.org>\nDate: Wed, 9 Aug 2017 08:01:38 -0400\nSubject: [PATCH] https:\/\/github.com\/ImageMagick\/ImageMagick\/issues\/662\n\n---\n coders\/mat.c | 4 ++--\n 1 file changed, 2 insertions(+), 2 deletions(-)\n\n","diff_code":"diff --git a\/coders\/mat.c b\/coders\/mat.c\nindex e3b80f14b9..fc8da2b144 100644\n--- a\/coders\/mat.c\n+++ b\/coders\/mat.c\n@@ -1330,8 +1330,6 @@ RestoreMSCWarning\n   if (quantum_info != (QuantumInfo *) NULL)\n     quantum_info=DestroyQuantumInfo(quantum_info);\n END_OF_READING:\n-  if (clone_info)\n-    clone_info=DestroyImageInfo(clone_info);\n   CloseBlob(image);\n \n \n@@ -1349,6 +1347,8 @@ RestoreMSCWarning\n         Image *tmp=p;\n         if ((p->rows == 0) || (p->columns == 0)) {\n           p=p->previous;\n+          if (tmp == image2)\n+            image2=(Image *) NULL;\n           DeleteImageFromList(&tmp);\n         } else {\n           image=p;\n","owner":"ImageMagick","repo":"ImageMagick","source":"cve"},{"CVE_ID":"CVE-2017-12932","CWE_ID":"416","category":"security","commit_id":"1a23ebc1fff59bf480ca92963b36eba5c1b904c4","commit_message":"From 1a23ebc1fff59bf480ca92963b36eba5c1b904c4 Mon Sep 17 00:00:00 2001\nFrom: Nikita Popov <nikita.ppv@gmail.com>\nDate: Sat, 12 Aug 2017 13:00:39 +0200\nSubject: [PATCH] Fixed bug #74103 and bug #75054\n\nDirectly fail unserialization when trying to acquire an r\/R\nreference to an UNDEF HT slot. Previously this left an UNDEF and\nlater deleted the index\/key from the HT.\n\nWhat actually caused the issue here is a combination of two\nfactors: First, the key deletion was performed using the hash API,\nrather than the symtable API, such that the element was not actually\nremoved if it used an integral string key. Second, a subsequent\ndeletion operation, while collecting trailing UNDEF ranges, would\nmark the element as available for reuse (leaving a corrupted HT\nstate with nNumOfElemnts > nNumUsed).\n\nFix this by failing early and dropping the deletion code.\n---\n NEWS                                       |    6 +\n ext\/standard\/tests\/serialize\/bug74103.phpt |    9 +\n ext\/standard\/tests\/serialize\/bug75054.phpt |   12 +\n ext\/standard\/var_unserializer.c            | 1153 ++++++++++----------\n ext\/standard\/var_unserializer.re           |   19 +-\n 5 files changed, 614 insertions(+), 585 deletions(-)\n create mode 100644 ext\/standard\/tests\/serialize\/bug74103.phpt\n create mode 100644 ext\/standard\/tests\/serialize\/bug75054.phpt\n\n","diff_code":"diff --git a\/NEWS b\/NEWS\nindex 5fc4f75616ef..8920376b4d20 100644\n--- a\/NEWS\n+++ b\/NEWS\n@@ -52,6 +52,12 @@ PHP                                                                        NEWS\n   . Fixed bug #74669 (Unserialize ArrayIterator broken). (Andrew Nester)\n   . Fixed bug #75015 (Crash in recursive iterator destructors). (Julien)\n \n+- Standard:\n+  . Fixed bug #74103 (heap-use-after-free when unserializing invalid array\n+    size). (Nikita)\n+  . Fixed bug #75054 (A Denial of Service Vulnerability was found when\n+    performing deserialization). (Nikita)\n+\n - XMLRPC:\n   . Fixed bug #74975 (Incorrect xmlrpc serialization for classes with declared\n     properties). (blar)\ndiff --git a\/ext\/standard\/tests\/serialize\/bug74103.phpt b\/ext\/standard\/tests\/serialize\/bug74103.phpt\nnew file mode 100644\nindex 000000000000..3d474b31b1cd\n--- \/dev\/null\n+++ b\/ext\/standard\/tests\/serialize\/bug74103.phpt\n@@ -0,0 +1,9 @@\n+--TEST--\n+Bug #74103: heap-use-after-free when unserializing invalid array size\n+--FILE--\n+<?php\n+var_dump(unserialize('a:7:{i:0;i:04;s:1:\"a\";i:2;i:00009617006;i:4;s:1:\"a\";i:4;s:1:\"a\";R:5;s:1:\"7\";R:3;s:1:\"a\";R:5;;s:18;}}'));\n+?>\n+--EXPECTF--\n+Notice: unserialize(): Error at offset 68 of 100 bytes in %s on line %d\n+bool(false)\ndiff --git a\/ext\/standard\/tests\/serialize\/bug75054.phpt b\/ext\/standard\/tests\/serialize\/bug75054.phpt\nnew file mode 100644\nindex 000000000000..51f5692f445a\n--- \/dev\/null\n+++ b\/ext\/standard\/tests\/serialize\/bug75054.phpt\n@@ -0,0 +1,12 @@\n+--TEST--\n+Bug #75054: A Denial of Service Vulnerability was found when performing deserialization\n+--FILE--\n+<?php\n+$poc = 'a:9:{i:0;s:4:\"0000\";i:0;s:4:\"0000\";i:0;R:2;s:4:\"5003\";R:2;s:4:\"0000\";R:2;s:4:\"0000\";R:2;s:4:\"';\n+$poc .= \"\\x06\";\n+$poc .= '000\";R:2;s:4:\"0000\";d:0;s:4:\"0000\";a:9:{s:4:\"0000\";';\n+var_dump(unserialize($poc));\n+?>\n+--EXPECTF--\n+Notice: unserialize(): Error at offset 43 of 145 bytes in %s on line %d\n+bool(false)\ndiff --git a\/ext\/standard\/var_unserializer.c b\/ext\/standard\/var_unserializer.c\nindex c50347d781f0..79545a936231 100644\n--- a\/ext\/standard\/var_unserializer.c\n+++ b\/ext\/standard\/var_unserializer.c\n@@ -1,4 +1,4 @@\n-\/* Generated by re2c 0.15.3 *\/\n+\/* Generated by re2c 0.16 *\/\n #line 1 \"ext\/standard\/var_unserializer.re\"\n \/*\n   +----------------------------------------------------------------------+\n@@ -405,16 +405,7 @@ static zend_always_inline int process_nested_data(UNSERIALIZE_PARAMETER, HashTab\n \t\t\treturn 0;\n \t\t}\n \n-\t\tif (UNEXPECTED(Z_ISUNDEF_P(data))) {\n-\t\t\tif (Z_TYPE(key) == IS_LONG) {\n-\t\t\t\tzend_hash_index_del(ht, Z_LVAL(key));\n-\t\t\t} else {\n-\t\t\t\tzend_hash_del_ind(ht, Z_STR(key));\n-\t\t\t}\n-\t\t} else {\n-\t\t\tvar_push_dtor(var_hash, data);\n-\t\t}\n-\n+\t\tvar_push_dtor(var_hash, data);\n \t\tzval_dtor(&key);\n \n \t\tif (elements && *(*p-1) != ';' && *(*p-1) != '}') {\n@@ -581,7 +572,7 @@ static int php_var_unserialize_internal(UNSERIALIZE_PARAMETER)\n \tstart = cursor;\n \n \n-#line 585 \"ext\/standard\/var_unserializer.c\"\n+#line 576 \"ext\/standard\/var_unserializer.c\"\n {\n \tYYCTYPE yych;\n \tstatic const unsigned char yybm[] = {\n@@ -622,536 +613,409 @@ static int php_var_unserialize_internal(UNSERIALIZE_PARAMETER)\n \tyych = *YYCURSOR;\n \tswitch (yych) {\n \tcase 'C':\n-\tcase 'O':\tgoto yy13;\n+\tcase 'O':\tgoto yy4;\n \tcase 'N':\tgoto yy5;\n-\tcase 'R':\tgoto yy2;\n-\tcase 'S':\tgoto yy10;\n-\tcase 'a':\tgoto yy11;\n-\tcase 'b':\tgoto yy6;\n-\tcase 'd':\tgoto yy8;\n-\tcase 'i':\tgoto yy7;\n+\tcase 'R':\tgoto yy6;\n+\tcase 'S':\tgoto yy7;\n+\tcase 'a':\tgoto yy8;\n+\tcase 'b':\tgoto yy9;\n+\tcase 'd':\tgoto yy10;\n+\tcase 'i':\tgoto yy11;\n \tcase 'o':\tgoto yy12;\n-\tcase 'r':\tgoto yy4;\n-\tcase 's':\tgoto yy9;\n-\tcase '}':\tgoto yy14;\n-\tdefault:\tgoto yy16;\n+\tcase 'r':\tgoto yy13;\n+\tcase 's':\tgoto yy14;\n+\tcase '}':\tgoto yy15;\n+\tdefault:\tgoto yy2;\n \t}\n yy2:\n-\tyych = *(YYMARKER = ++YYCURSOR);\n-\tif (yych == ':') goto yy95;\n+\t++YYCURSOR;\n yy3:\n-#line 962 \"ext\/standard\/var_unserializer.re\"\n+#line 951 \"ext\/standard\/var_unserializer.re\"\n \t{ return 0; }\n-#line 646 \"ext\/standard\/var_unserializer.c\"\n+#line 636 \"ext\/standard\/var_unserializer.c\"\n yy4:\n \tyych = *(YYMARKER = ++YYCURSOR);\n-\tif (yych == ':') goto yy89;\n+\tif (yych == ':') goto yy17;\n \tgoto yy3;\n yy5:\n \tyych = *++YYCURSOR;\n-\tif (yych == ';') goto yy87;\n+\tif (yych == ';') goto yy19;\n \tgoto yy3;\n yy6:\n \tyych = *(YYMARKER = ++YYCURSOR);\n-\tif (yych == ':') goto yy83;\n+\tif (yych == ':') goto yy21;\n \tgoto yy3;\n yy7:\n \tyych = *(YYMARKER = ++YYCURSOR);\n-\tif (yych == ':') goto yy77;\n+\tif (yych == ':') goto yy22;\n \tgoto yy3;\n yy8:\n \tyych = *(YYMARKER = ++YYCURSOR);\n-\tif (yych == ':') goto yy53;\n+\tif (yych == ':') goto yy23;\n \tgoto yy3;\n yy9:\n \tyych = *(YYMARKER = ++YYCURSOR);\n-\tif (yych == ':') goto yy46;\n+\tif (yych == ':') goto yy24;\n \tgoto yy3;\n yy10:\n \tyych = *(YYMARKER = ++YYCURSOR);\n-\tif (yych == ':') goto yy39;\n+\tif (yych == ':') goto yy25;\n \tgoto yy3;\n yy11:\n \tyych = *(YYMARKER = ++YYCURSOR);\n-\tif (yych == ':') goto yy32;\n+\tif (yych == ':') goto yy26;\n \tgoto yy3;\n yy12:\n \tyych = *(YYMARKER = ++YYCURSOR);\n-\tif (yych == ':') goto yy25;\n+\tif (yych == ':') goto yy27;\n \tgoto yy3;\n yy13:\n \tyych = *(YYMARKER = ++YYCURSOR);\n-\tif (yych == ':') goto yy17;\n+\tif (yych == ':') goto yy28;\n \tgoto yy3;\n yy14:\n+\tyych = *(YYMARKER = ++YYCURSOR);\n+\tif (yych == ':') goto yy29;\n+\tgoto yy3;\n+yy15:\n \t++YYCURSOR;\n-#line 956 \"ext\/standard\/var_unserializer.re\"\n+#line 945 \"ext\/standard\/var_unserializer.re\"\n \t{\n \t\/* this is the case where we have less data than planned *\/\n \tphp_error_docref(NULL, E_NOTICE, \"Unexpected end of serialized data\");\n \treturn 0; \/* not sure if it should be 0 or 1 here? *\/\n }\n-#line 695 \"ext\/standard\/var_unserializer.c\"\n-yy16:\n-\tyych = *++YYCURSOR;\n-\tgoto yy3;\n+#line 689 \"ext\/standard\/var_unserializer.c\"\n yy17:\n \tyych = *++YYCURSOR;\n \tif (yybm[0+yych] & 128) {\n-\t\tgoto yy20;\n+\t\tgoto yy31;\n \t}\n-\tif (yych == '+') goto yy19;\n+\tif (yych == '+') goto yy30;\n yy18:\n \tYYCURSOR = YYMARKER;\n \tgoto yy3;\n yy19:\n+\t++YYCURSOR;\n+#line 629 \"ext\/standard\/var_unserializer.re\"\n+\t{\n+\t*p = YYCURSOR;\n+\tZVAL_NULL(rval);\n+\treturn 1;\n+}\n+#line 707 \"ext\/standard\/var_unserializer.c\"\n+yy21:\n \tyych = *++YYCURSOR;\n-\tif (yybm[0+yych] & 128) {\n-\t\tgoto yy20;\n+\tif (yych <= ',') {\n+\t\tif (yych == '+') goto yy33;\n+\t\tgoto yy18;\n+\t} else {\n+\t\tif (yych <= '-') goto yy33;\n+\t\tif (yych <= '\/') goto yy18;\n+\t\tif (yych <= '9') goto yy34;\n+\t\tgoto yy18;\n \t}\n+yy22:\n+\tyych = *++YYCURSOR;\n+\tif (yych == '+') goto yy36;\n+\tif (yych <= '\/') goto yy18;\n+\tif (yych <= '9') goto yy37;\n \tgoto yy18;\n-yy20:\n-\t++YYCURSOR;\n-\tif ((YYLIMIT - YYCURSOR) < 2) YYFILL(2);\n-\tyych = *YYCURSOR;\n-\tif (yybm[0+yych] & 128) {\n-\t\tgoto yy20;\n-\t}\n+yy23:\n+\tyych = *++YYCURSOR;\n+\tif (yych == '+') goto yy39;\n \tif (yych <= '\/') goto yy18;\n-\tif (yych >= ';') goto yy18;\n+\tif (yych <= '9') goto yy40;\n+\tgoto yy18;\n+yy24:\n \tyych = *++YYCURSOR;\n-\tif (yych != '\"') goto yy18;\n-\t++YYCURSOR;\n-#line 804 \"ext\/standard\/var_unserializer.re\"\n-\t{\n-\tsize_t len, len2, len3, maxlen;\n-\tzend_long elements;\n-\tchar *str;\n-\tzend_string *class_name;\n-\tzend_class_entry *ce;\n-\tint incomplete_class = 0;\n-\n-\tint custom_object = 0;\n-\n-\tzval user_func;\n-\tzval retval;\n-\tzval args[1];\n-\n-    if (!var_hash) return 0;\n-\tif (*start == 'C') {\n-\t\tcustom_object = 1;\n-\t}\n-\n-\tlen2 = len = parse_uiv(start + 2);\n-\tmaxlen = max - YYCURSOR;\n-\tif (maxlen < len || len == 0) {\n-\t\t*p = start + 2;\n-\t\treturn 0;\n-\t}\n-\n-\tstr = (char*)YYCURSOR;\n-\n-\tYYCURSOR += len;\n-\n-\tif (*(YYCURSOR) != '\"') {\n-\t\t*p = YYCURSOR;\n-\t\treturn 0;\n-\t}\n-\tif (*(YYCURSOR+1) != ':') {\n-\t\t*p = YYCURSOR+1;\n-\t\treturn 0;\n-\t}\n-\n-\tlen3 = strspn(str, \"0123456789_abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\\177\\200\\201\\202\\203\\204\\205\\206\\207\\210\\211\\212\\213\\214\\215\\216\\217\\220\\221\\222\\223\\224\\225\\226\\227\\230\\231\\232\\233\\234\\235\\236\\237\\240\\241\\242\\243\\244\\245\\246\\247\\250\\251\\252\\253\\254\\255\\256\\257\\260\\261\\262\\263\\264\\265\\266\\267\\270\\271\\272\\273\\274\\275\\276\\277\\300\\301\\302\\303\\304\\305\\306\\307\\310\\311\\312\\313\\314\\315\\316\\317\\320\\321\\322\\323\\324\\325\\326\\327\\330\\331\\332\\333\\334\\335\\336\\337\\340\\341\\342\\343\\344\\345\\346\\347\\350\\351\\352\\353\\354\\355\\356\\357\\360\\361\\362\\363\\364\\365\\366\\367\\370\\371\\372\\373\\374\\375\\376\\377\\\\\");\n-\tif (len3 != len)\n-\t{\n-\t\t*p = YYCURSOR + len3 - len;\n-\t\treturn 0;\n-\t}\n-\n-\tclass_name = zend_string_init(str, len, 0);\n-\n-\tdo {\n-\t\tif(!unserialize_allowed_class(class_name, classes)) {\n-\t\t\tincomplete_class = 1;\n-\t\t\tce = PHP_IC_ENTRY;\n-\t\t\tbreak;\n-\t\t}\n-\n-\t\t\/* Try to find class directly *\/\n-\t\tBG(serialize_lock)++;\n-\t\tce = zend_lookup_class(class_name);\n-\t\tif (ce) {\n-\t\t\tBG(serialize_lock)--;\n-\t\t\tif (EG(exception)) {\n-\t\t\t\tzend_string_release(class_name);\n-\t\t\t\treturn 0;\n-\t\t\t}\n-\t\t\tbreak;\n-\t\t}\n-\t\tBG(serialize_lock)--;\n-\n-\t\tif (EG(exception)) {\n-\t\t\tzend_string_release(class_name);\n-\t\t\treturn 0;\n-\t\t}\n-\n-\t\t\/* Check for unserialize callback *\/\n-\t\tif ((PG(unserialize_callback_func) == NULL) || (PG(unserialize_callback_func)[0] == '\\0')) {\n-\t\t\tincomplete_class = 1;\n-\t\t\tce = PHP_IC_ENTRY;\n-\t\t\tbreak;\n-\t\t}\n-\n-\t\t\/* Call unserialize callback *\/\n-\t\tZVAL_STRING(&user_func, PG(unserialize_callback_func));\n-\n-\t\tZVAL_STR_COPY(&args[0], class_name);\n-\t\tBG(serialize_lock)++;\n-\t\tif (call_user_function_ex(CG(function_table), NULL, &user_func, &retval, 1, args, 0, NULL) != SUCCESS) {\n-\t\t\tBG(serialize_lock)--;\n-\t\t\tif (EG(exception)) {\n-\t\t\t\tzend_string_release(class_name);\n-\t\t\t\tzval_ptr_dtor(&user_func);\n-\t\t\t\tzval_ptr_dtor(&args[0]);\n-\t\t\t\treturn 0;\n-\t\t\t}\n-\t\t\tphp_error_docref(NULL, E_WARNING, \"defined (%s) but not found\", Z_STRVAL(user_func));\n-\t\t\tincomplete_class = 1;\n-\t\t\tce = PHP_IC_ENTRY;\n-\t\t\tzval_ptr_dtor(&user_func);\n-\t\t\tzval_ptr_dtor(&args[0]);\n-\t\t\tbreak;\n-\t\t}\n-\t\tBG(serialize_lock)--;\n-\t\tzval_ptr_dtor(&retval);\n-\t\tif (EG(exception)) {\n-\t\t\tzend_string_release(class_name);\n-\t\t\tzval_ptr_dtor(&user_func);\n-\t\t\tzval_ptr_dtor(&args[0]);\n-\t\t\treturn 0;\n-\t\t}\n-\n-\t\t\/* The callback function may have defined the class *\/\n-\t\tBG(serialize_lock)++;\n-\t\tif ((ce = zend_lookup_class(class_name)) == NULL) {\n-\t\t\tphp_error_docref(NULL, E_WARNING, \"Function %s() hasn't defined the class it was called for\", Z_STRVAL(user_func));\n-\t\t\tincomplete_class = 1;\n-\t\t\tce = PHP_IC_ENTRY;\n+\tif (yych <= '\/') goto yy18;\n+\tif (yych <= '1') goto yy42;\n+\tgoto yy18;\n+yy25:\n+\tyych = *++YYCURSOR;\n+\tif (yych <= '\/') {\n+\t\tif (yych <= ',') {\n+\t\t\tif (yych == '+') goto yy43;\n+\t\t\tgoto yy18;\n+\t\t} else {\n+\t\t\tif (yych <= '-') goto yy44;\n+\t\t\tif (yych <= '.') goto yy45;\n+\t\t\tgoto yy18;\n \t\t}\n-\t\tBG(serialize_lock)--;\n-\n-\t\tzval_ptr_dtor(&user_func);\n-\t\tzval_ptr_dtor(&args[0]);\n-\t\tbreak;\n-\t} while (1);\n-\n-\t*p = YYCURSOR;\n-\n-\tif (custom_object) {\n-\t\tint ret;\n-\n-\t\tret = object_custom(UNSERIALIZE_PASSTHRU, ce);\n-\n-\t\tif (ret && incomplete_class) {\n-\t\t\tphp_store_class_name(rval, ZSTR_VAL(class_name), len2);\n+\t} else {\n+\t\tif (yych <= 'I') {\n+\t\t\tif (yych <= '9') goto yy46;\n+\t\t\tif (yych <= 'H') goto yy18;\n+\t\t\tgoto yy48;\n+\t\t} else {\n+\t\t\tif (yych == 'N') goto yy49;\n+\t\t\tgoto yy18;\n \t\t}\n-\t\tzend_string_release(class_name);\n-\t\treturn ret;\n \t}\n-\n-\telements = object_common1(UNSERIALIZE_PASSTHRU, ce);\n-\n-\tif (elements < 0) {\n-\t   zend_string_release(class_name);\n-\t   return 0;\n+yy26:\n+\tyych = *++YYCURSOR;\n+\tif (yych <= ',') {\n+\t\tif (yych == '+') goto yy50;\n+\t\tgoto yy18;\n+\t} else {\n+\t\tif (yych <= '-') goto yy50;\n+\t\tif (yych <= '\/') goto yy18;\n+\t\tif (yych <= '9') goto yy51;\n+\t\tgoto yy18;\n \t}\n-\n-\tif (incomplete_class) {\n-\t\tphp_store_class_name(rval, ZSTR_VAL(class_name), len2);\n+yy27:\n+\tyych = *++YYCURSOR;\n+\tif (yych <= ',') {\n+\t\tif (yych == '+') goto yy53;\n+\t\tgoto yy18;\n+\t} else {\n+\t\tif (yych <= '-') goto yy53;\n+\t\tif (yych <= '\/') goto yy18;\n+\t\tif (yych <= '9') goto yy54;\n+\t\tgoto yy18;\n \t}\n-\tzend_string_release(class_name);\n-\n-\treturn object_common2(UNSERIALIZE_PASSTHRU, elements);\n-}\n-#line 878 \"ext\/standard\/var_unserializer.c\"\n-yy25:\n+yy28:\n \tyych = *++YYCURSOR;\n \tif (yych <= ',') {\n-\t\tif (yych != '+') goto yy18;\n+\t\tif (yych == '+') goto yy56;\n+\t\tgoto yy18;\n \t} else {\n-\t\tif (yych <= '-') goto yy26;\n+\t\tif (yych <= '-') goto yy56;\n \t\tif (yych <= '\/') goto yy18;\n-\t\tif (yych <= '9') goto yy27;\n+\t\tif (yych <= '9') goto yy57;\n \t\tgoto yy18;\n \t}\n-yy26:\n+yy29:\n \tyych = *++YYCURSOR;\n+\tif (yych == '+') goto yy59;\n \tif (yych <= '\/') goto yy18;\n-\tif (yych >= ':') goto yy18;\n-yy27:\n+\tif (yych <= '9') goto yy60;\n+\tgoto yy18;\n+yy30:\n+\tyych = *++YYCURSOR;\n+\tif (yybm[0+yych] & 128) {\n+\t\tgoto yy31;\n+\t}\n+\tgoto yy18;\n+yy31:\n \t++YYCURSOR;\n \tif ((YYLIMIT - YYCURSOR) < 2) YYFILL(2);\n \tyych = *YYCURSOR;\n+\tif (yybm[0+yych] & 128) {\n+\t\tgoto yy31;\n+\t}\n \tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy27;\n-\tif (yych >= ';') goto yy18;\n+\tif (yych <= ':') goto yy62;\n+\tgoto yy18;\n+yy33:\n \tyych = *++YYCURSOR;\n-\tif (yych != '\"') goto yy18;\n+\tif (yych <= '\/') goto yy18;\n+\tif (yych >= ':') goto yy18;\n+yy34:\n \t++YYCURSOR;\n-#line 793 \"ext\/standard\/var_unserializer.re\"\n-\t{\n-\tzend_long elements;\n-    if (!var_hash) return 0;\n-\n-\telements = object_common1(UNSERIALIZE_PASSTHRU, ZEND_STANDARD_CLASS_DEF_PTR);\n-\tif (elements < 0 || elements >= HT_MAX_SIZE) {\n-\t\treturn 0;\n-\t}\n-\treturn object_common2(UNSERIALIZE_PASSTHRU, elements);\n-}\n-#line 914 \"ext\/standard\/var_unserializer.c\"\n-yy32:\n-\tyych = *++YYCURSOR;\n-\tif (yych == '+') goto yy33;\n+\tif (YYLIMIT <= YYCURSOR) YYFILL(1);\n+\tyych = *YYCURSOR;\n \tif (yych <= '\/') goto yy18;\n \tif (yych <= '9') goto yy34;\n+\tif (yych == ';') goto yy63;\n \tgoto yy18;\n-yy33:\n+yy36:\n \tyych = *++YYCURSOR;\n \tif (yych <= '\/') goto yy18;\n \tif (yych >= ':') goto yy18;\n-yy34:\n+yy37:\n \t++YYCURSOR;\n \tif ((YYLIMIT - YYCURSOR) < 2) YYFILL(2);\n \tyych = *YYCURSOR;\n \tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy34;\n-\tif (yych >= ';') goto yy18;\n+\tif (yych <= '9') goto yy37;\n+\tif (yych <= ':') goto yy65;\n+\tgoto yy18;\n+yy39:\n \tyych = *++YYCURSOR;\n-\tif (yych != '{') goto yy18;\n+\tif (yych <= '\/') goto yy18;\n+\tif (yych >= ':') goto yy18;\n+yy40:\n \t++YYCURSOR;\n-#line 769 \"ext\/standard\/var_unserializer.re\"\n-\t{\n-\tzend_long elements = parse_iv(start + 2);\n-\t\/* use iv() not uiv() in order to check data range *\/\n-\t*p = YYCURSOR;\n-    if (!var_hash) return 0;\n-\n-\tif (elements < 0 || elements >= HT_MAX_SIZE) {\n-\t\treturn 0;\n-\t}\n-\n-\tarray_init_size(rval, elements);\n-\tif (elements) {\n-\t\t\/* we can't convert from packed to hash during unserialization, because\n-\t\t   reference to some zvals might be keept in var_hash (to support references) *\/\n-\t\tzend_hash_real_init(Z_ARRVAL_P(rval), 0);\n+\tif ((YYLIMIT - YYCURSOR) < 2) YYFILL(2);\n+\tyych = *YYCURSOR;\n+\tif (yych <= '\/') goto yy18;\n+\tif (yych <= '9') goto yy40;\n+\tif (yych <= ':') goto yy66;\n+\tgoto yy18;\n+yy42:\n+\tyych = *++YYCURSOR;\n+\tif (yych == ';') goto yy67;\n+\tgoto yy18;\n+yy43:\n+\tyych = *++YYCURSOR;\n+\tif (yych == '.') goto yy45;\n+\tif (yych <= '\/') goto yy18;\n+\tif (yych <= '9') goto yy46;\n+\tgoto yy18;\n+yy44:\n+\tyych = *++YYCURSOR;\n+\tif (yych <= '\/') {\n+\t\tif (yych != '.') goto yy18;\n+\t} else {\n+\t\tif (yych <= '9') goto yy46;\n+\t\tif (yych == 'I') goto yy48;\n+\t\tgoto yy18;\n \t}\n-\n-\tif (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_ARRVAL_P(rval), elements, 0)) {\n-\t\treturn 0;\n+yy45:\n+\tyych = *++YYCURSOR;\n+\tif (yych <= '\/') goto yy18;\n+\tif (yych <= '9') goto yy69;\n+\tgoto yy18;\n+yy46:\n+\t++YYCURSOR;\n+\tif ((YYLIMIT - YYCURSOR) < 4) YYFILL(4);\n+\tyych = *YYCURSOR;\n+\tif (yych <= ':') {\n+\t\tif (yych <= '.') {\n+\t\t\tif (yych <= '-') goto yy18;\n+\t\t\tgoto yy69;\n+\t\t} else {\n+\t\t\tif (yych <= '\/') goto yy18;\n+\t\t\tif (yych <= '9') goto yy46;\n+\t\t\tgoto yy18;\n+\t\t}\n+\t} else {\n+\t\tif (yych <= 'E') {\n+\t\t\tif (yych <= ';') goto yy71;\n+\t\t\tif (yych <= 'D') goto yy18;\n+\t\t\tgoto yy73;\n+\t\t} else {\n+\t\t\tif (yych == 'e') goto yy73;\n+\t\t\tgoto yy18;\n+\t\t}\n \t}\n-\n-\treturn finish_nested_data(UNSERIALIZE_PASSTHRU);\n-}\n-#line 959 \"ext\/standard\/var_unserializer.c\"\n-yy39:\n+yy48:\n+\tyych = *++YYCURSOR;\n+\tif (yych == 'N') goto yy74;\n+\tgoto yy18;\n+yy49:\n+\tyych = *++YYCURSOR;\n+\tif (yych == 'A') goto yy75;\n+\tgoto yy18;\n+yy50:\n \tyych = *++YYCURSOR;\n-\tif (yych == '+') goto yy40;\n \tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy41;\n+\tif (yych >= ':') goto yy18;\n+yy51:\n+\t++YYCURSOR;\n+\tif (YYLIMIT <= YYCURSOR) YYFILL(1);\n+\tyych = *YYCURSOR;\n+\tif (yych <= '\/') goto yy18;\n+\tif (yych <= '9') goto yy51;\n+\tif (yych == ';') goto yy76;\n \tgoto yy18;\n-yy40:\n+yy53:\n \tyych = *++YYCURSOR;\n \tif (yych <= '\/') goto yy18;\n \tif (yych >= ':') goto yy18;\n-yy41:\n+yy54:\n \t++YYCURSOR;\n \tif ((YYLIMIT - YYCURSOR) < 2) YYFILL(2);\n \tyych = *YYCURSOR;\n \tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy41;\n-\tif (yych >= ';') goto yy18;\n+\tif (yych <= '9') goto yy54;\n+\tif (yych <= ':') goto yy78;\n+\tgoto yy18;\n+yy56:\n \tyych = *++YYCURSOR;\n-\tif (yych != '\"') goto yy18;\n+\tif (yych <= '\/') goto yy18;\n+\tif (yych >= ':') goto yy18;\n+yy57:\n \t++YYCURSOR;\n-#line 735 \"ext\/standard\/var_unserializer.re\"\n-\t{\n-\tsize_t len, maxlen;\n-\tzend_string *str;\n-\n-\tlen = parse_uiv(start + 2);\n-\tmaxlen = max - YYCURSOR;\n-\tif (maxlen < len) {\n-\t\t*p = start + 2;\n-\t\treturn 0;\n-\t}\n-\n-\tif ((str = unserialize_str(&YYCURSOR, len, maxlen)) == NULL) {\n-\t\treturn 0;\n-\t}\n-\n-\tif (*(YYCURSOR) != '\"') {\n-\t\tzend_string_free(str);\n-\t\t*p = YYCURSOR;\n-\t\treturn 0;\n-\t}\n-\n-\tif (*(YYCURSOR + 1) != ';') {\n-\t\tefree(str);\n-\t\t*p = YYCURSOR + 1;\n-\t\treturn 0;\n-\t}\n-\n-\tYYCURSOR += 2;\n-\t*p = YYCURSOR;\n-\n-\tZVAL_STR(rval, str);\n-\treturn 1;\n-}\n-#line 1014 \"ext\/standard\/var_unserializer.c\"\n-yy46:\n-\tyych = *++YYCURSOR;\n-\tif (yych == '+') goto yy47;\n+\tif (YYLIMIT <= YYCURSOR) YYFILL(1);\n+\tyych = *YYCURSOR;\n \tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy48;\n+\tif (yych <= '9') goto yy57;\n+\tif (yych == ';') goto yy79;\n \tgoto yy18;\n-yy47:\n+yy59:\n \tyych = *++YYCURSOR;\n \tif (yych <= '\/') goto yy18;\n \tif (yych >= ':') goto yy18;\n-yy48:\n+yy60:\n \t++YYCURSOR;\n \tif ((YYLIMIT - YYCURSOR) < 2) YYFILL(2);\n \tyych = *YYCURSOR;\n \tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy48;\n-\tif (yych >= ';') goto yy18;\n+\tif (yych <= '9') goto yy60;\n+\tif (yych <= ':') goto yy81;\n+\tgoto yy18;\n+yy62:\n \tyych = *++YYCURSOR;\n-\tif (yych != '\"') goto yy18;\n+\tif (yych == '\"') goto yy82;\n+\tgoto yy18;\n+yy63:\n \t++YYCURSOR;\n-#line 703 \"ext\/standard\/var_unserializer.re\"\n+#line 580 \"ext\/standard\/var_unserializer.re\"\n \t{\n-\tsize_t len, maxlen;\n-\tchar *str;\n-\n-\tlen = parse_uiv(start + 2);\n-\tmaxlen = max - YYCURSOR;\n-\tif (maxlen < len) {\n-\t\t*p = start + 2;\n-\t\treturn 0;\n-\t}\n-\n-\tstr = (char*)YYCURSOR;\n+\tzend_long id;\n \n-\tYYCURSOR += len;\n+ \t*p = YYCURSOR;\n+\tif (!var_hash) return 0;\n \n-\tif (*(YYCURSOR) != '\"') {\n-\t\t*p = YYCURSOR;\n+\tid = parse_iv(start + 2) - 1;\n+\tif (id == -1 || (rval_ref = var_access(var_hash, id)) == NULL) {\n \t\treturn 0;\n \t}\n \n-\tif (*(YYCURSOR + 1) != ';') {\n-\t\t*p = YYCURSOR + 1;\n+\tif (Z_ISUNDEF_P(rval_ref) || (Z_ISREF_P(rval_ref) && Z_ISUNDEF_P(Z_REFVAL_P(rval_ref)))) {\n \t\treturn 0;\n \t}\n \n-\tYYCURSOR += 2;\n-\t*p = YYCURSOR;\n+\tif (Z_ISREF_P(rval_ref)) {\n+\t\tZVAL_COPY(rval, rval_ref);\n+\t} else {\n+\t\tZVAL_NEW_REF(rval_ref, rval_ref);\n+\t\tZVAL_COPY(rval, rval_ref);\n+\t}\n \n-\tZVAL_STRINGL(rval, str, len);\n \treturn 1;\n }\n-#line 1067 \"ext\/standard\/var_unserializer.c\"\n-yy53:\n-\tyych = *++YYCURSOR;\n-\tif (yych <= '\/') {\n-\t\tif (yych <= ',') {\n-\t\t\tif (yych == '+') goto yy57;\n-\t\t\tgoto yy18;\n-\t\t} else {\n-\t\t\tif (yych <= '-') goto yy55;\n-\t\t\tif (yych <= '.') goto yy60;\n-\t\t\tgoto yy18;\n-\t\t}\n-\t} else {\n-\t\tif (yych <= 'I') {\n-\t\t\tif (yych <= '9') goto yy58;\n-\t\t\tif (yych <= 'H') goto yy18;\n-\t\t\tgoto yy56;\n-\t\t} else {\n-\t\t\tif (yych != 'N') goto yy18;\n-\t\t}\n-\t}\n+#line 982 \"ext\/standard\/var_unserializer.c\"\n+yy65:\n \tyych = *++YYCURSOR;\n-\tif (yych == 'A') goto yy76;\n+\tif (yych == '\"') goto yy84;\n \tgoto yy18;\n-yy55:\n-\tyych = *++YYCURSOR;\n-\tif (yych <= '\/') {\n-\t\tif (yych == '.') goto yy60;\n-\t\tgoto yy18;\n-\t} else {\n-\t\tif (yych <= '9') goto yy58;\n-\t\tif (yych != 'I') goto yy18;\n-\t}\n-yy56:\n+yy66:\n \tyych = *++YYCURSOR;\n-\tif (yych == 'N') goto yy72;\n+\tif (yych == '{') goto yy86;\n \tgoto yy18;\n-yy57:\n-\tyych = *++YYCURSOR;\n-\tif (yych == '.') goto yy60;\n-\tif (yych <= '\/') goto yy18;\n-\tif (yych >= ':') goto yy18;\n-yy58:\n+yy67:\n \t++YYCURSOR;\n-\tif ((YYLIMIT - YYCURSOR) < 4) YYFILL(4);\n-\tyych = *YYCURSOR;\n-\tif (yych <= ':') {\n-\t\tif (yych <= '.') {\n-\t\t\tif (yych <= '-') goto yy18;\n-\t\t\tgoto yy70;\n-\t\t} else {\n-\t\t\tif (yych <= '\/') goto yy18;\n-\t\t\tif (yych <= '9') goto yy58;\n-\t\t\tgoto yy18;\n-\t\t}\n-\t} else {\n-\t\tif (yych <= 'E') {\n-\t\t\tif (yych <= ';') goto yy63;\n-\t\t\tif (yych <= 'D') goto yy18;\n-\t\t\tgoto yy65;\n-\t\t} else {\n-\t\t\tif (yych == 'e') goto yy65;\n-\t\t\tgoto yy18;\n-\t\t}\n-\t}\n-yy60:\n-\tyych = *++YYCURSOR;\n-\tif (yych <= '\/') goto yy18;\n-\tif (yych >= ':') goto yy18;\n-yy61:\n+#line 635 \"ext\/standard\/var_unserializer.re\"\n+\t{\n+\t*p = YYCURSOR;\n+\tZVAL_BOOL(rval, parse_iv(start + 2));\n+\treturn 1;\n+}\n+#line 999 \"ext\/standard\/var_unserializer.c\"\n+yy69:\n \t++YYCURSOR;\n \tif ((YYLIMIT - YYCURSOR) < 4) YYFILL(4);\n \tyych = *YYCURSOR;\n \tif (yych <= ';') {\n \t\tif (yych <= '\/') goto yy18;\n-\t\tif (yych <= '9') goto yy61;\n+\t\tif (yych <= '9') goto yy69;\n \t\tif (yych <= ':') goto yy18;\n \t} else {\n \t\tif (yych <= 'E') {\n \t\t\tif (yych <= 'D') goto yy18;\n-\t\t\tgoto yy65;\n+\t\t\tgoto yy73;\n \t\t} else {\n-\t\t\tif (yych == 'e') goto yy65;\n+\t\t\tif (yych == 'e') goto yy73;\n \t\t\tgoto yy18;\n \t\t}\n \t}\n-yy63:\n+yy71:\n \t++YYCURSOR;\n-#line 694 \"ext\/standard\/var_unserializer.re\"\n+#line 683 \"ext\/standard\/var_unserializer.re\"\n \t{\n #if SIZEOF_ZEND_LONG == 4\n use_double:\n@@ -1160,257 +1024,406 @@ static int php_var_unserialize_internal(UNSERIALIZE_PARAMETER)\n \tZVAL_DOUBLE(rval, zend_strtod((const char *)start + 2, NULL));\n \treturn 1;\n }\n-#line 1164 \"ext\/standard\/var_unserializer.c\"\n-yy65:\n+#line 1028 \"ext\/standard\/var_unserializer.c\"\n+yy73:\n \tyych = *++YYCURSOR;\n \tif (yych <= ',') {\n-\t\tif (yych != '+') goto yy18;\n+\t\tif (yych == '+') goto yy88;\n+\t\tgoto yy18;\n \t} else {\n-\t\tif (yych <= '-') goto yy66;\n+\t\tif (yych <= '-') goto yy88;\n \t\tif (yych <= '\/') goto yy18;\n-\t\tif (yych <= '9') goto yy67;\n+\t\tif (yych <= '9') goto yy89;\n \t\tgoto yy18;\n \t}\n-yy66:\n+yy74:\n \tyych = *++YYCURSOR;\n-\tif (yych <= ',') {\n-\t\tif (yych == '+') goto yy69;\n-\t\tgoto yy18;\n-\t} else {\n-\t\tif (yych <= '-') goto yy69;\n-\t\tif (yych <= '\/') goto yy18;\n-\t\tif (yych >= ':') goto yy18;\n-\t}\n-yy67:\n-\t++YYCURSOR;\n-\tif (YYLIMIT <= YYCURSOR) YYFILL(1);\n-\tyych = *YYCURSOR;\n-\tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy67;\n-\tif (yych == ';') goto yy63;\n+\tif (yych == 'F') goto yy91;\n \tgoto yy18;\n-yy69:\n+yy75:\n \tyych = *++YYCURSOR;\n-\tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy67;\n+\tif (yych == 'N') goto yy91;\n \tgoto yy18;\n-yy70:\n+yy76:\n \t++YYCURSOR;\n-\tif ((YYLIMIT - YYCURSOR) < 4) YYFILL(4);\n-\tyych = *YYCURSOR;\n-\tif (yych <= ';') {\n-\t\tif (yych <= '\/') goto yy18;\n-\t\tif (yych <= '9') goto yy70;\n-\t\tif (yych <= ':') goto yy18;\n-\t\tgoto yy63;\n-\t} else {\n-\t\tif (yych <= 'E') {\n-\t\t\tif (yych <= 'D') goto yy18;\n-\t\t\tgoto yy65;\n+#line 641 \"ext\/standard\/var_unserializer.re\"\n+\t{\n+#if SIZEOF_ZEND_LONG == 4\n+\tint digits = YYCURSOR - start - 3;\n+\n+\tif (start[2] == '-' || start[2] == '+') {\n+\t\tdigits--;\n+\t}\n+\n+\t\/* Use double for large zend_long values that were serialized on a 64-bit system *\/\n+\tif (digits >= MAX_LENGTH_OF_LONG - 1) {\n+\t\tif (digits == MAX_LENGTH_OF_LONG - 1) {\n+\t\t\tint cmp = strncmp((char*)YYCURSOR - MAX_LENGTH_OF_LONG, long_min_digits, MAX_LENGTH_OF_LONG - 1);\n+\n+\t\t\tif (!(cmp < 0 || (cmp == 0 && start[2] == '-'))) {\n+\t\t\t\tgoto use_double;\n+\t\t\t}\n \t\t} else {\n-\t\t\tif (yych == 'e') goto yy65;\n-\t\t\tgoto yy18;\n+\t\t\tgoto use_double;\n \t\t}\n \t}\n-yy72:\n-\tyych = *++YYCURSOR;\n-\tif (yych != 'F') goto yy18;\n-yy73:\n+#endif\n+\t*p = YYCURSOR;\n+\tZVAL_LONG(rval, parse_iv(start + 2));\n+\treturn 1;\n+}\n+#line 1076 \"ext\/standard\/var_unserializer.c\"\n+yy78:\n \tyych = *++YYCURSOR;\n-\tif (yych != ';') goto yy18;\n+\tif (yych == '\"') goto yy92;\n+\tgoto yy18;\n+yy79:\n \t++YYCURSOR;\n-#line 678 \"ext\/standard\/var_unserializer.re\"\n+#line 605 \"ext\/standard\/var_unserializer.re\"\n \t{\n-\t*p = YYCURSOR;\n+\tzend_long id;\n \n-\tif (!strncmp((char*)start + 2, \"NAN\", 3)) {\n-\t\tZVAL_DOUBLE(rval, php_get_nan());\n-\t} else if (!strncmp((char*)start + 2, \"INF\", 3)) {\n-\t\tZVAL_DOUBLE(rval, php_get_inf());\n-\t} else if (!strncmp((char*)start + 2, \"-INF\", 4)) {\n-\t\tZVAL_DOUBLE(rval, -php_get_inf());\n-\t} else {\n-\t\tZVAL_NULL(rval);\n+ \t*p = YYCURSOR;\n+\tif (!var_hash) return 0;\n+\n+\tid = parse_iv(start + 2) - 1;\n+\tif (id == -1 || (rval_ref = var_access(var_hash, id)) == NULL) {\n+\t\treturn 0;\n+\t}\n+\n+\tif (rval_ref == rval) {\n+\t\treturn 0;\n \t}\n \n+\tif (Z_ISUNDEF_P(rval_ref) || (Z_ISREF_P(rval_ref) && Z_ISUNDEF_P(Z_REFVAL_P(rval_ref)))) {\n+\t\treturn 0;\n+\t}\n+\n+\tZVAL_COPY(rval, rval_ref);\n+\n \treturn 1;\n }\n-#line 1239 \"ext\/standard\/var_unserializer.c\"\n-yy76:\n+#line 1107 \"ext\/standard\/var_unserializer.c\"\n+yy81:\n \tyych = *++YYCURSOR;\n-\tif (yych == 'N') goto yy73;\n+\tif (yych == '\"') goto yy94;\n \tgoto yy18;\n-yy77:\n-\tyych = *++YYCURSOR;\n-\tif (yych <= ',') {\n-\t\tif (yych != '+') goto yy18;\n-\t} else {\n-\t\tif (yych <= '-') goto yy78;\n-\t\tif (yych <= '\/') goto yy18;\n-\t\tif (yych <= '9') goto yy79;\n-\t\tgoto yy18;\n-\t}\n-yy78:\n-\tyych = *++YYCURSOR;\n-\tif (yych <= '\/') goto yy18;\n-\tif (yych >= ':') goto yy18;\n-yy79:\n+yy82:\n \t++YYCURSOR;\n-\tif (YYLIMIT <= YYCURSOR) YYFILL(1);\n-\tyych = *YYCURSOR;\n-\tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy79;\n-\tif (yych != ';') goto yy18;\n-\t++YYCURSOR;\n-#line 652 \"ext\/standard\/var_unserializer.re\"\n+#line 793 \"ext\/standard\/var_unserializer.re\"\n \t{\n-#if SIZEOF_ZEND_LONG == 4\n-\tint digits = YYCURSOR - start - 3;\n+\tsize_t len, len2, len3, maxlen;\n+\tzend_long elements;\n+\tchar *str;\n+\tzend_string *class_name;\n+\tzend_class_entry *ce;\n+\tint incomplete_class = 0;\n \n-\tif (start[2] == '-' || start[2] == '+') {\n-\t\tdigits--;\n+\tint custom_object = 0;\n+\n+\tzval user_func;\n+\tzval retval;\n+\tzval args[1];\n+\n+    if (!var_hash) return 0;\n+\tif (*start == 'C') {\n+\t\tcustom_object = 1;\n \t}\n \n-\t\/* Use double for large zend_long values that were serialized on a 64-bit system *\/\n-\tif (digits >= MAX_LENGTH_OF_LONG - 1) {\n-\t\tif (digits == MAX_LENGTH_OF_LONG - 1) {\n-\t\t\tint cmp = strncmp((char*)YYCURSOR - MAX_LENGTH_OF_LONG, long_min_digits, MAX_LENGTH_OF_LONG - 1);\n+\tlen2 = len = parse_uiv(start + 2);\n+\tmaxlen = max - YYCURSOR;\n+\tif (maxlen < len || len == 0) {\n+\t\t*p = start + 2;\n+\t\treturn 0;\n+\t}\n \n-\t\t\tif (!(cmp < 0 || (cmp == 0 && start[2] == '-'))) {\n-\t\t\t\tgoto use_double;\n+\tstr = (char*)YYCURSOR;\n+\n+\tYYCURSOR += len;\n+\n+\tif (*(YYCURSOR) != '\"') {\n+\t\t*p = YYCURSOR;\n+\t\treturn 0;\n+\t}\n+\tif (*(YYCURSOR+1) != ':') {\n+\t\t*p = YYCURSOR+1;\n+\t\treturn 0;\n+\t}\n+\n+\tlen3 = strspn(str, \"0123456789_abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\\177\\200\\201\\202\\203\\204\\205\\206\\207\\210\\211\\212\\213\\214\\215\\216\\217\\220\\221\\222\\223\\224\\225\\226\\227\\230\\231\\232\\233\\234\\235\\236\\237\\240\\241\\242\\243\\244\\245\\246\\247\\250\\251\\252\\253\\254\\255\\256\\257\\260\\261\\262\\263\\264\\265\\266\\267\\270\\271\\272\\273\\274\\275\\276\\277\\300\\301\\302\\303\\304\\305\\306\\307\\310\\311\\312\\313\\314\\315\\316\\317\\320\\321\\322\\323\\324\\325\\326\\327\\330\\331\\332\\333\\334\\335\\336\\337\\340\\341\\342\\343\\344\\345\\346\\347\\350\\351\\352\\353\\354\\355\\356\\357\\360\\361\\362\\363\\364\\365\\366\\367\\370\\371\\372\\373\\374\\375\\376\\377\\\\\");\n+\tif (len3 != len)\n+\t{\n+\t\t*p = YYCURSOR + len3 - len;\n+\t\treturn 0;\n+\t}\n+\n+\tclass_name = zend_string_init(str, len, 0);\n+\n+\tdo {\n+\t\tif(!unserialize_allowed_class(class_name, classes)) {\n+\t\t\tincomplete_class = 1;\n+\t\t\tce = PHP_IC_ENTRY;\n+\t\t\tbreak;\n+\t\t}\n+\n+\t\t\/* Try to find class directly *\/\n+\t\tBG(serialize_lock)++;\n+\t\tce = zend_lookup_class(class_name);\n+\t\tif (ce) {\n+\t\t\tBG(serialize_lock)--;\n+\t\t\tif (EG(exception)) {\n+\t\t\t\tzend_string_release(class_name);\n+\t\t\t\treturn 0;\n \t\t\t}\n-\t\t} else {\n-\t\t\tgoto use_double;\n+\t\t\tbreak;\n \t\t}\n-\t}\n-#endif\n+\t\tBG(serialize_lock)--;\n+\n+\t\tif (EG(exception)) {\n+\t\t\tzend_string_release(class_name);\n+\t\t\treturn 0;\n+\t\t}\n+\n+\t\t\/* Check for unserialize callback *\/\n+\t\tif ((PG(unserialize_callback_func) == NULL) || (PG(unserialize_callback_func)[0] == '\\0')) {\n+\t\t\tincomplete_class = 1;\n+\t\t\tce = PHP_IC_ENTRY;\n+\t\t\tbreak;\n+\t\t}\n+\n+\t\t\/* Call unserialize callback *\/\n+\t\tZVAL_STRING(&user_func, PG(unserialize_callback_func));\n+\n+\t\tZVAL_STR_COPY(&args[0], class_name);\n+\t\tBG(serialize_lock)++;\n+\t\tif (call_user_function_ex(CG(function_table), NULL, &user_func, &retval, 1, args, 0, NULL) != SUCCESS) {\n+\t\t\tBG(serialize_lock)--;\n+\t\t\tif (EG(exception)) {\n+\t\t\t\tzend_string_release(class_name);\n+\t\t\t\tzval_ptr_dtor(&user_func);\n+\t\t\t\tzval_ptr_dtor(&args[0]);\n+\t\t\t\treturn 0;\n+\t\t\t}\n+\t\t\tphp_error_docref(NULL, E_WARNING, \"defined (%s) but not found\", Z_STRVAL(user_func));\n+\t\t\tincomplete_class = 1;\n+\t\t\tce = PHP_IC_ENTRY;\n+\t\t\tzval_ptr_dtor(&user_func);\n+\t\t\tzval_ptr_dtor(&args[0]);\n+\t\t\tbreak;\n+\t\t}\n+\t\tBG(serialize_lock)--;\n+\t\tzval_ptr_dtor(&retval);\n+\t\tif (EG(exception)) {\n+\t\t\tzend_string_release(class_name);\n+\t\t\tzval_ptr_dtor(&user_func);\n+\t\t\tzval_ptr_dtor(&args[0]);\n+\t\t\treturn 0;\n+\t\t}\n+\n+\t\t\/* The callback function may have defined the class *\/\n+\t\tBG(serialize_lock)++;\n+\t\tif ((ce = zend_lookup_class(class_name)) == NULL) {\n+\t\t\tphp_error_docref(NULL, E_WARNING, \"Function %s() hasn't defined the class it was called for\", Z_STRVAL(user_func));\n+\t\t\tincomplete_class = 1;\n+\t\t\tce = PHP_IC_ENTRY;\n+\t\t}\n+\t\tBG(serialize_lock)--;\n+\n+\t\tzval_ptr_dtor(&user_func);\n+\t\tzval_ptr_dtor(&args[0]);\n+\t\tbreak;\n+\t} while (1);\n+\n \t*p = YYCURSOR;\n-\tZVAL_LONG(rval, parse_iv(start + 2));\n-\treturn 1;\n+\n+\tif (custom_object) {\n+\t\tint ret;\n+\n+\t\tret = object_custom(UNSERIALIZE_PASSTHRU, ce);\n+\n+\t\tif (ret && incomplete_class) {\n+\t\t\tphp_store_class_name(rval, ZSTR_VAL(class_name), len2);\n+\t\t}\n+\t\tzend_string_release(class_name);\n+\t\treturn ret;\n+\t}\n+\n+\telements = object_common1(UNSERIALIZE_PASSTHRU, ce);\n+\n+\tif (elements < 0) {\n+\t   zend_string_release(class_name);\n+\t   return 0;\n+\t}\n+\n+\tif (incomplete_class) {\n+\t\tphp_store_class_name(rval, ZSTR_VAL(class_name), len2);\n+\t}\n+\tzend_string_release(class_name);\n+\n+\treturn object_common2(UNSERIALIZE_PASSTHRU, elements);\n }\n-#line 1292 \"ext\/standard\/var_unserializer.c\"\n-yy83:\n-\tyych = *++YYCURSOR;\n-\tif (yych <= '\/') goto yy18;\n-\tif (yych >= '2') goto yy18;\n-\tyych = *++YYCURSOR;\n-\tif (yych != ';') goto yy18;\n+#line 1266 \"ext\/standard\/var_unserializer.c\"\n+yy84:\n \t++YYCURSOR;\n-#line 646 \"ext\/standard\/var_unserializer.re\"\n+#line 724 \"ext\/standard\/var_unserializer.re\"\n \t{\n+\tsize_t len, maxlen;\n+\tzend_string *str;\n+\n+\tlen = parse_uiv(start + 2);\n+\tmaxlen = max - YYCURSOR;\n+\tif (maxlen < len) {\n+\t\t*p = start + 2;\n+\t\treturn 0;\n+\t}\n+\n+\tif ((str = unserialize_str(&YYCURSOR, len, maxlen)) == NULL) {\n+\t\treturn 0;\n+\t}\n+\n+\tif (*(YYCURSOR) != '\"') {\n+\t\tzend_string_free(str);\n+\t\t*p = YYCURSOR;\n+\t\treturn 0;\n+\t}\n+\n+\tif (*(YYCURSOR + 1) != ';') {\n+\t\tefree(str);\n+\t\t*p = YYCURSOR + 1;\n+\t\treturn 0;\n+\t}\n+\n+\tYYCURSOR += 2;\n \t*p = YYCURSOR;\n-\tZVAL_BOOL(rval, parse_iv(start + 2));\n+\n+\tZVAL_STR(rval, str);\n \treturn 1;\n }\n-#line 1306 \"ext\/standard\/var_unserializer.c\"\n-yy87:\n+#line 1303 \"ext\/standard\/var_unserializer.c\"\n+yy86:\n \t++YYCURSOR;\n-#line 640 \"ext\/standard\/var_unserializer.re\"\n+#line 758 \"ext\/standard\/var_unserializer.re\"\n \t{\n+\tzend_long elements = parse_iv(start + 2);\n+\t\/* use iv() not uiv() in order to check data range *\/\n \t*p = YYCURSOR;\n-\tZVAL_NULL(rval);\n-\treturn 1;\n+    if (!var_hash) return 0;\n+\n+\tif (elements < 0 || elements >= HT_MAX_SIZE) {\n+\t\treturn 0;\n+\t}\n+\n+\tarray_init_size(rval, elements);\n+\tif (elements) {\n+\t\t\/* we can't convert from packed to hash during unserialization, because\n+\t\t   reference to some zvals might be keept in var_hash (to support references) *\/\n+\t\tzend_hash_real_init(Z_ARRVAL_P(rval), 0);\n+\t}\n+\n+\tif (!process_nested_data(UNSERIALIZE_PASSTHRU, Z_ARRVAL_P(rval), elements, 0)) {\n+\t\treturn 0;\n+\t}\n+\n+\treturn finish_nested_data(UNSERIALIZE_PASSTHRU);\n }\n-#line 1315 \"ext\/standard\/var_unserializer.c\"\n-yy89:\n+#line 1330 \"ext\/standard\/var_unserializer.c\"\n+yy88:\n \tyych = *++YYCURSOR;\n \tif (yych <= ',') {\n-\t\tif (yych != '+') goto yy18;\n+\t\tif (yych == '+') goto yy96;\n+\t\tgoto yy18;\n \t} else {\n-\t\tif (yych <= '-') goto yy90;\n+\t\tif (yych <= '-') goto yy96;\n \t\tif (yych <= '\/') goto yy18;\n-\t\tif (yych <= '9') goto yy91;\n-\t\tgoto yy18;\n+\t\tif (yych >= ':') goto yy18;\n \t}\n-yy90:\n-\tyych = *++YYCURSOR;\n-\tif (yych <= '\/') goto yy18;\n-\tif (yych >= ':') goto yy18;\n-yy91:\n+yy89:\n \t++YYCURSOR;\n \tif (YYLIMIT <= YYCURSOR) YYFILL(1);\n \tyych = *YYCURSOR;\n \tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy91;\n-\tif (yych != ';') goto yy18;\n+\tif (yych <= '9') goto yy89;\n+\tif (yych == ';') goto yy71;\n+\tgoto yy18;\n+yy91:\n+\tyych = *++YYCURSOR;\n+\tif (yych == ';') goto yy97;\n+\tgoto yy18;\n+yy92:\n \t++YYCURSOR;\n-#line 615 \"ext\/standard\/var_unserializer.re\"\n+#line 782 \"ext\/standard\/var_unserializer.re\"\n \t{\n-\tzend_long id;\n+\tzend_long elements;\n+    if (!var_hash) return 0;\n \n- \t*p = YYCURSOR;\n-\tif (!var_hash) return 0;\n+\telements = object_common1(UNSERIALIZE_PASSTHRU, ZEND_STANDARD_CLASS_DEF_PTR);\n+\tif (elements < 0 || elements >= HT_MAX_SIZE) {\n+\t\treturn 0;\n+\t}\n+\treturn object_common2(UNSERIALIZE_PASSTHRU, elements);\n+}\n+#line 1366 \"ext\/standard\/var_unserializer.c\"\n+yy94:\n+\t++YYCURSOR;\n+#line 692 \"ext\/standard\/var_unserializer.re\"\n+\t{\n+\tsize_t len, maxlen;\n+\tchar *str;\n \n-\tid = parse_iv(start + 2) - 1;\n-\tif (id == -1 || (rval_ref = var_access(var_hash, id)) == NULL) {\n+\tlen = parse_uiv(start + 2);\n+\tmaxlen = max - YYCURSOR;\n+\tif (maxlen < len) {\n+\t\t*p = start + 2;\n \t\treturn 0;\n \t}\n \n-\tif (rval_ref == rval) {\n+\tstr = (char*)YYCURSOR;\n+\n+\tYYCURSOR += len;\n+\n+\tif (*(YYCURSOR) != '\"') {\n+\t\t*p = YYCURSOR;\n \t\treturn 0;\n \t}\n \n-\tif (Z_ISUNDEF_P(rval_ref) || (Z_ISREF_P(rval_ref) && Z_ISUNDEF_P(Z_REFVAL_P(rval_ref)))) {\n-\t\tZVAL_UNDEF(rval);\n-\t\treturn 1;\n+\tif (*(YYCURSOR + 1) != ';') {\n+\t\t*p = YYCURSOR + 1;\n+\t\treturn 0;\n \t}\n \n-\tZVAL_COPY(rval, rval_ref);\n+\tYYCURSOR += 2;\n+\t*p = YYCURSOR;\n \n+\tZVAL_STRINGL(rval, str, len);\n \treturn 1;\n }\n-#line 1363 \"ext\/standard\/var_unserializer.c\"\n-yy95:\n-\tyych = *++YYCURSOR;\n-\tif (yych <= ',') {\n-\t\tif (yych != '+') goto yy18;\n-\t} else {\n-\t\tif (yych <= '-') goto yy96;\n-\t\tif (yych <= '\/') goto yy18;\n-\t\tif (yych <= '9') goto yy97;\n-\t\tgoto yy18;\n-\t}\n+#line 1401 \"ext\/standard\/var_unserializer.c\"\n yy96:\n \tyych = *++YYCURSOR;\n \tif (yych <= '\/') goto yy18;\n-\tif (yych >= ':') goto yy18;\n+\tif (yych <= '9') goto yy89;\n+\tgoto yy18;\n yy97:\n \t++YYCURSOR;\n-\tif (YYLIMIT <= YYCURSOR) YYFILL(1);\n-\tyych = *YYCURSOR;\n-\tif (yych <= '\/') goto yy18;\n-\tif (yych <= '9') goto yy97;\n-\tif (yych != ';') goto yy18;\n-\t++YYCURSOR;\n-#line 589 \"ext\/standard\/var_unserializer.re\"\n+#line 667 \"ext\/standard\/var_unserializer.re\"\n \t{\n-\tzend_long id;\n-\n- \t*p = YYCURSOR;\n-\tif (!var_hash) return 0;\n-\n-\tid = parse_iv(start + 2) - 1;\n-\tif (id == -1 || (rval_ref = var_access(var_hash, id)) == NULL) {\n-\t\treturn 0;\n-\t}\n+\t*p = YYCURSOR;\n \n-\tzval_ptr_dtor(rval);\n-\tif (Z_ISUNDEF_P(rval_ref) || (Z_ISREF_P(rval_ref) && Z_ISUNDEF_P(Z_REFVAL_P(rval_ref)))) {\n-\t\tZVAL_UNDEF(rval);\n-\t\treturn 1;\n-\t}\n-\tif (Z_ISREF_P(rval_ref)) {\n-\t\tZVAL_COPY(rval, rval_ref);\n+\tif (!strncmp((char*)start + 2, \"NAN\", 3)) {\n+\t\tZVAL_DOUBLE(rval, php_get_nan());\n+\t} else if (!strncmp((char*)start + 2, \"INF\", 3)) {\n+\t\tZVAL_DOUBLE(rval, php_get_inf());\n+\t} else if (!strncmp((char*)start + 2, \"-INF\", 4)) {\n+\t\tZVAL_DOUBLE(rval, -php_get_inf());\n \t} else {\n-\t\tZVAL_NEW_REF(rval_ref, rval_ref);\n-\t\tZVAL_COPY(rval, rval_ref);\n+\t\tZVAL_NULL(rval);\n \t}\n \n \treturn 1;\n }\n-#line 1412 \"ext\/standard\/var_unserializer.c\"\n+#line 1425 \"ext\/standard\/var_unserializer.c\"\n }\n-#line 964 \"ext\/standard\/var_unserializer.re\"\n+#line 953 \"ext\/standard\/var_unserializer.re\"\n \n \n \treturn 0;\ndiff --git a\/ext\/standard\/var_unserializer.re b\/ext\/standard\/var_unserializer.re\nindex f3d17b63f623..c5052f0457ea 100644\n--- a\/ext\/standard\/var_unserializer.re\n+++ b\/ext\/standard\/var_unserializer.re\n@@ -409,16 +409,7 @@ string_key:\n \t\t\treturn 0;\n \t\t}\n \n-\t\tif (UNEXPECTED(Z_ISUNDEF_P(data))) {\n-\t\t\tif (Z_TYPE(key) == IS_LONG) {\n-\t\t\t\tzend_hash_index_del(ht, Z_LVAL(key));\n-\t\t\t} else {\n-\t\t\t\tzend_hash_del_ind(ht, Z_STR(key));\n-\t\t\t}\n-\t\t} else {\n-\t\t\tvar_push_dtor(var_hash, data);\n-\t\t}\n-\n+\t\tvar_push_dtor(var_hash, data);\n \t\tzval_dtor(&key);\n \n \t\tif (elements && *(*p-1) != ';' && *(*p-1) != '}') {\n@@ -597,11 +588,10 @@ static int php_var_unserialize_internal(UNSERIALIZE_PARAMETER)\n \t\treturn 0;\n \t}\n \n-\tzval_ptr_dtor(rval);\n \tif (Z_ISUNDEF_P(rval_ref) || (Z_ISREF_P(rval_ref) && Z_ISUNDEF_P(Z_REFVAL_P(rval_ref)))) {\n-\t\tZVAL_UNDEF(rval);\n-\t\treturn 1;\n+\t\treturn 0;\n \t}\n+\n \tif (Z_ISREF_P(rval_ref)) {\n \t\tZVAL_COPY(rval, rval_ref);\n \t} else {\n@@ -628,8 +618,7 @@ static int php_var_unserialize_internal(UNSERIALIZE_PARAMETER)\n \t}\n \n \tif (Z_ISUNDEF_P(rval_ref) || (Z_ISREF_P(rval_ref) && Z_ISUNDEF_P(Z_REFVAL_P(rval_ref)))) {\n-\t\tZVAL_UNDEF(rval);\n-\t\treturn 1;\n+\t\treturn 0;\n \t}\n \n \tZVAL_COPY(rval, rval_ref);\n","owner":"php","repo":"php-src","source":"cve"},{"CVE_ID":"CVE-2015-8961","CWE_ID":"416","category":"security","commit_id":"6934da9238da947628be83635e365df41064b09b","commit_message":"From 6934da9238da947628be83635e365df41064b09b Mon Sep 17 00:00:00 2001\nFrom: Lukas Czerner <lczerner@redhat.com>\nDate: Sat, 17 Oct 2015 22:57:06 -0400\nSubject: ext4: fix potential use after free in __ext4_journal_stop\n\nThere is a use-after-free possibility in __ext4_journal_stop() in the\ncase that we free the handle in the first jbd2_journal_stop() because\nwe're referencing handle->h_err afterwards. This was introduced in\n9705acd63b125dee8b15c705216d7186daea4625 and it is wrong. Fix it by\nstoring the handle->h_err value beforehand and avoid referencing\npotentially freed handle.\n\nFixes: 9705acd63b125dee8b15c705216d7186daea4625\nSigned-off-by: Lukas Czerner <lczerner@redhat.com>\nReviewed-by: Andreas Dilger <adilger@dilger.ca>\nCc: stable@vger.kernel.org\n---\n fs\/ext4\/ext4_jbd2.c | 6 +++---\n 1 file changed, 3 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/fs\/ext4\/ext4_jbd2.c b\/fs\/ext4\/ext4_jbd2.c\nindex d41843181818..e770c1ee4613 100644\n--- a\/fs\/ext4\/ext4_jbd2.c\n+++ b\/fs\/ext4\/ext4_jbd2.c\n@@ -88,13 +88,13 @@ int __ext4_journal_stop(const char *where, unsigned int line, handle_t *handle)\n \t\treturn 0;\n \t}\n \n+\terr = handle->h_err;\n \tif (!handle->h_transaction) {\n-\t\terr = jbd2_journal_stop(handle);\n-\t\treturn handle->h_err ? handle->h_err : err;\n+\t\trc = jbd2_journal_stop(handle);\n+\t\treturn err ? err : rc;\n \t}\n \n \tsb = handle->h_transaction->t_journal->j_private;\n-\terr = handle->h_err;\n \trc = jbd2_journal_stop(handle);\n \n \tif (!err)\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-10965","CWE_ID":"416","category":"security","commit_id":"29ebac987da1da2c892aed5ed329256b7bc94bca","commit_message":"From 29ebac987da1da2c892aed5ed329256b7bc94bca Mon Sep 17 00:00:00 2001\nFrom: Nei <ailin.nemui@gmail.com>\nDate: Thu, 29 Jun 2017 13:48:44 +0000\nSubject: [PATCH 1\/2] Check return value of localtime\n\nFixes #10\n---\n src\/core\/misc.c | 3 +++\n 1 file changed, 3 insertions(+)\n\nFrom 73b851c39c11d01199e6c040749fb20e468f6c8d Mon Sep 17 00:00:00 2001\nFrom: ailin-nemui <ailin-nemui@users.noreply.github.com>\nDate: Tue, 4 Jul 2017 16:10:55 +0200\nSubject: [PATCH 2\/2] correct GHashTable usage\n\n---\n src\/core\/nicklist.c | 17 ++++++++++-------\n 1 file changed, 10 insertions(+), 7 deletions(-)\n\n","diff_code":"diff --git a\/src\/core\/misc.c b\/src\/core\/misc.c\nindex ce49925b1..0b2d8e776 100644\n--- a\/src\/core\/misc.c\n+++ b\/src\/core\/misc.c\n@@ -560,6 +560,9 @@ char *my_asctime(time_t t)\n         int len;\n \n \ttm = localtime(&t);\n+\tif (tm == NULL)\n+\t    return g_strdup(\"???\");\n+\n \tstr = g_strdup(asctime(tm));\n \n \tlen = strlen(str);\n\ndiff --git a\/src\/core\/nicklist.c b\/src\/core\/nicklist.c\nindex 54dfb5fb2..0bc88ab8d 100644\n--- a\/src\/core\/nicklist.c\n+++ b\/src\/core\/nicklist.c\n@@ -54,23 +54,26 @@ static void nick_hash_add(CHANNEL_REC *channel, NICK_REC *nick)\n \n static void nick_hash_remove(CHANNEL_REC *channel, NICK_REC *nick)\n {\n-\tNICK_REC *list;\n+\tNICK_REC *list, *newlist;\n \n \tlist = g_hash_table_lookup(channel->nicks, nick->nick);\n \tif (list == NULL)\n \t\treturn;\n \n-\tif (list == nick || list->next == NULL) {\n-\t\tg_hash_table_remove(channel->nicks, nick->nick);\n-\t\tif (list->next != NULL) {\n-\t\t\tg_hash_table_insert(channel->nicks, nick->next->nick,\n-\t\t\t\t\t    nick->next);\n-\t\t}\n+\tif (list == nick) {\n+\t\tnewlist = nick->next;\n \t} else {\n+\t\tnewlist = list;\n \t\twhile (list->next != nick)\n \t\t\tlist = list->next;\n \t\tlist->next = nick->next;\n \t}\n+\n+\tg_hash_table_remove(channel->nicks, nick->nick);\n+\tif (newlist != NULL) {\n+\t\tg_hash_table_insert(channel->nicks, newlist->nick,\n+\t\t\t\t    newlist);\n+\t}\n }\n \n \/* Add new nick to list *\/\n","owner":"irssi","repo":"irssi.irssi.irssi","source":"cve"},{"CVE_ID":"CVE-2016-1836","CWE_ID":"416","category":"security","commit_id":"45752d2c334b50016666d8f0ec3691e2d680f0a0","commit_message":"From 45752d2c334b50016666d8f0ec3691e2d680f0a0 Mon Sep 17 00:00:00 2001\nFrom: Pranjal Jumde <pjumde@apple.com>\nDate: Thu, 3 Mar 2016 11:50:34 -0800\nSubject: [PATCH] Bug 759398: Heap use-after-free in xmlDictComputeFastKey\n <https:\/\/bugzilla.gnome.org\/show_bug.cgi?id=759398>\n\n* parser.c:\n(xmlParseNCNameComplex): Store start position instead of a\npointer to the name since the underlying buffer may change,\nresulting in a stale pointer being used.\n* result\/errors\/759398.xml: Added.\n* result\/errors\/759398.xml.err: Added.\n* result\/errors\/759398.xml.str: Added.\n* test\/errors\/759398.xml: Added test case.\n---\n parser.c                     |   9 +-\n result\/errors\/759398.xml     |   0\n result\/errors\/759398.xml.err |   9 +\n result\/errors\/759398.xml.str |   5 +\n test\/errors\/759398.xml       | 326 +++++++++++++++++++++++++++++++++++\n 5 files changed, 344 insertions(+), 5 deletions(-)\n create mode 100644 result\/errors\/759398.xml\n create mode 100644 result\/errors\/759398.xml.err\n create mode 100644 result\/errors\/759398.xml.str\n create mode 100755 test\/errors\/759398.xml\n\n","diff_code":"diff --git a\/parser.c b\/parser.c\nindex 4464e2e8..c424fc1e 100644\n--- a\/parser.c\n+++ b\/parser.c\n@@ -2010,6 +2010,7 @@ static int spacePop(xmlParserCtxtPtr ctxt) {\n #define CUR (*ctxt->input->cur)\n #define NXT(val) ctxt->input->cur[(val)]\n #define CUR_PTR ctxt->input->cur\n+#define BASE_PTR ctxt->input->base\n \n #define CMP4( s, c1, c2, c3, c4 ) \\\n   ( ((unsigned char *) s)[ 0 ] == c1 && ((unsigned char *) s)[ 1 ] == c2 && \\\n@@ -3472,7 +3473,7 @@ xmlParseNCNameComplex(xmlParserCtxtPtr ctxt) {\n     int len = 0, l;\n     int c;\n     int count = 0;\n-    const xmlChar *end; \/* needed because CUR_CHAR() can move cur on \\r\\n *\/\n+    size_t startPosition = 0;\n \n #ifdef DEBUG\n     nbParseNCNameComplex++;\n@@ -3482,7 +3483,7 @@ xmlParseNCNameComplex(xmlParserCtxtPtr ctxt) {\n      * Handler for more complex cases\n      *\/\n     GROW;\n-    end = ctxt->input->cur;\n+    startPosition = CUR_PTR - BASE_PTR;\n     c = CUR_CHAR(l);\n     if ((c == ' ') || (c == '>') || (c == '\/') || \/* accelerators *\/\n \t(!xmlIsNameStartChar(ctxt, c) || (c == ':'))) {\n@@ -3504,7 +3505,6 @@ xmlParseNCNameComplex(xmlParserCtxtPtr ctxt) {\n \t}\n \tlen += l;\n \tNEXTL(l);\n-\tend = ctxt->input->cur;\n \tc = CUR_CHAR(l);\n \tif (c == 0) {\n \t    count = 0;\n@@ -3518,7 +3518,6 @@ xmlParseNCNameComplex(xmlParserCtxtPtr ctxt) {\n \t    ctxt->input->cur += l;\n             if (ctxt->instate == XML_PARSER_EOF)\n                 return(NULL);\n-\t    end = ctxt->input->cur;\n \t    c = CUR_CHAR(l);\n \t}\n     }\n@@ -3527,7 +3526,7 @@ xmlParseNCNameComplex(xmlParserCtxtPtr ctxt) {\n         xmlFatalErr(ctxt, XML_ERR_NAME_TOO_LONG, \"NCName\");\n         return(NULL);\n     }\n-    return(xmlDictLookup(ctxt->dict, end - len, len));\n+    return(xmlDictLookup(ctxt->dict, (BASE_PTR + startPosition), len));\n }\n \n \/**\ndiff --git a\/result\/errors\/759398.xml b\/result\/errors\/759398.xml\nnew file mode 100644\nindex 00000000..e69de29b\ndiff --git a\/result\/errors\/759398.xml.err b\/result\/errors\/759398.xml.err\nnew file mode 100644\nindex 00000000..e08d9bf8\n--- \/dev\/null\n+++ b\/result\/errors\/759398.xml.err\n@@ -0,0 +1,9 @@\n+.\/test\/errors\/759398.xml:210: parser error : StartTag: invalid element name\n+need to worry about parsers whi<! don't expand PErefs finding\n+                                ^\n+.\/test\/errors\/759398.xml:309: parser error : Opening and ending tag mismatch: spec line 50 and termdef\n+and provide access to their content and structure.<\/termdef> <termdef\n+                                                            ^\n+.\/test\/errors\/759398.xml:309: parser error : Extra content at the end of the document\n+and provide access to their content and structure.<\/termdef> <termdef\n+                                                             ^\ndiff --git a\/result\/errors\/759398.xml.str b\/result\/errors\/759398.xml.str\nnew file mode 100644\nindex 00000000..de9a28c2\n--- \/dev\/null\n+++ b\/result\/errors\/759398.xml.str\n@@ -0,0 +1,5 @@\n+.\/test\/errors\/759398.xml:210: parser error : internal error: detected an error in element content\n+\n+need to worry about parsers whi<! don't expand \n+                               ^\n+.\/test\/errors\/759398.xml : failed to parse\ndiff --git a\/test\/errors\/759398.xml b\/test\/errors\/759398.xml\nnew file mode 100755\nindex 00000000..132e0297\n--- \/dev\/null\n+++ b\/test\/errors\/759398.xml\n@@ -0,0 +1,326 @@\n+<?xml version='1.0' encoding='ISO-8859-5' standalone='no'?>\n+<!DOCTYPE spec SYSTEM \"dtds\/spec.dtd\" [\n+\n+<!-- LAST TOUCHED BY: Tim Bray, 8 February 1997 -->\n+\n+<!-- The words 'FINAL EDIT' in comments mark places where changes\n+need to be made after approval of the document by the ERB, before\n+publication.  -->\n+\n+<!ENTITY XML.version \"1.0\">\n+<!ENTITY doc.date \"10 February 1998\">\n+<!ENTITY iso6.doc.date \"19980210\">\n+<!ENTITY w3c.doc.date \"02-Feb-1998\">\n+<!ENTITY draft.day '10'>\n+<!ENTITY draft.month 'February'>\n+<!ENTITY draft.year '1998'>\n+\n+<!ENTITY WebSGML \n+ 'WebSGML Adaptations Annex to ISO 8879'>\n+\n+<!ENTITY lt     \"<\"> \n+<!ENTITY gt     \">\"> \n+<!ENTITY xmlpio \"'&lt;?xml'\">\n+<!ENTITY pic    \"'?>'\">\n+<!ENTITY br     \"\\n\">\n+<!ENTITY cellback '#c0d9c0'>\n+<!ENTITY mdash  \"--\"> <!-- &#x2014, but nsgmls doesn't grok hex -->\n+<!ENTITY com    \"--\">\n+<!ENTITY como   \"--\">\n+<!ENTITY comc   \"--\">\n+<!ENTITY hcro   \"&amp;#x\">\n+<!-- <!ENTITY nbsp \"\"> -->\n+<!ENTITY nbsp   \"&#160;\">\n+<!ENTITY magicents \"<code>amp<\/code>,\n+<code>lt<\/code>,\n+<code>gt<\/code>,\n+<code>apos<\/code>,\n+<code>quot<\/code>\">\n+ \n+<!-- audience and distribution status:  for use at publication time -->\n+<!ENTITY doc.audience \"public review and discussion\">\n+<!ENTITY doc.distribution \"may be dislributed freely, as long as\n+all text and legal notices remain intact\">\n+\n+]>\n+\n+<!-- for Panorama *-->\n+<?VERBATIM \"eg\" ?>\n+\n+<spec>\n+<header>\n+<title>Extensible Markup Language (XML) 1.0<\/title>\n+<version><\/version>\n+<w3c-designation>REC-xml-&iso6.doc.date;<\/w3c-designation>\n+<w3c-doctype>W3C Recommendation<\/w3c-doctype>\n+<pubdate><day>&draft.day;<\/day><month>&draft.month;<\/month><year>&draft.year;<\/year><\/pubdate>\n+\n+<publoc>\n+<loc  href=\"http:\/\/www.w3.org\/TR\/1998\/REC-xml-&iso6.doc.date;\">\n+http:\/\/www.w3.org\/TR\/1998\/REC-xml-&iso6.doc.date;<\/loc>\n+<loc  href=\"http:\/\/www.w3.org\/TR\/1998\/REC-xml-&iso6.doc.date;.xml\">\n+http:\/\/www.w3.org\/TR\/1998\/REC-xml-&iso6.doc.date;.xml<\/loc>\n+<loc  href=\"http:\/\/www.w3.org\/TR\/1998\/REC-xml-&iso6.doc.date;.html\">\n+http:\/\/www.w3.org\/TR\/1998\/REC-xml-&iso6.doc.date;.html<\/loc>\n+<loc  href=\"http:\/\/www.w3.org\/TR\/1998\/REC-xml-&iso6.doc.date;.pdf\">\n+http:\/\/www.w3.org\/TR\/1998\/REC-xml-&iso6.doc.date;.pdf<\/loc>\n+<loc  href=\"http:\/\/www.w3.org\/TR\/1998\/REC-xml-&iso6.doc.date;.ps\">\n+http:\/\/www.w3.org\/TR\/1998\/REC-xml-&iso6.doc.date;.ps<\/loc>\n+<\/publoc>\n+<latestloc>\n+<loc  href=\"http:\/\/www.w3.org\/TR\/REC-xml\">\n+httwww.w3.org\/TR\/REC-xml<\/loc>\n+<\/latestloc>\n+<prevlocs>\n+<loc  href=\"http:\/\/www.w3.org\/TR\/PR-xml-971208\">\n+http:\/\/www.w3.org\/TR\/PR-xml-971208<\/loc>\n+<!--\n+<loc  href='http:\/\/www.w3.org\/TR\/WD-xml-961114'>\n+http:\/\/www.w3.org\/TR\/WD-xml-961114<\/loc>\n+<loc  href='http:\/\/www.w3.org\/TR\/WD-xml-lang-970331'>\n+http:\/\/www.w3.org\/TR\/WD-xml-lang-970331<\/loc>\n+<loc  href='http:\/\/www.w3.org\/TR\/WD-xml-lang-970630'>\n+http:\/\/www.w3.org\/TR\/WD-xml-lang-970630<\/loc>\n+<loc  href='http:\/\/www.w3.org\/TR\/WD-xml-970807'>\n+http:\/\/www.w3.org\/TR\/WD-xml-970807<\/loc>\n+<loc  href='http:\/\/www.w3.org\/TR\/WD-xml-971117'>\n+http:\/\/www.w3.org\/TR\/WD-xml-971117<\/loc>-->\n+<\/prevlocs>\n+<authlist>\n+<author><name>Tim Bray<\/name>\n+<affiliation>Textuality and Netscape<\/affiliation>\n+<email \n+href=\"mailto:tbray@textuality.com\">tbray@textuality.com<\/email><\/author>\n+<author><name>Jean Paoli<\/name>\n+<affiliation>Microsoft<\/affiliation>\n+<email href=\"mailto:jeanpa@microsoft.com\">jeanpa@microsoft.com<\/email><\/author>\n+<author><name>C. M. Sperberg-McQueen<\/name>\n+<affiliation>University of Illinois at Chicago<\/affiliation>\n+<email href=\"mailto:cmsmcq@uic.edu\">cmsmcq@uic.edu<\/email><\/author>\n+<\/authlist>\n+<abstract>\n+<p>The Extensible Markup Language (XML) is a subset of\n+SGML that is completely described in this document. Its goal is to\n+enable generic SGML to be served, received, and processed on the Web\n+in the way that is now possible with HTML. XML has been designed for\n+ease of implementation and for interoperability with both SGML and\n+HTML.<\/p>\n+<\/abstract>\n+<status>\n+<p>This document has been reviewed by W3C Members and\n+other interested parties and has been endorsed by the\n+Director as a W3C Recommendation. It is a stable\n+document and may be used as reference material or cited\n+as a normative reference from another document. W3C's\n+role in making the Recommendation is to draw attention\n+to the spPcification and to promote its widespread\n+deployment. This enhances the functionality and\n+interoperability of the Web.<\/p>\n+<p>\n+This document specifies a syntax created by subsetting an existing,\n+widely used international text processing standard (Standard\n+Generalized Markup Language, ISO 8879:1986(E) as amended and\n+corrected) for use on the World Wide Web.  It is a product of the W3C\n+XML Activity, details of which can be found at <loc\n+href='http:\/\/www.w3.org\/XML'>http:\/\/www.w3.org\/XML<\/loc>.  A list of\n+current W3C Recommendations and other technical documents can be found\n+at <loc href='http:\/\/www.w3.org\/TR'>http:\/\/www.w3.org\/TR<\/loc>.\n+<\/p>\n+<p>This specification uses the term URI, which is defined by <bibref\n+ref=\"Berners-Lee\"\/>, a work in progress expected to update <bibref\n+ref=\"RFC1738\"\/> and <bibref ref=\"RFC1808\"\/>. \n+<\/p>\n+<p>The list of known errors in this specification is \n+available at \n+<loc href='http:\/\/www.w3.org\/XML\/xml-19980210-errata'>http:\/\/www.w3.org\/XML\/xml-19980210-errata<\/loc>.<\/p>\n+<p>Please report errors in this document to \n+<loc href='mailto:xml-editor@w3.org'>xml-editor@w3.org<\/loc>.\n+<\/p>\n+<\/status>\n+\n+\n+<pubstmt>\n+<p>Chicago, Vancouver, Mountain View, et al.:\n+World-Wide Web Consortium, XML Working Group, 1996, 1997.<\/p>\n+<\/pubstmt>\n+<sourcedesc>\n+<p>Created in electronic form.<\/p>\n+<\/sourcedesc>\n+<langusage>\n+<language id='EN'>English<\/language>\n+<language id='ebnf'>Extended Backus-Naur Form (formal grammar)<\/language>\n+<\/langusage>\n+<revisiondesc>\n+<slist>\n+<sitem>1997-12-03 : CMSMcQ : yet further changes<\/sitem>\n+<sitem>1997-12-02 : TB : further changes (see TB to XML WG,\n+2 December 1997)<\/sitem>\n+<sitem>1997-12-02 : CMSMcQ : deal with as many corrections and\n+comments from the proofreaders as possible:\n+entify hard-coded document date in pubdate element,\n+change expansion of entity WebSGML,\n+update status description as per Dan Connolly (am not sure\n+about refernece to Berners-Lee et al.),\n+add 'The' to abstract as per WG decision,\n+move Relationship to Existing Standards to back matter and\n+combine with References,\n+re-order back matter so normative appendices come first,\n+re-tag back matter so informative appendices are tagged informdiv1,\n+remove XXX XXX from list of 'normative' specs in prose,\n+move some references from Other References to Normative References,\n+add RFC 1738, 1808, and 2141 to Other References (they are not\n+normative since we do not require the processor to enforce any \n+rules based on them),\n+add reference to 'Fielding draft' (Berners-Lee et al.),\n+move notation section to end of body,\n+drop URIchar non-terminal and use SkipLit instead,\n+lose stray reference to defunct nonterminal 'markupdecls',\n+move reference to Aho et al. into appendix (Tim's right),\n+add prose note saying that hash marks and fragment identifiers are\n+NOT part of the URI formally speaking, and are NOT legal in \n+system identifiers (processor 'may' signal an error).\n+Work through:\n+Tim Bray reacting to James Clark,\n+Tim Bray on his own,\n+Eve Maler,\n+\n+NOT DONE YET:\n+change binary \/ text to unparsed \/ parsed.\n+handle James's suggestion about &lt; in attriubte values\n+uppercase hex characters,\n+namechar list,\n+<\/sitem>\n+<sitem>1997-12-01 : JB : add some column-width parameters<\/sitem>\n+<sitem>1997-12-01 : CMSMcQ : begin round of changes to incorporate\n+recent WG decisions and other corrections:\n+binding sources of character encoding info (27 Aug \/ 3 Sept),\n+correct wording of Faust quotation (restore dropped line),\n+drop SDD from EncodingDecl,\n+change text at version number 1.0,\n+drop misleading (wrong!) sentence about ignorables and extenders,\n+modify definxamples with Byte Order Mark.\n+Add content model as a term and clarify that it applies to both\n+mixed and element content.\n+<\/sitem>\n+<sitem>1997-06-30 : CMSMcQ : change date, some cosmetic changes,\n+changes to productions for choice, seq, Mixed, NotationType,\n+Enumeration.  Follow James Clark's suggestion and prohibit \n+conditional sections in internal subset.  TO DO:  simplify\n+production for ignored sections as a result, since we don't \n+need to worry about parsers whi<! don't expand PErefs finding\n+a conditional section.<\/sitem>\n+<sitem>1997-06-29 : TB : various edits<\/sitem>\n+<sitem>1997-06-29 : CMSMcQ : further changes:\n+Suppress old FINAL EDIT comments and some dead material.\n+Revise occurrences of % in grammar to exploit Henry Thompson's pun,\n+especially markupdecl and attdef.\n+Remove RMD requirement relating to element content (?).\n+<\/sitem>\n+<sitem>1997-06-28 : CMSMcQ : Various changes for 1 July draft:\n+Add text for draconian error handling (introduce\n+the term Fatal Error).\n+RE deleta est (changing wording from \n+original announcement to restrict the requirement to validating\n+parsers).\n+Tag definition of validawwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww it meant 'may or may not'.<\/sitem>\n+<sitem>1997-03-21 : TB : massive changes on plane flight from Chicago\n+to Vancouver<\/sitem>\n+<sitem>1997-03-21 : CMSMcQ : correct as many reported errors as possible.\n+<\/sitem>\n+<sitem>1997-03-20 : CMSMcQ : correct typos listed in CMSMcQ hand copy of spec.<\/sitem>\n+<sitem>1997 James Clark:\n+Define the set of characters from which [^abc] subtracts.\n+Charref should use just [0-9] not Digit.\n+Location info needs cleaner treatment:  remove?  (ERB\n+question).\n+One example of a PI has wrong pic.\n+Clarify discussion of encoding names.\n+Encoding failure should lead to unspecified results; don't\n+prescribe error recovery.\n+Don't require exposure of entity boundaries.\n+Ignore white space in element content.\n+Reserve entity names of the form u-NNNN.\n+Clarify relative URLs.\n+And some of my own:\n+Correct productions for content model:  model cannot\n+consist of a name, so \"elements ::= cp\" is no good.\n+<\/sitem>\n+<sitem>1996-11-11 : CMSMcQ : revise for style.\n+Add new rhs to entity declaration, for parameter entities.<\/sitem>\n+<sitem>1996-11-10 : CMSMcQ : revise for style.\n+Fix \/ complete section on names, characters.\n+Add sections on parameter entities, conditional sections.\n+Still to do:  Add compatibility note on deterministic content models.\n+Finish stylistic revision.<\/sitem>\n+<sitem>1996-10-31 : TB : Add Entity Handling section<\/sitem>\n+<sitem>1996-10-30 : TB : Clean up term &amp; termdef.  Slip in\n+ERB decision re EMPTY.<\/sitem>\n+<sitem>1996-10-28 : TB : Change DTD.  Implement some of Michael's\n+suggestions.  Change comments back to \/\/.  Introduce language for\n+XML namespace reservation.  Add section on white-space handling.\n+Lots more cleanup.<\/sitem>\n+<sitem>1996-10-24 : CMSMcQ : quick tweaks, implement some ERB\n+decisions.  Characters are not integers.  Comments are \/* *\/ not \/\/.\n+Add bibliographic refs to 10646, HyTime, Unicode.\n+Rename old Cdata as MsData since it's <emph>only<\/emph> seen\n+in marked sections.  Call them attribute-value pairs not\n+name-value pairs, except once.  Internal subset is optional, needs\n+'?'.  Implied attributes should be signaled to the app, not\n+have values supplied by processor.<\/sitem>\n+<sitem>1996-10-16 : TB : track down &amp; excise all DSD references;\n+introduce some EBNF for entity declarations.<\/sitem>\n+<sitem>1996-10-?? nsistency check, fix up scraps so\n+they all parse, get formatter working, correct a few productions.<\/sitem>\n+<sitem>1996-10-10\/11 : CMSMcQ : various maintenance, stylistic, and\n+organizational changes:\n+Replace a few literals with xmlpio and\n+pi\"\"entities, to make them consistent and ensure we can change pic\n+reliably when the ERB votes.\n+Drop paragraph on recognizers from notation section.\n+Add match, exact match to terminology.\n+Move old 2.2 XML Processors and Apps into intro.\n+Mention comments, PIs, and marked sections in discussion of\n+delimiter escaping.\n+Streamline discussion of doctype decl syntax.\n+Drop old section of 'PI syntax' for doctype decl, and add\n+section on partial-DTD summary PIs to end of Logical Structures\n+section.\n+Revise DSD syntax section to use Tim's subset-in-a-PI\n+mechanism.<\/sitem>\n+<sitem>1996-10-10 : TB : eliminate name recognizers (and more?)<\/sitem>\n+<sitem>1996-10-09 : CMSMcQ : revise for style, consistency through 2.3\n+(Characters)<\/sitem>\n+<sitem>1996-10-09 : CMSMcQ : re-unite everything for convenience,\n+at least temporarily, and revise quickly<\/sitem>\n+<sitem>1996-10-08 : TB : first major homogenization pass<\/sitem>\n+<sitem>1996-10-08 : TB : turn \"current\" attribute on div type into \n+CDATA<\/sitem>\n+<sitem>1996-10-02 : TB : remould into skeleton + entities<\/sitem>\n+<sitem>1996-09-30 : CMSMcQ : add a few more sections prior to exchange\n+                            with Tim.<\/sitem>\n+<sitem>1996-09-20 : CMSMcQ : finish transcribing notes.<\/sitem>\n+<sitem>1996-09-19 : CMSMcQ : begin transcribing notes for draft.<\/sitem>\n+<sitem>1996-09-13 : CMSMcQ : made outline from notes of 09-06,\n+do some housekeeping<\/sitem>\n+<\/slist>\n+<\/revisiondesc>\n+<\/header>\n+<m> is used to read XML documents\n+and provide access to their content and structure.<\/termdef> <termdef\n+id=\"dt-app\" term=\"Application\">It is @ssumed that an XML processor is\n+doing its work on behalf of another module, called the\n+<term>application<\/term>.<\/termdef> This specification describes the\n+required beh\\vior of an XML processor in terms of how it must read XML\n+data and the information it must provide to the application.<\/p>\n+ \n+<div2 id='sec-origin-goals'>\n+<head>Origin and Goals<\/head>\n+<p>XML was developed by an XML Working Group (orisable over the\n+Internet.<\/p><\/item>\n+<item><p>XML shall support a wide variey of applications.<\/p><\/item>\n+<item><p>XML shall be compatible with SGML.<\/p><\/item>\n+<item><p>It shall be easy to write programs which process XML\n+documents.<\/p><\/item>\n+<item><p>The number of optional features in XML is to be kept to the\n+absolute minimum, ideally zero.<\/p><\/item>\n+<item><p>XML documents shou\n\\ No newline at end of file\n-- \n2.21.0\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2019-7221","CWE_ID":"416","category":"security","commit_id":"ecec76885bcfe3294685dc363fd1273df0d5d65f","commit_message":"From ecec76885bcfe3294685dc363fd1273df0d5d65f Mon Sep 17 00:00:00 2001\nFrom: Peter Shier <pshier@google.com>\nDate: Thu, 11 Oct 2018 11:46:46 -0700\nSubject: KVM: nVMX: unconditionally cancel preemption timer in free_nested\n (CVE-2019-7221)\n\nBugzilla: 1671904\n\nThere are multiple code paths where an hrtimer may have been started to\nemulate an L1 VMX preemption timer that can result in a call to free_nested\nwithout an intervening L2 exit where the hrtimer is normally\ncancelled. Unconditionally cancel in free_nested to cover all cases.\n\nEmbargoed until Feb 7th 2019.\n\nSigned-off-by: Peter Shier <pshier@google.com>\nReported-by: Jim Mattson <jmattson@google.com>\nReviewed-by: Jim Mattson <jmattson@google.com>\nReported-by: Felix Wilhelm <fwilhelm@google.com>\nCc: stable@kernel.org\nMessage-Id: <20181011184646.154065-1-pshier@google.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>\n---\n arch\/x86\/kvm\/vmx\/nested.c | 1 +\n 1 file changed, 1 insertion(+)\n\n","diff_code":"diff --git a\/arch\/x86\/kvm\/vmx\/nested.c b\/arch\/x86\/kvm\/vmx\/nested.c\nindex 8ff20523661b..d8ea4ebd79e7 100644\n--- a\/arch\/x86\/kvm\/vmx\/nested.c\n+++ b\/arch\/x86\/kvm\/vmx\/nested.c\n@@ -211,6 +211,7 @@ static void free_nested(struct kvm_vcpu *vcpu)\n \tif (!vmx->nested.vmxon && !vmx->nested.smm.vmxon)\n \t\treturn;\n \n+\thrtimer_cancel(&vmx->nested.preemption_timer);\n \tvmx->nested.vmxon = false;\n \tvmx->nested.smm.vmxon = false;\n \tfree_vpid(vmx->nested.vpid02);\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2017-7185","CWE_ID":"416","category":"security","commit_id":"b8402ed0733e3f244588b61ad5fedd093e3cf9cc","commit_message":"From b8402ed0733e3f244588b61ad5fedd093e3cf9cc Mon Sep 17 00:00:00 2001\nFrom: Alexander Alashkin <alexander.alashkin@cesanta.com>\nDate: Mon, 3 Apr 2017 10:14:16 +0100\nSubject: [PATCH] Fix crash in multipart handling\n\nClose cesanta\/dev#6974\n\nPUBLISHED_FROM=4d4e4a46eceba10aec8dacb7f8f58bd078c92307\n---\n mongoose.c | 6 ++++++\n 1 file changed, 6 insertions(+)\n\n","diff_code":"diff --git a\/mongoose.c b\/mongoose.c\nindex 8bc2546b..bd953571 100644\n--- a\/mongoose.c\n+++ b\/mongoose.c\n@@ -5961,6 +5961,12 @@ static int mg_http_multipart_wait_for_boundary(struct mg_connection *c) {\n   struct mbuf *io = &c->recv_mbuf;\n   struct mg_http_proto_data *pd = mg_http_get_proto_data(c);\n \n+  if (pd->mp_stream.boundary == NULL) {\n+    pd->mp_stream.state = MPS_FINALIZE;\n+    DBG((\"Invalid request: boundary not initilaized\"));\n+    return 0;\n+  }\n+\n   if ((int) io->len < pd->mp_stream.boundary_len + 2) {\n     return 0;\n   }\n","owner":"cesanta","repo":"mongoose","source":"cve"},{"CVE_ID":"CVE-2016-10217","CWE_ID":"416","category":"security","commit_id":"90fd0c7ca3efc1ddff64a86f4104b13b3ac969eb","commit_message":"From 90fd0c7ca3efc1ddff64a86f4104b13b3ac969eb Mon Sep 17 00:00:00 2001\nFrom: Michael Vrhel <michael.vrhel@artifex.com>\nDate: Thu, 29 Dec 2016 14:00:21 -0800\nSubject: [PATCH] Bug 697456.  Dont create new ctx when pdf14 device reenabled\n\nThis bug had yet another weird case where the user created a\nfile that pushed the pdf14 device twice.  We were in that case,\ncreating a new ctx and blowing away the original one with out\nproper clean up.  To avoid, only create a new one when we need it.\n---\n base\/gdevp14.c | 6 ++++--\n 1 file changed, 4 insertions(+), 2 deletions(-)\n\n","diff_code":"diff --git a\/base\/gdevp14.c b\/base\/gdevp14.c\nindex fd56ec9..f19318e 100644\n--- a\/base\/gdevp14.c\n+++ b\/base\/gdevp14.c\n@@ -1669,8 +1669,10 @@ pdf14_open(gx_device *dev)\n     rect.p.y = 0;\n     rect.q.x = dev->width;\n     rect.q.y = dev->height;\n-    pdev->ctx = pdf14_ctx_new(&rect, dev->color_info.num_components,\n-        pdev->color_info.polarity != GX_CINFO_POLARITY_SUBTRACTIVE, dev);\n+    \/* If we are reenabling the device dont create a new ctx. Bug 697456 *\/\n+    if (pdev->ctx == NULL)\n+        pdev->ctx = pdf14_ctx_new(&rect, dev->color_info.num_components,\n+            pdev->color_info.polarity != GX_CINFO_POLARITY_SUBTRACTIVE, dev);\n     if (pdev->ctx == NULL)\n         return_error(gs_error_VMerror);\n     pdev->free_devicen = true;\n-- \n2.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2017-16943","CWE_ID":"416","category":"security","commit_id":"4090d62a4b25782129cc1643596dc2f6e8f63bde","commit_message":"From 4090d62a4b25782129cc1643596dc2f6e8f63bde Mon Sep 17 00:00:00 2001\nFrom: Jeremy Harris <jgh146exb@wizmail.org>\nDate: Fri, 24 Nov 2017 20:22:33 +0000\nSubject: [PATCH] Avoid release of store if there have been later allocations. \n Bug 2199\n\n---\n doc\/doc-txt\/ChangeLog | 4 ++++\n src\/src\/receive.c     | 7 ++++---\n 2 files changed, 8 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/doc\/doc-txt\/ChangeLog b\/doc\/doc-txt\/ChangeLog\nindex e937ba2..a2d9339 100644\n--- a\/doc\/doc-txt\/ChangeLog\n+++ b\/doc\/doc-txt\/ChangeLog\n@@ -59,6 +59,10 @@ JH\/30 Fix a logging bug on aarch64: an unsafe routine was previously used for\n       connection in response to HELO\" was logged instead of the actual 4xx\n       error for the HELO.\n \n+JH\/34 Bug 2199: fix a use-after-free while reading smtp input for header lines.\n+      A crafted sequence of BDAT commands could result in in-use memory beeing\n+      freed.\n+\n \n Exim version 4.89\n -----------------\ndiff --git a\/src\/src\/receive.c b\/src\/src\/receive.c\nindex 95cf13e..20672db 100644\n--- a\/src\/src\/receive.c\n+++ b\/src\/src\/receive.c\n@@ -1772,8 +1772,8 @@ for (;;)\n   (and sometimes lunatic messages can have ones that are 100s of K long) we\n   call store_release() for strings that have been copied - if the string is at\n   the start of a block (and therefore the only thing in it, because we aren't\n-  doing any other gets), the block gets freed. We can only do this because we\n-  know there are no other calls to store_get() going on. *\/\n+  doing any other gets), the block gets freed. We can only do this release if\n+  there were no allocations since the once that we want to free. *\/\n \n   if (ptr >= header_size - 4)\n     {\n@@ -1782,9 +1782,10 @@ for (;;)\n     header_size *= 2;\n     if (!store_extend(next->text, oldsize, header_size))\n       {\n+      BOOL release_ok = store_last_get[store_pool] == next->text;\n       uschar *newtext = store_get(header_size);\n       memcpy(newtext, next->text, ptr);\n-      store_release(next->text);\n+      if (release_ok) store_release(next->text);\n       next->text = newtext;\n       }\n     }\n-- \n1.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2016-6828","CWE_ID":"416","category":"security","commit_id":"bb1fceca22492109be12640d49f5ea5a544c6bb4","commit_message":"From bb1fceca22492109be12640d49f5ea5a544c6bb4 Mon Sep 17 00:00:00 2001\nFrom: Eric Dumazet <edumazet@google.com>\nDate: Wed, 17 Aug 2016 05:56:26 -0700\nSubject: tcp: fix use after free in tcp_xmit_retransmit_queue()\nMIME-Version: 1.0\nContent-Type: text\/plain; charset=UTF-8\nContent-Transfer-Encoding: 8bit\n\nWhen tcp_sendmsg() allocates a fresh and empty skb, it puts it at the\ntail of the write queue using tcp_add_write_queue_tail()\n\nThen it attempts to copy user data into this fresh skb.\n\nIf the copy fails, we undo the work and remove the fresh skb.\n\nUnfortunately, this undo lacks the change done to tp->highest_sack and\nwe can leave a dangling pointer (to a freed skb)\n\nLater, tcp_xmit_retransmit_queue() can dereference this pointer and\naccess freed memory. For regular kernels where memory is not unmapped,\nthis might cause SACK bugs because tcp_highest_sack_seq() is buggy,\nreturning garbage instead of tp->snd_nxt, but with various debug\nfeatures like CONFIG_DEBUG_PAGEALLOC, this can crash the kernel.\n\nThis bug was found by Marco Grassi thanks to syzkaller.\n\nFixes: 6859d49475d4 (\"[TCP]: Abstract tp->highest_sack accessing & point to next skb\")\nReported-by: Marco Grassi <marco.gra@gmail.com>\nSigned-off-by: Eric Dumazet <edumazet@google.com>\nCc: Ilpo J\u00e4rvinen <ilpo.jarvinen@helsinki.fi>\nCc: Yuchung Cheng <ycheng@google.com>\nCc: Neal Cardwell <ncardwell@google.com>\nAcked-by: Neal Cardwell <ncardwell@google.com>\nReviewed-by: Cong Wang <xiyou.wangcong@gmail.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n---\n include\/net\/tcp.h | 2 ++\n 1 file changed, 2 insertions(+)\n\n","diff_code":"diff --git a\/include\/net\/tcp.h b\/include\/net\/tcp.h\nindex c00e7d51bb18..7717302cab91 100644\n--- a\/include\/net\/tcp.h\n+++ b\/include\/net\/tcp.h\n@@ -1523,6 +1523,8 @@ static inline void tcp_check_send_head(struct sock *sk, struct sk_buff *skb_unli\n {\n \tif (sk->sk_send_head == skb_unlinked)\n \t\tsk->sk_send_head = NULL;\n+\tif (tcp_sk(sk)->highest_sack == skb_unlinked)\n+\t\ttcp_sk(sk)->highest_sack = NULL;\n }\n \n static inline void tcp_init_send_head(struct sock *sk)\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2016-7413","CWE_ID":"416","category":"security","commit_id":"b88393f08a558eec14964a55d3c680fe67407712","commit_message":"From b88393f08a558eec14964a55d3c680fe67407712 Mon Sep 17 00:00:00 2001\nFrom: Stanislav Malyshev <stas@php.net>\nDate: Mon, 5 Sep 2016 23:42:31 -0700\nSubject: [PATCH] Fix bug #72860: wddx_deserialize use-after-free\n\n---\n ext\/wddx\/tests\/bug72860.phpt | 27 +++++++++++++++++++++++++++\n ext\/wddx\/wddx.c              |  3 ++-\n 2 files changed, 29 insertions(+), 1 deletion(-)\n create mode 100644 ext\/wddx\/tests\/bug72860.phpt\n\n","diff_code":"diff --git a\/ext\/wddx\/tests\/bug72860.phpt b\/ext\/wddx\/tests\/bug72860.phpt\nnew file mode 100644\nindex 000000000000..6385457e8ee4\n--- \/dev\/null\n+++ b\/ext\/wddx\/tests\/bug72860.phpt\n@@ -0,0 +1,27 @@\n+--TEST--\n+Bug #72860: wddx_deserialize use-after-free\n+--SKIPIF--\n+<?php\n+if (!extension_loaded('wddx')) {\n+    die('skip. wddx not available');\n+}\n+?>\n+--FILE--\n+<?php\n+\n+$xml=<<<XML\n+<?xml version='1.0'?>\n+<!DOCTYPE wddxPacket SYSTEM 'wddx_0100.dtd'>\n+<wddxPacket version='1.0'>\n+       <recordset fieldNames='F'>\n+               <field name='F'>\n+       <\/recordset>\n+<\/wddxPacket>\n+XML;\n+\n+var_dump(wddx_deserialize($xml));\n+?>\n+DONE\n+--EXPECT--\n+NULL\n+DONE\n\\ No newline at end of file\ndiff --git a\/ext\/wddx\/wddx.c b\/ext\/wddx\/wddx.c\nindex d7bd295832c7..b02d2f07ded4 100644\n--- a\/ext\/wddx\/wddx.c\n+++ b\/ext\/wddx\/wddx.c\n@@ -230,7 +230,8 @@ static int wddx_stack_destroy(wddx_stack *stack)\n \n \tif (stack->elements) {\n \t\tfor (i = 0; i < stack->top; i++) {\n-\t\t\tif (((st_entry *)stack->elements[i])->data)\t{\n+\t\t\tif (((st_entry *)stack->elements[i])->data\n+\t\t\t\t\t&& ((st_entry *)stack->elements[i])->type != ST_FIELD)\t{\n \t\t\t\tzval_ptr_dtor(&((st_entry *)stack->elements[i])->data);\n \t\t\t}\n \t\t\tif (((st_entry *)stack->elements[i])->varname) {\n","owner":"php","repo":"php-src","source":"cve"},{"CVE_ID":"CVE-2018-10199","CWE_ID":"416","category":"security","commit_id":"b51b21fc63c9805862322551387d9036f2b63433","commit_message":"From b51b21fc63c9805862322551387d9036f2b63433 Mon Sep 17 00:00:00 2001\nFrom: \"Yukihiro \\\"Matz\\\" Matsumoto\" <matz@ruby.or.jp>\nDate: Tue, 17 Apr 2018 09:57:41 +0900\nSubject: [PATCH] Fix `use after free in File#initilialize_copy`; fix #4001\n\nThe bug and the fix were reported by https:\/\/hackerone.com\/pnoltof\n---\n mrbgems\/mruby-io\/src\/io.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/mrbgems\/mruby-io\/src\/io.c b\/mrbgems\/mruby-io\/src\/io.c\nindex 58bcdd1ee..6ace9e167 100644\n--- a\/mrbgems\/mruby-io\/src\/io.c\n+++ b\/mrbgems\/mruby-io\/src\/io.c\n@@ -561,13 +561,13 @@ mrb_io_initialize_copy(mrb_state *mrb, mrb_value copy)\n   mrb_bool failed = TRUE;\n \n   mrb_get_args(mrb, \"o\", &orig);\n+  fptr_orig = io_get_open_fptr(mrb, orig);\n   fptr_copy = (struct mrb_io *)DATA_PTR(copy);\n   if (fptr_copy != NULL) {\n     fptr_finalize(mrb, fptr_copy, FALSE);\n     mrb_free(mrb, fptr_copy);\n   }\n   fptr_copy = (struct mrb_io *)mrb_io_alloc(mrb);\n-  fptr_orig = io_get_open_fptr(mrb, orig);\n \n   DATA_TYPE(copy) = &mrb_io_type;\n   DATA_PTR(copy) = fptr_copy;\n","owner":"mruby","repo":"mruby","source":"cve"},{"CVE_ID":"CVE-2018-15857","CWE_ID":"416","category":"security","commit_id":"c1e5ac16e77a21f87bdf3bc4dea61b037a17dddb","commit_message":"From c1e5ac16e77a21f87bdf3bc4dea61b037a17dddb Mon Sep 17 00:00:00 2001\nFrom: Peter Hutterer <peter.hutterer@who-t.net>\nDate: Mon, 30 Jul 2018 14:11:46 +1000\nSubject: [PATCH] xkbcomp: fix pointer value for FreeStmt\n\nSigned-off-by: Peter Hutterer <peter.hutterer@who-t.net>\n---\n src\/xkbcomp\/ast-build.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/src\/xkbcomp\/ast-build.c b\/src\/xkbcomp\/ast-build.c\nindex 9c6ccd4..2de9e61 100644\n--- a\/src\/xkbcomp\/ast-build.c\n+++ b\/src\/xkbcomp\/ast-build.c\n@@ -240,7 +240,7 @@ ExprAppendMultiKeysymList(ExprDef *expr, ExprDef *append)\n     darray_append(expr->keysym_list.symsNumEntries, numEntries);\n     darray_concat(expr->keysym_list.syms, append->keysym_list.syms);\n \n-    FreeStmt((ParseCommon *) &append);\n+    FreeStmt((ParseCommon *) append);\n \n     return expr;\n }\n","owner":"xkbcommon","repo":"libxkbcommon","source":"cve"},{"CVE_ID":"CVE-2017-10661","CWE_ID":"416","category":"security","commit_id":"1e38da300e1e395a15048b0af1e5305bd91402f6","commit_message":"From 1e38da300e1e395a15048b0af1e5305bd91402f6 Mon Sep 17 00:00:00 2001\nFrom: Thomas Gleixner <tglx@linutronix.de>\nDate: Tue, 31 Jan 2017 15:24:03 +0100\nSubject: timerfd: Protect the might cancel mechanism proper\n\nThe handling of the might_cancel queueing is not properly protected, so\nparallel operations on the file descriptor can race with each other and\nlead to list corruptions or use after free.\n\nProtect the context for these operations with a seperate lock.\n\nThe wait queue lock cannot be reused for this because that would create a\nlock inversion scenario vs. the cancel lock. Replacing might_cancel with an\natomic (atomic_t or atomic bit) does not help either because it still can\nrace vs. the actual list operation.\n\nReported-by: Dmitry Vyukov <dvyukov@google.com>\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>\nCc: \"linux-fsdevel@vger.kernel.org\"\nCc: syzkaller <syzkaller@googlegroups.com>\nCc: Al Viro <viro@zeniv.linux.org.uk>\nCc: linux-fsdevel@vger.kernel.org\nLink: http:\/\/lkml.kernel.org\/r\/alpine.DEB.2.20.1701311521430.3457@nanos\nSigned-off-by: Thomas Gleixner <tglx@linutronix.de>\n---\n fs\/timerfd.c | 17 ++++++++++++++---\n 1 file changed, 14 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/fs\/timerfd.c b\/fs\/timerfd.c\nindex c173cc196175..384fa759a563 100644\n--- a\/fs\/timerfd.c\n+++ b\/fs\/timerfd.c\n@@ -40,6 +40,7 @@ struct timerfd_ctx {\n \tshort unsigned settime_flags;\t\/* to show in fdinfo *\/\n \tstruct rcu_head rcu;\n \tstruct list_head clist;\n+\tspinlock_t cancel_lock;\n \tbool might_cancel;\n };\n \n@@ -112,7 +113,7 @@ void timerfd_clock_was_set(void)\n \trcu_read_unlock();\n }\n \n-static void timerfd_remove_cancel(struct timerfd_ctx *ctx)\n+static void __timerfd_remove_cancel(struct timerfd_ctx *ctx)\n {\n \tif (ctx->might_cancel) {\n \t\tctx->might_cancel = false;\n@@ -122,6 +123,13 @@ static void timerfd_remove_cancel(struct timerfd_ctx *ctx)\n \t}\n }\n \n+static void timerfd_remove_cancel(struct timerfd_ctx *ctx)\n+{\n+\tspin_lock(&ctx->cancel_lock);\n+\t__timerfd_remove_cancel(ctx);\n+\tspin_unlock(&ctx->cancel_lock);\n+}\n+\n static bool timerfd_canceled(struct timerfd_ctx *ctx)\n {\n \tif (!ctx->might_cancel || ctx->moffs != KTIME_MAX)\n@@ -132,6 +140,7 @@ static bool timerfd_canceled(struct timerfd_ctx *ctx)\n \n static void timerfd_setup_cancel(struct timerfd_ctx *ctx, int flags)\n {\n+\tspin_lock(&ctx->cancel_lock);\n \tif ((ctx->clockid == CLOCK_REALTIME ||\n \t     ctx->clockid == CLOCK_REALTIME_ALARM) &&\n \t    (flags & TFD_TIMER_ABSTIME) && (flags & TFD_TIMER_CANCEL_ON_SET)) {\n@@ -141,9 +150,10 @@ static void timerfd_setup_cancel(struct timerfd_ctx *ctx, int flags)\n \t\t\tlist_add_rcu(&ctx->clist, &cancel_list);\n \t\t\tspin_unlock(&cancel_lock);\n \t\t}\n-\t} else if (ctx->might_cancel) {\n-\t\ttimerfd_remove_cancel(ctx);\n+\t} else {\n+\t\t__timerfd_remove_cancel(ctx);\n \t}\n+\tspin_unlock(&ctx->cancel_lock);\n }\n \n static ktime_t timerfd_get_remaining(struct timerfd_ctx *ctx)\n@@ -400,6 +410,7 @@ SYSCALL_DEFINE2(timerfd_create, int, clockid, int, flags)\n \t\treturn -ENOMEM;\n \n \tinit_waitqueue_head(&ctx->wqh);\n+\tspin_lock_init(&ctx->cancel_lock);\n \tctx->clockid = clockid;\n \n \tif (isalarm(ctx))\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2019-13224","CWE_ID":"416","category":"security","commit_id":"0f7f61ed1b7b697e283e37bd2d731d0bd57adb55","commit_message":"From 0f7f61ed1b7b697e283e37bd2d731d0bd57adb55 Mon Sep 17 00:00:00 2001\nFrom: \"K.Kosako\" <kosako@sofnec.co.jp>\nDate: Thu, 27 Jun 2019 17:25:26 +0900\nSubject: [PATCH] Fix CVE-2019-13224: don't allow different encodings for\n onig_new_deluxe()\n\n---\n src\/regext.c | 6 +++---\n 1 file changed, 3 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/src\/regext.c b\/src\/regext.c\nindex fa4b360..965c793 100644\n--- a\/src\/regext.c\n+++ b\/src\/regext.c\n@@ -29,6 +29,7 @@\n \n #include \"regint.h\"\n \n+#if 0\n static void\n conv_ext0be32(const UChar* s, const UChar* end, UChar* conv)\n {\n@@ -158,6 +159,7 @@ conv_encoding(OnigEncoding from, OnigEncoding to, const UChar* s, const UChar* e\n \n   return ONIGERR_NOT_SUPPORTED_ENCODING_COMBINATION;\n }\n+#endif\n \n extern int\n onig_new_deluxe(regex_t** reg, const UChar* pattern, const UChar* pattern_end,\n@@ -169,9 +171,7 @@ onig_new_deluxe(regex_t** reg, const UChar* pattern, const UChar* pattern_end,\n   if (IS_NOT_NULL(einfo)) einfo->par = (UChar* )NULL;\n \n   if (ci->pattern_enc != ci->target_enc) {\n-    r = conv_encoding(ci->pattern_enc, ci->target_enc, pattern, pattern_end,\n-                      &cpat, &cpat_end);\n-    if (r != 0) return r;\n+    return ONIGERR_NOT_SUPPORTED_ENCODING_COMBINATION;\n   }\n   else {\n     cpat     = (UChar* )pattern;\n","owner":"kkos","repo":"oniguruma","source":"cve"},{"CVE_ID":"CVE-2016-7912","CWE_ID":"416","category":"security","commit_id":"38740a5b87d53ceb89eb2c970150f6e94e00373a","commit_message":"From 38740a5b87d53ceb89eb2c970150f6e94e00373a Mon Sep 17 00:00:00 2001\nFrom: Lars-Peter Clausen <lars@metafoo.de>\nDate: Thu, 14 Apr 2016 17:01:17 +0200\nSubject: [PATCH] usb: gadget: f_fs: Fix use-after-free\n\nWhen using asynchronous read or write operations on the USB endpoints the\nissuer of the IO request is notified by calling the ki_complete() callback\nof the submitted kiocb when the URB has been completed.\n\nCalling this ki_complete() callback will free kiocb. Make sure that the\nstructure is no longer accessed beyond that point, otherwise undefined\nbehaviour might occur.\n\nFixes: 2e4c7553cd6f (\"usb: gadget: f_fs: add aio support\")\nCc: <stable@vger.kernel.org> # v3.15+\nSigned-off-by: Lars-Peter Clausen <lars@metafoo.de>\nSigned-off-by: Felipe Balbi <felipe.balbi@linux.intel.com>\n---\n drivers\/usb\/gadget\/function\/f_fs.c | 5 ++---\n 1 file changed, 2 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/drivers\/usb\/gadget\/function\/f_fs.c b\/drivers\/usb\/gadget\/function\/f_fs.c\nindex e21ca2bd6839e..15b648cbc75c4 100644\n--- a\/drivers\/usb\/gadget\/function\/f_fs.c\n+++ b\/drivers\/usb\/gadget\/function\/f_fs.c\n@@ -646,6 +646,7 @@ static void ffs_user_copy_worker(struct work_struct *work)\n \t\t\t\t\t\t   work);\n \tint ret = io_data->req->status ? io_data->req->status :\n \t\t\t\t\t io_data->req->actual;\n+\tbool kiocb_has_eventfd = io_data->kiocb->ki_flags & IOCB_EVENTFD;\n \n \tif (io_data->read && ret > 0) {\n \t\tuse_mm(io_data->mm);\n@@ -657,13 +658,11 @@ static void ffs_user_copy_worker(struct work_struct *work)\n \n \tio_data->kiocb->ki_complete(io_data->kiocb, ret, ret);\n \n-\tif (io_data->ffs->ffs_eventfd &&\n-\t    !(io_data->kiocb->ki_flags & IOCB_EVENTFD))\n+\tif (io_data->ffs->ffs_eventfd && !kiocb_has_eventfd)\n \t\teventfd_signal(io_data->ffs->ffs_eventfd, 1);\n \n \tusb_ep_free_request(io_data->ep, io_data->req);\n \n-\tio_data->kiocb->private = NULL;\n \tif (io_data->read)\n \t\tkfree(io_data->to_free);\n \tkfree(io_data->buf);\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-16527","CWE_ID":"416","category":"security","commit_id":"124751d5e63c823092060074bd0abaae61aaa9c4","commit_message":"From 124751d5e63c823092060074bd0abaae61aaa9c4 Mon Sep 17 00:00:00 2001\nFrom: Takashi Iwai <tiwai@suse.de>\nDate: Tue, 10 Oct 2017 14:10:32 +0200\nSubject: [PATCH] ALSA: usb-audio: Kill stray URB at exiting\n\nUSB-audio driver may leave a stray URB for the mixer interrupt when it\nexits by some error during probe.  This leads to a use-after-free\nerror as spotted by syzkaller like:\n  ==================================================================\n  BUG: KASAN: use-after-free in snd_usb_mixer_interrupt+0x604\/0x6f0\n  Call Trace:\n   <IRQ>\n   __dump_stack lib\/dump_stack.c:16\n   dump_stack+0x292\/0x395 lib\/dump_stack.c:52\n   print_address_description+0x78\/0x280 mm\/kasan\/report.c:252\n   kasan_report_error mm\/kasan\/report.c:351\n   kasan_report+0x23d\/0x350 mm\/kasan\/report.c:409\n   __asan_report_load8_noabort+0x19\/0x20 mm\/kasan\/report.c:430\n   snd_usb_mixer_interrupt+0x604\/0x6f0 sound\/usb\/mixer.c:2490\n   __usb_hcd_giveback_urb+0x2e0\/0x650 drivers\/usb\/core\/hcd.c:1779\n   ....\n\n  Allocated by task 1484:\n   save_stack_trace+0x1b\/0x20 arch\/x86\/kernel\/stacktrace.c:59\n   save_stack+0x43\/0xd0 mm\/kasan\/kasan.c:447\n   set_track mm\/kasan\/kasan.c:459\n   kasan_kmalloc+0xad\/0xe0 mm\/kasan\/kasan.c:551\n   kmem_cache_alloc_trace+0x11e\/0x2d0 mm\/slub.c:2772\n   kmalloc .\/include\/linux\/slab.h:493\n   kzalloc .\/include\/linux\/slab.h:666\n   snd_usb_create_mixer+0x145\/0x1010 sound\/usb\/mixer.c:2540\n   create_standard_mixer_quirk+0x58\/0x80 sound\/usb\/quirks.c:516\n   snd_usb_create_quirk+0x92\/0x100 sound\/usb\/quirks.c:560\n   create_composite_quirk+0x1c4\/0x3e0 sound\/usb\/quirks.c:59\n   snd_usb_create_quirk+0x92\/0x100 sound\/usb\/quirks.c:560\n   usb_audio_probe+0x1040\/0x2c10 sound\/usb\/card.c:618\n   ....\n\n  Freed by task 1484:\n   save_stack_trace+0x1b\/0x20 arch\/x86\/kernel\/stacktrace.c:59\n   save_stack+0x43\/0xd0 mm\/kasan\/kasan.c:447\n   set_track mm\/kasan\/kasan.c:459\n   kasan_slab_free+0x72\/0xc0 mm\/kasan\/kasan.c:524\n   slab_free_hook mm\/slub.c:1390\n   slab_free_freelist_hook mm\/slub.c:1412\n   slab_free mm\/slub.c:2988\n   kfree+0xf6\/0x2f0 mm\/slub.c:3919\n   snd_usb_mixer_free+0x11a\/0x160 sound\/usb\/mixer.c:2244\n   snd_usb_mixer_dev_free+0x36\/0x50 sound\/usb\/mixer.c:2250\n   __snd_device_free+0x1ff\/0x380 sound\/core\/device.c:91\n   snd_device_free_all+0x8f\/0xe0 sound\/core\/device.c:244\n   snd_card_do_free sound\/core\/init.c:461\n   release_card_device+0x47\/0x170 sound\/core\/init.c:181\n   device_release+0x13f\/0x210 drivers\/base\/core.c:814\n   ....\n\nActually such a URB is killed properly at disconnection when the\ndevice gets probed successfully, and what we need is to apply it for\nthe error-path, too.\n\nIn this patch, we apply snd_usb_mixer_disconnect() at releasing.\nAlso introduce a new flag, disconnected, to struct usb_mixer_interface\nfor not performing the disconnection procedure twice.\n\nReported-by: Andrey Konovalov <andreyknvl@google.com>\nTested-by: Andrey Konovalov <andreyknvl@google.com>\nCc: <stable@vger.kernel.org>\nSigned-off-by: Takashi Iwai <tiwai@suse.de>\n---\n sound\/usb\/mixer.c | 12 ++++++++++--\n sound\/usb\/mixer.h |  2 ++\n 2 files changed, 12 insertions(+), 2 deletions(-)\n\n","diff_code":"diff --git a\/sound\/usb\/mixer.c b\/sound\/usb\/mixer.c\nindex 9732edf77f860..91bc8f18791e4 100644\n--- a\/sound\/usb\/mixer.c\n+++ b\/sound\/usb\/mixer.c\n@@ -2234,6 +2234,9 @@ static int parse_audio_unit(struct mixer_build *state, int unitid)\n \n static void snd_usb_mixer_free(struct usb_mixer_interface *mixer)\n {\n+\t\/* kill pending URBs *\/\n+\tsnd_usb_mixer_disconnect(mixer);\n+\n \tkfree(mixer->id_elems);\n \tif (mixer->urb) {\n \t\tkfree(mixer->urb->transfer_buffer);\n@@ -2584,8 +2587,13 @@ int snd_usb_create_mixer(struct snd_usb_audio *chip, int ctrlif,\n \n void snd_usb_mixer_disconnect(struct usb_mixer_interface *mixer)\n {\n-\tusb_kill_urb(mixer->urb);\n-\tusb_kill_urb(mixer->rc_urb);\n+\tif (mixer->disconnected)\n+\t\treturn;\n+\tif (mixer->urb)\n+\t\tusb_kill_urb(mixer->urb);\n+\tif (mixer->rc_urb)\n+\t\tusb_kill_urb(mixer->rc_urb);\n+\tmixer->disconnected = true;\n }\n \n #ifdef CONFIG_PM\ndiff --git a\/sound\/usb\/mixer.h b\/sound\/usb\/mixer.h\nindex 2b4b067646ab0..545d99b09706b 100644\n--- a\/sound\/usb\/mixer.h\n+++ b\/sound\/usb\/mixer.h\n@@ -22,6 +22,8 @@ struct usb_mixer_interface {\n \tstruct urb *rc_urb;\n \tstruct usb_ctrlrequest *rc_setup_packet;\n \tu8 rc_buffer[6];\n+\n+\tbool disconnected;\n };\n \n #define MAX_CHANNELS\t16\t\/* max logical channels *\/\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-18234","CWE_ID":"416","category":"security","commit_id":"c26d5beb60a5a85f76259f50ed3e08c8169b0a0c","commit_message":"From c26d5beb60a5a85f76259f50ed3e08c8169b0a0c Mon Sep 17 00:00:00 2001\nFrom: =?UTF-8?q?Hubert=20Figui=C3=A8re?= <hub@figuiere.net>\nDate: Sun, 26 Mar 2017 01:10:11 -0400\nSubject: Bug 100397 - Fix crash on malformed JPEG file\n\n- Check the buffer doesn't overrun for the TIFF tag\n- Fix a use-after-free in exception handling\n- Fix two invalid memcpy() on overlapping memory\n---\n XMPFiles\/source\/FormatSupport\/ReconcileTIFF.cpp    |  2 +-\n ...\/source\/FormatSupport\/TIFF_MemoryReader.cpp     | 10 ++++--\n XMPFiles\/source\/FormatSupport\/TIFF_Support.hpp     |  8 ++++-\n exempi\/exempi.cpp                                  |  6 ++--\n public\/include\/XMP_Const.h                         | 24 +++++++++++--\n public\/include\/client-glue\/WXMP_Common.hpp         | 39 +++++++++++++++++++---\n source\/XMP_LibUtils.hpp                            | 24 ++++++-------\n 7 files changed, 85 insertions(+), 28 deletions(-)\n\n","diff_code":"diff --git a\/XMPFiles\/source\/FormatSupport\/ReconcileTIFF.cpp b\/XMPFiles\/source\/FormatSupport\/ReconcileTIFF.cpp\nindex aa4aea6..7e89b0e 100644\n--- a\/XMPFiles\/source\/FormatSupport\/ReconcileTIFF.cpp\n+++ b\/XMPFiles\/source\/FormatSupport\/ReconcileTIFF.cpp\n@@ -233,7 +233,7 @@ static XMP_Uns32 GatherInt ( const char * strPtr, size_t count )\n \n static size_t TrimTrailingSpaces ( char * firstChar, size_t origLen )\n {\n-\tif ( origLen == 0 ) return 0;\n+\tif ( !firstChar || origLen == 0 ) return 0;\n \n \tchar * lastChar  = firstChar + origLen - 1;\n \tif ( (*lastChar != ' ') && (*lastChar != 0) ) return origLen;\t\/\/ Nothing to do.\ndiff --git a\/XMPFiles\/source\/FormatSupport\/TIFF_MemoryReader.cpp b\/XMPFiles\/source\/FormatSupport\/TIFF_MemoryReader.cpp\nindex ea1b686..fcf9e43 100644\n--- a\/XMPFiles\/source\/FormatSupport\/TIFF_MemoryReader.cpp\n+++ b\/XMPFiles\/source\/FormatSupport\/TIFF_MemoryReader.cpp\n@@ -70,7 +70,7 @@ void TIFF_MemoryReader::SortIFD ( TweakedIFDInfo* thisIFD )\n \t\t} else if ( thisTag == prevTag ) {\n \n \t\t\t\/\/ Duplicate tag, keep the 2nd copy, move the tail of the array up, prevTag is unchanged.\n-\t\t\tmemcpy ( &ifdEntries[i-1], &ifdEntries[i], 12*(tagCount-i) );\t\/\/ AUDIT: Safe, moving tail forward, i >= 1.\n+\t\t\tmemmove ( &ifdEntries[i-1], &ifdEntries[i], 12*(tagCount-i) ); \/\/ may overlap -- Hub\n \t\t\t--tagCount;\n \t\t\t--i; \/\/ ! Don't move forward in the array, we've moved the unseen part up.\n \n@@ -86,7 +86,7 @@ void TIFF_MemoryReader::SortIFD ( TweakedIFDInfo* thisIFD )\n \n \t\t\t\t\/\/ Out of order duplicate, move it to position j, move the tail of the array up.\n \t\t\t\tifdEntries[j] = ifdEntries[i];\n-\t\t\t\tmemcpy ( &ifdEntries[i], &ifdEntries[i+1], 12*(tagCount-(i+1)) );\t\/\/ AUDIT: Safe, moving tail forward, i >= 1.\n+\t\t\t\tmemmove ( &ifdEntries[i], &ifdEntries[i+1], 12*(tagCount-(i+1)) );\t\/\/ may overlap -- Hub\n \t\t\t\t--tagCount;\n \t\t\t\t--i; \/\/ ! Don't move forward in the array, we've moved the unseen part up.\n \n@@ -232,7 +232,11 @@ bool TIFF_MemoryReader::GetTag ( XMP_Uns8 ifd, XMP_Uns16 id, TagInfo* info ) con\n \t\tinfo->dataLen = thisBytes;\n \n \t\tinfo->dataPtr = this->GetDataPtr ( thisTag );\n-\n+\t\t\/\/ Here we know that if it is NULL, it is wrong. -- Hub\n+\t\t\/\/ GetDataPtr will return NULL in case of overflow.\n+\t\tif (info->dataPtr == NULL) {\n+\t\t\treturn false;\n+\t\t}\n \t}\n \n \treturn true;\ndiff --git a\/XMPFiles\/source\/FormatSupport\/TIFF_Support.hpp b\/XMPFiles\/source\/FormatSupport\/TIFF_Support.hpp\nindex d4e2f4d..e3e458b 100644\n--- a\/XMPFiles\/source\/FormatSupport\/TIFF_Support.hpp\n+++ b\/XMPFiles\/source\/FormatSupport\/TIFF_Support.hpp\n@@ -786,7 +786,13 @@ private:\n \t\t{ if ( GetUns32AsIs(&tifdEntry->bytes) <= 4 ) {\n \t\t  \treturn &tifdEntry->dataOrPos;\n \t\t  } else {\n-\t\t  \treturn (this->tiffStream + GetUns32AsIs(&tifdEntry->dataOrPos));\n+\t\t\tXMP_Uns32 pos = GetUns32AsIs(&tifdEntry->dataOrPos);\n+\t\t\tif (pos + GetUns32AsIs (&tifdEntry->bytes) > this->tiffLength) {\n+\t\t\t\t\/\/ Invalid file.\n+\t\t\t\t\/\/ The data is past the length of the TIFF.\n+\t\t\t\treturn NULL;\n+\t\t\t}\n+\t\t\treturn (this->tiffStream + pos);\n \t\t  }\n \t\t}\n \ndiff --git a\/exempi\/exempi.cpp b\/exempi\/exempi.cpp\nindex 6857df9..584aaf1 100644\n--- a\/exempi\/exempi.cpp\n+++ b\/exempi\/exempi.cpp\n@@ -195,10 +195,8 @@ bool xmp_init()\n     RESET_ERROR;\n     try {\n         \/\/ no need to initialize anything else.\n-        \/\/ XMP SDK 5.1.2 needs this because it has been lobotomized of local\n-        \/\/ text\n-        \/\/ conversion\n-        \/\/ the one that was done in Exempi with libiconv.\n+        \/\/ XMP SDK 5.1.2 needs this because it has been stripped off local\n+        \/\/ text conversion the one that was done in Exempi with libiconv.\n         bool result = SXMPFiles::Initialize(kXMPFiles_IgnoreLocalText);\n         SXMPMeta::SetDefaultErrorCallback(&_xmp_error_callback, nullptr, 1);\n         return result;\ndiff --git a\/public\/include\/XMP_Const.h b\/public\/include\/XMP_Const.h\nindex 4b72404..aa05e89 100644\n--- a\/public\/include\/XMP_Const.h\n+++ b\/public\/include\/XMP_Const.h\n@@ -12,6 +12,8 @@\n #include \"XMP_Environment.h\"\n \n    #include <stddef.h>\n+   #include <string.h>\n+   #include <stdlib.h>\n \n #if XMP_MacBuild | XMP_iOSBuild\t\/\/ ! No stdint.h on Windows and some UNIXes.\n     #include <stdint.h>\n@@ -1313,7 +1315,25 @@ public:\n \t\/\/\/\n \t\/\/\/ @param _errMsg The descriptive string, for debugging use only. It must not be shown to users\n \t\/\/\/ in a final product. It is written for developers, not users, and never localized.\n-\tXMP_Error ( XMP_Int32 _id, XMP_StringPtr _errMsg ) : id(_id), errMsg(_errMsg), notified(false) {};\n+\tXMP_Error ( XMP_Int32 _id, XMP_StringPtr _errMsg ) : id(_id), errMsg(NULL), notified(false) {\n+\t\tif (_errMsg) {\n+\t\t\terrMsg = strdup(_errMsg);\n+\t\t}\n+\t};\n+\t\/\/\/ @brief Copy constructor for an XMP_Error.\n+\t\/\/\/\n+\t\/\/\/ Because we rethrow it.\n+\tXMP_Error (const XMP_Error& e)\n+\t\t: id(e.id), errMsg(NULL), notified(e.notified) {\n+\t\tif (e.errMsg) {\n+\t\t\terrMsg = strdup(e.errMsg);\n+\t\t}\n+\t};\n+\t~XMP_Error() {\n+\t\tif (errMsg) {\n+\t\t\tfree(errMsg);\n+\t\t}\n+\t};\n \n \t\/\/\/ Retrieves the numeric code from an XMP_Error.\n \tinline XMP_Int32     GetID() const     { return id; };\n@@ -1332,7 +1352,7 @@ private:\n \tXMP_Int32     id;\n \t\/\/\/ Descriptive string, for debugging use only. It must not be shown to users in a final\n \t\/\/\/ product. It is written for developers, not users, and never localized.\n-\tXMP_StringPtr errMsg;\n+\tchar* errMsg;\n \t\/\/\/ Variable to store whether this particular error is notified to user or not\n \tXMP_Bool notified;\n };\ndiff --git a\/public\/include\/client-glue\/WXMP_Common.hpp b\/public\/include\/client-glue\/WXMP_Common.hpp\nindex 97fb9fc..0aef5ba 100644\n--- a\/public\/include\/client-glue\/WXMP_Common.hpp\n+++ b\/public\/include\/client-glue\/WXMP_Common.hpp\n@@ -9,6 +9,9 @@\n \/\/ of the Adobe license agreement accompanying it.\n \/\/ =================================================================================================\n \n+#include <stdlib.h>\n+#include <string.h>\n+\n #ifndef XMP_Inline\n \t#if TXMP_EXPAND_INLINE\n \t\t#define XMP_Inline inline\n@@ -24,12 +27,38 @@ typedef void (* SetClientStringProc) ( void * clientPtr, XMP_StringPtr valuePtr,\n typedef void (* SetClientStringVectorProc) ( void * clientPtr, XMP_StringPtr * arrayPtr, XMP_Uns32 stringCount );\n \n struct WXMP_Result {\n-    XMP_StringPtr errMessage;\n+private:\n+    char*         errMessage;\n+public:\n     void *        ptrResult;\n     double        floatResult;\n     XMP_Uns64     int64Result;\n     XMP_Uns32     int32Result;\n-\tWXMP_Result() : errMessage(0),ptrResult(NULL),floatResult(0),int64Result(0),int32Result(0){};\n+\tWXMP_Result() : errMessage(NULL),ptrResult(NULL),floatResult(0),int64Result(0),int32Result(0){};\n+\t~WXMP_Result()\n+\t{\n+\t\tif (errMessage) {\n+\t\t\tfree(errMessage);\n+\t\t}\n+\t}\n+\tvoid SetErrMessage(const char* msg)\n+\t\t{\n+\t\t\tif (errMessage) {\n+\t\t\t\tfree(errMessage);\n+\t\t\t\terrMessage = NULL;\n+\t\t\t}\n+\t\t\tif (msg) {\n+\t\t\t\terrMessage = strdup(msg);\n+\t\t\t}\n+\t\t}\n+\tconst char* GetErrMessage() const\n+\t\t{\n+\t\t\treturn errMessage;\n+\t\t}\n+private:\n+\t\/\/ We should avoid automatic copy.\n+\tWXMP_Result(const WXMP_Result&);\n+\tWXMP_Result& operator=(const WXMP_Result&);\n };\n \n #if __cplusplus\n@@ -37,7 +66,7 @@ extern \"C\" {\n #endif\n \n #define PropagateException(res)\t\\\n-\tif ( res.errMessage != 0 ) throw XMP_Error ( res.int32Result, res.errMessage );\n+\tif ( res.GetErrMessage() != 0 ) throw XMP_Error ( res.int32Result, res.GetErrMessage() );\n \n #ifndef XMP_TraceClientCalls\n \t#define XMP_TraceClientCalls\t\t0\n@@ -55,10 +84,10 @@ extern \"C\" {\n     \tWXMP_Result wResult;                                                                                 \\\n     \tfprintf ( xmpClientLog, \"WXMP calling: %s\\n\", #WCallProto ); fflush ( xmpClientLog );                \\\n     \tWCallProto;                                                                                          \\\n-    \tif ( wResult.errMessage == 0 ) {                                                                     \\\n+\tif ( wResult.GetErrMessage() == 0 ) {\t\t\t\t\\\n \t\t\tfprintf ( xmpClientLog, \"WXMP back, no error\\n\" ); fflush ( xmpClientLog );                      \\\n     \t} else {                                                                                             \\\n-\t\t\tfprintf ( xmpClientLog, \"WXMP back, error: %s\\n\", wResult.errMessage ); fflush ( xmpClientLog ); \\\n+\t\t\tfprintf ( xmpClientLog, \"WXMP back, error: %s\\n\", wResult.GetErrMessage() ); fflush ( xmpClientLog ); \\\n     \t}                                                                                                    \\\n \t\tPropagateException ( wResult )\n #endif\ndiff --git a\/source\/XMP_LibUtils.hpp b\/source\/XMP_LibUtils.hpp\nindex 6b6a96a..3fa7a8b 100644\n--- a\/source\/XMP_LibUtils.hpp\n+++ b\/source\/XMP_LibUtils.hpp\n@@ -444,13 +444,13 @@ private:\n #define XMP_ENTER_NoLock(Proc)\t\t\\\n \tAnnounceStaticEntry ( Proc );\t\\\n \ttry {\t\t\t\t\t\t\t\\\n-\t\twResult->errMessage = 0;\n+\t\twResult->SetErrMessage(0);\n \n #define XMP_ENTER_Static(Proc)\t\t\t\t\\\n \tAnnounceStaticEntry ( Proc );\t\t\t\\\n \tAcquireLibraryLock ( sLibraryLock );\t\\\n \ttry {\t\t\t\t\t\t\t\t\t\\\n-\t\twResult->errMessage = 0;\n+\t\twResult->SetErrMessage(0);\n \n #define XMP_ENTER_ObjRead(XMPClass,Proc)\t\t\t\t\\\n \tAnnounceObjectEntry ( Proc, \"reader\" );\t\t\t\t\\\n@@ -458,7 +458,7 @@ private:\n \tconst XMPClass & thiz = *((XMPClass*)xmpObjRef);\t\\\n \tXMP_AutoLock objLock ( &thiz.lock, kXMP_ReadLock );\t\\\n \ttry {\t\t\t\t\t\t\t\t\t\t\t\t\\\n-\t\twResult->errMessage = 0;\n+\t\twResult->SetErrMessage(0);\n \n #define XMP_ENTER_ObjWrite(XMPClass,Proc)\t\t\t\t\t\\\n \tAnnounceObjectEntry ( Proc, \"writer\" );\t\t\t\t\t\\\n@@ -466,7 +466,7 @@ private:\n \tXMPClass * thiz = (XMPClass*)xmpObjRef;\t\t\t\t\t\\\n \tXMP_AutoLock objLock ( &thiz->lock, kXMP_WriteLock );\t\\\n \ttry {\t\t\t\t\t\t\t\t\t\t\t\t\t\\\n-\t\twResult->errMessage = 0;\n+\t\twResult->SetErrMessage(0);\n \n #define XMP_EXIT\t\t\t\\\n \tXMP_CATCH_EXCEPTIONS\t\\\n@@ -483,18 +483,18 @@ private:\n \t} catch ( XMP_Error & xmpErr ) {\t\t\t\t\t\t\t\t\\\n \t\twResult->int32Result = xmpErr.GetID(); \t\t\t\t\t\t\\\n \t\twResult->ptrResult   = (void*)\"XMP\";\t\t\t\t\t\t\\\n-\t\twResult->errMessage  = xmpErr.GetErrMsg();\t\t\t\t\t\\\n-\t\tif ( wResult->errMessage == 0 ) wResult->errMessage = \"\";\t\\\n-\t\tAnnounceCatch ( wResult->errMessage );\t\t\t\t\t\t\\\n+\t\twResult->SetErrMessage(xmpErr.GetErrMsg());             \\\n+\t\tif ( wResult->GetErrMessage() == 0 ) wResult->SetErrMessage(\"\"); \\\n+\t\tAnnounceCatch ( wResult->GetErrMessage() );             \\\n \t} catch ( std::exception & stdErr ) {\t\t\t\t\t\t\t\\\n \t\twResult->int32Result = kXMPErr_StdException; \t\t\t\t\\\n-\t\twResult->errMessage  = stdErr.what(); \t\t\t\t\t\t\\\n-\t\tif ( wResult->errMessage == 0 ) wResult->errMessage = \"\";\t\\\n-\t\tAnnounceCatch ( wResult->errMessage );\t\t\t\t\t\t\\\n+\t\twResult->SetErrMessage(stdErr.what());                  \\\n+\t\tif ( wResult->GetErrMessage() == 0 ) wResult->SetErrMessage(\"\"); \\\n+\t\tAnnounceCatch ( wResult->GetErrMessage() );             \\\n \t} catch ( ... ) {\t\t\t\t\t\t\t\t\t\t\t\t\\\n \t\twResult->int32Result = kXMPErr_UnknownException; \t\t\t\\\n-\t\twResult->errMessage  = \"Caught unknown exception\";\t\t\t\\\n-\t\tAnnounceCatch ( wResult->errMessage );\t\t\t\t\t\t\\\n+\t\twResult->SetErrMessage(\"Caught unknown exception\");     \\\n+\t\tAnnounceCatch ( wResult->GetErrMessage() );                \\\n \t}\n \n #if XMP_DebugBuild\n-- \ncgit v1.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2018-12320","CWE_ID":"416","category":"security","commit_id":"90b71c017a7fa9732fe45fd21b245ee051b1f548","commit_message":"From 90b71c017a7fa9732fe45fd21b245ee051b1f548 Mon Sep 17 00:00:00 2001\nFrom: pancake <pancake@nopcode.org>\nDate: Mon, 11 Jun 2018 03:28:35 +0200\nSubject: [PATCH] Fix #10293 - Use-after-free in r_anal_bb_free()\n\n---\n libr\/anal\/bb.c | 6 +++++-\n 1 file changed, 5 insertions(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/libr\/anal\/bb.c b\/libr\/anal\/bb.c\nindex 81c5fab143..a693c55856 100644\n--- a\/libr\/anal\/bb.c\n+++ b\/libr\/anal\/bb.c\n@@ -62,7 +62,11 @@ R_API void r_anal_bb_free(RAnalBlock *bb) {\n \t\tbb->failbb->prev = NULL;\n \t\tbb->failbb = NULL;\n \t}\n-\tR_FREE (bb);\n+\tif (bb->next) {\n+\t\t\/\/ avoid double free\n+\t\tbb->next->prev = NULL;\n+\t}\n+\tR_FREE (bb); \/\/ double free\n }\n \n R_API RList *r_anal_bb_list_new() {\n","owner":"radare","repo":"radare2","source":"cve"},{"CVE_ID":"CVE-2016-9137","CWE_ID":"416","category":"security","commit_id":"0e6fe3a4c96be2d3e88389a5776f878021b4c59f","commit_message":"From 0e6fe3a4c96be2d3e88389a5776f878021b4c59f Mon Sep 17 00:00:00 2001\nFrom: Stanislav Malyshev <stas@php.net>\nDate: Sun, 25 Sep 2016 19:53:59 -0700\nSubject: [PATCH] Fix bug #73147: Use After Free in PHP7 unserialize()\n\n---\n Zend\/zend_API.c              | 24 ++++++++++++++++++++++++\n Zend\/zend_API.h              |  1 +\n ext\/curl\/curl_file.c         |  5 ++++-\n ext\/curl\/tests\/bug73147.phpt | 20 ++++++++++++++++++++\n 4 files changed, 49 insertions(+), 1 deletion(-)\n create mode 100644 ext\/curl\/tests\/bug73147.phpt\n\n","diff_code":"diff --git a\/Zend\/zend_API.c b\/Zend\/zend_API.c\nindex 8202b9a..0757cc9 100644\n--- a\/Zend\/zend_API.c\n+++ b\/Zend\/zend_API.c\n@@ -3776,6 +3776,30 @@ ZEND_API void zend_update_property(zend_class_entry *scope, zval *object, const\n }\n \/* }}} *\/\n \n+ZEND_API void zend_unset_property(zend_class_entry *scope, zval *object, const char *name, int name_length TSRMLS_DC) \/* {{{ *\/\n+{\n+\tzval *property;\n+\tzend_class_entry *old_scope = EG(scope);\n+\n+\tEG(scope) = scope;\n+\n+\tif (!Z_OBJ_HT_P(object)->unset_property) {\n+\t\tconst char *class_name;\n+\t\tzend_uint class_name_len;\n+\n+\t\tzend_get_object_classname(object, &class_name, &class_name_len TSRMLS_CC);\n+\n+\t\tzend_error(E_CORE_ERROR, \"Property %s of class %s cannot be unset\", name, class_name);\n+\t}\n+\tMAKE_STD_ZVAL(property);\n+\tZVAL_STRINGL(property, name, name_length, 1);\n+\tZ_OBJ_HT_P(object)->unset_property(object, property, 0 TSRMLS_CC);\n+\tzval_ptr_dtor(&property);\n+\n+\tEG(scope) = old_scope;\n+}\n+\/* }}} *\/\n+\n ZEND_API void zend_update_property_null(zend_class_entry *scope, zval *object, const char *name, int name_length TSRMLS_DC) \/* {{{ *\/\n {\n \tzval *tmp;\ndiff --git a\/Zend\/zend_API.h b\/Zend\/zend_API.h\nindex 53c1a4c..c57c003 100644\n--- a\/Zend\/zend_API.h\n+++ b\/Zend\/zend_API.h\n@@ -330,6 +330,7 @@ ZEND_API void zend_update_property_long(zend_class_entry *scope, zval *object, c\n ZEND_API void zend_update_property_double(zend_class_entry *scope, zval *object, const char *name, int name_length, double value TSRMLS_DC);\n ZEND_API void zend_update_property_string(zend_class_entry *scope, zval *object, const char *name, int name_length, const char *value TSRMLS_DC);\n ZEND_API void zend_update_property_stringl(zend_class_entry *scope, zval *object, const char *name, int name_length, const char *value, int value_length TSRMLS_DC);\n+ZEND_API void zend_unset_property(zend_class_entry *scope, zval *object, const char *name, int name_length TSRMLS_DC);\n \n ZEND_API int zend_update_static_property(zend_class_entry *scope, const char *name, int name_length, zval *value TSRMLS_DC);\n ZEND_API int zend_update_static_property_null(zend_class_entry *scope, const char *name, int name_length TSRMLS_DC);\ndiff --git a\/ext\/curl\/curl_file.c b\/ext\/curl\/curl_file.c\nindex 56c1bbe..029a58a 100644\n--- a\/ext\/curl\/curl_file.c\n+++ b\/ext\/curl\/curl_file.c\n@@ -137,7 +137,10 @@ ZEND_METHOD(CURLFile, setPostFilename)\n    Unserialization handler *\/\n ZEND_METHOD(CURLFile, __wakeup)\n {\n-\tzend_update_property_string(curl_CURLFile_class, getThis(), \"name\", sizeof(\"name\")-1, \"\" TSRMLS_CC);\n+\tzval *_this = getThis();\n+\n+\tzend_unset_property(curl_CURLFile_class, _this, \"name\", sizeof(\"name\")-1 TSRMLS_CC);\n+\tzend_update_property_string(curl_CURLFile_class, _this, \"name\", sizeof(\"name\")-1, \"\" TSRMLS_CC);\n \tzend_throw_exception(NULL, \"Unserialization of CURLFile instances is not allowed\", 0 TSRMLS_CC);\n }\n \/* }}} *\/\ndiff --git a\/ext\/curl\/tests\/bug73147.phpt b\/ext\/curl\/tests\/bug73147.phpt\nnew file mode 100644\nindex 0000000..118177d\n--- \/dev\/null\n+++ b\/ext\/curl\/tests\/bug73147.phpt\n@@ -0,0 +1,20 @@\n+--TEST--\n+Bug #73147: Use After Free in PHP7 unserialize()\n+--SKIPIF--\n+<?php\n+if (!extension_loaded(\"curl\")) {\n+        exit(\"skip curl extension not loaded\");\n+}\n+?>\n+--FILE--\n+<?php\n+\n+$poc = 'a:1:{i:0;O:8:\"CURLFile\":1:{s:4:\"name\";R:1;}}';\n+try {\n+var_dump(unserialize($poc));\n+} catch(Exception $e) {\n+\techo $e->getMessage();\n+}\n+?>\n+--EXPECT--\n+Unserialization of CURLFile instances is not allowed\n-- \n2.1.4\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2018-1000038","CWE_ID":"416","category":"security","commit_id":"f597300439e62f5e921f0d7b1e880b5c1a1f1607","commit_message":"From f597300439e62f5e921f0d7b1e880b5c1a1f1607 Mon Sep 17 00:00:00 2001\nFrom: Sebastian Rasmussen <sebras@gmail.com>\nDate: Tue, 23 Jan 2018 23:02:16 +0100\nSubject: [PATCH 1\/1] Bug 698883: Reset cmap splay tree pointer, handling\n resized tree.\n\nWithout this change a resized cmap splay tree leads to using stale pointers.\n---\n source\/pdf\/pdf-cmap.c | 1 +\n 1 file changed, 1 insertion(+)\n\n","diff_code":"diff --git a\/source\/pdf\/pdf-cmap.c b\/source\/pdf\/pdf-cmap.c\nindex 29d9c50..00e2afb 100644\n--- a\/source\/pdf\/pdf-cmap.c\n+++ b\/source\/pdf\/pdf-cmap.c\n@@ -525,6 +525,7 @@ add_range(fz_context *ctx, pdf_cmap *cmap, unsigned int low, unsigned int high,\n \t\t\t\t\tint new_high = tree[current].high;\n \t\t\t\t\ttree[current].high = low-1;\n \t\t\t\t\tadd_range(ctx, cmap, high+1, new_high, tree[current].out + high + 1 - tree[current].low, 0, tree[current].many);\n+\t\t\t\t\ttree = cmap->tree;\n \t\t\t\t}\n \t\t\t\t\/* Now look for where to move to next (left for case 0, right for case 5) *\/\n \t\t\t\tif (tree[current].low > high) {\n-- \n2.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2018-1000038","CWE_ID":"416","category":"security","commit_id":"71ceebcf56e682504da22c4035b39a2d451e8ffd","commit_message":"From 71ceebcf56e682504da22c4035b39a2d451e8ffd Mon Sep 17 00:00:00 2001\nFrom: Sebastian Rasmussen <sebras@gmail.com>\nDate: Tue, 23 Jan 2018 03:04:33 +0100\nSubject: [PATCH 1\/1] Bug 698888: Keep one-to-many state when splitting nodes\n in cmap splay trees.\n\nThanks to oss-fuzz for reporting this.\n---\n source\/pdf\/pdf-cmap.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/source\/pdf\/pdf-cmap.c b\/source\/pdf\/pdf-cmap.c\nindex ade72c4..bedc130 100644\n--- a\/source\/pdf\/pdf-cmap.c\n+++ b\/source\/pdf\/pdf-cmap.c\n@@ -520,7 +520,7 @@ add_range(fz_context *ctx, pdf_cmap *cmap, unsigned int low, unsigned int high,\n \t\t\t\t\t\/* case 3, reduces to case 5 *\/\n \t\t\t\t\tint new_high = tree[current].high;\n \t\t\t\t\ttree[current].high = low-1;\n-\t\t\t\t\tadd_range(ctx, cmap, high+1, new_high, tree[current].out + high + 1 - tree[current].low, 0, many);\n+\t\t\t\t\tadd_range(ctx, cmap, high+1, new_high, tree[current].out + high + 1 - tree[current].low, 0, tree[current].many);\n \t\t\t\t}\n \t\t\t\t\/* Now look for where to move to next (left for case 0, right for case 5) *\/\n \t\t\t\tif (tree[current].low > high) {\n-- \n2.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2016-9936","CWE_ID":"416","category":"security","commit_id":"b2af4e8868726a040234de113436c6e4f6372d17","commit_message":"From b2af4e8868726a040234de113436c6e4f6372d17 Mon Sep 17 00:00:00 2001\nFrom: Nikita Popov <nikic@php.net>\nDate: Sun, 23 Oct 2016 21:37:36 +0200\nSubject: [PATCH] Complete the fix of bug #70172 for PHP 7\n\n---\n ext\/standard\/tests\/serialize\/bug70172_2.phpt |  6 ++----\n ext\/standard\/var.c                           | 10 +++++-----\n 2 files changed, 7 insertions(+), 9 deletions(-)\n\n","diff_code":"diff --git a\/ext\/standard\/tests\/serialize\/bug70172_2.phpt b\/ext\/standard\/tests\/serialize\/bug70172_2.phpt\nindex dc9067168a08..2b12a78edb5b 100644\n--- a\/ext\/standard\/tests\/serialize\/bug70172_2.phpt\n+++ b\/ext\/standard\/tests\/serialize\/bug70172_2.phpt\n@@ -1,7 +1,5 @@\n --TEST--\n Bug #70172 - Use After Free Vulnerability in unserialize()\n---XFAIL--\n-Unfinished merge, needs fix.\n --FILE--\n <?php\n class obj implements Serializable {\n@@ -61,10 +59,10 @@ array(2) {\n     [0]=>\n     array(1) {\n       [0]=>\n-      &object(obj2)#%d (1) {\n+      object(obj2)#%d (1) {\n         [\"ryat\"]=>\n         int(1)\n       }\n     }\n   }\n-}\n\\ No newline at end of file\n+}\ndiff --git a\/ext\/standard\/var.c b\/ext\/standard\/var.c\nindex 472cd62d8f57..88719ccb64dc 100644\n--- a\/ext\/standard\/var.c\n+++ b\/ext\/standard\/var.c\n@@ -1036,6 +1036,7 @@ PHP_FUNCTION(unserialize)\n \tconst unsigned char *p;\n \tphp_unserialize_data_t var_hash;\n \tzval *options = NULL, *classes = NULL;\n+\tzval *retval;\n \tHashTable *class_hash = NULL;\n \n \tif (zend_parse_parameters(ZEND_NUM_ARGS(), \"s|a\", &buf, &buf_len, &options) == FAILURE) {\n@@ -1067,22 +1068,21 @@ PHP_FUNCTION(unserialize)\n \t\t}\n \t}\n \n-\tif (!php_var_unserialize_ex(return_value, &p, p + buf_len, &var_hash, class_hash)) {\n+\tretval = var_tmp_var(&var_hash);\n+\tif (!php_var_unserialize_ex(retval, &p, p + buf_len, &var_hash, class_hash)) {\n \t\tPHP_VAR_UNSERIALIZE_DESTROY(var_hash);\n \t\tif (class_hash) {\n \t\t\tzend_hash_destroy(class_hash);\n \t\t\tFREE_HASHTABLE(class_hash);\n \t\t}\n-\t\tzval_ptr_dtor(return_value);\n \t\tif (!EG(exception)) {\n \t\t\tphp_error_docref(NULL, E_NOTICE, \"Error at offset \" ZEND_LONG_FMT \" of %zd bytes\",\n \t\t\t\t(zend_long)((char*)p - buf), buf_len);\n \t\t}\n \t\tRETURN_FALSE;\n \t}\n-\t\/* We should keep an reference to return_value to prevent it from being dtor\n-\t   in case nesting calls to unserialize *\/\n-\tvar_push_dtor(&var_hash, return_value);\n+\n+\tZVAL_COPY(return_value, retval);\n \n \tPHP_VAR_UNSERIALIZE_DESTROY(var_hash);\n \tif (class_hash) {\n","owner":"php","repo":"php-src","source":"cve"},{"CVE_ID":"CVE-2016-10211","CWE_ID":"416","category":"security","commit_id":"890c3f850293176c0e996a602ffa88b315f4e98f","commit_message":"From 890c3f850293176c0e996a602ffa88b315f4e98f Mon Sep 17 00:00:00 2001\nFrom: plusvic <plusvic@gmail.com>\nDate: Wed, 4 Jan 2017 17:09:35 +0100\nSubject: [PATCH] Fix issue #575\n\n---\n libyara\/grammar.c | 645 +++++++++++++++++++++++-----------------------\n libyara\/grammar.y |   5 +\n 2 files changed, 332 insertions(+), 318 deletions(-)\n\n","diff_code":"diff --git a\/libyara\/grammar.c b\/libyara\/grammar.c\nindex 9ab6dfe7..6e5c46e5 100644\n--- a\/libyara\/grammar.c\n+++ b\/libyara\/grammar.c\n@@ -546,16 +546,16 @@ union yyalloc\n \/* YYFINAL -- State number of the termination state.  *\/\n #define YYFINAL  2\n \/* YYLAST -- Last index in YYTABLE.  *\/\n-#define YYLAST   408\n+#define YYLAST   406\n \n \/* YYNTOKENS -- Number of terminals.  *\/\n #define YYNTOKENS  72\n \/* YYNNTS -- Number of nonterminals.  *\/\n #define YYNNTS  41\n \/* YYNRULES -- Number of rules.  *\/\n-#define YYNRULES  121\n+#define YYNRULES  122\n \/* YYNSTATES -- Number of states.  *\/\n-#define YYNSTATES  209\n+#define YYNSTATES  210\n \n \/* YYTRANSLATE[YYX] -- Symbol number corresponding to YYX as returned\n    by yylex, with out-of-bounds checking.  *\/\n@@ -612,13 +612,13 @@ static const yytype_uint16 yyrline[] =\n      472,   485,   502,   503,   509,   508,   524,   523,   539,   553,\n      554,   559,   560,   561,   562,   567,   652,   698,   756,   801,\n      802,   806,   831,   867,   913,   935,   944,   953,   968,   980,\n-     994,  1007,  1019,  1049,  1018,  1163,  1162,  1241,  1247,  1254,\n-    1253,  1316,  1315,  1376,  1385,  1394,  1403,  1412,  1421,  1430,\n-    1434,  1442,  1443,  1448,  1470,  1482,  1498,  1497,  1503,  1514,\n-    1515,  1520,  1527,  1538,  1539,  1543,  1551,  1555,  1565,  1579,\n-    1595,  1605,  1614,  1639,  1651,  1663,  1679,  1691,  1707,  1752,\n-    1771,  1789,  1807,  1825,  1851,  1869,  1879,  1889,  1899,  1909,\n-    1919,  1929\n+     994,  1007,  1018,  1024,  1054,  1023,  1168,  1167,  1246,  1252,\n+    1259,  1258,  1321,  1320,  1381,  1390,  1399,  1408,  1417,  1426,\n+    1435,  1439,  1447,  1448,  1453,  1475,  1487,  1503,  1502,  1508,\n+    1519,  1520,  1525,  1532,  1543,  1544,  1548,  1556,  1560,  1570,\n+    1584,  1600,  1610,  1619,  1644,  1656,  1668,  1684,  1696,  1712,\n+    1757,  1776,  1794,  1812,  1830,  1856,  1874,  1884,  1894,  1904,\n+    1914,  1924,  1934\n };\n #endif\n \n@@ -672,7 +672,7 @@ static const yytype_uint16 yytoknum[] =\n #define yypact_value_is_default(Yystate) \\\n   (!!((Yystate) == (-73)))\n \n-#define YYTABLE_NINF -94\n+#define YYTABLE_NINF -95\n \n #define yytable_value_is_error(Yytable_value) \\\n   0\n@@ -681,27 +681,27 @@ static const yytype_uint16 yytoknum[] =\n      STATE-NUM.  *\/\n static const yytype_int16 yypact[] =\n {\n-     -73,    79,   -73,   -32,    -4,   -73,   -73,    94,   -73,   -73,\n-     -73,   -73,    13,   -73,   -73,   -73,   -73,    -8,    72,     6,\n-     -73,    78,   111,   -73,    61,   122,   123,    82,   -73,    90,\n-     123,   -73,   147,   150,    16,   -73,    96,   147,   -73,   101,\n-      97,   -73,   -73,   -73,   -73,   151,    53,   -73,    48,   -73,\n-     -73,   -73,   149,   145,   -73,    -9,   -73,   103,   107,   -73,\n-     -73,   106,   -73,   -73,   -73,   -73,   -73,   -73,   110,   -73,\n-     -73,   135,    48,   135,    48,   -33,   -73,    64,   -73,   144,\n-     306,   -73,   -73,   135,   108,   135,   135,   135,   135,    -7,\n-     322,   -73,   -73,   -73,    64,   117,   163,   168,   135,    48,\n-     -73,   -73,    -6,   167,   135,   135,   135,   135,   135,   135,\n-     135,   135,   135,   135,   135,   135,   135,   135,   135,   135,\n-     135,    86,    86,   322,   135,   -73,   243,   261,   183,   203,\n-     159,    -6,   -73,   -73,   -73,   279,   121,   125,    95,    48,\n-      48,   -73,   -73,   -73,   -73,   322,   337,   351,   -43,   322,\n-     322,   322,   322,   322,   322,    40,    40,    58,    58,   -73,\n-     -73,   -73,   -73,   -73,   -73,   -73,   -73,   129,   -73,   -73,\n-     -73,   -73,   128,   -73,   -73,    48,   152,   -73,    15,   135,\n-     131,   -73,    95,   -73,   -73,    71,   -73,   223,   135,   133,\n-     -73,   132,   -73,    15,   -73,    73,   129,   -73,    48,   -73,\n-     -73,   135,   134,    31,   322,    48,   -73,    49,   -73\n+     -73,    90,   -73,   -32,   -10,   -73,   -73,    93,   -73,   -73,\n+     -73,   -73,     1,   -73,   -73,   -73,   -73,   -49,     7,   -36,\n+     -73,    20,    26,   -73,   -28,    92,    46,     4,   -73,    40,\n+      46,   -73,   100,   119,    16,   -73,    72,   100,   -73,    77,\n+      83,   -73,   -73,   -73,   -73,   134,    59,   -73,    48,   -73,\n+     -73,   -73,   133,   136,   -73,   -18,   -73,    88,    95,   -73,\n+     -73,    91,   -73,   -73,   -73,   -73,   -73,   -73,   102,   -73,\n+     -73,   126,    48,   126,    48,   -44,   -73,    85,   -73,   127,\n+     297,   -73,   -73,   126,   110,   126,   126,   126,   126,     2,\n+     313,   -73,   -73,   -73,    85,   111,   154,   172,   126,    48,\n+     -73,   -73,    -6,   162,   126,   126,   126,   126,   126,   126,\n+     126,   126,   126,   126,   126,   126,   126,   126,   126,   126,\n+     126,    60,    60,   313,   126,   -73,   234,   252,   174,   194,\n+     -73,   153,    -6,   -73,   -73,   -73,   270,   117,   120,   108,\n+      48,    48,   -73,   -73,   -73,   -73,   313,   328,   342,   349,\n+     313,   313,   313,   313,   313,   313,   113,   113,    53,    53,\n+     -73,   -73,   -73,   -73,   -73,   -73,   -73,   -73,   121,   -73,\n+     -73,   -73,   -73,   124,   -73,   -73,    48,   151,   -73,    -1,\n+     126,   125,   -73,   108,   -73,   -73,    18,   -73,   214,   126,\n+     129,   -73,   143,   -73,    -1,   -73,    63,   121,   -73,    48,\n+     -73,   -73,   126,   144,    31,   313,    48,   -73,    33,   -73\n };\n \n   \/* YYDEFACT[STATE-NUM] -- Default reduction number in state STATE-NUM.\n@@ -714,31 +714,31 @@ static const yytype_uint8 yydefact[] =\n       23,    22,    12,    24,     0,    14,     0,     0,    10,     0,\n       13,    25,     0,     0,     0,    26,     0,    15,    32,     0,\n        0,    28,    27,    30,    31,     0,    34,    33,     0,    11,\n-      29,    38,     0,     0,    45,    59,   103,   105,   107,   100,\n-     101,     0,   102,    53,    97,    98,    94,    95,     0,    55,\n-      56,     0,     0,     0,     0,   108,   121,    16,    54,     0,\n-      79,    39,    39,     0,     0,     0,     0,     0,     0,     0,\n-      93,   109,    68,   118,     0,    54,    79,     0,     0,    49,\n-      71,    69,     0,     0,     0,     0,     0,     0,     0,     0,\n+      29,    38,     0,     0,    45,    59,   104,   106,   108,   101,\n+     102,     0,   103,    53,    98,    99,    95,    96,     0,    55,\n+      56,     0,     0,     0,     0,   109,   122,    16,    54,     0,\n+      80,    39,    39,     0,     0,     0,     0,     0,     0,     0,\n+      94,   110,    69,   119,     0,    54,    80,     0,     0,    49,\n+      72,    70,     0,     0,     0,     0,     0,     0,     0,     0,\n        0,     0,     0,     0,     0,     0,     0,     0,     0,     0,\n        0,    35,    37,    60,     0,    61,     0,     0,     0,     0,\n-       0,     0,    80,    96,    46,     0,     0,    50,    51,     0,\n-       0,    88,    86,    67,    57,    58,   117,   115,   116,    77,\n-      78,    73,    75,    74,    76,   119,   120,   110,   111,   112,\n-     113,   114,    42,    41,    43,    44,    40,     0,   104,   106,\n-      99,    62,     0,    47,    48,     0,    72,    70,     0,     0,\n-       0,    65,    52,    91,    92,     0,    89,     0,     0,     0,\n-      82,     0,    87,     0,    83,     0,    84,    63,     0,    90,\n-      81,     0,     0,     0,    85,     0,    66,     0,    64\n+      62,     0,     0,    81,    97,    46,     0,     0,    50,    51,\n+       0,     0,    89,    87,    68,    57,    58,   118,   116,   117,\n+      78,    79,    74,    76,    75,    77,   120,   121,   111,   112,\n+     113,   114,   115,    42,    41,    43,    44,    40,     0,   105,\n+     107,   100,    63,     0,    47,    48,     0,    73,    71,     0,\n+       0,     0,    66,    52,    92,    93,     0,    90,     0,     0,\n+       0,    83,     0,    88,     0,    84,     0,    85,    64,     0,\n+      91,    82,     0,     0,     0,    86,     0,    67,     0,    65\n };\n \n   \/* YYPGOTO[NTERM-NUM].  *\/\n static const yytype_int16 yypgoto[] =\n {\n-     -73,   -73,   199,   218,   -73,   -73,   -73,   -73,   -73,   -73,\n-     -73,   -73,   -73,   -73,   192,   -73,   186,   -73,   -73,   142,\n-     -73,   -73,   -73,   -73,   126,   -48,   -72,   -73,   -73,   -73,\n-     -73,   -73,   -73,    50,   -73,   100,   -73,   -73,    35,   164,\n+     -73,   -73,   211,   212,   -73,   -73,   -73,   -73,   -73,   -73,\n+     -73,   -73,   -73,   -73,   189,   -73,   183,   -73,   -73,   139,\n+     -73,   -73,   -73,   -73,   130,   -48,   -72,   -73,   -73,   -73,\n+     -73,   -73,   -73,    41,   -73,   103,   -73,   -73,    29,   164,\n      -67\n };\n \n@@ -747,8 +747,8 @@ static const yytype_int16 yydefgoto[] =\n {\n       -1,     1,     5,     6,    17,    33,    25,    28,    40,     7,\n       15,    19,    21,    30,    31,    37,    38,    52,    53,   121,\n-     166,    75,   136,   137,    76,    94,    78,   180,   202,   191,\n-     140,   139,   189,   125,   195,   143,   178,   185,   186,    79,\n+     167,    75,   137,   138,    76,    94,    78,   181,   203,   192,\n+     141,   140,   190,   125,   196,   144,   179,   186,   187,    79,\n       80\n };\n \n@@ -757,92 +757,92 @@ static const yytype_int16 yydefgoto[] =\n      number is the opposite.  If YYTABLE_NINF, syntax error.  *\/\n static const yytype_int16 yytable[] =\n {\n-      77,    90,    95,   130,    91,     4,    93,    96,   114,   115,\n-     116,   117,   118,   119,   120,    11,   123,    83,   126,   127,\n-     128,   129,    84,    16,    92,   131,   183,   138,   141,     8,\n-     184,   135,    41,    97,    98,    42,    99,   145,   146,   147,\n-     148,   149,   150,   151,   152,   153,   154,   155,   156,   157,\n-     158,   159,   160,   161,    43,    44,    18,   167,    54,    55,\n-      56,    57,    58,   142,    59,    60,    61,    62,    22,    63,\n-      45,   100,   101,    51,   -36,    64,    65,    66,    67,     2,\n-       3,    68,    20,   -17,   -17,   -17,    69,    70,    23,   100,\n-     101,   176,   177,   116,   117,   118,   119,   120,    12,    13,\n-      14,   206,    71,   182,   100,   101,    72,    73,   162,   163,\n-     164,   165,   187,   118,   119,   120,     4,    74,    24,   208,\n-      54,   196,    56,    57,    58,    26,    59,    60,    61,    62,\n-      27,    63,   179,    29,   204,   -54,   -54,    64,    65,    66,\n-      67,   192,   193,   200,   201,    54,    32,    56,    57,    58,\n-     203,    59,    60,    61,    62,    34,    63,   207,    36,    39,\n-      49,    46,    64,    65,    71,    48,    82,    50,    81,    73,\n-      85,   105,   106,   107,    86,    87,   102,   124,   134,    88,\n-     114,   115,   116,   117,   118,   119,   120,   132,    63,    71,\n-     171,   174,   181,   101,    73,   -93,   175,   197,   103,   104,\n-     188,   198,     9,   205,    88,   105,   106,   107,   108,   109,\n-     110,   111,   112,   113,   114,   115,   116,   117,   118,   119,\n-     120,    10,    35,    47,   122,   105,   106,   107,   199,   144,\n-     190,   172,    89,   133,   114,   115,   116,   117,   118,   119,\n-     120,     0,     0,     0,     0,   105,   106,   107,     0,     0,\n-       0,     0,     0,   170,   114,   115,   116,   117,   118,   119,\n-     120,     0,     0,     0,     0,   105,   106,   107,     0,     0,\n-       0,     0,     0,   133,   114,   115,   116,   117,   118,   119,\n-     120,     0,     0,     0,     0,   105,   106,   107,     0,     0,\n-       0,     0,     0,   194,   114,   115,   116,   117,   118,   119,\n-     120,     0,     0,   105,   106,   107,     0,     0,     0,     0,\n-       0,   168,   114,   115,   116,   117,   118,   119,   120,     0,\n-       0,   105,   106,   107,     0,     0,     0,     0,     0,   169,\n-     114,   115,   116,   117,   118,   119,   120,     0,   -93,     0,\n-       0,   103,   104,     0,     0,     0,     0,   173,   105,   106,\n-     107,   108,   109,   110,   111,   112,   113,   114,   115,   116,\n-     117,   118,   119,   120,   105,   106,   107,     0,     0,     0,\n+      77,    90,    95,   130,    91,     4,    93,    96,    83,    11,\n+     184,    16,   131,    84,   185,    18,   123,    20,   126,   127,\n+     128,   129,    97,    98,    92,    99,    22,   139,   142,     8,\n+      23,   136,    41,    24,   132,    42,    26,   146,   147,   148,\n+     149,   150,   151,   152,   153,   154,   155,   156,   157,   158,\n+     159,   160,   161,   162,    43,    44,    29,   168,    54,    55,\n+      56,    57,    58,   143,    59,    60,    61,    62,    32,    63,\n+      45,   100,   101,   100,   101,    64,    65,    66,    67,    51,\n+     -36,    68,   163,   164,   165,   166,    69,    70,   193,   194,\n+       2,     3,   177,   178,   -17,   -17,   -17,    12,    13,    14,\n+      27,   207,    71,   209,   183,    34,    72,    73,   118,   119,\n+     120,    36,    54,   188,    56,    57,    58,    74,    59,    60,\n+      61,    62,   197,    63,   180,   100,   101,     4,    39,    64,\n+      65,    66,    67,   201,   202,   205,    54,    46,    56,    57,\n+      58,    48,    59,    60,    61,    62,    49,    63,   -54,   -54,\n+      50,   204,    81,    64,    65,    85,    71,    82,   208,   102,\n+      87,    73,    86,   105,   106,   107,   116,   117,   118,   119,\n+     120,    88,   114,   115,   116,   117,   118,   119,   120,   124,\n+      71,   133,   135,    63,   172,    73,   -94,   175,   182,   103,\n+     104,   176,   101,   198,   189,    88,   105,   106,   107,   108,\n+     109,   110,   111,   112,   113,   114,   115,   116,   117,   118,\n+     119,   120,   199,   206,     9,    10,   105,   106,   107,    35,\n+      47,   122,   191,   200,   134,   114,   115,   116,   117,   118,\n+     119,   120,    89,   145,     0,   173,   105,   106,   107,     0,\n+       0,     0,     0,     0,   171,   114,   115,   116,   117,   118,\n+     119,   120,     0,     0,     0,     0,   105,   106,   107,     0,\n+       0,     0,     0,     0,   134,   114,   115,   116,   117,   118,\n+     119,   120,     0,     0,     0,     0,   105,   106,   107,     0,\n+       0,     0,     0,     0,   195,   114,   115,   116,   117,   118,\n+     119,   120,     0,     0,   105,   106,   107,     0,     0,     0,\n+       0,     0,   169,   114,   115,   116,   117,   118,   119,   120,\n+       0,     0,   105,   106,   107,     0,     0,     0,     0,     0,\n+     170,   114,   115,   116,   117,   118,   119,   120,     0,   -94,\n+       0,     0,   103,   104,     0,     0,     0,     0,   174,   105,\n+     106,   107,   108,   109,   110,   111,   112,   113,   114,   115,\n+     116,   117,   118,   119,   120,   105,   106,   107,     0,     0,\n+       0,     0,     0,     0,   114,   115,   116,   117,   118,   119,\n+     120,   106,   107,     0,     0,     0,     0,     0,     0,   114,\n+     115,   116,   117,   118,   119,   120,   107,     0,     0,     0,\n        0,     0,     0,   114,   115,   116,   117,   118,   119,   120,\n-     106,   107,     0,     0,     0,     0,     0,     0,   114,   115,\n-     116,   117,   118,   119,   120,   107,     0,     0,     0,     0,\n-       0,     0,   114,   115,   116,   117,   118,   119,   120\n+     114,   115,   116,   117,   118,   119,   120\n };\n \n static const yytype_int16 yycheck[] =\n {\n-      48,    68,    74,    10,    71,    37,    73,    74,    51,    52,\n-      53,    54,    55,    56,    57,    19,    83,    26,    85,    86,\n-      87,    88,    31,    10,    72,    32,    11,    99,    34,    61,\n-      15,    98,    16,    66,    67,    19,    69,   104,   105,   106,\n+      48,    68,    74,     1,    71,    37,    73,    74,    26,    19,\n+      11,    10,    10,    31,    15,    64,    83,    10,    85,    86,\n+      87,    88,    66,    67,    72,    69,    62,    99,    34,    61,\n+      10,    98,    16,     7,    32,    19,    64,   104,   105,   106,\n      107,   108,   109,   110,   111,   112,   113,   114,   115,   116,\n-     117,   118,   119,   120,    38,    39,    64,   124,    10,    11,\n-      12,    13,    14,    69,    16,    17,    18,    19,    62,    21,\n-      54,    40,    41,    20,    21,    27,    28,    29,    30,     0,\n-       1,    33,    10,     4,     5,     6,    38,    39,    10,    40,\n-      41,   139,   140,    53,    54,    55,    56,    57,     4,     5,\n-       6,    70,    54,   175,    40,    41,    58,    59,    22,    23,\n-      24,    25,   179,    55,    56,    57,    37,    69,     7,    70,\n-      10,   188,    12,    13,    14,    64,    16,    17,    18,    19,\n-       8,    21,     3,    10,   201,    40,    41,    27,    28,    29,\n-      30,    70,    71,    70,    71,    10,    64,    12,    13,    14,\n-     198,    16,    17,    18,    19,    65,    21,   205,    11,     9,\n-      63,    65,    27,    28,    54,    64,    21,    16,    19,    59,\n-      67,    42,    43,    44,    67,    69,    32,    69,    10,    69,\n-      51,    52,    53,    54,    55,    56,    57,    70,    21,    54,\n-      31,    70,    64,    41,    59,    32,    71,    64,    35,    36,\n-      69,    69,     3,    69,    69,    42,    43,    44,    45,    46,\n-      47,    48,    49,    50,    51,    52,    53,    54,    55,    56,\n-      57,     3,    30,    37,    82,    42,    43,    44,   193,   103,\n-     180,   131,    68,    70,    51,    52,    53,    54,    55,    56,\n-      57,    -1,    -1,    -1,    -1,    42,    43,    44,    -1,    -1,\n-      -1,    -1,    -1,    70,    51,    52,    53,    54,    55,    56,\n-      57,    -1,    -1,    -1,    -1,    42,    43,    44,    -1,    -1,\n-      -1,    -1,    -1,    70,    51,    52,    53,    54,    55,    56,\n-      57,    -1,    -1,    -1,    -1,    42,    43,    44,    -1,    -1,\n-      -1,    -1,    -1,    70,    51,    52,    53,    54,    55,    56,\n-      57,    -1,    -1,    42,    43,    44,    -1,    -1,    -1,    -1,\n-      -1,    68,    51,    52,    53,    54,    55,    56,    57,    -1,\n-      -1,    42,    43,    44,    -1,    -1,    -1,    -1,    -1,    68,\n-      51,    52,    53,    54,    55,    56,    57,    -1,    32,    -1,\n-      -1,    35,    36,    -1,    -1,    -1,    -1,    68,    42,    43,\n-      44,    45,    46,    47,    48,    49,    50,    51,    52,    53,\n-      54,    55,    56,    57,    42,    43,    44,    -1,    -1,    -1,\n+     117,   118,   119,   120,    38,    39,    10,   124,    10,    11,\n+      12,    13,    14,    69,    16,    17,    18,    19,    64,    21,\n+      54,    40,    41,    40,    41,    27,    28,    29,    30,    20,\n+      21,    33,    22,    23,    24,    25,    38,    39,    70,    71,\n+       0,     1,   140,   141,     4,     5,     6,     4,     5,     6,\n+       8,    70,    54,    70,   176,    65,    58,    59,    55,    56,\n+      57,    11,    10,   180,    12,    13,    14,    69,    16,    17,\n+      18,    19,   189,    21,     3,    40,    41,    37,     9,    27,\n+      28,    29,    30,    70,    71,   202,    10,    65,    12,    13,\n+      14,    64,    16,    17,    18,    19,    63,    21,    40,    41,\n+      16,   199,    19,    27,    28,    67,    54,    21,   206,    32,\n+      69,    59,    67,    42,    43,    44,    53,    54,    55,    56,\n+      57,    69,    51,    52,    53,    54,    55,    56,    57,    69,\n+      54,    70,    10,    21,    31,    59,    32,    70,    64,    35,\n+      36,    71,    41,    64,    69,    69,    42,    43,    44,    45,\n+      46,    47,    48,    49,    50,    51,    52,    53,    54,    55,\n+      56,    57,    69,    69,     3,     3,    42,    43,    44,    30,\n+      37,    82,   181,   194,    70,    51,    52,    53,    54,    55,\n+      56,    57,    68,   103,    -1,   132,    42,    43,    44,    -1,\n+      -1,    -1,    -1,    -1,    70,    51,    52,    53,    54,    55,\n+      56,    57,    -1,    -1,    -1,    -1,    42,    43,    44,    -1,\n+      -1,    -1,    -1,    -1,    70,    51,    52,    53,    54,    55,\n+      56,    57,    -1,    -1,    -1,    -1,    42,    43,    44,    -1,\n+      -1,    -1,    -1,    -1,    70,    51,    52,    53,    54,    55,\n+      56,    57,    -1,    -1,    42,    43,    44,    -1,    -1,    -1,\n+      -1,    -1,    68,    51,    52,    53,    54,    55,    56,    57,\n+      -1,    -1,    42,    43,    44,    -1,    -1,    -1,    -1,    -1,\n+      68,    51,    52,    53,    54,    55,    56,    57,    -1,    32,\n+      -1,    -1,    35,    36,    -1,    -1,    -1,    -1,    68,    42,\n+      43,    44,    45,    46,    47,    48,    49,    50,    51,    52,\n+      53,    54,    55,    56,    57,    42,    43,    44,    -1,    -1,\n+      -1,    -1,    -1,    -1,    51,    52,    53,    54,    55,    56,\n+      57,    43,    44,    -1,    -1,    -1,    -1,    -1,    -1,    51,\n+      52,    53,    54,    55,    56,    57,    44,    -1,    -1,    -1,\n       -1,    -1,    -1,    51,    52,    53,    54,    55,    56,    57,\n-      43,    44,    -1,    -1,    -1,    -1,    -1,    -1,    51,    52,\n-      53,    54,    55,    56,    57,    44,    -1,    -1,    -1,    -1,\n-      -1,    -1,    51,    52,    53,    54,    55,    56,    57\n+      51,    52,    53,    54,    55,    56,    57\n };\n \n   \/* YYSTOS[STATE-NUM] -- The (internal number of the) accessing\n@@ -862,14 +862,14 @@ static const yytype_uint8 yystos[] =\n       40,    41,    32,    35,    36,    42,    43,    44,    45,    46,\n       47,    48,    49,    50,    51,    52,    53,    54,    55,    56,\n       57,    91,    91,   112,    69,   105,   112,   112,   112,   112,\n-      10,    32,    70,    70,    10,   112,    94,    95,    98,   103,\n-     102,    34,    69,   107,    96,   112,   112,   112,   112,   112,\n+       1,    10,    32,    70,    70,    10,   112,    94,    95,    98,\n+     103,   102,    34,    69,   107,    96,   112,   112,   112,   112,\n      112,   112,   112,   112,   112,   112,   112,   112,   112,   112,\n-     112,   112,    22,    23,    24,    25,    92,   112,    68,    68,\n-      70,    31,   107,    68,    70,    71,    97,    97,   108,     3,\n-      99,    64,    98,    11,    15,   109,   110,   112,    69,   104,\n-     105,   101,    70,    71,    70,   106,   112,    64,    69,   110,\n-      70,    71,   100,    97,   112,    69,    70,    97,    70\n+     112,   112,   112,    22,    23,    24,    25,    92,   112,    68,\n+      68,    70,    31,   107,    68,    70,    71,    97,    97,   108,\n+       3,    99,    64,    98,    11,    15,   109,   110,   112,    69,\n+     104,   105,   101,    70,    71,    70,   106,   112,    64,    69,\n+     110,    70,    71,   100,    97,   112,    69,    70,    97,    70\n };\n \n   \/* YYR1[YYN] -- Symbol number of symbol that rule YYN derives.  *\/\n@@ -881,13 +881,13 @@ static const yytype_uint8 yyr1[] =\n       86,    86,    87,    87,    89,    88,    90,    88,    88,    91,\n       91,    92,    92,    92,    92,    93,    93,    93,    93,    94,\n       94,    95,    95,    96,    97,    98,    98,    98,    98,    98,\n-      98,    98,    99,   100,    98,   101,    98,    98,    98,   102,\n-      98,   103,    98,    98,    98,    98,    98,    98,    98,    98,\n-      98,   104,   104,   105,   106,   106,   108,   107,   107,   109,\n-     109,   110,   110,   111,   111,   111,   112,   112,   112,   112,\n+      98,    98,    98,    99,   100,    98,   101,    98,    98,    98,\n+     102,    98,   103,    98,    98,    98,    98,    98,    98,    98,\n+      98,    98,   104,   104,   105,   106,   106,   108,   107,   107,\n+     109,   109,   110,   110,   111,   111,   111,   112,   112,   112,\n      112,   112,   112,   112,   112,   112,   112,   112,   112,   112,\n      112,   112,   112,   112,   112,   112,   112,   112,   112,   112,\n-     112,   112\n+     112,   112,   112\n };\n \n   \/* YYR2[YYN] -- Number of symbols on the right hand side of rule YYN.  *\/\n@@ -899,13 +899,13 @@ static const yytype_uint8 yyr2[] =\n        3,     3,     1,     2,     0,     5,     0,     5,     3,     0,\n        2,     1,     1,     1,     1,     1,     3,     4,     4,     0,\n        1,     1,     3,     1,     1,     1,     1,     3,     3,     1,\n-       3,     3,     0,     0,    11,     0,     9,     3,     2,     0,\n-       4,     0,     4,     3,     3,     3,     3,     3,     3,     1,\n-       3,     3,     1,     5,     1,     3,     0,     4,     1,     1,\n-       3,     1,     1,     1,     1,     1,     3,     1,     1,     4,\n-       1,     1,     1,     1,     4,     1,     4,     1,     1,     2,\n-       3,     3,     3,     3,     3,     3,     3,     3,     2,     3,\n-       3,     1\n+       3,     3,     3,     0,     0,    11,     0,     9,     3,     2,\n+       0,     4,     0,     4,     3,     3,     3,     3,     3,     3,\n+       1,     3,     3,     1,     5,     1,     3,     0,     4,     1,\n+       1,     3,     1,     1,     1,     1,     1,     3,     1,     1,\n+       4,     1,     1,     1,     1,     4,     1,     4,     1,     1,\n+       2,     3,     3,     3,     3,     3,     3,     3,     3,     2,\n+       3,     3,     1\n };\n \n \n@@ -2586,6 +2586,15 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n   case 62:\n #line 1019 \"grammar.y\" \/* yacc.c:1646  *\/\n+    {\n+        compiler->loop_depth--;\n+        compiler->loop_identifier[compiler->loop_depth] = NULL;\n+      }\n+#line 2594 \"grammar.c\" \/* yacc.c:1646  *\/\n+    break;\n+\n+  case 63:\n+#line 1024 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         int var_index;\n \n@@ -2615,11 +2624,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         ERROR_IF(compiler->last_result != ERROR_SUCCESS);\n       }\n-#line 2619 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2628 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 63:\n-#line 1049 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 64:\n+#line 1054 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         int mem_offset = LOOP_LOCAL_VARS * compiler->loop_depth;\n         uint8_t* addr;\n@@ -2654,11 +2663,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         compiler->loop_identifier[compiler->loop_depth] = (yyvsp[-4].c_string);\n         compiler->loop_depth++;\n       }\n-#line 2658 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2667 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 64:\n-#line 1084 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 65:\n+#line 1089 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         int mem_offset;\n \n@@ -2737,11 +2746,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 2741 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2750 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 65:\n-#line 1163 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 66:\n+#line 1168 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         int mem_offset = LOOP_LOCAL_VARS * compiler->loop_depth;\n         uint8_t* addr;\n@@ -2771,11 +2780,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         compiler->loop_identifier[compiler->loop_depth] = NULL;\n         compiler->loop_depth++;\n       }\n-#line 2775 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2784 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 66:\n-#line 1193 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 67:\n+#line 1198 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         int mem_offset;\n \n@@ -2824,31 +2833,31 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n \n       }\n-#line 2828 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2837 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 67:\n-#line 1242 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 68:\n+#line 1247 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         yr_parser_emit(yyscanner, OP_OF, NULL);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 2838 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2847 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 68:\n-#line 1248 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 69:\n+#line 1253 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         yr_parser_emit(yyscanner, OP_NOT, NULL);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 2848 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2857 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 69:\n-#line 1254 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 70:\n+#line 1259 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         YR_FIXUP* fixup;\n         void* jmp_destination_addr;\n@@ -2874,11 +2883,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         fixup->next = compiler->fixup_stack_head;\n         compiler->fixup_stack_head = fixup;\n       }\n-#line 2878 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2887 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 70:\n-#line 1280 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 71:\n+#line 1285 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         YR_FIXUP* fixup;\n         uint8_t* and_addr;\n@@ -2914,11 +2923,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 2918 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2927 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 71:\n-#line 1316 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 72:\n+#line 1321 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         YR_FIXUP* fixup;\n         void* jmp_destination_addr;\n@@ -2943,11 +2952,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         fixup->next = compiler->fixup_stack_head;\n         compiler->fixup_stack_head = fixup;\n       }\n-#line 2947 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2956 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 72:\n-#line 1341 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 73:\n+#line 1346 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         YR_FIXUP* fixup;\n         uint8_t* or_addr;\n@@ -2983,11 +2992,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 2987 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 2996 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 73:\n-#line 1377 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 74:\n+#line 1382 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_operation(\n             yyscanner, \"<\", (yyvsp[-2].expression), (yyvsp[0].expression));\n@@ -2996,11 +3005,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 3000 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3009 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 74:\n-#line 1386 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 75:\n+#line 1391 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_operation(\n             yyscanner, \">\", (yyvsp[-2].expression), (yyvsp[0].expression));\n@@ -3009,11 +3018,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 3013 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3022 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 75:\n-#line 1395 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 76:\n+#line 1400 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_operation(\n             yyscanner, \"<=\", (yyvsp[-2].expression), (yyvsp[0].expression));\n@@ -3022,11 +3031,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 3026 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3035 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 76:\n-#line 1404 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 77:\n+#line 1409 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_operation(\n             yyscanner, \">=\", (yyvsp[-2].expression), (yyvsp[0].expression));\n@@ -3035,11 +3044,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 3039 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3048 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 77:\n-#line 1413 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 78:\n+#line 1418 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_operation(\n             yyscanner, \"==\", (yyvsp[-2].expression), (yyvsp[0].expression));\n@@ -3048,11 +3057,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 3052 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3061 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 78:\n-#line 1422 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 79:\n+#line 1427 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_operation(\n             yyscanner, \"!=\", (yyvsp[-2].expression), (yyvsp[0].expression));\n@@ -3061,39 +3070,39 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         (yyval.expression).type = EXPRESSION_TYPE_BOOLEAN;\n       }\n-#line 3065 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3074 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 79:\n-#line 1431 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 80:\n+#line 1436 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         (yyval.expression) = (yyvsp[0].expression);\n       }\n-#line 3073 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3082 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 80:\n-#line 1435 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 81:\n+#line 1440 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         (yyval.expression) = (yyvsp[-1].expression);\n       }\n-#line 3081 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3090 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 81:\n-#line 1442 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 82:\n+#line 1447 \"grammar.y\" \/* yacc.c:1646  *\/\n     { (yyval.integer) = INTEGER_SET_ENUMERATION; }\n-#line 3087 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3096 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 82:\n-#line 1443 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 83:\n+#line 1448 \"grammar.y\" \/* yacc.c:1646  *\/\n     { (yyval.integer) = INTEGER_SET_RANGE; }\n-#line 3093 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3102 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 83:\n-#line 1449 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 84:\n+#line 1454 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         if ((yyvsp[-3].expression).type != EXPRESSION_TYPE_INTEGER)\n         {\n@@ -3111,11 +3120,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         ERROR_IF(compiler->last_result != ERROR_SUCCESS);\n       }\n-#line 3115 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3124 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 84:\n-#line 1471 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 85:\n+#line 1476 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         if ((yyvsp[0].expression).type != EXPRESSION_TYPE_INTEGER)\n         {\n@@ -3127,11 +3136,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         ERROR_IF(compiler->last_result != ERROR_SUCCESS);\n       }\n-#line 3131 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3140 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 85:\n-#line 1483 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 86:\n+#line 1488 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         if ((yyvsp[0].expression).type != EXPRESSION_TYPE_INTEGER)\n         {\n@@ -3142,77 +3151,77 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         ERROR_IF(compiler->last_result != ERROR_SUCCESS);\n       }\n-#line 3146 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3155 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 86:\n-#line 1498 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 87:\n+#line 1503 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         \/\/ Push end-of-list marker\n         yr_parser_emit_with_arg(yyscanner, OP_PUSH, UNDEFINED, NULL, NULL);\n       }\n-#line 3155 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3164 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 88:\n-#line 1504 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 89:\n+#line 1509 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         yr_parser_emit_with_arg(yyscanner, OP_PUSH, UNDEFINED, NULL, NULL);\n         yr_parser_emit_pushes_for_strings(yyscanner, \"$*\");\n \n         ERROR_IF(compiler->last_result != ERROR_SUCCESS);\n       }\n-#line 3166 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3175 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 91:\n-#line 1521 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 92:\n+#line 1526 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         yr_parser_emit_pushes_for_strings(yyscanner, (yyvsp[0].c_string));\n         yr_free((yyvsp[0].c_string));\n \n         ERROR_IF(compiler->last_result != ERROR_SUCCESS);\n       }\n-#line 3177 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3186 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 92:\n-#line 1528 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 93:\n+#line 1533 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         yr_parser_emit_pushes_for_strings(yyscanner, (yyvsp[0].c_string));\n         yr_free((yyvsp[0].c_string));\n \n         ERROR_IF(compiler->last_result != ERROR_SUCCESS);\n       }\n-#line 3188 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3197 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 94:\n-#line 1540 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 95:\n+#line 1545 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         yr_parser_emit_with_arg(yyscanner, OP_PUSH, UNDEFINED, NULL, NULL);\n       }\n-#line 3196 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3205 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 95:\n-#line 1544 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 96:\n+#line 1549 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         yr_parser_emit_with_arg(yyscanner, OP_PUSH, 1, NULL, NULL);\n       }\n-#line 3204 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3213 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 96:\n-#line 1552 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 97:\n+#line 1557 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         (yyval.expression) = (yyvsp[-1].expression);\n       }\n-#line 3212 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3221 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 97:\n-#line 1556 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 98:\n+#line 1561 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_emit(\n             yyscanner, OP_FILESIZE, NULL);\n@@ -3222,11 +3231,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = UNDEFINED;\n       }\n-#line 3226 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3235 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 98:\n-#line 1566 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 99:\n+#line 1571 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         yywarning(yyscanner,\n             \"Using deprecated \\\"entrypoint\\\" keyword. Use the \\\"entry_point\\\" \"\n@@ -3240,11 +3249,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = UNDEFINED;\n       }\n-#line 3244 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3253 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 99:\n-#line 1580 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 100:\n+#line 1585 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         CHECK_TYPE((yyvsp[-1].expression), EXPRESSION_TYPE_INTEGER, \"intXXXX or uintXXXX\");\n \n@@ -3260,11 +3269,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = UNDEFINED;\n       }\n-#line 3264 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3273 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 100:\n-#line 1596 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 101:\n+#line 1601 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_emit_with_arg(\n             yyscanner, OP_PUSH, (yyvsp[0].integer), NULL, NULL);\n@@ -3274,11 +3283,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = (yyvsp[0].integer);\n       }\n-#line 3278 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3287 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 101:\n-#line 1606 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 102:\n+#line 1611 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_emit_with_arg_double(\n             yyscanner, OP_PUSH, (yyvsp[0].double_), NULL, NULL);\n@@ -3287,11 +3296,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         (yyval.expression).type = EXPRESSION_TYPE_FLOAT;\n       }\n-#line 3291 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3300 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 102:\n-#line 1615 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 103:\n+#line 1620 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         SIZED_STRING* sized_string;\n \n@@ -3316,11 +3325,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_STRING;\n         (yyval.expression).value.sized_string = sized_string;\n       }\n-#line 3320 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3329 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 103:\n-#line 1640 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 104:\n+#line 1645 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_string_identifier(\n             yyscanner, (yyvsp[0].c_string), OP_COUNT, UNDEFINED);\n@@ -3332,11 +3341,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = UNDEFINED;\n       }\n-#line 3336 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3345 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 104:\n-#line 1652 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 105:\n+#line 1657 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_string_identifier(\n             yyscanner, (yyvsp[-3].c_string), OP_OFFSET, UNDEFINED);\n@@ -3348,11 +3357,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = UNDEFINED;\n       }\n-#line 3352 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3361 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 105:\n-#line 1664 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 106:\n+#line 1669 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_emit_with_arg(\n             yyscanner, OP_PUSH, 1, NULL, NULL);\n@@ -3368,11 +3377,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = UNDEFINED;\n       }\n-#line 3372 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3381 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 106:\n-#line 1680 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 107:\n+#line 1685 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_string_identifier(\n             yyscanner, (yyvsp[-3].c_string), OP_LENGTH, UNDEFINED);\n@@ -3384,11 +3393,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = UNDEFINED;\n       }\n-#line 3388 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3397 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 107:\n-#line 1692 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 108:\n+#line 1697 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_emit_with_arg(\n             yyscanner, OP_PUSH, 1, NULL, NULL);\n@@ -3404,11 +3413,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = UNDEFINED;\n       }\n-#line 3408 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3417 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 108:\n-#line 1708 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 109:\n+#line 1713 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         if ((yyvsp[0].expression).type == EXPRESSION_TYPE_INTEGER)  \/\/ loop identifier\n         {\n@@ -3453,11 +3462,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         ERROR_IF(compiler->last_result != ERROR_SUCCESS);\n       }\n-#line 3457 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3466 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 109:\n-#line 1753 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 110:\n+#line 1758 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         CHECK_TYPE((yyvsp[0].expression), EXPRESSION_TYPE_INTEGER | EXPRESSION_TYPE_FLOAT, \"-\");\n \n@@ -3476,11 +3485,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n \n         ERROR_IF(compiler->last_result != ERROR_SUCCESS);\n       }\n-#line 3480 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3489 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 110:\n-#line 1772 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 111:\n+#line 1777 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_operation(\n             yyscanner, \"+\", (yyvsp[-2].expression), (yyvsp[0].expression));\n@@ -3498,11 +3507,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n           (yyval.expression).type = EXPRESSION_TYPE_FLOAT;\n         }\n       }\n-#line 3502 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3511 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 111:\n-#line 1790 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 112:\n+#line 1795 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_operation(\n             yyscanner, \"-\", (yyvsp[-2].expression), (yyvsp[0].expression));\n@@ -3520,11 +3529,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n           (yyval.expression).type = EXPRESSION_TYPE_FLOAT;\n         }\n       }\n-#line 3524 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3533 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 112:\n-#line 1808 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 113:\n+#line 1813 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_operation(\n             yyscanner, \"*\", (yyvsp[-2].expression), (yyvsp[0].expression));\n@@ -3542,11 +3551,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n           (yyval.expression).type = EXPRESSION_TYPE_FLOAT;\n         }\n       }\n-#line 3546 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3555 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 113:\n-#line 1826 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 114:\n+#line 1831 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         compiler->last_result = yr_parser_reduce_operation(\n             yyscanner, \"\\\\\", (yyvsp[-2].expression), (yyvsp[0].expression));\n@@ -3572,11 +3581,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n           (yyval.expression).type = EXPRESSION_TYPE_FLOAT;\n         }\n       }\n-#line 3576 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3585 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 114:\n-#line 1852 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 115:\n+#line 1857 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         CHECK_TYPE((yyvsp[-2].expression), EXPRESSION_TYPE_INTEGER, \"%\");\n         CHECK_TYPE((yyvsp[0].expression), EXPRESSION_TYPE_INTEGER, \"%\");\n@@ -3594,11 +3603,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n           ERROR_IF(compiler->last_result != ERROR_SUCCESS);\n         }\n       }\n-#line 3598 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3607 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 115:\n-#line 1870 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 116:\n+#line 1875 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         CHECK_TYPE((yyvsp[-2].expression), EXPRESSION_TYPE_INTEGER, \"^\");\n         CHECK_TYPE((yyvsp[0].expression), EXPRESSION_TYPE_INTEGER, \"^\");\n@@ -3608,11 +3617,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = OPERATION(^, (yyvsp[-2].expression).value.integer, (yyvsp[0].expression).value.integer);\n       }\n-#line 3612 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3621 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 116:\n-#line 1880 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 117:\n+#line 1885 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         CHECK_TYPE((yyvsp[-2].expression), EXPRESSION_TYPE_INTEGER, \"^\");\n         CHECK_TYPE((yyvsp[0].expression), EXPRESSION_TYPE_INTEGER, \"^\");\n@@ -3622,11 +3631,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = OPERATION(&, (yyvsp[-2].expression).value.integer, (yyvsp[0].expression).value.integer);\n       }\n-#line 3626 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3635 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 117:\n-#line 1890 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 118:\n+#line 1895 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         CHECK_TYPE((yyvsp[-2].expression), EXPRESSION_TYPE_INTEGER, \"|\");\n         CHECK_TYPE((yyvsp[0].expression), EXPRESSION_TYPE_INTEGER, \"|\");\n@@ -3636,11 +3645,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = OPERATION(|, (yyvsp[-2].expression).value.integer, (yyvsp[0].expression).value.integer);\n       }\n-#line 3640 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3649 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 118:\n-#line 1900 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 119:\n+#line 1905 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         CHECK_TYPE((yyvsp[0].expression), EXPRESSION_TYPE_INTEGER, \"~\");\n \n@@ -3650,11 +3659,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).value.integer = ((yyvsp[0].expression).value.integer == UNDEFINED) ?\n             UNDEFINED : ~((yyvsp[0].expression).value.integer);\n       }\n-#line 3654 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3663 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 119:\n-#line 1910 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 120:\n+#line 1915 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         CHECK_TYPE((yyvsp[-2].expression), EXPRESSION_TYPE_INTEGER, \"<<\");\n         CHECK_TYPE((yyvsp[0].expression), EXPRESSION_TYPE_INTEGER, \"<<\");\n@@ -3664,11 +3673,11 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = OPERATION(<<, (yyvsp[-2].expression).value.integer, (yyvsp[0].expression).value.integer);\n       }\n-#line 3668 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3677 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 120:\n-#line 1920 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 121:\n+#line 1925 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         CHECK_TYPE((yyvsp[-2].expression), EXPRESSION_TYPE_INTEGER, \">>\");\n         CHECK_TYPE((yyvsp[0].expression), EXPRESSION_TYPE_INTEGER, \">>\");\n@@ -3678,19 +3687,19 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n         (yyval.expression).type = EXPRESSION_TYPE_INTEGER;\n         (yyval.expression).value.integer = OPERATION(>>, (yyvsp[-2].expression).value.integer, (yyvsp[0].expression).value.integer);\n       }\n-#line 3682 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3691 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n-  case 121:\n-#line 1930 \"grammar.y\" \/* yacc.c:1646  *\/\n+  case 122:\n+#line 1935 \"grammar.y\" \/* yacc.c:1646  *\/\n     {\n         (yyval.expression) = (yyvsp[0].expression);\n       }\n-#line 3690 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3699 \"grammar.c\" \/* yacc.c:1646  *\/\n     break;\n \n \n-#line 3694 \"grammar.c\" \/* yacc.c:1646  *\/\n+#line 3703 \"grammar.c\" \/* yacc.c:1646  *\/\n       default: break;\n     }\n   \/* User semantic actions sometimes alter yychar, and that requires\n@@ -3918,5 +3927,5 @@ YYSTYPE yylval YY_INITIAL_VALUE (= yyval_default);\n #endif\n   return yyresult;\n }\n-#line 1935 \"grammar.y\" \/* yacc.c:1906  *\/\n+#line 1940 \"grammar.y\" \/* yacc.c:1906  *\/\n \ndiff --git a\/libyara\/grammar.y b\/libyara\/grammar.y\nindex 9de84f06..446d3741 100644\n--- a\/libyara\/grammar.y\n+++ b\/libyara\/grammar.y\n@@ -1015,6 +1015,11 @@ expression\n \n         $$.type = EXPRESSION_TYPE_BOOLEAN;\n       }\n+    | _FOR_ for_expression error\n+      {\n+        compiler->loop_depth--;\n+        compiler->loop_identifier[compiler->loop_depth] = NULL;\n+      }\n     | _FOR_ for_expression _IDENTIFIER_ _IN_\n       {\n         int var_index;\n","owner":"VirusTotal","repo":"yara","source":"cve"},{"CVE_ID":"CVE-2014-9940","CWE_ID":"416","category":"security","commit_id":"60a2362f769cf549dc466134efe71c8bf9fbaaba","commit_message":"From 60a2362f769cf549dc466134efe71c8bf9fbaaba Mon Sep 17 00:00:00 2001\nFrom: Seung-Woo Kim <sw0312.kim@samsung.com>\nDate: Thu, 4 Dec 2014 19:17:17 +0900\nSubject: [PATCH] regulator: core: Fix regualtor_ena_gpio_free not to access\n pin after freeing\n\nAfter freeing pin from regulator_ena_gpio_free, loop can access\nthe pin. So this patch fixes not to access pin after freeing.\n\nSigned-off-by: Seung-Woo Kim <sw0312.kim@samsung.com>\nSigned-off-by: Mark Brown <broonie@kernel.org>\n---\n drivers\/regulator\/core.c | 2 ++\n 1 file changed, 2 insertions(+)\n\n","diff_code":"diff --git a\/drivers\/regulator\/core.c b\/drivers\/regulator\/core.c\nindex df2af3a11351a..47a455cfe04fb 100644\n--- a\/drivers\/regulator\/core.c\n+++ b\/drivers\/regulator\/core.c\n@@ -1713,6 +1713,8 @@ static void regulator_ena_gpio_free(struct regulator_dev *rdev)\n \t\t\t\tgpiod_put(pin->gpiod);\n \t\t\t\tlist_del(&pin->list);\n \t\t\t\tkfree(pin);\n+\t\t\t\trdev->ena_pin = NULL;\n+\t\t\t\treturn;\n \t\t\t} else {\n \t\t\t\tpin->request_count--;\n \t\t\t}\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-8929","CWE_ID":"416","category":"security","commit_id":"053e67e3ec81cc9268ce30eaf0d6663d8639ed1e","commit_message":"From 053e67e3ec81cc9268ce30eaf0d6663d8639ed1e Mon Sep 17 00:00:00 2001\nFrom: \"Victor M. Alvarez\" <plusvic@gmail.com>\nDate: Sun, 14 May 2017 10:27:39 +0200\nSubject: [PATCH] Fix issue #658\n\n---\n libyara\/arena.c                 |  2 +-\n libyara\/exec.c                  | 44 +++++++++++++++++++++++++++------\n libyara\/include\/yara\/object.h   |  5 ++++\n libyara\/include\/yara\/sizedstr.h | 10 +++++---\n libyara\/modules\/tests.c         | 18 ++++++++++++++\n libyara\/object.c                | 16 ++++++++++--\n libyara\/sizedstr.c              | 20 +++++++++++++++\n tests\/test-rules.c              | 14 +++++++++++\n 8 files changed, 115 insertions(+), 14 deletions(-)\n\n","diff_code":"diff --git a\/libyara\/arena.c b\/libyara\/arena.c\nindex 48faa425..f53775da 100644\n--- a\/libyara\/arena.c\n+++ b\/libyara\/arena.c\n@@ -316,7 +316,7 @@ void yr_arena_destroy(\n \/\/    YR_ARENA* arena  - Pointer to the arena.\n \/\/\n \/\/ Returns:\n-\/\/    A pointer to the arena's data. NULL if the no data has been written to\n+\/\/    A pointer to the arena's data. NULL if no data has been written to\n \/\/    the arena yet.\n \/\/\n \ndiff --git a\/libyara\/exec.c b\/libyara\/exec.c\nindex d42c1b03..80379911 100644\n--- a\/libyara\/exec.c\n+++ b\/libyara\/exec.c\n@@ -34,6 +34,7 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n #include <time.h>\n #include <math.h>\n \n+#include <yara\/arena.h>\n #include <yara\/endian.h>\n #include <yara\/exec.h>\n #include <yara\/limits.h>\n@@ -177,6 +178,8 @@ int yr_execute_code(\n   YR_RULE* rule;\n   YR_MATCH* match;\n   YR_OBJECT_FUNCTION* function;\n+  YR_OBJECT** obj_ptr;\n+  YR_ARENA* obj_arena;\n \n   char* identifier;\n   char* args_fmt;\n@@ -201,6 +204,10 @@ int yr_execute_code(\n   if (stack == NULL)\n     return ERROR_INSUFFICIENT_MEMORY;\n \n+  FAIL_ON_ERROR_WITH_CLEANUP(\n+      yr_arena_create(1024, 0, &obj_arena),\n+      yr_free(stack));\n+\n   while(!stop)\n   {\n     switch(*ip)\n@@ -437,6 +444,8 @@ int yr_execute_code(\n         rule->clock_ticks += clock() - start;\n         start = clock();\n         #endif\n+\n+        assert(sp == 0);\n         break;\n \n       case OP_OBJ_LOAD:\n@@ -577,18 +586,26 @@ int yr_execute_code(\n           }\n         }\n \n+        \/\/ if i == MAX_OVERLOADED_FUNCTIONS at this point no matching\n+        \/\/ prototype was found, but this shouldn't happen.\n+\n         assert(i < MAX_OVERLOADED_FUNCTIONS);\n \n+        \/\/ make a copy of the returned object and push the copy into the stack\n+        \/\/ function->return_obj can't be pushed because it can change in\n+        \/\/ subsequent calls to the same function.\n+\n         if (result == ERROR_SUCCESS)\n-        {\n-          r1.o = function->return_obj;\n-          push(r1);\n-        }\n-        else\n-        {\n-          stop = TRUE;\n-        }\n+          result = yr_object_copy(function->return_obj, &r1.o);\n+\n+        \/\/ a pointer to the copied object is stored in a arena in order to\n+        \/\/ free the object before exiting yr_execute_code\n \n+        if (result == ERROR_SUCCESS)\n+          result = yr_arena_write_data(obj_arena, &r1.o, sizeof(r1.o), NULL);\n+\n+        stop = (result != ERROR_SUCCESS);\n+        push(r1);\n         break;\n \n       case OP_FOUND:\n@@ -1146,6 +1163,17 @@ int yr_execute_code(\n     ip++;\n   }\n \n+  obj_ptr = (YR_OBJECT**) yr_arena_base_address(obj_arena);\n+\n+  while (obj_ptr != NULL)\n+  {\n+    yr_object_destroy(*obj_ptr);\n+\n+    obj_ptr = (YR_OBJECT**) yr_arena_next_address(\n+        obj_arena, obj_ptr, sizeof(YR_OBJECT*));\n+  }\n+\n+  yr_arena_destroy(obj_arena);\n   yr_modules_unload_all(context);\n   yr_free(stack);\n \ndiff --git a\/libyara\/include\/yara\/object.h b\/libyara\/include\/yara\/object.h\nindex 0fbf311b..5f412931 100644\n--- a\/libyara\/include\/yara\/object.h\n+++ b\/libyara\/include\/yara\/object.h\n@@ -86,6 +86,11 @@ void yr_object_destroy(\n     YR_OBJECT* object);\n \n \n+int yr_object_copy(\n+    YR_OBJECT* object,\n+    YR_OBJECT** object_copy);\n+\n+\n YR_OBJECT* yr_object_lookup_field(\n     YR_OBJECT* object,\n     const char* field_name);\ndiff --git a\/libyara\/include\/yara\/sizedstr.h b\/libyara\/include\/yara\/sizedstr.h\nindex 9e29ec6a..da4b98d3 100644\n--- a\/libyara\/include\/yara\/sizedstr.h\n+++ b\/libyara\/include\/yara\/sizedstr.h\n@@ -51,7 +51,7 @@ typedef struct _SIZED_STRING\n {\n   uint32_t length;\n   uint32_t flags;\n-  \n+\n   char c_string[1];\n \n } SIZED_STRING;\n@@ -60,7 +60,11 @@ typedef struct _SIZED_STRING\n \n \n int sized_string_cmp(\n-  SIZED_STRING* s1,\n-  SIZED_STRING* s2);\n+    SIZED_STRING* s1,\n+    SIZED_STRING* s2);\n+\n+\n+SIZED_STRING* sized_string_dup(\n+    SIZED_STRING* s);\n \n #endif\ndiff --git a\/libyara\/modules\/tests.c b\/libyara\/modules\/tests.c\nindex 55fd2f30..a1526383 100644\n--- a\/libyara\/modules\/tests.c\n+++ b\/libyara\/modules\/tests.c\n@@ -88,6 +88,23 @@ define_function(match)\n }\n \n \n+define_function(foobar)\n+{\n+  int64_t arg = integer_argument(1);\n+\n+  switch (arg)\n+  {\n+    case 1:\n+      return_string(\"foo\");\n+      break;\n+    case 2:\n+      return_string(\"bar\");\n+      break;\n+  }\n+\n+  return_string(\"oops\")\n+}\n+\n begin_declarations;\n \n   begin_struct(\"constants\");\n@@ -125,6 +142,7 @@ begin_declarations;\n   declare_function(\"fsum\", \"fff\", \"f\", fsum_3);\n   declare_function(\"length\", \"s\", \"i\", length);\n   declare_function(\"empty\", \"\", \"s\", empty);\n+  declare_function(\"foobar\", \"i\", \"s\", foobar);\n \n end_declarations;\n \ndiff --git a\/libyara\/object.c b\/libyara\/object.c\nindex d2d84f58..5b5b2655 100644\n--- a\/libyara\/object.c\n+++ b\/libyara\/object.c\n@@ -573,11 +573,23 @@ int yr_object_copy(\n   switch(object->type)\n   {\n     case OBJECT_TYPE_INTEGER:\n-      ((YR_OBJECT_INTEGER*) copy)->value = UNDEFINED;\n+      ((YR_OBJECT_INTEGER*) copy)->value = ((YR_OBJECT_INTEGER*) object)->value;\n       break;\n \n     case OBJECT_TYPE_STRING:\n-      ((YR_OBJECT_STRING*) copy)->value = NULL;\n+      if (((YR_OBJECT_STRING*) object)->value != NULL)\n+      {\n+        ((YR_OBJECT_STRING*) copy)->value = sized_string_dup(\n+            ((YR_OBJECT_STRING*) object)->value);\n+      }\n+      else\n+      {\n+        ((YR_OBJECT_STRING*) copy)->value = NULL;\n+      }\n+      break;\n+\n+    case OBJECT_TYPE_FLOAT:\n+      ((YR_OBJECT_DOUBLE*) copy)->value = ((YR_OBJECT_DOUBLE*) object)->value;\n       break;\n \n     case OBJECT_TYPE_FUNCTION:\ndiff --git a\/libyara\/sizedstr.c b\/libyara\/sizedstr.c\nindex 767aa7e0..3bf058ac 100644\n--- a\/libyara\/sizedstr.c\n+++ b\/libyara\/sizedstr.c\n@@ -27,6 +27,8 @@ ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n *\/\n \n+#include <string.h>\n+#include <yara\/mem.h>\n #include <yara\/sizedstr.h>\n \n \n@@ -54,3 +56,21 @@ int sized_string_cmp(\n   else\n     return 1;\n }\n+\n+\n+SIZED_STRING* sized_string_dup(\n+    SIZED_STRING* s)\n+{\n+  SIZED_STRING* result = (SIZED_STRING*) yr_malloc(\n+      sizeof(SIZED_STRING) + s->length);\n+\n+  if (result == NULL)\n+    return NULL;\n+\n+  result->length = s->length;\n+  result->flags = s->flags;\n+\n+  strncpy(result->c_string, s->c_string, s->length + 1);\n+\n+  return result;\n+}\ndiff --git a\/tests\/test-rules.c b\/tests\/test-rules.c\nindex 63433e08..2a28c005 100644\n--- a\/tests\/test-rules.c\n+++ b\/tests\/test-rules.c\n@@ -1439,6 +1439,20 @@ static void test_modules()\n       }\",\n       NULL);\n \n+  assert_true_rule(\n+      \"import \\\"tests\\\" \\\n+       rule test { \\\n+        condition: tests.foobar(1) == tests.foobar(1) \\\n+      }\",\n+      NULL);\n+\n+  assert_true_rule(\n+      \"import \\\"tests\\\" \\\n+       rule test { \\\n+        condition: tests.foobar(1) != tests.foobar(2) \\\n+      }\",\n+      NULL);\n+\n   assert_true_rule(\n       \"import \\\"tests\\\" \\\n        rule test { \\\n","owner":"VirusTotal","repo":"yara","source":"cve"},{"CVE_ID":"CVE-2019-8956","CWE_ID":"416","category":"security","commit_id":"ba59fb0273076637f0add4311faa990a5eec27c0","commit_message":"From ba59fb0273076637f0add4311faa990a5eec27c0 Mon Sep 17 00:00:00 2001\nFrom: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\nDate: Fri, 1 Feb 2019 15:15:22 +0100\nSubject: sctp: walk the list of asoc safely\n\nIn sctp_sendmesg(), when walking the list of endpoint associations, the\nassociation can be dropped from the list, making the list corrupt.\nProperly handle this by using list_for_each_entry_safe()\n\nFixes: 4910280503f3 (\"sctp: add support for snd flag SCTP_SENDALL process in sendmsg\")\nReported-by: Secunia Research <vuln@secunia.com>\nTested-by: Secunia Research <vuln@secunia.com>\nSigned-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>\nAcked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>\nAcked-by: Neil Horman <nhorman@tuxdriver.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n---\n net\/sctp\/socket.c | 4 ++--\n 1 file changed, 2 insertions(+), 2 deletions(-)\n\n","diff_code":"diff --git a\/net\/sctp\/socket.c b\/net\/sctp\/socket.c\nindex f93c3cf9e567..65d6d04546ae 100644\n--- a\/net\/sctp\/socket.c\n+++ b\/net\/sctp\/socket.c\n@@ -2027,7 +2027,7 @@ static int sctp_sendmsg(struct sock *sk, struct msghdr *msg, size_t msg_len)\n \tstruct sctp_endpoint *ep = sctp_sk(sk)->ep;\n \tstruct sctp_transport *transport = NULL;\n \tstruct sctp_sndrcvinfo _sinfo, *sinfo;\n-\tstruct sctp_association *asoc;\n+\tstruct sctp_association *asoc, *tmp;\n \tstruct sctp_cmsgs cmsgs;\n \tunion sctp_addr *daddr;\n \tbool new = false;\n@@ -2053,7 +2053,7 @@ static int sctp_sendmsg(struct sock *sk, struct msghdr *msg, size_t msg_len)\n \n \t\/* SCTP_SENDALL process *\/\n \tif ((sflags & SCTP_SENDALL) && sctp_style(sk, UDP)) {\n-\t\tlist_for_each_entry(asoc, &ep->asocs, asocs) {\n+\t\tlist_for_each_entry_safe(asoc, tmp, &ep->asocs, asocs) {\n \t\t\terr = sctp_sendmsg_check_sflags(asoc, sflags, msg,\n \t\t\t\t\t\t\tmsg_len);\n \t\t\tif (err == 0)\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2016-7906","CWE_ID":"416","category":"security","commit_id":"d63a3c5729df59f183e9e110d5d8385d17caaad0","commit_message":"From d63a3c5729df59f183e9e110d5d8385d17caaad0 Mon Sep 17 00:00:00 2001\nFrom: Cristy <urban-warrior@imagemagick.org>\nDate: Sat, 1 Oct 2016 11:16:55 -0400\nSubject: [PATCH] https:\/\/github.com\/ImageMagick\/ImageMagick\/issues\/281\n\n---\n magick\/attribute.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/magick\/attribute.c b\/magick\/attribute.c\nindex 4e01240811..53d270692f 100644\n--- a\/magick\/attribute.c\n+++ b\/magick\/attribute.c\n@@ -1296,7 +1296,7 @@ MagickExport MagickBooleanType SetImageType(Image *image,const ImageType type)\n           status=QuantizeImage(quantize_info,image);\n           quantize_info=DestroyQuantizeInfo(quantize_info);\n         }\n-      image->colors=2;\n+      status=AcquireImageColormap(image,2);\n       image->matte=MagickFalse;\n       break;\n     }\n","owner":"ImageMagick","repo":"ImageMagick","source":"cve"},{"CVE_ID":"CVE-2019-11487","CWE_ID":"416","category":"security","commit_id":"8fde12ca79aff9b5ba951fce1a2641901b8d8e64","commit_message":"From 8fde12ca79aff9b5ba951fce1a2641901b8d8e64 Mon Sep 17 00:00:00 2001\nFrom: Linus Torvalds <torvalds@linux-foundation.org>\nDate: Thu, 11 Apr 2019 10:49:19 -0700\nSubject: mm: prevent get_user_pages() from overflowing page refcount\n\nIf the page refcount wraps around past zero, it will be freed while\nthere are still four billion references to it.  One of the possible\navenues for an attacker to try to make this happen is by doing direct IO\non a page multiple times.  This patch makes get_user_pages() refuse to\ntake a new page reference if there are already more than two billion\nreferences to the page.\n\nReported-by: Jann Horn <jannh@google.com>\nAcked-by: Matthew Wilcox <willy@infradead.org>\nCc: stable@kernel.org\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n mm\/gup.c     | 48 ++++++++++++++++++++++++++++++++++++------------\n mm\/hugetlb.c | 13 +++++++++++++\n 2 files changed, 49 insertions(+), 12 deletions(-)\n\n","diff_code":"diff --git a\/mm\/gup.c b\/mm\/gup.c\nindex 75029649baca..81e0bdefa2cc 100644\n--- a\/mm\/gup.c\n+++ b\/mm\/gup.c\n@@ -157,8 +157,12 @@ retry:\n \t\tgoto retry;\n \t}\n \n-\tif (flags & FOLL_GET)\n-\t\tget_page(page);\n+\tif (flags & FOLL_GET) {\n+\t\tif (unlikely(!try_get_page(page))) {\n+\t\t\tpage = ERR_PTR(-ENOMEM);\n+\t\t\tgoto out;\n+\t\t}\n+\t}\n \tif (flags & FOLL_TOUCH) {\n \t\tif ((flags & FOLL_WRITE) &&\n \t\t    !pte_dirty(pte) && !PageDirty(page))\n@@ -295,7 +299,10 @@ retry_locked:\n \t\t\tif (pmd_trans_unstable(pmd))\n \t\t\t\tret = -EBUSY;\n \t\t} else {\n-\t\t\tget_page(page);\n+\t\t\tif (unlikely(!try_get_page(page))) {\n+\t\t\t\tspin_unlock(ptl);\n+\t\t\t\treturn ERR_PTR(-ENOMEM);\n+\t\t\t}\n \t\t\tspin_unlock(ptl);\n \t\t\tlock_page(page);\n \t\t\tret = split_huge_page(page);\n@@ -497,7 +504,10 @@ static int get_gate_page(struct mm_struct *mm, unsigned long address,\n \t\tif (is_device_public_page(*page))\n \t\t\tgoto unmap;\n \t}\n-\tget_page(*page);\n+\tif (unlikely(!try_get_page(*page))) {\n+\t\tret = -ENOMEM;\n+\t\tgoto unmap;\n+\t}\n out:\n \tret = 0;\n unmap:\n@@ -1393,6 +1403,20 @@ static void undo_dev_pagemap(int *nr, int nr_start, struct page **pages)\n \t}\n }\n \n+\/*\n+ * Return the compund head page with ref appropriately incremented,\n+ * or NULL if that failed.\n+ *\/\n+static inline struct page *try_get_compound_head(struct page *page, int refs)\n+{\n+\tstruct page *head = compound_head(page);\n+\tif (WARN_ON_ONCE(page_ref_count(head) < 0))\n+\t\treturn NULL;\n+\tif (unlikely(!page_cache_add_speculative(head, refs)))\n+\t\treturn NULL;\n+\treturn head;\n+}\n+\n #ifdef CONFIG_ARCH_HAS_PTE_SPECIAL\n static int gup_pte_range(pmd_t pmd, unsigned long addr, unsigned long end,\n \t\t\t int write, struct page **pages, int *nr)\n@@ -1427,9 +1451,9 @@ static int gup_pte_range(pmd_t pmd, unsigned long addr, unsigned long end,\n \n \t\tVM_BUG_ON(!pfn_valid(pte_pfn(pte)));\n \t\tpage = pte_page(pte);\n-\t\thead = compound_head(page);\n \n-\t\tif (!page_cache_get_speculative(head))\n+\t\thead = try_get_compound_head(page, 1);\n+\t\tif (!head)\n \t\t\tgoto pte_unmap;\n \n \t\tif (unlikely(pte_val(pte) != pte_val(*ptep))) {\n@@ -1568,8 +1592,8 @@ static int gup_huge_pmd(pmd_t orig, pmd_t *pmdp, unsigned long addr,\n \t\trefs++;\n \t} while (addr += PAGE_SIZE, addr != end);\n \n-\thead = compound_head(pmd_page(orig));\n-\tif (!page_cache_add_speculative(head, refs)) {\n+\thead = try_get_compound_head(pmd_page(orig), refs);\n+\tif (!head) {\n \t\t*nr -= refs;\n \t\treturn 0;\n \t}\n@@ -1606,8 +1630,8 @@ static int gup_huge_pud(pud_t orig, pud_t *pudp, unsigned long addr,\n \t\trefs++;\n \t} while (addr += PAGE_SIZE, addr != end);\n \n-\thead = compound_head(pud_page(orig));\n-\tif (!page_cache_add_speculative(head, refs)) {\n+\thead = try_get_compound_head(pud_page(orig), refs);\n+\tif (!head) {\n \t\t*nr -= refs;\n \t\treturn 0;\n \t}\n@@ -1643,8 +1667,8 @@ static int gup_huge_pgd(pgd_t orig, pgd_t *pgdp, unsigned long addr,\n \t\trefs++;\n \t} while (addr += PAGE_SIZE, addr != end);\n \n-\thead = compound_head(pgd_page(orig));\n-\tif (!page_cache_add_speculative(head, refs)) {\n+\thead = try_get_compound_head(pgd_page(orig), refs);\n+\tif (!head) {\n \t\t*nr -= refs;\n \t\treturn 0;\n \t}\ndiff --git a\/mm\/hugetlb.c b\/mm\/hugetlb.c\nindex 8dfdffc34a99..c220315dc533 100644\n--- a\/mm\/hugetlb.c\n+++ b\/mm\/hugetlb.c\n@@ -4298,6 +4298,19 @@ long follow_hugetlb_page(struct mm_struct *mm, struct vm_area_struct *vma,\n \n \t\tpfn_offset = (vaddr & ~huge_page_mask(h)) >> PAGE_SHIFT;\n \t\tpage = pte_page(huge_ptep_get(pte));\n+\n+\t\t\/*\n+\t\t * Instead of doing 'try_get_page()' below in the same_page\n+\t\t * loop, just check the count once here.\n+\t\t *\/\n+\t\tif (unlikely(page_count(page) <= 0)) {\n+\t\t\tif (pages) {\n+\t\t\t\tspin_unlock(ptl);\n+\t\t\t\tremainder = 0;\n+\t\t\t\terr = -ENOMEM;\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n same_page:\n \t\tif (pages) {\n \t\t\tpages[i] = mem_map_offset(page, pfn_offset);\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2016-5773","CWE_ID":"416","category":"security","commit_id":"f6aef68089221c5ea047d4a74224ee3deead99a6","commit_message":"From f6aef68089221c5ea047d4a74224ee3deead99a6 Mon Sep 17 00:00:00 2001\nFrom: Stanislav Malyshev <stas@php.net>\nDate: Mon, 20 Jun 2016 21:35:22 -0700\nSubject: [PATCH] Fix bug #72434: ZipArchive class Use After Free Vulnerability\n in PHP's GC algorithm and unserialize\n\n---\n ext\/standard\/tests\/strings\/bug72434.phpt | 33 ++++++++++++++++++++++++\n ext\/zip\/php_zip.c                        |  9 +++++++\n 2 files changed, 42 insertions(+)\n create mode 100644 ext\/standard\/tests\/strings\/bug72434.phpt\n\n","diff_code":"diff --git a\/ext\/standard\/tests\/strings\/bug72434.phpt b\/ext\/standard\/tests\/strings\/bug72434.phpt\nnew file mode 100644\nindex 000000000000..1408b8f578aa\n--- \/dev\/null\n+++ b\/ext\/standard\/tests\/strings\/bug72434.phpt\n@@ -0,0 +1,33 @@\n+--TEST--\n+Bug #72434: ZipArchive class Use After Free Vulnerability in PHP's GC algorithm and unserialize\n+--SKIPIF--\n+<?php\n+if(!class_exists('zip')) die('ZipArchive');\n+?>\n+--FILE--\n+<?php\n+\/\/ The following array will be serialized and this representation will be freed later on.\n+$free_me = array(new StdClass());\n+\/\/ Create our payload and unserialize it.\n+$serialized_payload = 'a:3:{i:1;N;i:2;O:10:\"ZipArchive\":1:{s:8:\"filename\";'.serialize($free_me).'}i:1;R:4;}';\n+$unserialized_payload = unserialize($serialized_payload);\n+gc_collect_cycles();\n+\/\/ The reference counter for $free_me is at -1 for PHP 7 right now.\n+\/\/ Increment the reference counter by 1 -> rc is 0\n+$a = $unserialized_payload[1];\n+\/\/ Increment the reference counter by 1 again -> rc is 1\n+$b = $a;\n+\/\/ Trigger free of $free_me (referenced by $m[1]).\n+unset($b);\n+$fill_freed_space_1 = \"filler_zval_1\";\n+$fill_freed_space_2 = \"filler_zval_2\";\n+$fill_freed_space_3 = \"filler_zval_3\";\n+$fill_freed_space_4 = \"filler_zval_4\";\n+debug_zval_dump($unserialized_payload[1]);\n+?>\n+--EXPECTF--\n+array(1) refcount(1){\n+  [0]=>\n+  object(stdClass)#%d (0) refcount(3){\n+  }\n+}\ndiff --git a\/ext\/zip\/php_zip.c b\/ext\/zip\/php_zip.c\nindex 99c293c6d742..57d060f4ff33 100644\n--- a\/ext\/zip\/php_zip.c\n+++ b\/ext\/zip\/php_zip.c\n@@ -1015,6 +1015,14 @@ static int php_zip_has_property(zval *object, zval *member, int type, const zend\n }\n \/* }}} *\/\n \n+static HashTable *php_zip_get_gc(zval *object, zval ***gc_data, int *gc_data_count TSRMLS_DC) \/* {{{ *\/\n+{\n+\t*gc_data = NULL;\n+\t*gc_data_count = 0;\n+\treturn zend_std_get_properties(object TSRMLS_CC);\n+}\n+\/* }}} *\/\n+\n static HashTable *php_zip_get_properties(zval *object TSRMLS_DC)\/* {{{ *\/\n {\n \tze_zip_object *obj;\n@@ -2777,6 +2785,7 @@ static PHP_MINIT_FUNCTION(zip)\n \tzip_object_handlers.clone_obj\t\t= NULL;\n \tzip_object_handlers.get_property_ptr_ptr = php_zip_get_property_ptr_ptr;\n \n+\tzip_object_handlers.get_gc          = php_zip_get_gc;\n \tzip_object_handlers.get_properties = php_zip_get_properties;\n \tzip_object_handlers.read_property\t= php_zip_read_property;\n \tzip_object_handlers.has_property\t= php_zip_has_property;\n","owner":"php","repo":"php-src","source":"cve"},{"CVE_ID":"CVE-2019-11487","CWE_ID":"416","category":"security","commit_id":"15fab63e1e57be9fdb5eec1bbc5916e9825e9acb","commit_message":"From 15fab63e1e57be9fdb5eec1bbc5916e9825e9acb Mon Sep 17 00:00:00 2001\nFrom: Matthew Wilcox <willy@infradead.org>\nDate: Fri, 5 Apr 2019 14:02:10 -0700\nSubject: fs: prevent page refcount overflow in pipe_buf_get\n\nChange pipe_buf_get() to return a bool indicating whether it succeeded\nin raising the refcount of the page (if the thing in the pipe is a page).\nThis removes another mechanism for overflowing the page refcount.  All\ncallers converted to handle a failure.\n\nReported-by: Jann Horn <jannh@google.com>\nSigned-off-by: Matthew Wilcox <willy@infradead.org>\nCc: stable@kernel.org\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n---\n fs\/fuse\/dev.c             | 12 ++++++------\n fs\/pipe.c                 |  4 ++--\n fs\/splice.c               | 12 ++++++++++--\n include\/linux\/pipe_fs_i.h | 10 ++++++----\n kernel\/trace\/trace.c      |  6 +++++-\n 5 files changed, 29 insertions(+), 15 deletions(-)\n\n","diff_code":"diff --git a\/fs\/fuse\/dev.c b\/fs\/fuse\/dev.c\nindex 809c0f2f9942..64f4de983468 100644\n--- a\/fs\/fuse\/dev.c\n+++ b\/fs\/fuse\/dev.c\n@@ -2034,10 +2034,8 @@ static ssize_t fuse_dev_splice_write(struct pipe_inode_info *pipe,\n \t\trem += pipe->bufs[(pipe->curbuf + idx) & (pipe->buffers - 1)].len;\n \n \tret = -EINVAL;\n-\tif (rem < len) {\n-\t\tpipe_unlock(pipe);\n-\t\tgoto out;\n-\t}\n+\tif (rem < len)\n+\t\tgoto out_free;\n \n \trem = len;\n \twhile (rem) {\n@@ -2055,7 +2053,9 @@ static ssize_t fuse_dev_splice_write(struct pipe_inode_info *pipe,\n \t\t\tpipe->curbuf = (pipe->curbuf + 1) & (pipe->buffers - 1);\n \t\t\tpipe->nrbufs--;\n \t\t} else {\n-\t\t\tpipe_buf_get(pipe, ibuf);\n+\t\t\tif (!pipe_buf_get(pipe, ibuf))\n+\t\t\t\tgoto out_free;\n+\n \t\t\t*obuf = *ibuf;\n \t\t\tobuf->flags &= ~PIPE_BUF_FLAG_GIFT;\n \t\t\tobuf->len = rem;\n@@ -2078,11 +2078,11 @@ static ssize_t fuse_dev_splice_write(struct pipe_inode_info *pipe,\n \tret = fuse_dev_do_write(fud, &cs, len);\n \n \tpipe_lock(pipe);\n+out_free:\n \tfor (idx = 0; idx < nbuf; idx++)\n \t\tpipe_buf_release(pipe, &bufs[idx]);\n \tpipe_unlock(pipe);\n \n-out:\n \tkvfree(bufs);\n \treturn ret;\n }\ndiff --git a\/fs\/pipe.c b\/fs\/pipe.c\nindex bdc5d3c0977d..b1543b85c14a 100644\n--- a\/fs\/pipe.c\n+++ b\/fs\/pipe.c\n@@ -189,9 +189,9 @@ EXPORT_SYMBOL(generic_pipe_buf_steal);\n  *\tin the tee() system call, when we duplicate the buffers in one\n  *\tpipe into another.\n  *\/\n-void generic_pipe_buf_get(struct pipe_inode_info *pipe, struct pipe_buffer *buf)\n+bool generic_pipe_buf_get(struct pipe_inode_info *pipe, struct pipe_buffer *buf)\n {\n-\tget_page(buf->page);\n+\treturn try_get_page(buf->page);\n }\n EXPORT_SYMBOL(generic_pipe_buf_get);\n \ndiff --git a\/fs\/splice.c b\/fs\/splice.c\nindex de2ede048473..f30af82b850d 100644\n--- a\/fs\/splice.c\n+++ b\/fs\/splice.c\n@@ -1588,7 +1588,11 @@ retry:\n \t\t\t * Get a reference to this pipe buffer,\n \t\t\t * so we can copy the contents over.\n \t\t\t *\/\n-\t\t\tpipe_buf_get(ipipe, ibuf);\n+\t\t\tif (!pipe_buf_get(ipipe, ibuf)) {\n+\t\t\t\tif (ret == 0)\n+\t\t\t\t\tret = -EFAULT;\n+\t\t\t\tbreak;\n+\t\t\t}\n \t\t\t*obuf = *ibuf;\n \n \t\t\t\/*\n@@ -1660,7 +1664,11 @@ static int link_pipe(struct pipe_inode_info *ipipe,\n \t\t * Get a reference to this pipe buffer,\n \t\t * so we can copy the contents over.\n \t\t *\/\n-\t\tpipe_buf_get(ipipe, ibuf);\n+\t\tif (!pipe_buf_get(ipipe, ibuf)) {\n+\t\t\tif (ret == 0)\n+\t\t\t\tret = -EFAULT;\n+\t\t\tbreak;\n+\t\t}\n \n \t\tobuf = opipe->bufs + nbuf;\n \t\t*obuf = *ibuf;\ndiff --git a\/include\/linux\/pipe_fs_i.h b\/include\/linux\/pipe_fs_i.h\nindex 5a3bb3b7c9ad..3f2a42c11e20 100644\n--- a\/include\/linux\/pipe_fs_i.h\n+++ b\/include\/linux\/pipe_fs_i.h\n@@ -108,18 +108,20 @@ struct pipe_buf_operations {\n \t\/*\n \t * Get a reference to the pipe buffer.\n \t *\/\n-\tvoid (*get)(struct pipe_inode_info *, struct pipe_buffer *);\n+\tbool (*get)(struct pipe_inode_info *, struct pipe_buffer *);\n };\n \n \/**\n  * pipe_buf_get - get a reference to a pipe_buffer\n  * @pipe:\tthe pipe that the buffer belongs to\n  * @buf:\tthe buffer to get a reference to\n+ *\n+ * Return: %true if the reference was successfully obtained.\n  *\/\n-static inline void pipe_buf_get(struct pipe_inode_info *pipe,\n+static inline __must_check bool pipe_buf_get(struct pipe_inode_info *pipe,\n \t\t\t\tstruct pipe_buffer *buf)\n {\n-\tbuf->ops->get(pipe, buf);\n+\treturn buf->ops->get(pipe, buf);\n }\n \n \/**\n@@ -178,7 +180,7 @@ struct pipe_inode_info *alloc_pipe_info(void);\n void free_pipe_info(struct pipe_inode_info *);\n \n \/* Generic pipe buffer ops functions *\/\n-void generic_pipe_buf_get(struct pipe_inode_info *, struct pipe_buffer *);\n+bool generic_pipe_buf_get(struct pipe_inode_info *, struct pipe_buffer *);\n int generic_pipe_buf_confirm(struct pipe_inode_info *, struct pipe_buffer *);\n int generic_pipe_buf_steal(struct pipe_inode_info *, struct pipe_buffer *);\n void generic_pipe_buf_release(struct pipe_inode_info *, struct pipe_buffer *);\ndiff --git a\/kernel\/trace\/trace.c b\/kernel\/trace\/trace.c\nindex c4238b441624..0f300d488c9f 100644\n--- a\/kernel\/trace\/trace.c\n+++ b\/kernel\/trace\/trace.c\n@@ -6835,12 +6835,16 @@ static void buffer_pipe_buf_release(struct pipe_inode_info *pipe,\n \tbuf->private = 0;\n }\n \n-static void buffer_pipe_buf_get(struct pipe_inode_info *pipe,\n+static bool buffer_pipe_buf_get(struct pipe_inode_info *pipe,\n \t\t\t\tstruct pipe_buffer *buf)\n {\n \tstruct buffer_ref *ref = (struct buffer_ref *)buf->private;\n \n+\tif (ref->ref > INT_MAX\/2)\n+\t\treturn false;\n+\n \tref->ref++;\n+\treturn true;\n }\n \n \/* Pipe buffer operations for a buffer. *\/\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2016-10088","CWE_ID":"416","category":"security","commit_id":"128394eff343fc6d2f32172f03e24829539c5835","commit_message":"From 128394eff343fc6d2f32172f03e24829539c5835 Mon Sep 17 00:00:00 2001\nFrom: Al Viro <viro@zeniv.linux.org.uk>\nDate: Fri, 16 Dec 2016 13:42:06 -0500\nSubject: sg_write()\/bsg_write() is not fit to be called under KERNEL_DS\n\nBoth damn things interpret userland pointers embedded into the payload;\nworse, they are actually traversing those.  Leaving aside the bad\nAPI design, this is very much _not_ safe to call with KERNEL_DS.\nBail out early if that happens.\n\nCc: stable@vger.kernel.org\nSigned-off-by: Al Viro <viro@zeniv.linux.org.uk>\n---\n block\/bsg.c       | 3 +++\n drivers\/scsi\/sg.c | 3 +++\n 2 files changed, 6 insertions(+)\n\n","diff_code":"diff --git a\/block\/bsg.c b\/block\/bsg.c\nindex 8a05a404ae70..a57046de2f07 100644\n--- a\/block\/bsg.c\n+++ b\/block\/bsg.c\n@@ -655,6 +655,9 @@ bsg_write(struct file *file, const char __user *buf, size_t count, loff_t *ppos)\n \n \tdprintk(\"%s: write %Zd bytes\\n\", bd->name, count);\n \n+\tif (unlikely(segment_eq(get_fs(), KERNEL_DS)))\n+\t\treturn -EINVAL;\n+\n \tbsg_set_block(bd, file);\n \n \tbytes_written = 0;\ndiff --git a\/drivers\/scsi\/sg.c b\/drivers\/scsi\/sg.c\nindex 070332eb41f3..dbe5b4b95df0 100644\n--- a\/drivers\/scsi\/sg.c\n+++ b\/drivers\/scsi\/sg.c\n@@ -581,6 +581,9 @@ sg_write(struct file *filp, const char __user *buf, size_t count, loff_t * ppos)\n \tsg_io_hdr_t *hp;\n \tunsigned char cmnd[SG_MAX_CDB_SIZE];\n \n+\tif (unlikely(segment_eq(get_fs(), KERNEL_DS)))\n+\t\treturn -EINVAL;\n+\n \tif ((!(sfp = (Sg_fd *) filp->private_data)) || (!(sdp = sfp->parentdp)))\n \t\treturn -ENXIO;\n \tSCSI_LOG_TIMEOUT(3, sg_printk(KERN_INFO, sdp,\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2018-14734","CWE_ID":"416","category":"security","commit_id":"cb2595c1393b4a5211534e6f0a0fbad369e21ad8","commit_message":"From cb2595c1393b4a5211534e6f0a0fbad369e21ad8 Mon Sep 17 00:00:00 2001\nFrom: Cong Wang <xiyou.wangcong@gmail.com>\nDate: Fri, 1 Jun 2018 11:31:44 -0700\nSubject: infiniband: fix a possible use-after-free bug\n\nucma_process_join() will free the new allocated \"mc\" struct,\nif there is any error after that, especially the copy_to_user().\n\nBut in parallel, ucma_leave_multicast() could find this \"mc\"\nthrough idr_find() before ucma_process_join() frees it, since it\nis already published.\n\nSo \"mc\" could be used in ucma_leave_multicast() after it is been\nallocated and freed in ucma_process_join(), since we don't refcnt\nit.\n\nFix this by separating \"publish\" from ID allocation, so that we\ncan get an ID first and publish it later after copy_to_user().\n\nFixes: c8f6a362bf3e (\"RDMA\/cma: Add multicast communication support\")\nReported-by: Noam Rathaus <noamr@beyondsecurity.com>\nSigned-off-by: Cong Wang <xiyou.wangcong@gmail.com>\nSigned-off-by: Jason Gunthorpe <jgg@mellanox.com>\n---\n drivers\/infiniband\/core\/ucma.c | 6 +++++-\n 1 file changed, 5 insertions(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/drivers\/infiniband\/core\/ucma.c b\/drivers\/infiniband\/core\/ucma.c\nindex eab43b17e9cf..ec8fb289621f 100644\n--- a\/drivers\/infiniband\/core\/ucma.c\n+++ b\/drivers\/infiniband\/core\/ucma.c\n@@ -235,7 +235,7 @@ static struct ucma_multicast* ucma_alloc_multicast(struct ucma_context *ctx)\n \t\treturn NULL;\n \n \tmutex_lock(&mut);\n-\tmc->id = idr_alloc(&multicast_idr, mc, 0, 0, GFP_KERNEL);\n+\tmc->id = idr_alloc(&multicast_idr, NULL, 0, 0, GFP_KERNEL);\n \tmutex_unlock(&mut);\n \tif (mc->id < 0)\n \t\tgoto error;\n@@ -1421,6 +1421,10 @@ static ssize_t ucma_process_join(struct ucma_file *file,\n \t\tgoto err3;\n \t}\n \n+\tmutex_lock(&mut);\n+\tidr_replace(&multicast_idr, mc, mc->id);\n+\tmutex_unlock(&mut);\n+\n \tmutex_unlock(&file->mut);\n \tucma_put_ctx(ctx);\n \treturn 0;\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2015-5221","CWE_ID":"416","category":"security","commit_id":"df5d2867e8004e51e18b89865bc4aa69229227b3","commit_message":"From df5d2867e8004e51e18b89865bc4aa69229227b3 Mon Sep 17 00:00:00 2001\nFrom: Richard Hughes <richard@hughsie.com>\nDate: Mon, 19 Sep 2016 10:03:36 +0100\nSubject: [PATCH] CVE-2015-5221\n\n---\n src\/libjasper\/mif\/mif_cod.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/src\/libjasper\/mif\/mif_cod.c b\/src\/libjasper\/mif\/mif_cod.c\nindex 17506a1..5afc0a2 100644\n--- a\/src\/libjasper\/mif\/mif_cod.c\n+++ b\/src\/libjasper\/mif\/mif_cod.c\n@@ -570,13 +570,13 @@ static int mif_process_cmpt(mif_hdr_t *hdr, char *buf)\n \t\t\tbreak;\n \t\t}\n \t}\n-\tjas_tvparser_destroy(tvp);\n \tif (!cmpt->sampperx || !cmpt->samppery) {\n \t\tgoto error;\n \t}\n \tif (mif_hdr_addcmpt(hdr, hdr->numcmpts, cmpt)) {\n \t\tgoto error;\n \t}\n+\tjas_tvparser_destroy(tvp);\n \treturn 0;\n \n error:\n","owner":"mdadams","repo":"jasper","source":"cve"},{"CVE_ID":"CVE-2019-12106","CWE_ID":"416","category":"security","commit_id":"cd506a67e174a45c6a202eff182a712955ed6d6f","commit_message":"From cd506a67e174a45c6a202eff182a712955ed6d6f Mon Sep 17 00:00:00 2001\nFrom: Thomas Bernard <miniupnp@free.fr>\nDate: Tue, 18 Dec 2018 20:23:47 +0100\nSubject: [PATCH] updateDevice() remove element from the list when realloc\n fails\n\n---\n minissdpd\/minissdpd.c | 1 +\n 1 file changed, 1 insertion(+)\n\n","diff_code":"diff --git a\/minissdpd\/minissdpd.c b\/minissdpd\/minissdpd.c\nindex 5d4a386e..5c9c5d62 100644\n--- a\/minissdpd\/minissdpd.c\n+++ b\/minissdpd\/minissdpd.c\n@@ -318,6 +318,7 @@ updateDevice(const struct header * headers, time_t t)\n \t\t\t\tif(!tmp)\t\/* allocation error *\/\n \t\t\t\t{\n \t\t\t\t\tsyslog(LOG_ERR, \"updateDevice() : memory allocation error\");\n+\t\t\t\t\t*pp = p->next;\t\/* remove \"p\" from the list *\/\n \t\t\t\t\tfree(p);\n \t\t\t\t\treturn 0;\n \t\t\t\t}\n","owner":"miniupnp","repo":"miniupnp","source":"cve"},{"CVE_ID":"CVE-2016-7910","CWE_ID":"416","category":"security","commit_id":"77da160530dd1dc94f6ae15a981f24e5f0021e84","commit_message":"From 77da160530dd1dc94f6ae15a981f24e5f0021e84 Mon Sep 17 00:00:00 2001\nFrom: Vegard Nossum <vegard.nossum@oracle.com>\nDate: Fri, 29 Jul 2016 10:40:31 +0200\nSubject: block: fix use-after-free in seq file\n\nI got a KASAN report of use-after-free:\n\n    ==================================================================\n    BUG: KASAN: use-after-free in klist_iter_exit+0x61\/0x70 at addr ffff8800b6581508\n    Read of size 8 by task trinity-c1\/315\n    =============================================================================\n    BUG kmalloc-32 (Not tainted): kasan: bad access detected\n    -----------------------------------------------------------------------------\n\n    Disabling lock debugging due to kernel taint\n    INFO: Allocated in disk_seqf_start+0x66\/0x110 age=144 cpu=1 pid=315\n            ___slab_alloc+0x4f1\/0x520\n            __slab_alloc.isra.58+0x56\/0x80\n            kmem_cache_alloc_trace+0x260\/0x2a0\n            disk_seqf_start+0x66\/0x110\n            traverse+0x176\/0x860\n            seq_read+0x7e3\/0x11a0\n            proc_reg_read+0xbc\/0x180\n            do_loop_readv_writev+0x134\/0x210\n            do_readv_writev+0x565\/0x660\n            vfs_readv+0x67\/0xa0\n            do_preadv+0x126\/0x170\n            SyS_preadv+0xc\/0x10\n            do_syscall_64+0x1a1\/0x460\n            return_from_SYSCALL_64+0x0\/0x6a\n    INFO: Freed in disk_seqf_stop+0x42\/0x50 age=160 cpu=1 pid=315\n            __slab_free+0x17a\/0x2c0\n            kfree+0x20a\/0x220\n            disk_seqf_stop+0x42\/0x50\n            traverse+0x3b5\/0x860\n            seq_read+0x7e3\/0x11a0\n            proc_reg_read+0xbc\/0x180\n            do_loop_readv_writev+0x134\/0x210\n            do_readv_writev+0x565\/0x660\n            vfs_readv+0x67\/0xa0\n            do_preadv+0x126\/0x170\n            SyS_preadv+0xc\/0x10\n            do_syscall_64+0x1a1\/0x460\n            return_from_SYSCALL_64+0x0\/0x6a\n\n    CPU: 1 PID: 315 Comm: trinity-c1 Tainted: G    B           4.7.0+ #62\n    Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04\/01\/2014\n     ffffea0002d96000 ffff880119b9f918 ffffffff81d6ce81 ffff88011a804480\n     ffff8800b6581500 ffff880119b9f948 ffffffff8146c7bd ffff88011a804480\n     ffffea0002d96000 ffff8800b6581500 fffffffffffffff4 ffff880119b9f970\n    Call Trace:\n     [<ffffffff81d6ce81>] dump_stack+0x65\/0x84\n     [<ffffffff8146c7bd>] print_trailer+0x10d\/0x1a0\n     [<ffffffff814704ff>] object_err+0x2f\/0x40\n     [<ffffffff814754d1>] kasan_report_error+0x221\/0x520\n     [<ffffffff8147590e>] __asan_report_load8_noabort+0x3e\/0x40\n     [<ffffffff83888161>] klist_iter_exit+0x61\/0x70\n     [<ffffffff82404389>] class_dev_iter_exit+0x9\/0x10\n     [<ffffffff81d2e8ea>] disk_seqf_stop+0x3a\/0x50\n     [<ffffffff8151f812>] seq_read+0x4b2\/0x11a0\n     [<ffffffff815f8fdc>] proc_reg_read+0xbc\/0x180\n     [<ffffffff814b24e4>] do_loop_readv_writev+0x134\/0x210\n     [<ffffffff814b4c45>] do_readv_writev+0x565\/0x660\n     [<ffffffff814b8a17>] vfs_readv+0x67\/0xa0\n     [<ffffffff814b8de6>] do_preadv+0x126\/0x170\n     [<ffffffff814b92ec>] SyS_preadv+0xc\/0x10\n\nThis problem can occur in the following situation:\n\nopen()\n - pread()\n    - .seq_start()\n       - iter = kmalloc() \/\/ succeeds\n       - seqf->private = iter\n    - .seq_stop()\n       - kfree(seqf->private)\n - pread()\n    - .seq_start()\n       - iter = kmalloc() \/\/ fails\n    - .seq_stop()\n       - class_dev_iter_exit(seqf->private) \/\/ boom! old pointer\n\nAs the comment in disk_seqf_stop() says, stop is called even if start\nfailed, so we need to reinitialise the private pointer to NULL when seq\niteration stops.\n\nAn alternative would be to set the private pointer to NULL when the\nkmalloc() in disk_seqf_start() fails.\n\nCc: stable@vger.kernel.org\nSigned-off-by: Vegard Nossum <vegard.nossum@oracle.com>\nAcked-by: Tejun Heo <tj@kernel.org>\nSigned-off-by: Jens Axboe <axboe@fb.com>\n---\n block\/genhd.c | 1 +\n 1 file changed, 1 insertion(+)\n\n","diff_code":"diff --git a\/block\/genhd.c b\/block\/genhd.c\nindex 3c9dede4e04f..0ad879655f82 100644\n--- a\/block\/genhd.c\n+++ b\/block\/genhd.c\n@@ -856,6 +856,7 @@ static void disk_seqf_stop(struct seq_file *seqf, void *v)\n \tif (iter) {\n \t\tclass_dev_iter_exit(iter);\n \t\tkfree(iter);\n+\t\tseqf->private = NULL;\n \t}\n }\n \n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-9798","CWE_ID":"416","category":"security","commit_id":"29afdd2550b3d30a8defece2b95ae81edcf66ac9","commit_message":"From 29afdd2550b3d30a8defece2b95ae81edcf66ac9 Mon Sep 17 00:00:00 2001\nFrom: Yann Ylavic <ylavic@apache.org>\nDate: Thu, 7 Sep 2017 22:43:41 +0000\nSubject: [PATCH] core: Disallow Methods' registration at run time (.htaccess),\n they may be used only if registered at init time (httpd.conf).\n\nCalling ap_method_register() in children processes is not the right scope\nsince it won't be shared for all requests.\n\n\ngit-svn-id: https:\/\/svn.apache.org\/repos\/asf\/httpd\/httpd\/trunk@1807655 13f79535-47bb-0310-9956-ffa450edef68\n---\n CHANGES       | 3 +++\n server\/core.c | 6 ++++++\n 2 files changed, 9 insertions(+)\n\n","diff_code":"diff --git a\/CHANGES b\/CHANGES\nindex 4ca0e4cc822..2b744675e78 100644\n--- a\/CHANGES\n+++ b\/CHANGES\n@@ -1,6 +1,9 @@\n                                                          -*- coding: utf-8 -*-\n Changes with Apache 2.5.0\n \n+  *) core: Disallow Methods' registration at runtime (.htaccess), they may be\n+     used only if registered at init time (httpd.conf).  [Yann Ylavic]\n+\n   *) mod_md: v0.9.1:\n      - various fixes in MDRenewWindow handling when specifying percent. Serialization changed. If \n        someone already used percent configurations, it is advised to change these to a new value,\ndiff --git a\/server\/core.c b\/server\/core.c\nindex 76adb4d8693..c9b6837bd41 100644\n--- a\/server\/core.c\n+++ b\/server\/core.c\n@@ -2331,6 +2331,12 @@ AP_CORE_DECLARE_NONSTD(const char *) ap_limit_section(cmd_parms *cmd,\n             \/* method has not been registered yet, but resource restriction\n              * is always checked before method handling, so register it.\n              *\/\n+            if (cmd->pool == cmd->temp_pool) {\n+                \/* In .htaccess, we can't globally register new methods. *\/\n+                return apr_psprintf(cmd->pool, \"Could not register method '%s' \"\n+                                   \"for %s from .htaccess configuration\",\n+                                    method, cmd->cmd->name);\n+            }\n             methnum = ap_method_register(cmd->pool,\n                                          apr_pstrdup(cmd->pool, method));\n         }\n","owner":"apache","repo":"httpd","source":"cve"},{"CVE_ID":"CVE-2017-7487","CWE_ID":"416","category":"security","commit_id":"ee0d8d8482345ff97a75a7d747efc309f13b0d80","commit_message":"From ee0d8d8482345ff97a75a7d747efc309f13b0d80 Mon Sep 17 00:00:00 2001\nFrom: Dan Carpenter <dan.carpenter@oracle.com>\nDate: Tue, 2 May 2017 13:58:53 +0300\nSubject: [PATCH] ipx: call ipxitf_put() in ioctl error path\nMIME-Version: 1.0\nContent-Type: text\/plain; charset=UTF-8\nContent-Transfer-Encoding: 8bit\n\nWe should call ipxitf_put() if the copy_to_user() fails.\n\nReported-by: \u674e\u5f3a <liqiang6-s@360.cn>\nSigned-off-by: Dan Carpenter <dan.carpenter@oracle.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n---\n net\/ipx\/af_ipx.c | 5 ++---\n 1 file changed, 2 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/net\/ipx\/af_ipx.c b\/net\/ipx\/af_ipx.c\nindex 8a9219ff2e77e..fa31ef29e3fa0 100644\n--- a\/net\/ipx\/af_ipx.c\n+++ b\/net\/ipx\/af_ipx.c\n@@ -1168,11 +1168,10 @@ static int ipxitf_ioctl(unsigned int cmd, void __user *arg)\n \t\tsipx->sipx_network\t= ipxif->if_netnum;\n \t\tmemcpy(sipx->sipx_node, ipxif->if_node,\n \t\t\tsizeof(sipx->sipx_node));\n-\t\trc = -EFAULT;\n+\t\trc = 0;\n \t\tif (copy_to_user(arg, &ifr, sizeof(ifr)))\n-\t\t\tbreak;\n+\t\t\trc = -EFAULT;\n \t\tipxitf_put(ipxif);\n-\t\trc = 0;\n \t\tbreak;\n \t}\n \tcase SIOCAIPXITFCRT:\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-6420","CWE_ID":"416","category":"security","commit_id":"dfc00cd3301a42b571454b51a6102eecf58407bc","commit_message":"From dfc00cd3301a42b571454b51a6102eecf58407bc Mon Sep 17 00:00:00 2001\nFrom: Steven Morgan <stevmorg@cisco.com>\nDate: Fri, 3 Mar 2017 13:56:28 -0500\nSubject: [PATCH] bb19798 - fix out of bound memory access for crafted wwunpack\n file.\n\n---\n libclamav\/wwunpack.c | 6 ++++++\n 1 file changed, 6 insertions(+)\n\n","diff_code":"diff --git a\/libclamav\/wwunpack.c b\/libclamav\/wwunpack.c\nindex 8611cb6041..38c18081ce 100644\n--- a\/libclamav\/wwunpack.c\n+++ b\/libclamav\/wwunpack.c\n@@ -226,6 +226,12 @@ int wwunpack(uint8_t *exe, uint32_t exesz, uint8_t *wwsect, struct cli_exe_secti\n \treturn CL_EFORMAT;\n     exe[pe+6]=(uint8_t)scount;\n     exe[pe+7]=(uint8_t)(scount>>8);\n+    if (!CLI_ISCONTAINED(wwsect, sects[scount].rsz, wwsect+0x295, 4) ||\n+        !CLI_ISCONTAINED(wwsect, sects[scount].rsz, wwsect+0x295+sects[scount].rva, 4) ||\n+        !CLI_ISCONTAINED(wwsect, sects[scount].rsz, wwsect+0x295+sects[scount].rva+0x299, 4)) {\n+        cli_dbgmsg(\"WWPack: unpack memory address out of bounds.\\n\");\n+        return CL_EFORMAT;\n+    }\n     cli_writeint32(&exe[pe+0x28], cli_readint32(wwsect+0x295)+sects[scount].rva+0x299);\n     cli_writeint32(&exe[pe+0x50], cli_readint32(&exe[pe+0x50])-sects[scount].vsz);\n \n","owner":"vrtadmin","repo":"clamav-devel","source":"cve"},{"CVE_ID":"CVE-2018-10879","CWE_ID":"416","category":"security","commit_id":"513f86d73855ce556ea9522b6bfd79f87356dc3a","commit_message":"From 513f86d73855ce556ea9522b6bfd79f87356dc3a Mon Sep 17 00:00:00 2001\nFrom: Theodore Ts'o <tytso@mit.edu>\nDate: Wed, 13 Jun 2018 00:51:28 -0400\nSubject: ext4: always verify the magic number in xattr blocks\n\nIf there an inode points to a block which is also some other type of\nmetadata block (such as a block allocation bitmap), the\nbuffer_verified flag can be set when it was validated as that other\nmetadata block type; however, it would make a really terrible external\nattribute block.  The reason why we use the verified flag is to avoid\nconstantly reverifying the block.  However, it doesn't take much\noverhead to make sure the magic number of the xattr block is correct,\nand this will avoid potential crashes.\n\nThis addresses CVE-2018-10879.\n\nhttps:\/\/bugzilla.kernel.org\/show_bug.cgi?id=200001\n\nSigned-off-by: Theodore Ts'o <tytso@mit.edu>\nReviewed-by: Andreas Dilger <adilger@dilger.ca>\nCc: stable@kernel.org\n---\n fs\/ext4\/xattr.c | 6 +++---\n 1 file changed, 3 insertions(+), 3 deletions(-)\n\n","diff_code":"diff --git a\/fs\/ext4\/xattr.c b\/fs\/ext4\/xattr.c\nindex 230ba79715f6..0263692979ec 100644\n--- a\/fs\/ext4\/xattr.c\n+++ b\/fs\/ext4\/xattr.c\n@@ -230,12 +230,12 @@ __ext4_xattr_check_block(struct inode *inode, struct buffer_head *bh,\n {\n \tint error = -EFSCORRUPTED;\n \n-\tif (buffer_verified(bh))\n-\t\treturn 0;\n-\n \tif (BHDR(bh)->h_magic != cpu_to_le32(EXT4_XATTR_MAGIC) ||\n \t    BHDR(bh)->h_blocks != cpu_to_le32(1))\n \t\tgoto errout;\n+\tif (buffer_verified(bh))\n+\t\treturn 0;\n+\n \terror = -EFSBADCRC;\n \tif (!ext4_xattr_block_csum_verify(inode, bh))\n \t\tgoto errout;\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2018-1000037","CWE_ID":"416","category":"security","commit_id":"71ceebcf56e682504da22c4035b39a2d451e8ffd","commit_message":"From 71ceebcf56e682504da22c4035b39a2d451e8ffd Mon Sep 17 00:00:00 2001\nFrom: Sebastian Rasmussen <sebras@gmail.com>\nDate: Tue, 23 Jan 2018 03:04:33 +0100\nSubject: [PATCH 1\/1] Bug 698888: Keep one-to-many state when splitting nodes\n in cmap splay trees.\n\nThanks to oss-fuzz for reporting this.\n---\n source\/pdf\/pdf-cmap.c | 2 +-\n 1 file changed, 1 insertion(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/source\/pdf\/pdf-cmap.c b\/source\/pdf\/pdf-cmap.c\nindex ade72c4..bedc130 100644\n--- a\/source\/pdf\/pdf-cmap.c\n+++ b\/source\/pdf\/pdf-cmap.c\n@@ -520,7 +520,7 @@ add_range(fz_context *ctx, pdf_cmap *cmap, unsigned int low, unsigned int high,\n \t\t\t\t\t\/* case 3, reduces to case 5 *\/\n \t\t\t\t\tint new_high = tree[current].high;\n \t\t\t\t\ttree[current].high = low-1;\n-\t\t\t\t\tadd_range(ctx, cmap, high+1, new_high, tree[current].out + high + 1 - tree[current].low, 0, many);\n+\t\t\t\t\tadd_range(ctx, cmap, high+1, new_high, tree[current].out + high + 1 - tree[current].low, 0, tree[current].many);\n \t\t\t\t}\n \t\t\t\t\/* Now look for where to move to next (left for case 0, right for case 5) *\/\n \t\t\t\tif (tree[current].low > high) {\n-- \n2.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2017-18017","CWE_ID":"416","category":"security","commit_id":"2638fd0f92d4397884fd991d8f4925cb3f081901","commit_message":"From 2638fd0f92d4397884fd991d8f4925cb3f081901 Mon Sep 17 00:00:00 2001\nFrom: Eric Dumazet <edumazet@google.com>\nDate: Mon, 3 Apr 2017 10:55:11 -0700\nSubject: netfilter: xt_TCPMSS: add more sanity tests on tcph->doff\n\nDenys provided an awesome KASAN report pointing to an use\nafter free in xt_TCPMSS\n\nI have provided three patches to fix this issue, either in xt_TCPMSS or\nin xt_tcpudp.c. It seems xt_TCPMSS patch has the smallest possible\nimpact.\n\nSigned-off-by: Eric Dumazet <edumazet@google.com>\nReported-by: Denys Fedoryshchenko <nuclearcat@nuclearcat.com>\nSigned-off-by: Pablo Neira Ayuso <pablo@netfilter.org>\n---\n net\/netfilter\/xt_TCPMSS.c | 6 +++++-\n 1 file changed, 5 insertions(+), 1 deletion(-)\n\n","diff_code":"diff --git a\/net\/netfilter\/xt_TCPMSS.c b\/net\/netfilter\/xt_TCPMSS.c\nindex 27241a767f17..c64aca611ac5 100644\n--- a\/net\/netfilter\/xt_TCPMSS.c\n+++ b\/net\/netfilter\/xt_TCPMSS.c\n@@ -104,7 +104,7 @@ tcpmss_mangle_packet(struct sk_buff *skb,\n \ttcph = (struct tcphdr *)(skb_network_header(skb) + tcphoff);\n \ttcp_hdrlen = tcph->doff * 4;\n \n-\tif (len < tcp_hdrlen)\n+\tif (len < tcp_hdrlen || tcp_hdrlen < sizeof(struct tcphdr))\n \t\treturn -1;\n \n \tif (info->mss == XT_TCPMSS_CLAMP_PMTU) {\n@@ -152,6 +152,10 @@ tcpmss_mangle_packet(struct sk_buff *skb,\n \tif (len > tcp_hdrlen)\n \t\treturn 0;\n \n+\t\/* tcph->doff has 4 bits, do not wrap it to 0 *\/\n+\tif (tcp_hdrlen >= 15 * 4)\n+\t\treturn 0;\n+\n \t\/*\n \t * MSS Option not found ?! add it..\n \t *\/\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2016-1837","CWE_ID":"416","category":"security","commit_id":"11ed4a7a90d5ce156a18980a4ad4e53e77384852","commit_message":"From 11ed4a7a90d5ce156a18980a4ad4e53e77384852 Mon Sep 17 00:00:00 2001\nFrom: Pranjal Jumde <pjumde@apple.com>\nDate: Wed, 2 Mar 2016 15:52:24 -0800\nSubject: [PATCH] Heap use-after-free in htmlParsePubidLiteral and\n htmlParseSystemiteral\n\nFor https:\/\/bugzilla.gnome.org\/show_bug.cgi?id=760263\n\n* HTMLparser.c: Add BASE_PTR convenience macro.\n(htmlParseSystemLiteral): Store length and start position instead\nof a pointer while iterating through the public identifier since\nthe underlying buffer may change, resulting in a stale pointer\nbeing used.\n(htmlParsePubidLiteral): Ditto.\n---\n HTMLparser.c | 58 ++++++++++++++++++++++++++++++++++++++--------------\n 1 file changed, 43 insertions(+), 15 deletions(-)\n\n","diff_code":"diff --git a\/HTMLparser.c b\/HTMLparser.c\nindex 0985d1d9..d1395fa5 100644\n--- a\/HTMLparser.c\n+++ b\/HTMLparser.c\n@@ -303,6 +303,7 @@ htmlNodeInfoPop(htmlParserCtxtPtr ctxt)\n #define UPP(val) (toupper(ctxt->input->cur[(val)]))\n \n #define CUR_PTR ctxt->input->cur\n+#define BASE_PTR ctxt->input->base\n \n #define SHRINK if ((ctxt->input->cur - ctxt->input->base > 2 * INPUT_CHUNK) && \\\n \t\t   (ctxt->input->end - ctxt->input->cur < 2 * INPUT_CHUNK)) \\\n@@ -2781,31 +2782,43 @@ htmlParseAttValue(htmlParserCtxtPtr ctxt) {\n \n static xmlChar *\n htmlParseSystemLiteral(htmlParserCtxtPtr ctxt) {\n-    const xmlChar *q;\n+    size_t len = 0, startPosition = 0;\n     xmlChar *ret = NULL;\n \n     if (CUR == '\"') {\n         NEXT;\n-\tq = CUR_PTR;\n-\twhile ((IS_CHAR_CH(CUR)) && (CUR != '\"'))\n+\n+        if (CUR_PTR < BASE_PTR)\n+            return(ret);\n+        startPosition = CUR_PTR - BASE_PTR;\n+\n+\twhile ((IS_CHAR_CH(CUR)) && (CUR != '\"')) {\n \t    NEXT;\n+\t    len++;\n+\t}\n \tif (!IS_CHAR_CH(CUR)) {\n \t    htmlParseErr(ctxt, XML_ERR_LITERAL_NOT_FINISHED,\n \t\t\t \"Unfinished SystemLiteral\\n\", NULL, NULL);\n \t} else {\n-\t    ret = xmlStrndup(q, CUR_PTR - q);\n+\t    ret = xmlStrndup((BASE_PTR+startPosition), len);\n \t    NEXT;\n         }\n     } else if (CUR == '\\'') {\n         NEXT;\n-\tq = CUR_PTR;\n-\twhile ((IS_CHAR_CH(CUR)) && (CUR != '\\''))\n+\n+        if (CUR_PTR < BASE_PTR)\n+            return(ret);\n+        startPosition = CUR_PTR - BASE_PTR;\n+\n+\twhile ((IS_CHAR_CH(CUR)) && (CUR != '\\'')) {\n \t    NEXT;\n+\t    len++;\n+\t}\n \tif (!IS_CHAR_CH(CUR)) {\n \t    htmlParseErr(ctxt, XML_ERR_LITERAL_NOT_FINISHED,\n \t\t\t \"Unfinished SystemLiteral\\n\", NULL, NULL);\n \t} else {\n-\t    ret = xmlStrndup(q, CUR_PTR - q);\n+\t    ret = xmlStrndup((BASE_PTR+startPosition), len);\n \t    NEXT;\n         }\n     } else {\n@@ -2829,32 +2842,47 @@ htmlParseSystemLiteral(htmlParserCtxtPtr ctxt) {\n \n static xmlChar *\n htmlParsePubidLiteral(htmlParserCtxtPtr ctxt) {\n-    const xmlChar *q;\n+    size_t len = 0, startPosition = 0;\n     xmlChar *ret = NULL;\n     \/*\n      * Name ::= (Letter | '_') (NameChar)*\n      *\/\n     if (CUR == '\"') {\n         NEXT;\n-\tq = CUR_PTR;\n-\twhile (IS_PUBIDCHAR_CH(CUR)) NEXT;\n+\n+        if (CUR_PTR < BASE_PTR)\n+            return(ret);\n+        startPosition = CUR_PTR - BASE_PTR;\n+\n+        while (IS_PUBIDCHAR_CH(CUR)) {\n+            len++;\n+            NEXT;\n+        }\n+\n \tif (CUR != '\"') {\n \t    htmlParseErr(ctxt, XML_ERR_LITERAL_NOT_FINISHED,\n \t                 \"Unfinished PubidLiteral\\n\", NULL, NULL);\n \t} else {\n-\t    ret = xmlStrndup(q, CUR_PTR - q);\n+\t    ret = xmlStrndup((BASE_PTR + startPosition), len);\n \t    NEXT;\n \t}\n     } else if (CUR == '\\'') {\n         NEXT;\n-\tq = CUR_PTR;\n-\twhile ((IS_PUBIDCHAR_CH(CUR)) && (CUR != '\\''))\n-\t    NEXT;\n+\n+        if (CUR_PTR < BASE_PTR)\n+            return(ret);\n+        startPosition = CUR_PTR - BASE_PTR;\n+\n+        while ((IS_PUBIDCHAR_CH(CUR)) && (CUR != '\\'')){\n+            len++;\n+            NEXT;\n+        }\n+\n \tif (CUR != '\\'') {\n \t    htmlParseErr(ctxt, XML_ERR_LITERAL_NOT_FINISHED,\n \t                 \"Unfinished PubidLiteral\\n\", NULL, NULL);\n \t} else {\n-\t    ret = xmlStrndup(q, CUR_PTR - q);\n+\t    ret = xmlStrndup((BASE_PTR + startPosition), len);\n \t    NEXT;\n \t}\n     } else {\n-- \n2.21.0\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2018-1000039","CWE_ID":"416","category":"security","commit_id":"f597300439e62f5e921f0d7b1e880b5c1a1f1607","commit_message":"From f597300439e62f5e921f0d7b1e880b5c1a1f1607 Mon Sep 17 00:00:00 2001\nFrom: Sebastian Rasmussen <sebras@gmail.com>\nDate: Tue, 23 Jan 2018 23:02:16 +0100\nSubject: [PATCH 1\/1] Bug 698883: Reset cmap splay tree pointer, handling\n resized tree.\n\nWithout this change a resized cmap splay tree leads to using stale pointers.\n---\n source\/pdf\/pdf-cmap.c | 1 +\n 1 file changed, 1 insertion(+)\n\n","diff_code":"diff --git a\/source\/pdf\/pdf-cmap.c b\/source\/pdf\/pdf-cmap.c\nindex 29d9c50..00e2afb 100644\n--- a\/source\/pdf\/pdf-cmap.c\n+++ b\/source\/pdf\/pdf-cmap.c\n@@ -525,6 +525,7 @@ add_range(fz_context *ctx, pdf_cmap *cmap, unsigned int low, unsigned int high,\n \t\t\t\t\tint new_high = tree[current].high;\n \t\t\t\t\ttree[current].high = low-1;\n \t\t\t\t\tadd_range(ctx, cmap, high+1, new_high, tree[current].out + high + 1 - tree[current].low, 0, tree[current].many);\n+\t\t\t\t\ttree = cmap->tree;\n \t\t\t\t}\n \t\t\t\t\/* Now look for where to move to next (left for case 0, right for case 5) *\/\n \t\t\t\tif (tree[current].low > high) {\n-- \n2.9.1\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2017-18218","CWE_ID":"416","category":"security","commit_id":"27463ad99f738ed93c7c8b3e2e5bc8c4853a2ff2","commit_message":"From 27463ad99f738ed93c7c8b3e2e5bc8c4853a2ff2 Mon Sep 17 00:00:00 2001\nFrom: Yunsheng Lin <linyunsheng@huawei.com>\nDate: Thu, 6 Jul 2017 10:22:00 +0800\nSubject: net: hns: Fix a skb used after free bug\n\nskb maybe freed in hns_nic_net_xmit_hw() and return NETDEV_TX_OK,\nwhich cause hns_nic_net_xmit to use a freed skb.\n\nBUG: KASAN: use-after-free in hns_nic_net_xmit_hw+0x62c\/0x940...\n\t[17659.112635]      alloc_debug_processing+0x18c\/0x1a0\n\t[17659.117208]      __slab_alloc+0x52c\/0x560\n\t[17659.120909]      kmem_cache_alloc_node+0xac\/0x2c0\n\t[17659.125309]      __alloc_skb+0x6c\/0x260\n\t[17659.128837]      tcp_send_ack+0x8c\/0x280\n\t[17659.132449]      __tcp_ack_snd_check+0x9c\/0xf0\n\t[17659.136587]      tcp_rcv_established+0x5a4\/0xa70\n\t[17659.140899]      tcp_v4_do_rcv+0x27c\/0x620\n\t[17659.144687]      tcp_prequeue_process+0x108\/0x170\n\t[17659.149085]      tcp_recvmsg+0x940\/0x1020\n\t[17659.152787]      inet_recvmsg+0x124\/0x180\n\t[17659.156488]      sock_recvmsg+0x64\/0x80\n\t[17659.160012]      SyS_recvfrom+0xd8\/0x180\n\t[17659.163626]      __sys_trace_return+0x0\/0x4\n\t[17659.167506] INFO: Freed in kfree_skbmem+0xa0\/0xb0 age=23 cpu=1 pid=13\n\t[17659.174000]      free_debug_processing+0x1d4\/0x2c0\n\t[17659.178486]      __slab_free+0x240\/0x390\n\t[17659.182100]      kmem_cache_free+0x24c\/0x270\n\t[17659.186062]      kfree_skbmem+0xa0\/0xb0\n\t[17659.189587]      __kfree_skb+0x28\/0x40\n\t[17659.193025]      napi_gro_receive+0x168\/0x1c0\n\t[17659.197074]      hns_nic_rx_up_pro+0x58\/0x90\n\t[17659.201038]      hns_nic_rx_poll_one+0x518\/0xbc0\n\t[17659.205352]      hns_nic_common_poll+0x94\/0x140\n\t[17659.209576]      net_rx_action+0x458\/0x5e0\n\t[17659.213363]      __do_softirq+0x1b8\/0x480\n\t[17659.217062]      run_ksoftirqd+0x64\/0x80\n\t[17659.220679]      smpboot_thread_fn+0x224\/0x310\n\t[17659.224821]      kthread+0x150\/0x170\n\t[17659.228084]      ret_from_fork+0x10\/0x40\n\n\tBUG: KASAN: use-after-free in hns_nic_net_xmit+0x8c\/0xc0...\n\t[17751.080490]      __slab_alloc+0x52c\/0x560\n\t[17751.084188]      kmem_cache_alloc+0x244\/0x280\n\t[17751.088238]      __build_skb+0x40\/0x150\n\t[17751.091764]      build_skb+0x28\/0x100\n\t[17751.095115]      __alloc_rx_skb+0x94\/0x150\n\t[17751.098900]      __napi_alloc_skb+0x34\/0x90\n\t[17751.102776]      hns_nic_rx_poll_one+0x180\/0xbc0\n\t[17751.107097]      hns_nic_common_poll+0x94\/0x140\n\t[17751.111333]      net_rx_action+0x458\/0x5e0\n\t[17751.115123]      __do_softirq+0x1b8\/0x480\n\t[17751.118823]      run_ksoftirqd+0x64\/0x80\n\t[17751.122437]      smpboot_thread_fn+0x224\/0x310\n\t[17751.126575]      kthread+0x150\/0x170\n\t[17751.129838]      ret_from_fork+0x10\/0x40\n\t[17751.133454] INFO: Freed in kfree_skbmem+0xa0\/0xb0 age=19 cpu=7 pid=43\n\t[17751.139951]      free_debug_processing+0x1d4\/0x2c0\n\t[17751.144436]      __slab_free+0x240\/0x390\n\t[17751.148051]      kmem_cache_free+0x24c\/0x270\n\t[17751.152014]      kfree_skbmem+0xa0\/0xb0\n\t[17751.155543]      __kfree_skb+0x28\/0x40\n\t[17751.159022]      napi_gro_receive+0x168\/0x1c0\n\t[17751.163074]      hns_nic_rx_up_pro+0x58\/0x90\n\t[17751.167041]      hns_nic_rx_poll_one+0x518\/0xbc0\n\t[17751.171358]      hns_nic_common_poll+0x94\/0x140\n\t[17751.175585]      net_rx_action+0x458\/0x5e0\n\t[17751.179373]      __do_softirq+0x1b8\/0x480\n\t[17751.183076]      run_ksoftirqd+0x64\/0x80\n\t[17751.186691]      smpboot_thread_fn+0x224\/0x310\n\t[17751.190826]      kthread+0x150\/0x170\n\t[17751.194093]      ret_from_fork+0x10\/0x40\n\nFixes: 13ac695e7ea1 (\"net:hns: Add support of Hip06 SoC to the Hislicon Network Subsystem\")\nSigned-off-by: Yunsheng Lin <linyunsheng@huawei.com>\nSigned-off-by: lipeng <lipeng321@huawei.com>\nReported-by: Jun He <hjat2005@huawei.com>\nSigned-off-by: David S. Miller <davem@davemloft.net>\n---\n drivers\/net\/ethernet\/hisilicon\/hns\/hns_enet.c | 22 ++++++++++------------\n drivers\/net\/ethernet\/hisilicon\/hns\/hns_enet.h |  6 +++---\n 2 files changed, 13 insertions(+), 15 deletions(-)\n\n","diff_code":"diff --git a\/drivers\/net\/ethernet\/hisilicon\/hns\/hns_enet.c b\/drivers\/net\/ethernet\/hisilicon\/hns\/hns_enet.c\nindex c6700b91a2df..fe166e0f6781 100644\n--- a\/drivers\/net\/ethernet\/hisilicon\/hns\/hns_enet.c\n+++ b\/drivers\/net\/ethernet\/hisilicon\/hns\/hns_enet.c\n@@ -300,9 +300,9 @@ static void fill_tso_desc(struct hnae_ring *ring, void *priv,\n \t\t\t     mtu);\n }\n \n-int hns_nic_net_xmit_hw(struct net_device *ndev,\n-\t\t\tstruct sk_buff *skb,\n-\t\t\tstruct hns_nic_ring_data *ring_data)\n+netdev_tx_t hns_nic_net_xmit_hw(struct net_device *ndev,\n+\t\t\t\tstruct sk_buff *skb,\n+\t\t\t\tstruct hns_nic_ring_data *ring_data)\n {\n \tstruct hns_nic_priv *priv = netdev_priv(ndev);\n \tstruct hnae_ring *ring = ring_data->ring;\n@@ -361,6 +361,10 @@ int hns_nic_net_xmit_hw(struct net_device *ndev,\n \tdev_queue = netdev_get_tx_queue(ndev, skb->queue_mapping);\n \tnetdev_tx_sent_queue(dev_queue, skb->len);\n \n+\tnetif_trans_update(ndev);\n+\tndev->stats.tx_bytes += skb->len;\n+\tndev->stats.tx_packets++;\n+\n \twmb(); \/* commit all data before submit *\/\n \tassert(skb->queue_mapping < priv->ae_handle->q_num);\n \thnae_queue_xmit(priv->ae_handle->qs[skb->queue_mapping], buf_num);\n@@ -1469,17 +1473,11 @@ static netdev_tx_t hns_nic_net_xmit(struct sk_buff *skb,\n \t\t\t\t    struct net_device *ndev)\n {\n \tstruct hns_nic_priv *priv = netdev_priv(ndev);\n-\tint ret;\n \n \tassert(skb->queue_mapping < ndev->ae_handle->q_num);\n-\tret = hns_nic_net_xmit_hw(ndev, skb,\n-\t\t\t\t  &tx_ring_data(priv, skb->queue_mapping));\n-\tif (ret == NETDEV_TX_OK) {\n-\t\tnetif_trans_update(ndev);\n-\t\tndev->stats.tx_bytes += skb->len;\n-\t\tndev->stats.tx_packets++;\n-\t}\n-\treturn (netdev_tx_t)ret;\n+\n+\treturn hns_nic_net_xmit_hw(ndev, skb,\n+\t\t\t\t   &tx_ring_data(priv, skb->queue_mapping));\n }\n \n static void hns_nic_drop_rx_fetch(struct hns_nic_ring_data *ring_data,\ndiff --git a\/drivers\/net\/ethernet\/hisilicon\/hns\/hns_enet.h b\/drivers\/net\/ethernet\/hisilicon\/hns\/hns_enet.h\nindex 1b83232082b2..9cb4c7884201 100644\n--- a\/drivers\/net\/ethernet\/hisilicon\/hns\/hns_enet.h\n+++ b\/drivers\/net\/ethernet\/hisilicon\/hns\/hns_enet.h\n@@ -92,8 +92,8 @@ void hns_ethtool_set_ops(struct net_device *ndev);\n void hns_nic_net_reset(struct net_device *ndev);\n void hns_nic_net_reinit(struct net_device *netdev);\n int hns_nic_init_phy(struct net_device *ndev, struct hnae_handle *h);\n-int hns_nic_net_xmit_hw(struct net_device *ndev,\n-\t\t\tstruct sk_buff *skb,\n-\t\t\tstruct hns_nic_ring_data *ring_data);\n+netdev_tx_t hns_nic_net_xmit_hw(struct net_device *ndev,\n+\t\t\t\tstruct sk_buff *skb,\n+\t\t\t\tstruct hns_nic_ring_data *ring_data);\n \n #endif\t\/**__HNS_ENET_H *\/\n-- \ncgit 1.2-0.3.lf.el7\n\n","owner":"torvalds","repo":"linux","source":"cve"},{"CVE_ID":"CVE-2017-11143","CWE_ID":"416","category":"security","commit_id":"2aae60461c2ff7b7fbcdd194c789ac841d0747d7","commit_message":"From 2aae60461c2ff7b7fbcdd194c789ac841d0747d7 Mon Sep 17 00:00:00 2001\nFrom: Stanislav Malyshev <stas@php.net>\nDate: Sun, 2 Jul 2017 14:25:54 -0700\nSubject: [PATCH] Fix bug #74145 - wddx parsing empty boolean tag leads to\n SIGSEGV\n\n---\n ext\/wddx\/tests\/bug74145.phpt | 16 ++++++++++++++++\n ext\/wddx\/tests\/bug74145.xml  |  9 +++++++++\n ext\/wddx\/wddx.c              | 15 ++++++---------\n 3 files changed, 31 insertions(+), 9 deletions(-)\n create mode 100644 ext\/wddx\/tests\/bug74145.phpt\n create mode 100644 ext\/wddx\/tests\/bug74145.xml\n\n","diff_code":"diff --git a\/ext\/wddx\/tests\/bug74145.phpt b\/ext\/wddx\/tests\/bug74145.phpt\nnew file mode 100644\nindex 0000000..a99a117\n--- \/dev\/null\n+++ b\/ext\/wddx\/tests\/bug74145.phpt\n@@ -0,0 +1,16 @@\n+--TEST--\n+Bug #74145 (wddx parsing empty boolean tag leads to SIGSEGV)\n+--SKIPIF--\n+<?php\n+if (!extension_loaded(\"wddx\")) print \"skip\";\n+?>\n+--FILE--\n+<?php\n+$data = file_get_contents(__DIR__ . '\/bug74145.xml');\n+$wddx = wddx_deserialize($data);\n+var_dump($wddx);\n+?>\n+DONE\n+--EXPECTF--\n+NULL\n+DONE\n\\ No newline at end of file\ndiff --git a\/ext\/wddx\/tests\/bug74145.xml b\/ext\/wddx\/tests\/bug74145.xml\nnew file mode 100644\nindex 0000000..e5d35fb\n--- \/dev\/null\n+++ b\/ext\/wddx\/tests\/bug74145.xml\n@@ -0,0 +1,9 @@\n+<?xml version='1.0' ?>\n+    <!DOCTYPE et SYSTEM 'w'>\n+    <wddxPacket ven='1.0'>\n+        <array>\n+            <var Name=\"name\">\n+                <boolean \u0002><\/boolean>\n+            <\/var>\n+        <\/array>\n+    <\/wddxPacket>\ndiff --git a\/ext\/wddx\/wddx.c b\/ext\/wddx\/wddx.c\nindex 72d2408..41fdd3d 100644\n--- a\/ext\/wddx\/wddx.c\n+++ b\/ext\/wddx\/wddx.c\n@@ -799,22 +799,19 @@ static void php_wddx_push_element(void *user_data, const XML_Char *name, const X\n \t} else if (!strcmp(name, EL_BOOLEAN)) {\n \t\tint i;\n \n+\t\tALLOC_ZVAL(ent.data);\n+\t\tINIT_PZVAL(ent.data);\n+\t\tZ_TYPE_P(ent.data) = IS_BOOL;\n+\t\tent.type = ST_BOOLEAN;\n+\t\tSET_STACK_VARNAME;\n \t\tif (atts) for (i = 0; atts[i]; i++) {\n \t\t\tif (!strcmp(atts[i], EL_VALUE) && atts[i+1] && atts[i+1][0]) {\n-\t\t\t\tent.type = ST_BOOLEAN;\n-\t\t\t\tSET_STACK_VARNAME;\n-\n-\t\t\t\tALLOC_ZVAL(ent.data);\n-\t\t\t\tINIT_PZVAL(ent.data);\n-\t\t\t\tZ_TYPE_P(ent.data) = IS_BOOL;\n \t\t\t\twddx_stack_push((wddx_stack *)stack, &ent, sizeof(st_entry));\n \t\t\t\tphp_wddx_process_data(user_data, atts[i+1], strlen(atts[i+1]));\n \t\t\t\tbreak;\n \t\t\t}\n \t\t} else {\n-\t\t\tent.type = ST_BOOLEAN;\n-\t\t\tSET_STACK_VARNAME;\n-\t\t\tZVAL_FALSE(&ent.data);\n+\t\t\tZVAL_FALSE(ent.data);\n \t\t\twddx_stack_push((wddx_stack *)stack, &ent, sizeof(st_entry));\n \t\t}\n \t} else if (!strcmp(name, EL_NULL)) {\n-- \n2.1.4\n\n","owner":"NA","repo":"NA","source":"cve"},{"CVE_ID":"CVE-2017-9520","CWE_ID":"416","category":"security","commit_id":"f85bc674b2a2256a364fe796351bc1971e106005","commit_message":"From f85bc674b2a2256a364fe796351bc1971e106005 Mon Sep 17 00:00:00 2001\nFrom: pancake <pancake@nopcode.org>\nDate: Wed, 7 Jun 2017 23:50:59 +0200\nSubject: [PATCH] Fix #7698 - UAF in r_config_set when loading a dex\n\n---\n libr\/config\/config.c | 3 ++-\n libr\/core\/cbin.c     | 9 ++++++---\n 2 files changed, 8 insertions(+), 4 deletions(-)\n\n","diff_code":"diff --git a\/libr\/config\/config.c b\/libr\/config\/config.c\nindex 4eaa7b876c..c2b3662b29 100644\n--- a\/libr\/config\/config.c\n+++ b\/libr\/config\/config.c\n@@ -388,8 +388,9 @@ R_API RConfigNode* r_config_set(RConfig *cfg, const char *name, const char *valu\n \t\t\t\tif (node->value == value) {\n \t\t\t\t\tgoto beach;\n \t\t\t\t}\n-\t\t\t\tfree (node->value);\n+\t\t\t\tchar *tmp = node->value;\n \t\t\t\tnode->value = strdup (value);\n+\t\t\t\tfree (tmp);\n \t\t\t\tif (IS_DIGIT (*value)) {\n \t\t\t\t\tif (strchr (value, '\/')) {\n \t\t\t\t\t\tnode->i_value = r_num_get (cfg->num, value);\ndiff --git a\/libr\/core\/cbin.c b\/libr\/core\/cbin.c\nindex 65e088aee2..add791c1c7 100644\n--- a\/libr\/core\/cbin.c\n+++ b\/libr\/core\/cbin.c\n@@ -96,7 +96,8 @@ R_API int r_core_bin_set_env(RCore *r, RBinFile *binfile) {\n \tRBinInfo *info = binobj ? binobj->info: NULL;\n \tif (info) {\n \t\tint va = info->has_va;\n-\t\tconst char * arch = info->arch;\n+\t\tchar * arch = strdup(info->arch);\n+\t\tchar * cpu = info->cpu? strdup(info->cpu): NULL;\n \t\tut16 bits = info->bits;\n \t\tut64 baseaddr = r_bin_get_baddr (r->bin);\n \t\t\/* Hack to make baddr work on some corner *\/\n@@ -106,14 +107,16 @@ R_API int r_core_bin_set_env(RCore *r, RBinFile *binfile) {\n \t\tr_config_set (r->config, \"asm.arch\", arch);\n \t\tr_config_set_i (r->config, \"asm.bits\", bits);\n \t\tr_config_set (r->config, \"anal.arch\", arch);\n-\t\tif (info->cpu && *info->cpu) {\n-\t\t\tr_config_set (r->config, \"anal.cpu\", info->cpu);\n+\t\tif (cpu && *cpu) {\n+\t\t\tr_config_set (r->config, \"anal.cpu\", cpu);\n \t\t} else {\n \t\t\tr_config_set (r->config, \"anal.cpu\", arch);\n \t\t}\n \t\tr_asm_use (r->assembler, arch);\n \t\tr_core_bin_info (r, R_CORE_BIN_ACC_ALL, R_CORE_BIN_SET, va, NULL, NULL);\n \t\tr_core_bin_set_cur (r, binfile);\n+\t\tfree (cpu);\n+\t\tfree (arch);\n \t\treturn true;\n \t}\n \treturn false;\n","owner":"radare","repo":"radare2","source":"cve"},{"CVE_ID":"CVE-2016-6295","CWE_ID":"416","category":"security","commit_id":"cab1c3b3708eead315e033359d07049b23b147a3","commit_message":"From cab1c3b3708eead315e033359d07049b23b147a3 Mon Sep 17 00:00:00 2001\nFrom: Stanislav Malyshev <stas@php.net>\nDate: Sun, 26 Jun 2016 17:52:09 -0700\nSubject: [PATCH] Fixed bug #72479 - same as #72434\n\n---\n ext\/snmp\/snmp.c              | 89 ++++++++++++++++++++++++--------------------\n ext\/snmp\/tests\/bug72479.phpt | 35 +++++++++++++++++\n 2 files changed, 84 insertions(+), 40 deletions(-)\n create mode 100644 ext\/snmp\/tests\/bug72479.phpt\n\n","diff_code":"diff --git a\/ext\/snmp\/snmp.c b\/ext\/snmp\/snmp.c\nindex 6c1da4c..e1161c7 100644\n--- a\/ext\/snmp\/snmp.c\n+++ b\/ext\/snmp\/snmp.c\n@@ -475,7 +475,7 @@ static void php_snmp_session_destructor(zend_rsrc_list_entry *rsrc TSRMLS_DC)\n static void php_snmp_object_free_storage(void *object TSRMLS_DC)\n {\n \tphp_snmp_object *intern = (php_snmp_object *)object;\n-\t\n+\n \tif (!intern) {\n \t\treturn;\n \t}\n@@ -483,7 +483,7 @@ static void php_snmp_object_free_storage(void *object TSRMLS_DC)\n \tnetsnmp_session_free(&(intern->session));\n \n \tzend_object_std_dtor(&intern->zo TSRMLS_CC);\n-\t\n+\n \tefree(intern);\n }\n \n@@ -503,7 +503,7 @@ static zend_object_value php_snmp_object_new(zend_class_entry *class_type TSRMLS\n \tretval.handlers = (zend_object_handlers *) &php_snmp_object_handlers;\n \n \treturn retval;\n-\t\n+\n }\n \n \/* {{{ php_snmp_error\n@@ -556,7 +556,7 @@ static void php_snmp_getvalue(struct variable_list *vars, zval *snmpval TSRMLS_D\n \tchar *dbuf = (char *)NULL;\n \tint buflen = sizeof(sbuf) - 1;\n \tint val_len = vars->val_len;\n-\t\n+\n \t\/* use emalloc() for large values, use static array otherwize *\/\n \n \t\/* There is no way to know the size of buffer snprint_value() needs in order to print a value there.\n@@ -702,7 +702,7 @@ static void php_snmp_getvalue(struct variable_list *vars, zval *snmpval TSRMLS_D\n * SNMP object fetcher\/setter for all SNMP versions\n *\n *\/\n-static void php_snmp_internal(INTERNAL_FUNCTION_PARAMETERS, int st, \n+static void php_snmp_internal(INTERNAL_FUNCTION_PARAMETERS, int st,\n \t\t\t\t\t\t\tstruct snmp_session *session,\n \t\t\t\t\t\t\tstruct objid_query *objid_query)\n {\n@@ -721,7 +721,7 @@ static void php_snmp_internal(INTERNAL_FUNCTION_PARAMETERS, int st,\n \n \t\/* we start with retval=FALSE. If any actual data is acquired, retval will be set to appropriate type *\/\n \tRETVAL_FALSE;\n-\t\n+\n \t\/* reset errno and errstr *\/\n \tphp_snmp_error(getThis(), NULL TSRMLS_CC, PHP_SNMP_ERRNO_NOERROR, \"\");\n \n@@ -805,8 +805,8 @@ retry:\n \t\t\t\t}\n \t\t\t\tfor (vars = response->variables; vars; vars = vars->next_variable) {\n \t\t\t\t\t\/* do not output errors as values *\/\n-\t\t\t\t\tif ( \tvars->type == SNMP_ENDOFMIBVIEW || \n-\t\t\t\t\t\tvars->type == SNMP_NOSUCHOBJECT || \n+\t\t\t\t\tif ( \tvars->type == SNMP_ENDOFMIBVIEW ||\n+\t\t\t\t\t\tvars->type == SNMP_NOSUCHOBJECT ||\n \t\t\t\t\t\tvars->type == SNMP_NOSUCHINSTANCE ) {\n \t\t\t\t\t\tif ((st & SNMP_CMD_WALK) && Z_TYPE_P(return_value) == IS_ARRAY) {\n \t\t\t\t\t\t\tbreak;\n@@ -816,8 +816,8 @@ retry:\n \t\t\t\t\t\tphp_snmp_error(getThis(), NULL TSRMLS_CC, PHP_SNMP_ERRNO_ERROR_IN_REPLY, \"Error in packet at '%s': %s\", buf, buf2);\n \t\t\t\t\t\tcontinue;\n \t\t\t\t\t}\n-\t\t\t\t\t\n-\t\t\t\t\tif ((st & SNMP_CMD_WALK) && \n+\n+\t\t\t\t\tif ((st & SNMP_CMD_WALK) &&\n \t\t\t\t\t\t(vars->name_length < rootlen || memcmp(root, vars->name, rootlen * sizeof(oid)))) { \/* not part of this subtree *\/\n \t\t\t\t\t\tif (Z_TYPE_P(return_value) == IS_ARRAY) { \/* some records are fetched already, shut down further lookup *\/\n \t\t\t\t\t\t\tkeepwalking = 0;\n@@ -1101,7 +1101,7 @@ static int php_snmp_parse_oid(zval *object, int st, struct objid_query *objid_qu\n \t\t\t\tefree(objid_query->vars);\n \t\t\t\treturn FALSE;\n \t\t\t}\n-\t\t} else { \n+\t\t} else {\n \t\t\tmemmove((char *)objid_query->vars[0].name, (char *)objid_mib, sizeof(objid_mib));\n \t\t\tobjid_query->vars[0].name_length = sizeof(objid_mib) \/ sizeof(oid);\n \t\t}\n@@ -1437,7 +1437,7 @@ static void php_snmp(INTERNAL_FUNCTION_PARAMETERS, int st, int version)\n \tint session_less_mode = (getThis() == NULL);\n \tphp_snmp_object *snmp_object;\n \tphp_snmp_object glob_snmp_object;\n-\t\n+\n \tobjid_query.max_repetitions = -1;\n \tobjid_query.non_repeaters = 0;\n \tobjid_query.valueretrieval = SNMP_G(valueretrieval);\n@@ -1550,7 +1550,7 @@ static void php_snmp(INTERNAL_FUNCTION_PARAMETERS, int st, int version)\n \t}\n \n \tphp_snmp_internal(INTERNAL_FUNCTION_PARAM_PASSTHRU, st, session, &objid_query);\n-\t\n+\n \tefree(objid_query.vars);\n \n \tif (session_less_mode) {\n@@ -1563,7 +1563,7 @@ static void php_snmp(INTERNAL_FUNCTION_PARAMETERS, int st, int version)\n }\n \/* }}} *\/\n \n-\/* {{{ proto mixed snmpget(string host, string community, mixed object_id [, int timeout [, int retries]]) \n+\/* {{{ proto mixed snmpget(string host, string community, mixed object_id [, int timeout [, int retries]])\n    Fetch a SNMP object *\/\n PHP_FUNCTION(snmpget)\n {\n@@ -1571,7 +1571,7 @@ PHP_FUNCTION(snmpget)\n }\n \/* }}} *\/\n \n-\/* {{{ proto mixed snmpgetnext(string host, string community, mixed object_id [, int timeout [, int retries]]) \n+\/* {{{ proto mixed snmpgetnext(string host, string community, mixed object_id [, int timeout [, int retries]])\n    Fetch a SNMP object *\/\n PHP_FUNCTION(snmpgetnext)\n {\n@@ -1579,7 +1579,7 @@ PHP_FUNCTION(snmpgetnext)\n }\n \/* }}} *\/\n \n-\/* {{{ proto mixed snmpwalk(string host, string community, mixed object_id [, int timeout [, int retries]]) \n+\/* {{{ proto mixed snmpwalk(string host, string community, mixed object_id [, int timeout [, int retries]])\n    Return all objects under the specified object id *\/\n PHP_FUNCTION(snmpwalk)\n {\n@@ -1595,7 +1595,7 @@ PHP_FUNCTION(snmprealwalk)\n }\n \/* }}} *\/\n \n-\/* {{{ proto bool snmpset(string host, string community, mixed object_id, mixed type, mixed value [, int timeout [, int retries]]) \n+\/* {{{ proto bool snmpset(string host, string community, mixed object_id, mixed type, mixed value [, int timeout [, int retries]])\n    Set the value of a SNMP object *\/\n PHP_FUNCTION(snmpset)\n {\n@@ -1642,7 +1642,7 @@ PHP_FUNCTION(snmp_set_enum_print)\n \n \tnetsnmp_ds_set_boolean(NETSNMP_DS_LIBRARY_ID, NETSNMP_DS_LIB_PRINT_NUMERIC_ENUM, (int) a1);\n \tRETURN_TRUE;\n-} \n+}\n \/* }}} *\/\n \n \/* {{{ proto bool snmp_set_oid_output_format(int oid_format)\n@@ -1670,10 +1670,10 @@ PHP_FUNCTION(snmp_set_oid_output_format)\n \t\t\tRETURN_FALSE;\n \t\t\tbreak;\n \t}\n-} \n+}\n \/* }}} *\/\n \n-\/* {{{ proto mixed snmp2_get(string host, string community, mixed object_id [, int timeout [, int retries]]) \n+\/* {{{ proto mixed snmp2_get(string host, string community, mixed object_id [, int timeout [, int retries]])\n    Fetch a SNMP object *\/\n PHP_FUNCTION(snmp2_get)\n {\n@@ -1681,7 +1681,7 @@ PHP_FUNCTION(snmp2_get)\n }\n \/* }}} *\/\n \n-\/* {{{ proto mixed snmp2_getnext(string host, string community, mixed object_id [, int timeout [, int retries]]) \n+\/* {{{ proto mixed snmp2_getnext(string host, string community, mixed object_id [, int timeout [, int retries]])\n    Fetch a SNMP object *\/\n PHP_FUNCTION(snmp2_getnext)\n {\n@@ -1689,7 +1689,7 @@ PHP_FUNCTION(snmp2_getnext)\n }\n \/* }}} *\/\n \n-\/* {{{ proto mixed snmp2_walk(string host, string community, mixed object_id [, int timeout [, int retries]]) \n+\/* {{{ proto mixed snmp2_walk(string host, string community, mixed object_id [, int timeout [, int retries]])\n    Return all objects under the specified object id *\/\n PHP_FUNCTION(snmp2_walk)\n {\n@@ -1705,7 +1705,7 @@ PHP_FUNCTION(snmp2_real_walk)\n }\n \/* }}} *\/\n \n-\/* {{{ proto bool snmp2_set(string host, string community, mixed object_id, mixed type, mixed value [, int timeout [, int retries]]) \n+\/* {{{ proto bool snmp2_set(string host, string community, mixed object_id, mixed type, mixed value [, int timeout [, int retries]])\n    Set the value of a SNMP object *\/\n PHP_FUNCTION(snmp2_set)\n {\n@@ -1821,7 +1821,7 @@ PHP_METHOD(snmp, __construct)\n \n \tsnmp_object = (php_snmp_object *)zend_object_store_get_object(object TSRMLS_CC);\n \tzend_replace_error_handling(EH_THROW, NULL, &error_handling TSRMLS_CC);\n-\t\n+\n \tif (zend_parse_parameters(argc TSRMLS_CC, \"lss|ll\", &version, &a1, &a1_len, &a2, &a2_len, &timeout, &retries) == FAILURE) {\n \t\tzend_restore_error_handling(&error_handling TSRMLS_CC);\n \t\treturn;\n@@ -1843,7 +1843,7 @@ PHP_METHOD(snmp, __construct)\n \tif (snmp_object->session) {\n \t\tnetsnmp_session_free(&(snmp_object->session));\n \t}\n-\t\n+\n \tif (netsnmp_session_init(&(snmp_object->session), version, a1, a2, timeout, retries TSRMLS_CC)) {\n \t\treturn;\n \t}\n@@ -1857,7 +1857,7 @@ PHP_METHOD(snmp, __construct)\n }\n \/* }}} *\/\n \n-\/* {{{ proto bool SNMP::close() \n+\/* {{{ proto bool SNMP::close()\n \tClose SNMP session *\/\n PHP_METHOD(snmp, close)\n {\n@@ -1900,7 +1900,7 @@ PHP_METHOD(snmp, walk)\n }\n \/* }}} *\/\n \n-\/* {{{ proto bool SNMP::set(mixed object_id, mixed type, mixed value) \n+\/* {{{ proto bool SNMP::set(mixed object_id, mixed type, mixed value)\n    Set the value of a SNMP object *\/\n PHP_METHOD(snmp, set)\n {\n@@ -1918,7 +1918,7 @@ PHP_METHOD(snmp, setSecurity)\n \tint argc = ZEND_NUM_ARGS();\n \n \tsnmp_object = (php_snmp_object *)zend_object_store_get_object(object TSRMLS_CC);\n-\t\n+\n \tif (zend_parse_parameters(argc TSRMLS_CC, \"s|ssssss\", &a1, &a1_len, &a2, &a2_len, &a3, &a3_len,\n \t\t&a4, &a4_len, &a5, &a5_len, &a6, &a6_len, &a7, &a7_len) == FAILURE) {\n \t\tRETURN_FALSE;\n@@ -1932,7 +1932,7 @@ PHP_METHOD(snmp, setSecurity)\n }\n \/* }}} *\/\n \n-\/* {{{ proto long SNMP::getErrno() \n+\/* {{{ proto long SNMP::getErrno()\n \tGet last error code number *\/\n PHP_METHOD(snmp, getErrno)\n {\n@@ -1946,7 +1946,7 @@ PHP_METHOD(snmp, getErrno)\n }\n \/* }}} *\/\n \n-\/* {{{ proto long SNMP::getError() \n+\/* {{{ proto long SNMP::getError()\n \tGet last error message *\/\n PHP_METHOD(snmp, getError)\n {\n@@ -2095,6 +2095,14 @@ static int php_snmp_has_property(zval *object, zval *member, int has_set_exists,\n }\n \/* }}} *\/\n \n+static HashTable *php_snmp_get_gc(zval *object, zval ***gc_data, int *gc_data_count TSRMLS_DC) \/* {{{ *\/\n+{\n+\t*gc_data = NULL;\n+\t*gc_data_count = 0;\n+\treturn zend_std_get_properties(object TSRMLS_CC);\n+}\n+\/* }}} *\/\n+\n \/* {{{ php_snmp_get_properties(zval *object)\n    Returns all object properties. Injects SNMP properties into object on first call *\/\n static HashTable *php_snmp_get_properties(zval *object TSRMLS_DC)\n@@ -2137,23 +2145,23 @@ static int php_snmp_read_info(php_snmp_object *snmp_object, zval **retval TSRMLS\n \tif (snmp_object->session == NULL) {\n \t\treturn SUCCESS;\n \t}\n-\t\t\n+\n \tMAKE_STD_ZVAL(val);\n \tZVAL_STRINGL(val, snmp_object->session->peername, strlen(snmp_object->session->peername), 1);\n \tadd_assoc_zval(*retval, \"hostname\", val);\n-\t\n+\n \tMAKE_STD_ZVAL(val);\n \tZVAL_LONG(val, snmp_object->session->remote_port);\n \tadd_assoc_zval(*retval, \"port\", val);\n-\t\n+\n \tMAKE_STD_ZVAL(val);\n \tZVAL_LONG(val, snmp_object->session->timeout);\n \tadd_assoc_zval(*retval, \"timeout\", val);\n-\t\n+\n \tMAKE_STD_ZVAL(val);\n \tZVAL_LONG(val, snmp_object->session->retries);\n \tadd_assoc_zval(*retval, \"retries\", val);\n-\t\n+\n \treturn SUCCESS;\n }\n \/* }}} *\/\n@@ -2226,7 +2234,7 @@ static int php_snmp_write_max_oids(php_snmp_object *snmp_object, zval *newval TS\n \t} else {\n \t\tphp_error_docref(NULL TSRMLS_CC, E_WARNING, \"max_oids should be positive integer or NULL, got %ld\", Z_LVAL_P(newval));\n \t}\n-\t\n+\n \tif (newval == &ztmp) {\n \t\tzval_dtor(newval);\n \t}\n@@ -2254,7 +2262,7 @@ static int php_snmp_write_valueretrieval(php_snmp_object *snmp_object, zval *new\n \t\tphp_error_docref(NULL TSRMLS_CC, E_WARNING, \"Unknown SNMP value retrieval method '%ld'\", Z_LVAL_P(newval));\n \t\tret = FAILURE;\n \t}\n-\t\n+\n \tif (newval == &ztmp) {\n \t\tzval_dtor(newval);\n \t}\n@@ -2297,7 +2305,7 @@ static int php_snmp_write_oid_output_format(php_snmp_object *snmp_object, zval *\n \t\tconvert_to_long(&ztmp);\n \t\tnewval = &ztmp;\n \t}\n-\t\n+\n \tswitch(Z_LVAL_P(newval)) {\n \t\tcase NETSNMP_OID_OUTPUT_SUFFIX:\n \t\tcase NETSNMP_OID_OUTPUT_MODULE:\n@@ -2332,7 +2340,7 @@ static int php_snmp_write_exceptions_enabled(php_snmp_object *snmp_object, zval\n \t\tnewval = &ztmp;\n \t}\n \n-\tsnmp_object->exceptions_enabled = Z_LVAL_P(newval);\t\n+\tsnmp_object->exceptions_enabled = Z_LVAL_P(newval);\n \n \tif (newval == &ztmp) {\n \t\tzval_dtor(newval);\n@@ -2401,6 +2409,7 @@ PHP_MINIT_FUNCTION(snmp)\n \tphp_snmp_object_handlers.write_property = php_snmp_write_property;\n \tphp_snmp_object_handlers.has_property = php_snmp_has_property;\n \tphp_snmp_object_handlers.get_properties = php_snmp_get_properties;\n+\tphp_snmp_object_handlers.get_gc = php_snmp_get_gc;\n \n \t\/* Register SNMP Class *\/\n \tINIT_CLASS_ENTRY(ce, \"SNMP\", php_snmp_class_methods);\n@@ -2467,7 +2476,7 @@ PHP_MINIT_FUNCTION(snmp)\n PHP_MSHUTDOWN_FUNCTION(snmp)\n {\n \tsnmp_shutdown(\"snmpapp\");\n-\t\n+\n \tzend_hash_destroy(&php_snmp_properties);\n \n \treturn SUCCESS;\ndiff --git a\/ext\/snmp\/tests\/bug72479.phpt b\/ext\/snmp\/tests\/bug72479.phpt\nnew file mode 100644\nindex 0000000..0308754\n--- \/dev\/null\n+++ b\/ext\/snmp\/tests\/bug72479.phpt\n@@ -0,0 +1,35 @@\n+--TEST--                                 \n+Bug #72479: Use After Free Vulnerability in SNMP with GC and unserialize()\n+--SKIPIF--\n+<?php\n+require_once(dirname(__FILE__).'\/skipif.inc');\n+?>\n+--FILE--\n+<?php\n+$arr = [1, [1, 2, 3, 4, 5], 3, 4, 5];\n+$poc = 'a:3:{i:1;N;i:2;O:4:\"snmp\":1:{s:11:\"quick_print\";'.serialize($arr).'}i:1;R:7;}';\n+$out = unserialize($poc);\n+gc_collect_cycles();\n+$fakezval = ptr2str(1122334455);\n+$fakezval .= ptr2str(0);\n+$fakezval .= \"\\x00\\x00\\x00\\x00\";\n+$fakezval .= \"\\x01\";\n+$fakezval .= \"\\x00\";\n+$fakezval .= \"\\x00\\x00\";\n+for ($i = 0; $i < 5; $i++) {\n+    $v[$i] = $fakezval.$i;\n+}\n+var_dump($out[1]);\n+\n+function ptr2str($ptr)\n+{\n+    $out = '';\n+    for ($i = 0; $i < 8; $i++) {\n+        $out .= chr($ptr & 0xff);\n+        $ptr >>= 8;\n+    }\n+    return $out;\n+}\n+?>\n+--EXPECT--\n+int(1)\n\\ No newline at end of file\n-- \n2.1.4\n\n","owner":"NA","repo":"NA","source":"cve"}]